

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>tifffile.tifffile &mdash; aicsimageio 3.0.7 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> aicsimageio
          

          
          </a>

          
            
            
              <div class="version">
                3.0.7
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#stable-release">Stable release</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#from-sources">From sources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Package modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../aicsimageio.html">aicsimageio package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../aicsimageio.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../aicsimageio.readers.html">aicsimageio.readers package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../aicsimageio.vendor.html">aicsimageio.vendor package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../aicsimageio.writers.html">aicsimageio.writers package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../aicsimageio.html#submodules">Submodules</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../aicsimageio.html#module-aicsimageio.aics_image">aicsimageio.aics_image module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../aicsimageio.html#module-aicsimageio.buffer_reader">aicsimageio.buffer_reader module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../aicsimageio.html#module-aicsimageio.constants">aicsimageio.constants module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../aicsimageio.html#module-aicsimageio.exceptions">aicsimageio.exceptions module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../aicsimageio.html#module-aicsimageio.transforms">aicsimageio.transforms module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../aicsimageio.html#module-aicsimageio.types">aicsimageio.types module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../aicsimageio.html#module-aicsimageio">Module contents</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../contributing.html#get-started">Get Started!</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing.html#deploying">Deploying</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">aicsimageio</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>tifffile.tifffile</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tifffile.tifffile</h1><div class="highlight"><pre>
<span></span>

<span class="c1">#! /usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># tifffile.py</span>

<span class="c1"># Copyright (c) 2008-2018, Christoph Gohlke</span>
<span class="c1"># Copyright (c) 2008-2018, The Regents of the University of California</span>
<span class="c1"># Produced at the Laboratory for Fluorescence Dynamics</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># * Redistributions of source code must retain the above copyright</span>
<span class="c1">#   notice, this list of conditions and the following disclaimer.</span>
<span class="c1"># * Redistributions in binary form must reproduce the above copyright</span>
<span class="c1">#   notice, this list of conditions and the following disclaimer in the</span>
<span class="c1">#   documentation and/or other materials provided with the distribution.</span>
<span class="c1"># * Neither the name of the copyright holders nor the names of any</span>
<span class="c1">#   contributors may be used to endorse or promote products derived</span>
<span class="c1">#   from this software without specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="c1"># AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="c1"># IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="c1"># ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
<span class="c1"># LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="c1"># CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="c1"># SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="c1"># INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<span class="c1"># CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="c1"># ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="c1"># POSSIBILITY OF SUCH DAMAGE.</span>

<span class="sd">&quot;&quot;&quot;Read image and meta data from (bio) TIFF(R) files. Save numpy arrays as TIFF.</span>

<span class="sd">Image and metadata can be read from TIFF, BigTIFF, OME-TIFF, STK, LSM, NIH,</span>
<span class="sd">SGI, ImageJ, MicroManager, FluoView, ScanImage, SEQ, GEL, and GeoTIFF files.</span>

<span class="sd">Tifffile is not a general-purpose TIFF library.</span>
<span class="sd">Only a subset of the TIFF specification is supported, mainly uncompressed and</span>
<span class="sd">losslessly compressed 1, 8, 16, 32 and 64 bit integer, 16, 32 and 64-bit float,</span>
<span class="sd">grayscale and RGB(A) images, which are commonly used in scientific imaging.</span>
<span class="sd">Specifically, reading slices of image data, image trees defined via SubIFDs,</span>
<span class="sd">CCITT and OJPEG compression, chroma subsampling without JPEG compression,</span>
<span class="sd">or IPTC and XMP metadata are not implemented.</span>

<span class="sd">TIFF(R), the tagged Image File Format, is a trademark and under control of</span>
<span class="sd">Adobe Systems Incorporated. BigTIFF allows for files greater than 4 GB.</span>
<span class="sd">STK, LSM, FluoView, SGI, SEQ, GEL, and OME-TIFF, are custom extensions</span>
<span class="sd">defined by Molecular Devices (Universal Imaging Corporation), Carl Zeiss</span>
<span class="sd">MicroImaging, Olympus, Silicon Graphics International, Media Cybernetics,</span>
<span class="sd">Molecular Dynamics, and the Open Microscopy Environment consortium</span>
<span class="sd">respectively.</span>

<span class="sd">For command line usage run C{python -m tifffile --help}</span>

<span class="sd">:Author:</span>
<span class="sd">  `Christoph Gohlke &lt;https://www.lfd.uci.edu/~gohlke/&gt;`_</span>

<span class="sd">:Organization:</span>
<span class="sd">  Laboratory for Fluorescence Dynamics, University of California, Irvine</span>

<span class="sd">:Version: 2018.06.15</span>

<span class="sd">Requirements</span>
<span class="sd">------------</span>
<span class="sd">* `CPython 3.6 64-bit &lt;https://www.python.org&gt;`_</span>
<span class="sd">* `Numpy 1.14 &lt;http://www.numpy.org&gt;`_</span>
<span class="sd">* `Matplotlib 2.2 &lt;https://www.matplotlib.org&gt;`_ (optional for plotting)</span>
<span class="sd">* `Tifffile.c 2018.02.10 &lt;https://www.lfd.uci.edu/~gohlke/&gt;`_</span>
<span class="sd">  (recommended for faster decoding of PackBits and LZW encoded strings)</span>
<span class="sd">* `Tifffile_geodb.py 2018.02.10 &lt;https://www.lfd.uci.edu/~gohlke/&gt;`_</span>
<span class="sd">  (optional enums for GeoTIFF metadata)</span>
<span class="sd">* Python 2 requires &#39;futures&#39;, &#39;enum34&#39;, &#39;pathlib&#39;.</span>

<span class="sd">Revisions</span>
<span class="sd">---------</span>
<span class="sd">2018.06.15</span>
<span class="sd">    Pass 2680 tests.</span>
<span class="sd">    Towards reading JPEG and other compressions via imagecodecs package (WIP).</span>
<span class="sd">    Add function to validate TIFF using &#39;jhove -m TIFF-hul&#39;.</span>
<span class="sd">    Save bool arrays as bilevel TIFF.</span>
<span class="sd">    Accept pathlib.Path as filenames.</span>
<span class="sd">    Move &#39;software&#39; argument from TiffWriter __init__ to save.</span>
<span class="sd">    Raise DOS limit to 16 TB.</span>
<span class="sd">    Lazy load lzma and zstd compressors and decompressors.</span>
<span class="sd">    Add option to save IJMetadata tags.</span>
<span class="sd">    Return correct number of pages for truncated series (bug fix).</span>
<span class="sd">    Move EXIF tags to TIFF.TAG as per TIFF/EP standard.</span>
<span class="sd">2018.02.18</span>
<span class="sd">    Pass 2293 tests.</span>
<span class="sd">    Always save RowsPerStrip and Resolution tags as required by TIFF standard.</span>
<span class="sd">    Do not use badly typed ImageDescription.</span>
<span class="sd">    Coherce bad ASCII string tags to bytes.</span>
<span class="sd">    Tuning of __str__ functions.</span>
<span class="sd">    Fix reading &#39;undefined&#39; tag values (bug fix).</span>
<span class="sd">    Read and write ZSTD compressed data.</span>
<span class="sd">    Use hexdump to print byte strings.</span>
<span class="sd">    Determine TIFF byte order from data dtype in imsave.</span>
<span class="sd">    Add option to specify RowsPerStrip for compressed strips.</span>
<span class="sd">    Allow memory map of arrays with non-native byte order.</span>
<span class="sd">    Attempt to handle ScanImage &lt;= 5.1 files.</span>
<span class="sd">    Restore TiffPageSeries.pages sequence interface.</span>
<span class="sd">    Use numpy.frombuffer instead of fromstring to read from binary data.</span>
<span class="sd">    Parse GeoTIFF metadata.</span>
<span class="sd">    Add option to apply horizontal differencing before compression.</span>
<span class="sd">    Towards reading PerkinElmer QPTIFF (no test files).</span>
<span class="sd">    Do not index out of bounds data in tifffile.c unpackbits and decodelzw.</span>
<span class="sd">2017.09.29 (tentative)</span>
<span class="sd">    Many backwards incompatible changes improving speed and resource usage:</span>
<span class="sd">    Pass 2268 tests.</span>
<span class="sd">    Add detail argument to __str__ function. Remove info functions.</span>
<span class="sd">    Fix potential issue correcting offsets of large LSM files with positions.</span>
<span class="sd">    Remove TiffFile sequence interface; use TiffFile.pages instead.</span>
<span class="sd">    Do not make tag values available as TiffPage attributes.</span>
<span class="sd">    Use str (not bytes) type for tag and metadata strings (WIP).</span>
<span class="sd">    Use documented standard tag and value names (WIP).</span>
<span class="sd">    Use enums for some documented TIFF tag values.</span>
<span class="sd">    Remove &#39;memmap&#39; and &#39;tmpfile&#39; options; use out=&#39;memmap&#39; instead.</span>
<span class="sd">    Add option to specify output in asarray functions.</span>
<span class="sd">    Add option to concurrently decode image strips or tiles using threads.</span>
<span class="sd">    Add TiffPage.asrgb function (WIP).</span>
<span class="sd">    Do not apply colormap in asarray.</span>
<span class="sd">    Remove &#39;colormapped&#39;, &#39;rgbonly&#39;, and &#39;scale_mdgel&#39; options from asarray.</span>
<span class="sd">    Consolidate metadata in TiffFile _metadata functions.</span>
<span class="sd">    Remove non-tag metadata properties from TiffPage.</span>
<span class="sd">    Add function to convert LSM to tiled BIN files.</span>
<span class="sd">    Align image data in file.</span>
<span class="sd">    Make TiffPage.dtype a numpy.dtype.</span>
<span class="sd">    Add &#39;ndim&#39; and &#39;size&#39; properties to TiffPage and TiffPageSeries.</span>
<span class="sd">    Allow imsave to write non-BigTIFF files up to ~4 GB.</span>
<span class="sd">    Only read one page for shaped series if possible.</span>
<span class="sd">    Add memmap function to create memory-mapped array stored in TIFF file.</span>
<span class="sd">    Add option to save empty arrays to TIFF files.</span>
<span class="sd">    Add option to save truncated TIFF files.</span>
<span class="sd">    Allow single tile images to be saved contiguously.</span>
<span class="sd">    Add optional movie mode for files with uniform pages.</span>
<span class="sd">    Lazy load pages.</span>
<span class="sd">    Use lightweight TiffFrame for IFDs sharing properties with key TiffPage.</span>
<span class="sd">    Move module constants to &#39;TIFF&#39; namespace (speed up module import).</span>
<span class="sd">    Remove &#39;fastij&#39; option from TiffFile.</span>
<span class="sd">    Remove &#39;pages&#39; parameter from TiffFile.</span>
<span class="sd">    Remove TIFFfile alias.</span>
<span class="sd">    Deprecate Python 2.</span>
<span class="sd">    Require enum34 and futures packages on Python 2.7.</span>
<span class="sd">    Remove Record class and return all metadata as dict instead.</span>
<span class="sd">    Add functions to parse STK, MetaSeries, ScanImage, SVS, Pilatus metadata.</span>
<span class="sd">    Read tags from EXIF and GPS IFDs.</span>
<span class="sd">    Use pformat for tag and metadata values.</span>
<span class="sd">    Fix reading some UIC tags (bug fix).</span>
<span class="sd">    Do not modify input array in imshow (bug fix).</span>
<span class="sd">    Fix Python implementation of unpack_ints.</span>
<span class="sd">2017.05.23</span>
<span class="sd">    Pass 1961 tests.</span>
<span class="sd">    Write correct number of SampleFormat values (bug fix).</span>
<span class="sd">    Use Adobe deflate code to write ZIP compressed files.</span>
<span class="sd">    Add option to pass tag values as packed binary data for writing.</span>
<span class="sd">    Defer tag validation to attribute access.</span>
<span class="sd">    Use property instead of lazyattr decorator for simple expressions.</span>
<span class="sd">2017.03.17</span>
<span class="sd">    Write IFDs and tag values on word boundaries.</span>
<span class="sd">    Read ScanImage metadata.</span>
<span class="sd">    Remove is_rgb and is_indexed attributes from TiffFile.</span>
<span class="sd">    Create files used by doctests.</span>
<span class="sd">2017.01.12</span>
<span class="sd">    Read Zeiss SEM metadata.</span>
<span class="sd">    Read OME-TIFF with invalid references to external files.</span>
<span class="sd">    Rewrite C LZW decoder (5x faster).</span>
<span class="sd">    Read corrupted LSM files missing EOI code in LZW stream.</span>
<span class="sd">2017.01.01</span>
<span class="sd">    Add option to append images to existing TIFF files.</span>
<span class="sd">    Read files without pages.</span>
<span class="sd">    Read S-FEG and Helios NanoLab tags created by FEI software.</span>
<span class="sd">    Allow saving Color Filter Array (CFA) images.</span>
<span class="sd">    Add info functions returning more information about TiffFile and TiffPage.</span>
<span class="sd">    Add option to read specific pages only.</span>
<span class="sd">    Remove maxpages argument (backwards incompatible).</span>
<span class="sd">    Remove test_tifffile function.</span>
<span class="sd">2016.10.28</span>
<span class="sd">    Pass 1944 tests.</span>
<span class="sd">    Improve detection of ImageJ hyperstacks.</span>
<span class="sd">    Read TVIPS metadata created by EM-MENU (by Marco Oster).</span>
<span class="sd">    Add option to disable using OME-XML metadata.</span>
<span class="sd">    Allow non-integer range attributes in modulo tags (by Stuart Berg).</span>
<span class="sd">2016.06.21</span>
<span class="sd">    Do not always memmap contiguous data in page series.</span>
<span class="sd">2016.05.13</span>
<span class="sd">    Add option to specify resolution unit.</span>
<span class="sd">    Write grayscale images with extra samples when planarconfig is specified.</span>
<span class="sd">    Do not write RGB color images with 2 samples.</span>
<span class="sd">    Reorder TiffWriter.save keyword arguments (backwards incompatible).</span>
<span class="sd">2016.04.18</span>
<span class="sd">    Pass 1932 tests.</span>
<span class="sd">    TiffWriter, imread, and imsave accept open binary file streams.</span>
<span class="sd">2016.04.13</span>
<span class="sd">    Correctly handle reversed fill order in 2 and 4 bps images (bug fix).</span>
<span class="sd">    Implement reverse_bitorder in C.</span>
<span class="sd">2016.03.18</span>
<span class="sd">    Fix saving additional ImageJ metadata.</span>
<span class="sd">2016.02.22</span>
<span class="sd">    Pass 1920 tests.</span>
<span class="sd">    Write 8 bytes double tag values using offset if necessary (bug fix).</span>
<span class="sd">    Add option to disable writing second image description tag.</span>
<span class="sd">    Detect tags with incorrect counts.</span>
<span class="sd">    Disable color mapping for LSM.</span>
<span class="sd">2015.11.13</span>
<span class="sd">    Read LSM 6 mosaics.</span>
<span class="sd">    Add option to specify directory of memory-mapped files.</span>
<span class="sd">    Add command line options to specify vmin and vmax values for colormapping.</span>
<span class="sd">2015.10.06</span>
<span class="sd">    New helper function to apply colormaps.</span>
<span class="sd">    Renamed is_palette attributes to is_indexed (backwards incompatible).</span>
<span class="sd">    Color-mapped samples are now contiguous (backwards incompatible).</span>
<span class="sd">    Do not color-map ImageJ hyperstacks (backwards incompatible).</span>
<span class="sd">    Towards reading Leica SCN.</span>
<span class="sd">2015.09.25</span>
<span class="sd">    Read images with reversed bit order (FillOrder is LSB2MSB).</span>
<span class="sd">2015.09.21</span>
<span class="sd">    Read RGB OME-TIFF.</span>
<span class="sd">    Warn about malformed OME-XML.</span>
<span class="sd">2015.09.16</span>
<span class="sd">    Detect some corrupted ImageJ metadata.</span>
<span class="sd">    Better axes labels for &#39;shaped&#39; files.</span>
<span class="sd">    Do not create TiffTag for default values.</span>
<span class="sd">    Chroma subsampling is not supported.</span>
<span class="sd">    Memory-map data in TiffPageSeries if possible (optional).</span>
<span class="sd">2015.08.17</span>
<span class="sd">    Pass 1906 tests.</span>
<span class="sd">    Write ImageJ hyperstacks (optional).</span>
<span class="sd">    Read and write LZMA compressed data.</span>
<span class="sd">    Specify datetime when saving (optional).</span>
<span class="sd">    Save tiled and color-mapped images (optional).</span>
<span class="sd">    Ignore void bytecounts and offsets if possible.</span>
<span class="sd">    Ignore bogus image_depth tag created by ISS Vista software.</span>
<span class="sd">    Decode floating point horizontal differencing (not tiled).</span>
<span class="sd">    Save image data contiguously if possible.</span>
<span class="sd">    Only read first IFD from ImageJ files if possible.</span>
<span class="sd">    Read ImageJ &#39;raw&#39; format (files larger than 4 GB).</span>
<span class="sd">    TiffPageSeries class for pages with compatible shape and data type.</span>
<span class="sd">    Try to read incomplete tiles.</span>
<span class="sd">    Open file dialog if no filename is passed on command line.</span>
<span class="sd">    Ignore errors when decoding OME-XML.</span>
<span class="sd">    Rename decoder functions (backwards incompatible).</span>
<span class="sd">2014.08.24</span>
<span class="sd">    TiffWriter class for incremental writing images.</span>
<span class="sd">    Simplify examples.</span>
<span class="sd">2014.08.19</span>
<span class="sd">    Add memmap function to FileHandle.</span>
<span class="sd">    Add function to determine if image data in TiffPage is memory-mappable.</span>
<span class="sd">    Do not close files if multifile_close parameter is False.</span>
<span class="sd">2014.08.10</span>
<span class="sd">    Pass 1730 tests.</span>
<span class="sd">    Return all extrasamples by default (backwards incompatible).</span>
<span class="sd">    Read data from series of pages into memory-mapped array (optional).</span>
<span class="sd">    Squeeze OME dimensions (backwards incompatible).</span>
<span class="sd">    Workaround missing EOI code in strips.</span>
<span class="sd">    Support image and tile depth tags (SGI extension).</span>
<span class="sd">    Better handling of STK/UIC tags (backwards incompatible).</span>
<span class="sd">    Disable color mapping for STK.</span>
<span class="sd">    Julian to datetime converter.</span>
<span class="sd">    TIFF ASCII type may be NULL separated.</span>
<span class="sd">    Unwrap strip offsets for LSM files greater than 4 GB.</span>
<span class="sd">    Correct strip byte counts in compressed LSM files.</span>
<span class="sd">    Skip missing files in OME series.</span>
<span class="sd">    Read embedded TIFF files.</span>
<span class="sd">2014.02.05</span>
<span class="sd">    Save rational numbers as type 5 (bug fix).</span>
<span class="sd">2013.12.20</span>
<span class="sd">    Keep other files in OME multi-file series closed.</span>
<span class="sd">    FileHandle class to abstract binary file handle.</span>
<span class="sd">    Disable color mapping for bad OME-TIFF produced by bio-formats.</span>
<span class="sd">    Read bad OME-XML produced by ImageJ when cropping.</span>
<span class="sd">2013.11.03</span>
<span class="sd">    Allow zlib compress data in imsave function (optional).</span>
<span class="sd">    Memory-map contiguous image data (optional).</span>
<span class="sd">2013.10.28</span>
<span class="sd">    Read MicroManager metadata and little-endian ImageJ tag.</span>
<span class="sd">    Save extra tags in imsave function.</span>
<span class="sd">    Save tags in ascending order by code (bug fix).</span>
<span class="sd">2012.10.18</span>
<span class="sd">    Accept file like objects (read from OIB files).</span>
<span class="sd">2012.08.21</span>
<span class="sd">    Rename TIFFfile to TiffFile and TIFFpage to TiffPage.</span>
<span class="sd">    TiffSequence class for reading sequence of TIFF files.</span>
<span class="sd">    Read UltraQuant tags.</span>
<span class="sd">    Allow float numbers as resolution in imsave function.</span>
<span class="sd">2012.08.03</span>
<span class="sd">    Read MD GEL tags and NIH Image header.</span>
<span class="sd">2012.07.25</span>
<span class="sd">    Read ImageJ tags.</span>
<span class="sd">    ...</span>

<span class="sd">Notes</span>
<span class="sd">-----</span>
<span class="sd">The API is not stable yet and might change between revisions.</span>

<span class="sd">Tested on little-endian platforms only.</span>

<span class="sd">Other Python packages and modules for reading (bio) scientific TIFF files:</span>

<span class="sd">*  `python-bioformats &lt;https://github.com/CellProfiler/python-bioformats&gt;`_</span>
<span class="sd">*  `Imread &lt;https://github.com/luispedro/imread&gt;`_</span>
<span class="sd">*  `PyLibTiff &lt;https://github.com/pearu/pylibtiff&gt;`_</span>
<span class="sd">*  `SimpleITK &lt;http://www.simpleitk.org&gt;`_</span>
<span class="sd">*  `PyLSM &lt;https://launchpad.net/pylsm&gt;`_</span>
<span class="sd">*  `PyMca.TiffIO.py &lt;https://github.com/vasole/pymca&gt;`_ (same as fabio.TiffIO)</span>
<span class="sd">*  `BioImageXD.Readers &lt;http://www.bioimagexd.net/&gt;`_</span>
<span class="sd">*  `Cellcognition.io &lt;http://cellcognition.org/&gt;`_</span>
<span class="sd">*  `pymimage &lt;https://github.com/ardoi/pymimage&gt;`_</span>
<span class="sd">*  `pytiff &lt;https://github.com/FZJ-INM1-BDA/pytiff&gt;`_</span>

<span class="sd">Acknowledgements</span>
<span class="sd">----------------</span>
<span class="sd">*   Egor Zindy, University of Manchester, for lsm_scan_info specifics.</span>
<span class="sd">*   Wim Lewis for a bug fix and some LSM functions.</span>
<span class="sd">*   Hadrien Mary for help on reading MicroManager files.</span>
<span class="sd">*   Christian Kliche for help writing tiled and color-mapped files.</span>

<span class="sd">References</span>
<span class="sd">----------</span>
<span class="sd">1)  TIFF 6.0 Specification and Supplements. Adobe Systems Incorporated.</span>
<span class="sd">    http://partners.adobe.com/public/developer/tiff/</span>
<span class="sd">2)  TIFF File Format FAQ. http://www.awaresystems.be/imaging/tiff/faq.html</span>
<span class="sd">3)  MetaMorph Stack (STK) Image File Format.</span>
<span class="sd">    http://support.meta.moleculardevices.com/docs/t10243.pdf</span>
<span class="sd">4)  Image File Format Description LSM 5/7 Release 6.0 (ZEN 2010).</span>
<span class="sd">    Carl Zeiss MicroImaging GmbH. BioSciences. May 10, 2011</span>
<span class="sd">5)  The OME-TIFF format.</span>
<span class="sd">    http://www.openmicroscopy.org/site/support/file-formats/ome-tiff</span>
<span class="sd">6)  UltraQuant(r) Version 6.0 for Windows Start-Up Guide.</span>
<span class="sd">    http://www.ultralum.com/images%20ultralum/pdf/UQStart%20Up%20Guide.pdf</span>
<span class="sd">7)  Micro-Manager File Formats.</span>
<span class="sd">    http://www.micro-manager.org/wiki/Micro-Manager_File_Formats</span>
<span class="sd">8)  Tags for TIFF and Related Specifications. Digital Preservation.</span>
<span class="sd">    http://www.digitalpreservation.gov/formats/content/tiff_tags.shtml</span>
<span class="sd">9)  ScanImage BigTiff Specification - ScanImage 2016.</span>
<span class="sd">    http://scanimage.vidriotechnologies.com/display/SI2016/</span>
<span class="sd">    ScanImage+BigTiff+Specification</span>
<span class="sd">10) CIPA DC-008-2016: Exchangeable image file format for digital still cameras:</span>
<span class="sd">    Exif Version 2.31.</span>
<span class="sd">    http://www.cipa.jp/std/documents/e/DC-008-Translation-2016-E.pdf</span>

<span class="sd">Examples</span>
<span class="sd">--------</span>
<span class="sd">&gt;&gt;&gt; # write numpy array to TIFF file</span>
<span class="sd">&gt;&gt;&gt; data = numpy.random.rand(4, 301, 219)</span>
<span class="sd">&gt;&gt;&gt; imsave(&#39;temp.tif&#39;, data, photometric=&#39;minisblack&#39;)</span>

<span class="sd">&gt;&gt;&gt; # read numpy array from TIFF file</span>
<span class="sd">&gt;&gt;&gt; image = imread(&#39;temp.tif&#39;)</span>
<span class="sd">&gt;&gt;&gt; numpy.testing.assert_array_equal(image, data)</span>

<span class="sd">&gt;&gt;&gt; # iterate over pages and tags in TIFF file</span>
<span class="sd">&gt;&gt;&gt; with TiffFile(&#39;temp.tif&#39;) as tif:</span>
<span class="sd">...     images = tif.asarray()</span>
<span class="sd">...     for page in tif.pages:</span>
<span class="sd">...         for tag in page.tags.values():</span>
<span class="sd">...             _ = tag.name, tag.value</span>
<span class="sd">...         image = page.asarray()</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">zlib</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>

<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># delay imports: mmap, pprint, fractions, xml, tkinter, matplotlib, lzma, zstd,</span>
<span class="c1">#                subprocess</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;2018.06.15&#39;</span>
<span class="n">__docformat__</span> <span class="o">=</span> <span class="s1">&#39;restructuredtext en&#39;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;imsave&#39;</span><span class="p">,</span> <span class="s1">&#39;imread&#39;</span><span class="p">,</span> <span class="s1">&#39;imshow&#39;</span><span class="p">,</span> <span class="s1">&#39;memmap&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TiffFile&#39;</span><span class="p">,</span> <span class="s1">&#39;TiffWriter&#39;</span><span class="p">,</span> <span class="s1">&#39;TiffSequence&#39;</span><span class="p">,</span>
    <span class="c1"># utility functions used by oiffile or czifile</span>
    <span class="s1">&#39;FileHandle&#39;</span><span class="p">,</span> <span class="s1">&#39;lazyattr&#39;</span><span class="p">,</span> <span class="s1">&#39;natural_sorted&#39;</span><span class="p">,</span> <span class="s1">&#39;decode_lzw&#39;</span><span class="p">,</span> <span class="s1">&#39;stripnull&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_output&#39;</span><span class="p">,</span> <span class="s1">&#39;repeat_nd&#39;</span><span class="p">,</span> <span class="s1">&#39;format_size&#39;</span><span class="p">,</span> <span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="s1">&#39;xml2dict&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">imread</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return image data from TIFF file(s) as numpy array.</span>

<span class="sd">    Refer to the TiffFile class and member functions for documentation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    files : str, binary stream, or sequence</span>
<span class="sd">        File name, seekable binary stream, glob pattern, or sequence of</span>
<span class="sd">        file names.</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        Parameters &#39;multifile&#39; and &#39;is_ome&#39; are passed to the TiffFile class.</span>
<span class="sd">        The &#39;pattern&#39; parameter is passed to the TiffSequence class.</span>
<span class="sd">        Other parameters are passed to the asarray functions.</span>
<span class="sd">        The first image series is returned if no arguments are provided.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; # get image from first page</span>
<span class="sd">    &gt;&gt;&gt; imsave(&#39;temp.tif&#39;, numpy.random.rand(3, 4, 301, 219))</span>
<span class="sd">    &gt;&gt;&gt; im = imread(&#39;temp.tif&#39;, key=0)</span>
<span class="sd">    &gt;&gt;&gt; im.shape</span>
<span class="sd">    (4, 301, 219)</span>

<span class="sd">    &gt;&gt;&gt; # get images from sequence of files</span>
<span class="sd">    &gt;&gt;&gt; ims = imread([&#39;temp.tif&#39;, &#39;temp.tif&#39;])</span>
<span class="sd">    &gt;&gt;&gt; ims.shape</span>
<span class="sd">    (2, 3, 4, 301, 219)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs_file</span> <span class="o">=</span> <span class="n">parse_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;multifile&#39;</span><span class="p">,</span> <span class="s1">&#39;is_ome&#39;</span><span class="p">)</span>
    <span class="n">kwargs_seq</span> <span class="o">=</span> <span class="n">parse_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="s1">&#39;?*&#39;</span><span class="p">):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no files found&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="s1">&#39;seek&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="s1">&#39;seek&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">TiffFile</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">tif</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">TiffSequence</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs_seq</span><span class="p">)</span> <span class="k">as</span> <span class="n">imseq</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">imseq</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">imsave</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bigsize</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="o">-</span><span class="mi">2</span><span class="o">**</span><span class="mi">25</span><span class="p">,</span>
           <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write numpy array to TIFF file.</span>

<span class="sd">    Refer to the TiffWriter class and member functions for documentation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : str or binary stream</span>
<span class="sd">        File name or writable binary stream, such as an open file or BytesIO.</span>
<span class="sd">    data : array_like</span>
<span class="sd">        Input image. The last dimensions are assumed to be image depth,</span>
<span class="sd">        height, width, and samples.</span>
<span class="sd">        If None, an empty array of the specified shape and dtype is</span>
<span class="sd">        saved to file.</span>
<span class="sd">        Unless &#39;byteorder&#39; is specified in &#39;kwargs&#39;, the TIFF file byte order</span>
<span class="sd">        is determined from the data&#39;s dtype or the dtype argument.</span>
<span class="sd">    shape : tuple</span>
<span class="sd">        If &#39;data&#39; is None, shape of an empty array to save to the file.</span>
<span class="sd">    dtype : numpy.dtype</span>
<span class="sd">        If &#39;data&#39; is None, data-type of an empty array to save to the file.</span>
<span class="sd">    bigsize : int</span>
<span class="sd">        Create a BigTIFF file if the size of data in bytes is larger than</span>
<span class="sd">        this threshold and &#39;imagej&#39; or &#39;truncate&#39; are not enabled.</span>
<span class="sd">        By default, the threshold is 4 GB minus 32 MB reserved for metadata.</span>
<span class="sd">        Use the &#39;bigtiff&#39; parameter to explicitly specify the type of</span>
<span class="sd">        file created.</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        Parameters &#39;append&#39;, &#39;byteorder&#39;, &#39;bigtiff&#39;, and &#39;imagej&#39;, are passed</span>
<span class="sd">        to TiffWriter(). Other parameters are passed to TiffWriter.save().</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    If the image data are written contiguously, return offset and bytecount</span>
<span class="sd">    of image data in the file.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; # save a RGB image</span>
<span class="sd">    &gt;&gt;&gt; data = numpy.random.randint(0, 255, (256, 256, 3), &#39;uint8&#39;)</span>
<span class="sd">    &gt;&gt;&gt; imsave(&#39;temp.tif&#39;, data, photometric=&#39;rgb&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # save a random array and metadata, using compression</span>
<span class="sd">    &gt;&gt;&gt; data = numpy.random.rand(2, 5, 3, 301, 219)</span>
<span class="sd">    &gt;&gt;&gt; imsave(&#39;temp.tif&#39;, data, compress=6, metadata={&#39;axes&#39;: &#39;TZCYX&#39;})</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tifargs</span> <span class="o">=</span> <span class="n">parse_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="s1">&#39;bigtiff&#39;</span><span class="p">,</span> <span class="s1">&#39;byteorder&#39;</span><span class="p">,</span> <span class="s1">&#39;imagej&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="n">byteorder</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">byteorder</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">nbytes</span>
            <span class="n">byteorder</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">byteorder</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">byteorder</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">bigsize</span> <span class="ow">and</span> <span class="s1">&#39;bigtiff&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tifargs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">tifargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;imagej&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="n">tifargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;truncate&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
        <span class="n">tifargs</span><span class="p">[</span><span class="s1">&#39;bigtiff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="s1">&#39;byteorder&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tifargs</span><span class="p">:</span>
        <span class="n">tifargs</span><span class="p">[</span><span class="s1">&#39;byteorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">byteorder</span>

    <span class="k">with</span> <span class="n">TiffWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">tifargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">tif</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tif</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">memmap</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">,</span>
           <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return memory-mapped numpy array stored in TIFF file.</span>

<span class="sd">    Memory-mapping requires data stored in native byte order, without tiling,</span>
<span class="sd">    compression, predictors, etc.</span>
<span class="sd">    If &#39;shape&#39; and &#39;dtype&#39; are provided, existing files will be overwritten or</span>
<span class="sd">    appended to depending on the &#39;append&#39; parameter.</span>
<span class="sd">    Otherwise the image data of a specified page or series in an existing</span>
<span class="sd">    file will be memory-mapped. By default, the image data of the first page</span>
<span class="sd">    series is memory-mapped.</span>
<span class="sd">    Call flush() to write any changes in the array to the file.</span>
<span class="sd">    Raise ValueError if the image data in the file is not memory-mappable.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Name of the TIFF file which stores the array.</span>
<span class="sd">    shape : tuple</span>
<span class="sd">        Shape of the empty array.</span>
<span class="sd">    dtype : numpy.dtype</span>
<span class="sd">        Data-type of the empty array.</span>
<span class="sd">    page : int</span>
<span class="sd">        Index of the page which image data to memory-map.</span>
<span class="sd">    series : int</span>
<span class="sd">        Index of the page series which image data to memory-map.</span>
<span class="sd">    mode : {&#39;r+&#39;, &#39;r&#39;, &#39;c&#39;}, optional</span>
<span class="sd">        The file open mode. Default is to open existing file for reading and</span>
<span class="sd">        writing (&#39;r+&#39;).</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        Additional parameters passed to imsave() or TiffFile().</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; # create an empty TIFF file and write to memory-mapped image</span>
<span class="sd">    &gt;&gt;&gt; im = memmap(&#39;temp.tif&#39;, shape=(256, 256), dtype=&#39;float32&#39;)</span>
<span class="sd">    &gt;&gt;&gt; im[255, 255] = 1.0</span>
<span class="sd">    &gt;&gt;&gt; im.flush()</span>
<span class="sd">    &gt;&gt;&gt; im.shape, im.dtype</span>
<span class="sd">    ((256, 256), dtype(&#39;float32&#39;))</span>
<span class="sd">    &gt;&gt;&gt; del im</span>

<span class="sd">    &gt;&gt;&gt; # memory-map image data in a TIFF file</span>
<span class="sd">    &gt;&gt;&gt; im = memmap(&#39;temp.tif&#39;, page=0)</span>
<span class="sd">    &gt;&gt;&gt; im[255, 255]</span>
<span class="sd">    1.0</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># create a new, empty array</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">returnoffset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">align</span><span class="o">=</span><span class="n">TIFF</span><span class="o">.</span><span class="n">ALLOCATIONGRANULARITY</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">imsave</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO: fail before creating file or writing data</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;image data are not memory-mappable&#39;</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># use existing file</span>
        <span class="k">with</span> <span class="n">TiffFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">tif</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">page</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">page</span><span class="o">.</span><span class="n">is_memmappable</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;image data are not memory-mappable&#39;</span><span class="p">)</span>
                <span class="n">offset</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">dtype</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">series</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="n">series</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">series</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;image data are not memory-mappable&#39;</span><span class="p">)</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">dtype</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">offset</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">+</span> <span class="n">dtype</span><span class="o">.</span><span class="n">char</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">lazyattr</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Attribute whose value is computed on first access.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: help() doesn&#39;t work</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;func&#39;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="c1"># self.__name__ = func.__name__</span>
        <span class="c1"># self.__doc__ = func.__doc__</span>
        <span class="c1"># self.lock = threading.RLock()</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="c1"># with self.lock:</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">NotImplemented</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">instance</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">TiffWriter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write numpy arrays to TIFF file.</span>

<span class="sd">    TiffWriter instances must be closed using the &#39;close&#39; method, which is</span>
<span class="sd">    automatically called when using the &#39;with&#39; context manager.</span>

<span class="sd">    TiffWriter&#39;s main purpose is saving nD numpy array&#39;s as TIFF,</span>
<span class="sd">    not to create any possible TIFF format. Specifically, JPEG compression,</span>
<span class="sd">    SubIFDs, ExifIFD, or GPSIFD tags are not supported.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; # successively append images to BigTIFF file</span>
<span class="sd">    &gt;&gt;&gt; data = numpy.random.rand(2, 5, 3, 301, 219)</span>
<span class="sd">    &gt;&gt;&gt; with TiffWriter(&#39;temp.tif&#39;, bigtiff=True) as tif:</span>
<span class="sd">    ...     for i in range(data.shape[0]):</span>
<span class="sd">    ...         tif.save(data[i], compress=6, photometric=&#39;minisblack&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">bigtiff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">imagej</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open a TIFF file for writing.</span>

<span class="sd">        An empty TIFF file is created if the file does not exist, else the</span>
<span class="sd">        file is overwritten with an empty TIFF file unless &#39;append&#39;</span>
<span class="sd">        is true. Use bigtiff=True when creating files larger than 4 GB.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : str, binary stream, or FileHandle</span>
<span class="sd">            File name or writable binary stream, such as an open file</span>
<span class="sd">            or BytesIO.</span>
<span class="sd">        bigtiff : bool</span>
<span class="sd">            If True, the BigTIFF format is used.</span>
<span class="sd">        byteorder : {&#39;&lt;&#39;, &#39;&gt;&#39;, &#39;=&#39;, &#39;|&#39;}</span>
<span class="sd">            The endianness of the data in the file.</span>
<span class="sd">            By default, this is the system&#39;s native byte order.</span>
<span class="sd">        append : bool</span>
<span class="sd">            If True and &#39;file&#39; is an existing standard TIFF file, image data</span>
<span class="sd">            and tags are appended to the file.</span>
<span class="sd">            Appending data may corrupt specifically formatted TIFF files</span>
<span class="sd">            such as LSM, STK, ImageJ, NIH, or FluoView.</span>
<span class="sd">        imagej : bool</span>
<span class="sd">            If True, write an ImageJ hyperstack compatible file.</span>
<span class="sd">            This format can handle data types uint8, uint16, or float32 and</span>
<span class="sd">            data shapes up to 6 dimensions in TZCYXS order.</span>
<span class="sd">            RGB images (S=3 or S=4) must be uint8.</span>
<span class="sd">            ImageJ&#39;s default byte order is big-endian but this implementation</span>
<span class="sd">            uses the system&#39;s native byte order by default.</span>
<span class="sd">            ImageJ does not support BigTIFF format or LZMA compression.</span>
<span class="sd">            The ImageJ file format is undocumented.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="c1"># determine if file is an existing TIFF file that can be extended</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">FileHandle</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">TiffFile</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span> <span class="k">as</span> <span class="n">tif</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">append</span> <span class="o">!=</span> <span class="s1">&#39;force&#39;</span> <span class="ow">and</span>
                                    <span class="nb">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">tif</span><span class="p">,</span> <span class="s1">&#39;is_&#39;</span><span class="o">+</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span>
                                        <span class="s1">&#39;lsm&#39;</span><span class="p">,</span> <span class="s1">&#39;stk&#39;</span><span class="p">,</span> <span class="s1">&#39;imagej&#39;</span><span class="p">,</span> <span class="s1">&#39;nih&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;fluoview&#39;</span><span class="p">,</span> <span class="s1">&#39;micromanager&#39;</span><span class="p">))):</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;file contains metadata&#39;</span><span class="p">)</span>
                            <span class="n">byteorder</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">byteorder</span>
                            <span class="n">bigtiff</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">is_bigtiff</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_ifdoffset</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">next_page_offset</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot append to file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
                <span class="n">append</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">):</span>
            <span class="n">byteorder</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;little&#39;</span> <span class="k">else</span> <span class="s1">&#39;&gt;&#39;</span>
        <span class="k">elif</span> <span class="n">byteorder</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid byteorder </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">imagej</span> <span class="ow">and</span> <span class="n">bigtiff</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;writing incompatible BigTIFF ImageJ&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_byteorder</span> <span class="o">=</span> <span class="n">byteorder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">imagej</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_truncate</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_colormap</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptionoffset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptionlen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptionlenoffset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># normalized shape of data in consecutive pages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># shape of data in consecutive pages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datadtype</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># data type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataoffset</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># offset to data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_databytecounts</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># byte counts per plane</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tagoffsets</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># strip or tile offset tag code</span>

        <span class="k">if</span> <span class="n">bigtiff</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bigtiff</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_offsetsize</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tagsize</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tagnoformat</span> <span class="o">=</span> <span class="s1">&#39;Q&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_offsetformat</span> <span class="o">=</span> <span class="s1">&#39;Q&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_valueformat</span> <span class="o">=</span> <span class="s1">&#39;8s&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bigtiff</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_offsetsize</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tagsize</span> <span class="o">=</span> <span class="mi">12</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tagnoformat</span> <span class="o">=</span> <span class="s1">&#39;H&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_offsetformat</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_valueformat</span> <span class="o">=</span> <span class="s1">&#39;4s&#39;</span>

        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="n">FileHandle</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+b&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="n">FileHandle</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;MM&#39;</span><span class="p">}[</span><span class="n">byteorder</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">bigtiff</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;HHH&#39;</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="mi">42</span><span class="p">))</span>
            <span class="c1"># first IFD</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ifdoffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_offsetformat</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">returnoffset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">photometric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">planarconfig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">align</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rowsperstrip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">predictor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="s1">&#39;tifffile.py&#39;</span><span class="p">,</span>
             <span class="n">metadata</span><span class="o">=</span><span class="p">{},</span> <span class="n">ijmetadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extratags</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;Write numpy array and tags to TIFF file.</span>

<span class="sd">        The data shape&#39;s last dimensions are assumed to be image depth,</span>
<span class="sd">        height (length), width, and samples.</span>
<span class="sd">        If a colormap is provided, the data&#39;s dtype must be uint8 or uint16</span>
<span class="sd">        and the data values are indices into the last dimension of the</span>
<span class="sd">        colormap.</span>
<span class="sd">        If &#39;shape&#39; and &#39;dtype&#39; are specified, an empty array is saved.</span>
<span class="sd">        This option cannot be used with compression or multiple tiles.</span>
<span class="sd">        Image data are written uncompressed in one strip per plane by default.</span>
<span class="sd">        Dimensions larger than 2 to 4 (depending on photometric mode, planar</span>
<span class="sd">        configuration, and SGI mode) are flattened and saved as separate pages.</span>
<span class="sd">        The SampleFormat and BitsPerSample tags are derived from the data type.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : numpy.ndarray or None</span>
<span class="sd">            Input image array.</span>
<span class="sd">        shape : tuple or None</span>
<span class="sd">            Shape of the empty array to save. Used only if &#39;data&#39; is None.</span>
<span class="sd">        dtype : numpy.dtype or None</span>
<span class="sd">            Data-type of the empty array to save. Used only if &#39;data&#39; is None.</span>
<span class="sd">        returnoffset : bool</span>
<span class="sd">            If True and the image data in the file is memory-mappable, return</span>
<span class="sd">            the offset and number of bytes of the image data in the file.</span>
<span class="sd">        photometric : {&#39;MINISBLACK&#39;, &#39;MINISWHITE&#39;, &#39;RGB&#39;, &#39;PALETTE&#39;, &#39;CFA&#39;}</span>
<span class="sd">            The color space of the image data.</span>
<span class="sd">            By default, this setting is inferred from the data shape and the</span>
<span class="sd">            value of colormap.</span>
<span class="sd">            For CFA images, DNG tags must be specified in &#39;extratags&#39;.</span>
<span class="sd">        planarconfig : {&#39;CONTIG&#39;, &#39;SEPARATE&#39;}</span>
<span class="sd">            Specifies if samples are stored contiguous or in separate planes.</span>
<span class="sd">            By default, this setting is inferred from the data shape.</span>
<span class="sd">            If this parameter is set, extra samples are used to store grayscale</span>
<span class="sd">            images.</span>
<span class="sd">            &#39;CONTIG&#39;: last dimension contains samples.</span>
<span class="sd">            &#39;SEPARATE&#39;: third last dimension contains samples.</span>
<span class="sd">        tile : tuple of int</span>
<span class="sd">            The shape (depth, length, width) of image tiles to write.</span>
<span class="sd">            If None (default), image data are written in strips.</span>
<span class="sd">            The tile length and width must be a multiple of 16.</span>
<span class="sd">            If the tile depth is provided, the SGI ImageDepth and TileDepth</span>
<span class="sd">            tags are used to save volume data.</span>
<span class="sd">            Unless a single tile is used, tiles cannot be used to write</span>
<span class="sd">            contiguous files.</span>
<span class="sd">            Few software can read the SGI format, e.g. MeVisLab.</span>
<span class="sd">        contiguous : bool</span>
<span class="sd">            If True (default) and the data and parameters are compatible with</span>
<span class="sd">            previous ones, if any, the image data are stored contiguously after</span>
<span class="sd">            the previous one. Parameters &#39;photometric&#39; and &#39;planarconfig&#39;</span>
<span class="sd">            are ignored. Parameters &#39;description&#39;, datetime&#39;, and &#39;extratags&#39;</span>
<span class="sd">            are written to the first page of a contiguous series only.</span>
<span class="sd">        align : int</span>
<span class="sd">            Byte boundary on which to align the image data in the file.</span>
<span class="sd">            Default 16. Use mmap.ALLOCATIONGRANULARITY for memory-mapped data.</span>
<span class="sd">            Following contiguous writes are not aligned.</span>
<span class="sd">        truncate : bool</span>
<span class="sd">            If True, only write the first page including shape metadata if</span>
<span class="sd">            possible (uncompressed, contiguous, not tiled).</span>
<span class="sd">            Other TIFF readers will only be able to read part of the data.</span>
<span class="sd">        compress : int or &#39;LZMA&#39;, &#39;ZSTD&#39;</span>
<span class="sd">            Values from 0 to 9 controlling the level of zlib compression.</span>
<span class="sd">            If 0 (default), data are written uncompressed.</span>
<span class="sd">            Compression cannot be used to write contiguous files.</span>
<span class="sd">            If &#39;LZMA&#39; or &#39;ZSTD&#39;, LZMA or ZSTD compression is used, which is</span>
<span class="sd">            not available on all platforms.</span>
<span class="sd">        rowsperstrip : int</span>
<span class="sd">            The number of rows per strip used for compression.</span>
<span class="sd">            Uncompressed data are written in one strip per plane.</span>
<span class="sd">        predictor : bool</span>
<span class="sd">            If True, apply horizontal differencing to integer type images</span>
<span class="sd">            before compression.</span>
<span class="sd">        colormap : numpy.ndarray</span>
<span class="sd">            RGB color values for the corresponding data value.</span>
<span class="sd">            Must be of shape (3, 2**(data.itemsize*8)) and dtype uint16.</span>
<span class="sd">        description : str</span>
<span class="sd">            The subject of the image. Must be 7-bit ASCII. Cannot be used with</span>
<span class="sd">            the ImageJ format. Saved with the first page only.</span>
<span class="sd">        datetime : datetime</span>
<span class="sd">            Date and time of image creation in &#39;%Y:%m:%d %H:%M:%S&#39; format.</span>
<span class="sd">            If None (default), the current date and time is used.</span>
<span class="sd">            Saved with the first page only.</span>
<span class="sd">        resolution : (float, float[, str]) or ((int, int), (int, int)[, str])</span>
<span class="sd">            X and Y resolutions in pixels per resolution unit as float or</span>
<span class="sd">            rational numbers. A third, optional parameter specifies the</span>
<span class="sd">            resolution unit, which must be None (default for ImageJ),</span>
<span class="sd">            &#39;INCH&#39; (default), or &#39;CENTIMETER&#39;.</span>
<span class="sd">        software : str</span>
<span class="sd">            Name of the software used to create the file. Must be 7-bit ASCII.</span>
<span class="sd">            Saved with the first page only.</span>
<span class="sd">        metadata : dict</span>
<span class="sd">            Additional meta data to be saved along with shape information</span>
<span class="sd">            in JSON or ImageJ formats in an ImageDescription tag.</span>
<span class="sd">            If None, do not write a second ImageDescription tag.</span>
<span class="sd">            Strings must be 7-bit ASCII. Saved with the first page only.</span>
<span class="sd">        ijmetadata : dict</span>
<span class="sd">            Additional meta data to be saved in application specific</span>
<span class="sd">            IJMetadata and IJMetadataByteCounts tags. Refer to the</span>
<span class="sd">            imagej_metadata_tags function for valid keys and values.</span>
<span class="sd">            Saved with the first page only.</span>
<span class="sd">        extratags : sequence of tuples</span>
<span class="sd">            Additional tags as [(code, dtype, count, value, writeonce)].</span>

<span class="sd">            code : int</span>
<span class="sd">                The TIFF tag Id.</span>
<span class="sd">            dtype : str</span>
<span class="sd">                Data type of items in &#39;value&#39; in Python struct format.</span>
<span class="sd">                One of B, s, H, I, 2I, b, h, i, 2i, f, d, Q, or q.</span>
<span class="sd">            count : int</span>
<span class="sd">                Number of data values. Not used for string or byte string</span>
<span class="sd">                values.</span>
<span class="sd">            value : sequence</span>
<span class="sd">                &#39;Count&#39; values compatible with &#39;dtype&#39;.</span>
<span class="sd">                Byte strings must contain count values of dtype packed as</span>
<span class="sd">                binary data.</span>
<span class="sd">            writeonce : bool</span>
<span class="sd">                If True, the tag is written to the first page only.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: refactor this function</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span>
        <span class="n">byteorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byteorder</span>

        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">compress</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot save compressed empty file&#39;</span><span class="p">)</span>
            <span class="n">datashape</span> <span class="o">=</span> <span class="n">shape</span>
            <span class="n">datadtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(</span><span class="n">byteorder</span><span class="p">)</span>
            <span class="n">datadtypechar</span> <span class="o">=</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">char</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">+</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot save empty array&#39;</span><span class="p">)</span>
            <span class="n">datashape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">datadtype</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span>
            <span class="n">datadtypechar</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span>

        <span class="n">returnoffset</span> <span class="o">=</span> <span class="n">returnoffset</span> <span class="ow">and</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">isnative</span>
        <span class="n">bilevel</span> <span class="o">=</span> <span class="n">datadtypechar</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span>
        <span class="k">if</span> <span class="n">bilevel</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">datashape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">2</span>
            <span class="n">datasize</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">datashape</span><span class="p">[:</span><span class="n">index</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">datashape</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">%</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">datasize</span> <span class="o">*=</span> <span class="n">datashape</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">//</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">datasize</span> <span class="o">*=</span> <span class="n">datashape</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">//</span> <span class="mi">8</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">datasize</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">datashape</span><span class="p">)</span> <span class="o">*</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span>

        <span class="c1"># just append contiguous data if possible</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_truncate</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">truncate</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">contiguous</span>
                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">datashape</span>
                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datadtype</span> <span class="o">!=</span> <span class="n">datadtype</span>
                    <span class="ow">or</span> <span class="p">(</span><span class="n">compress</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">tile</span>
                    <span class="ow">or</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colormap</span><span class="p">)):</span>
                <span class="c1"># incompatible shape, dtype, compression mode, or colormap</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_remaining_pages</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_image_description</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_truncate</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_descriptionoffset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_descriptionlenoffset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_colormap</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;ImageJ does not support non-contiguous data&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># consecutive mode</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">datashape</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">compress</span><span class="p">:</span>
                    <span class="c1"># write contiguous data, write IFDs/tags later</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">write_empty</span><span class="p">(</span><span class="n">datasize</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">returnoffset</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">offset</span><span class="p">,</span> <span class="n">datasize</span>
                    <span class="k">return</span>

        <span class="n">input_shape</span> <span class="o">=</span> <span class="n">datashape</span>
        <span class="n">tagnoformat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tagnoformat</span>
        <span class="n">valueformat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valueformat</span>
        <span class="n">offsetformat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offsetformat</span>
        <span class="n">offsetsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offsetsize</span>
        <span class="n">tagsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tagsize</span>

        <span class="n">MINISBLACK</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">MINISBLACK</span>
        <span class="n">RGB</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">RGB</span>
        <span class="n">CFA</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">CFA</span>
        <span class="n">PALETTE</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">PALETTE</span>
        <span class="n">CONTIG</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PLANARCONFIG</span><span class="o">.</span><span class="n">CONTIG</span>
        <span class="n">SEPARATE</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PLANARCONFIG</span><span class="o">.</span><span class="n">SEPARATE</span>

        <span class="c1"># parse input</span>
        <span class="k">if</span> <span class="n">photometric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">photometric</span> <span class="o">=</span> <span class="n">enumarg</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="p">,</span> <span class="n">photometric</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">planarconfig</span><span class="p">:</span>
            <span class="n">planarconfig</span> <span class="o">=</span> <span class="n">enumarg</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">PLANARCONFIG</span><span class="p">,</span> <span class="n">planarconfig</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">compress</span><span class="p">:</span>
            <span class="n">compress</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">compresstag</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">predictor</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compress</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">compress</span><span class="p">,</span> <span class="n">compresslevel</span> <span class="o">=</span> <span class="n">compress</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compress</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">compress</span><span class="p">,</span> <span class="n">compresslevel</span> <span class="o">=</span> <span class="s1">&#39;ADOBE_DEFLATE&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">compress</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">compresslevel</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid compression level </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">compress</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">compresslevel</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">compress</span> <span class="o">=</span> <span class="n">compress</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">compresstag</span> <span class="o">=</span> <span class="n">enumarg</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">COMPRESSION</span><span class="p">,</span> <span class="n">compress</span><span class="p">)</span>

        <span class="c1"># prepare ImageJ format</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">compress</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;LZMA&#39;</span><span class="p">,</span> <span class="s1">&#39;ZSTD&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;ImageJ cannot handle LZMA or ZSTD compression&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;not writing description to ImageJ file&#39;</span><span class="p">)</span>
                <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">datadtypechar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;BHhf&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;ImageJ does not support data type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">datadtypechar</span><span class="p">)</span>
            <span class="n">ijrgb</span> <span class="o">=</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">RGB</span> <span class="k">if</span> <span class="n">photometric</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">datadtypechar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span>
                <span class="n">ijrgb</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ijshape</span> <span class="o">=</span> <span class="n">imagej_shape</span><span class="p">(</span><span class="n">datashape</span><span class="p">,</span> <span class="n">ijrgb</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ijshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="n">photometric</span> <span class="o">=</span> <span class="n">RGB</span>
                <span class="k">if</span> <span class="n">datadtypechar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ImageJ does not support data type </span><span class="si">%s</span><span class="s1"> &#39;</span>
                                     <span class="s1">&#39;for RGB&#39;</span> <span class="o">%</span> <span class="n">datadtypechar</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">photometric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">photometric</span> <span class="o">=</span> <span class="n">MINISBLACK</span>
                <span class="n">planarconfig</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">planarconfig</span> <span class="o">==</span> <span class="n">SEPARATE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ImageJ does not support planar images&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">planarconfig</span> <span class="o">=</span> <span class="n">CONTIG</span> <span class="k">if</span> <span class="n">ijrgb</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># define compress function</span>
        <span class="k">if</span> <span class="n">compress</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">compresslevel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">compressor</span><span class="p">,</span> <span class="n">compresslevel</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">COMPESSORS</span><span class="p">[</span><span class="n">compresstag</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">compressor</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">COMPESSORS</span><span class="p">[</span><span class="n">compresstag</span><span class="p">]</span>
                <span class="n">compresslevel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">compresslevel</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">predictor</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;iu&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;prediction not implemented for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">datadtype</span><span class="p">)</span>

                <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">compresslevel</span><span class="p">):</span>
                    <span class="c1"># horizontal differencing</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">compressor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">compresslevel</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">compressor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="c1"># verify colormap and indices</span>
        <span class="k">if</span> <span class="n">colormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">datadtypechar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;BH&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid data dtype for palette mode&#39;</span><span class="p">)</span>
            <span class="n">colormap</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">colormap</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid color map shape&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_colormap</span> <span class="o">=</span> <span class="n">colormap</span>

        <span class="c1"># verify tile shape</span>
        <span class="k">if</span> <span class="n">tile</span><span class="p">:</span>
            <span class="n">tile</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tile</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">tile</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="mi">16</span> <span class="ow">or</span> <span class="n">tile</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">%</span> <span class="mi">16</span> <span class="ow">or</span>
                    <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tile</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid tile shape&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tile</span> <span class="o">=</span> <span class="p">()</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># normalize data shape to 5D or 6D, depending on volume:</span>
        <span class="c1">#   (pages, planar_samples, [depth,] height, width, contig_samples)</span>
        <span class="n">datashape</span> <span class="o">=</span> <span class="n">reshape_nd</span><span class="p">(</span><span class="n">datashape</span><span class="p">,</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">RGB</span> <span class="k">else</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">datashape</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datashape</span><span class="p">)</span>

        <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">extrasamples</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">volume</span> <span class="ow">and</span> <span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">colormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">photometric</span> <span class="o">=</span> <span class="n">PALETTE</span>
            <span class="n">planarconfig</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">photometric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">photometric</span> <span class="o">=</span> <span class="n">MINISBLACK</span>
            <span class="k">if</span> <span class="n">bilevel</span><span class="p">:</span>
                <span class="n">photometric</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">MINISWHITE</span>
            <span class="k">elif</span> <span class="n">planarconfig</span> <span class="o">==</span> <span class="n">CONTIG</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                    <span class="n">photometric</span> <span class="o">=</span> <span class="n">RGB</span>
            <span class="k">elif</span> <span class="n">planarconfig</span> <span class="o">==</span> <span class="n">SEPARATE</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">volume</span> <span class="ow">and</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                    <span class="n">photometric</span> <span class="o">=</span> <span class="n">RGB</span>
                <span class="k">elif</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                    <span class="n">photometric</span> <span class="o">=</span> <span class="n">RGB</span>
            <span class="k">elif</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="n">photometric</span> <span class="o">=</span> <span class="n">RGB</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">:</span>
                <span class="n">photometric</span> <span class="o">=</span> <span class="n">MINISBLACK</span>
            <span class="k">elif</span> <span class="n">volume</span> <span class="ow">and</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="n">photometric</span> <span class="o">=</span> <span class="n">RGB</span>
            <span class="k">elif</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="n">photometric</span> <span class="o">=</span> <span class="n">RGB</span>
        <span class="k">if</span> <span class="n">planarconfig</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">3</span> <span class="k">if</span> <span class="n">volume</span> <span class="k">else</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">planarconfig</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">photometric</span> <span class="o">=</span> <span class="n">MINISBLACK</span>
        <span class="k">if</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">RGB</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not a RGB(A) image&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">planarconfig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                    <span class="n">planarconfig</span> <span class="o">=</span> <span class="n">CONTIG</span>
                <span class="k">elif</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span> <span class="k">if</span> <span class="n">volume</span> <span class="k">else</span> <span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                    <span class="n">planarconfig</span> <span class="o">=</span> <span class="n">SEPARATE</span>
                <span class="k">elif</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span> <span class="k">if</span> <span class="n">volume</span> <span class="k">else</span> <span class="o">-</span><span class="mi">3</span><span class="p">]:</span>
                    <span class="n">planarconfig</span> <span class="o">=</span> <span class="n">SEPARATE</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">planarconfig</span> <span class="o">=</span> <span class="n">CONTIG</span>
            <span class="k">if</span> <span class="n">planarconfig</span> <span class="o">==</span> <span class="n">CONTIG</span><span class="p">:</span>
                <span class="n">datashape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[(</span><span class="o">-</span><span class="mi">4</span> <span class="k">if</span> <span class="n">volume</span> <span class="k">else</span> <span class="o">-</span><span class="mi">3</span><span class="p">):]</span>
                <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="n">datashape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">datashape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[(</span><span class="o">-</span><span class="mi">4</span> <span class="k">if</span> <span class="n">volume</span> <span class="k">else</span> <span class="o">-</span><span class="mi">3</span><span class="p">):]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
                <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="n">datashape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">samplesperpixel</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">extrasamples</span> <span class="o">=</span> <span class="n">samplesperpixel</span> <span class="o">-</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">CFA</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid CFA image&#39;</span><span class="p">)</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">planarconfig</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">datashape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
            <span class="k">if</span> <span class="mi">50706</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">et</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">et</span> <span class="ow">in</span> <span class="n">extratags</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must specify DNG tags for CFA image&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">planarconfig</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span> <span class="k">if</span> <span class="n">volume</span> <span class="k">else</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">planarconfig</span> <span class="o">==</span> <span class="n">CONTIG</span><span class="p">:</span>
                <span class="n">datashape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[(</span><span class="o">-</span><span class="mi">4</span> <span class="k">if</span> <span class="n">volume</span> <span class="k">else</span> <span class="o">-</span><span class="mi">3</span><span class="p">):]</span>
                <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="n">datashape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">datashape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[(</span><span class="o">-</span><span class="mi">4</span> <span class="k">if</span> <span class="n">volume</span> <span class="k">else</span> <span class="o">-</span><span class="mi">3</span><span class="p">):]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
                <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="n">datashape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">extrasamples</span> <span class="o">=</span> <span class="n">samplesperpixel</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">planarconfig</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># remove trailing 1s</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">datashape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[(</span><span class="o">-</span><span class="mi">3</span> <span class="k">if</span> <span class="n">volume</span> <span class="k">else</span> <span class="o">-</span><span class="mi">2</span><span class="p">):]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>

        <span class="c1"># normalize shape to 6D</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">datashape</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datashape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">datashape</span> <span class="o">=</span> <span class="n">datashape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">datashape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">datashape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">//</span> <span class="n">product</span><span class="p">(</span><span class="n">datashape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">datashape</span> <span class="o">=</span> <span class="p">(</span><span class="n">s0</span><span class="p">,)</span> <span class="o">+</span> <span class="n">datashape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">datashape</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tile</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">volume</span><span class="p">:</span>
            <span class="n">tile</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tile</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">tile</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">PALETTE</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">samplesperpixel</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">extrasamples</span> <span class="ow">or</span>
                    <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid data shape for palette mode&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">RGB</span> <span class="ow">and</span> <span class="n">samplesperpixel</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not a RGB image (samplesperpixel=2)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bilevel</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">compress</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot save compressed bilevel image&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tile</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot save tiled bilevel image&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">photometric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot save bilevel image as </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                 <span class="nb">str</span><span class="p">(</span><span class="n">photometric</span><span class="p">))</span>
            <span class="n">datashape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">datashape</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">datashape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">%</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">datashape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">datashape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">datashape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">datashape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">8</span>
            <span class="n">datashape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">datashape</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">datasize</span> <span class="o">==</span> <span class="n">product</span><span class="p">(</span><span class="n">datashape</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">packbits</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">datashape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">bytestr</span> <span class="o">=</span> <span class="nb">bytes</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span> <span class="k">else</span> <span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;ascii&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of (code, ifdentry, ifdvalue, writeonce)</span>

        <span class="n">strip_or_tile</span> <span class="o">=</span> <span class="s1">&#39;Tile&#39;</span> <span class="k">if</span> <span class="n">tile</span> <span class="k">else</span> <span class="s1">&#39;Strip&#39;</span>
        <span class="n">tagbytecounts</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_NAMES</span><span class="p">[</span><span class="n">strip_or_tile</span> <span class="o">+</span> <span class="s1">&#39;ByteCounts&#39;</span><span class="p">]</span>
        <span class="n">tag_offsets</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_NAMES</span><span class="p">[</span><span class="n">strip_or_tile</span> <span class="o">+</span> <span class="s1">&#39;Offsets&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tagoffsets</span> <span class="o">=</span> <span class="n">tag_offsets</span>

        <span class="k">def</span> <span class="nf">pack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">addtag</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">writeonce</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># Compute ifdentry &amp; ifdvalue bytes from code, dtype, count, value</span>
            <span class="c1"># Append (code, ifdentry, ifdvalue, writeonce) to tags list</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_NAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">code</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tifftype</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DATA_DTYPES</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown dtype </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dtype</span><span class="p">)</span>
            <span class="n">rawcount</span> <span class="o">=</span> <span class="n">count</span>

            <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
                <span class="c1"># strings</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">bytestr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">rawcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">rawcount</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0\0</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rawcount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">rawcount</span> <span class="o">=</span> <span class="n">count</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rawcount</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># length of string without buffer</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="c1"># packed binary data</span>
                <span class="n">dtsize</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">%</span> <span class="n">dtsize</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid packed binary data&#39;</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">//</span> <span class="n">dtsize</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">*=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dtype</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ifdentry</span> <span class="o">=</span> <span class="p">[</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;HH&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">tifftype</span><span class="p">),</span>
                        <span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">rawcount</span><span class="p">)]</span>
            <span class="n">ifdvalue</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="n">offsetsize</span><span class="p">:</span>
                <span class="c1"># value(s) can be written directly</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="n">ifdentry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">valueformat</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ifdentry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">valueformat</span><span class="p">,</span> <span class="n">pack</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">value</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ifdentry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">valueformat</span><span class="p">,</span>
                                         <span class="n">pack</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="n">dtype</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># use offset to value(s)</span>
                <span class="n">ifdentry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="n">ifdvalue</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">count</span>
                    <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="o">==</span> <span class="n">dtype</span>
                    <span class="n">ifdvalue</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">ifdvalue</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="n">dtype</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ifdvalue</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">code</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ifdentry</span><span class="p">),</span> <span class="n">ifdvalue</span><span class="p">,</span> <span class="n">writeonce</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">rational</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">max_denominator</span><span class="o">=</span><span class="mi">1000000</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;&quot;Return nominator and denominator from float or two integers.&quot;&quot;&quot;</span>
            <span class="kn">from</span> <span class="nn">fractions</span> <span class="k">import</span> <span class="n">Fraction</span>  <span class="c1"># delayed import</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">Fraction</span><span class="o">.</span><span class="n">from_float</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">limit_denominator</span><span class="p">(</span><span class="n">max_denominator</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">denominator</span>

        <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
            <span class="c1"># user provided description</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;ImageDescription&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">writeonce</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># write shape and metadata to ImageDescription</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span> <span class="k">else</span> <span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">:</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">imagej_description</span><span class="p">(</span>
                <span class="n">input_shape</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="n">metadata</span> <span class="o">==</span> <span class="p">{}:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truncate</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">truncated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">json_description</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
            <span class="c1"># add 64 bytes buffer</span>
            <span class="c1"># the image description might be updated later with the final shape</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">str2bytes</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">64</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_descriptionlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;ImageDescription&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">writeonce</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">software</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;Software&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">software</span><span class="p">,</span> <span class="n">writeonce</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datetime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">datetime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_now</span><span class="p">()</span>
        <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;DateTime&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y:%m:</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">),</span>
               <span class="n">writeonce</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;Compression&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">compresstag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">predictor</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;Predictor&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;ImageWidth&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;ImageLength&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">tile</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;TileWidth&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tile</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;TileLength&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tile</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;ImageDepth&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
                <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;TileDepth&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;NewSubfileType&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bilevel</span><span class="p">:</span>
            <span class="n">sampleformat</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">}[</span><span class="n">datadtype</span><span class="o">.</span><span class="n">kind</span><span class="p">]</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;SampleFormat&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">samplesperpixel</span><span class="p">,</span>
                   <span class="p">(</span><span class="n">sampleformat</span><span class="p">,)</span> <span class="o">*</span> <span class="n">samplesperpixel</span><span class="p">)</span>
        <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;PhotometricInterpretation&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">photometric</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">colormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;ColorMap&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">colormap</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">colormap</span><span class="p">)</span>
        <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;SamplesPerPixel&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">samplesperpixel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bilevel</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">planarconfig</span> <span class="ow">and</span> <span class="n">samplesperpixel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;PlanarConfiguration&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">planarconfig</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;BitsPerSample&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">samplesperpixel</span><span class="p">,</span>
                   <span class="p">(</span><span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,)</span> <span class="o">*</span> <span class="n">samplesperpixel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;BitsPerSample&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extrasamples</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">RGB</span> <span class="ow">and</span> <span class="n">extrasamples</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;ExtraSamples&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># associated alpha channel</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;ExtraSamples&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">extrasamples</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="n">extrasamples</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;XResolution&#39;</span><span class="p">,</span> <span class="s1">&#39;2I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rational</span><span class="p">(</span><span class="n">resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;YResolution&#39;</span><span class="p">,</span> <span class="s1">&#39;2I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rational</span><span class="p">(</span><span class="n">resolution</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">unit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">enumarg</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">RESUNIT</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;ResolutionUnit&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;XResolution&#39;</span><span class="p">,</span> <span class="s1">&#39;2I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;YResolution&#39;</span><span class="p">,</span> <span class="s1">&#39;2I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;ResolutionUnit&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ijmetadata</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">imagej_metadata_tags</span><span class="p">(</span><span class="n">ijmetadata</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
                <span class="n">addtag</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

        <span class="n">contiguous</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">compress</span>
        <span class="k">if</span> <span class="n">tile</span><span class="p">:</span>
            <span class="c1"># one chunk per tile per plane</span>
            <span class="n">tiles</span> <span class="o">=</span> <span class="p">((</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                     <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                     <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">tile</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">numtiles</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">tiles</span><span class="p">)</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">stripbytecounts</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">product</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">]</span> <span class="o">*</span> <span class="n">numtiles</span>
            <span class="n">addtag</span><span class="p">(</span><span class="n">tagbytecounts</span><span class="p">,</span> <span class="n">offsetformat</span><span class="p">,</span> <span class="n">numtiles</span><span class="p">,</span> <span class="n">stripbytecounts</span><span class="p">)</span>
            <span class="n">addtag</span><span class="p">(</span><span class="n">tag_offsets</span><span class="p">,</span> <span class="n">offsetformat</span><span class="p">,</span> <span class="n">numtiles</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">numtiles</span><span class="p">)</span>
            <span class="n">contiguous</span> <span class="o">=</span> <span class="n">contiguous</span> <span class="ow">and</span> <span class="n">product</span><span class="p">(</span><span class="n">tiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">contiguous</span><span class="p">:</span>
                <span class="c1"># allocate tile buffer</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">tile</span> <span class="o">+</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">datadtype</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">contiguous</span><span class="p">:</span>
            <span class="c1"># one strip per plane</span>
            <span class="k">if</span> <span class="n">bilevel</span><span class="p">:</span>
                <span class="n">stripbytecounts</span> <span class="o">=</span> <span class="p">[</span><span class="n">product</span><span class="p">(</span><span class="n">datashape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])]</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stripbytecounts</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">product</span><span class="p">(</span><span class="n">datashape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="o">*</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">]</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">addtag</span><span class="p">(</span><span class="n">tagbytecounts</span><span class="p">,</span> <span class="n">offsetformat</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stripbytecounts</span><span class="p">)</span>
            <span class="n">addtag</span><span class="p">(</span><span class="n">tag_offsets</span><span class="p">,</span> <span class="n">offsetformat</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;RowsPerStrip&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># compress rowsperstrip or ~64 KB chunks</span>
            <span class="n">rowsize</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span> <span class="o">*</span> <span class="n">datadtype</span><span class="o">.</span><span class="n">itemsize</span>
            <span class="k">if</span> <span class="n">rowsperstrip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rowsperstrip</span> <span class="o">=</span> <span class="mi">65536</span> <span class="o">//</span> <span class="n">rowsize</span>
            <span class="k">if</span> <span class="n">rowsperstrip</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">rowsperstrip</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">rowsperstrip</span> <span class="o">&gt;</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">rowsperstrip</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">addtag</span><span class="p">(</span><span class="s1">&#39;RowsPerStrip&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rowsperstrip</span><span class="p">)</span>

            <span class="n">numstrips</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">rowsperstrip</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">rowsperstrip</span>
            <span class="n">numstrips</span> <span class="o">*=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">stripbytecounts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">numstrips</span>
            <span class="n">addtag</span><span class="p">(</span><span class="n">tagbytecounts</span><span class="p">,</span> <span class="n">offsetformat</span><span class="p">,</span> <span class="n">numstrips</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">numstrips</span><span class="p">)</span>
            <span class="n">addtag</span><span class="p">(</span><span class="n">tag_offsets</span><span class="p">,</span> <span class="n">offsetformat</span><span class="p">,</span> <span class="n">numstrips</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">numstrips</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">contiguous</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot write non-contiguous empty file&#39;</span><span class="p">)</span>

        <span class="c1"># add extra tags from user</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">extratags</span><span class="p">:</span>
            <span class="n">addtag</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

        <span class="c1"># TODO: check TIFFReadDirectoryCheckOrder warning in files containing</span>
        <span class="c1">#   multiple tags of same code</span>
        <span class="c1"># the entries in an IFD must be sorted in ascending order by tag code</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bigtiff</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">+</span> <span class="n">datasize</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data too large for standard TIFF file&#39;</span><span class="p">)</span>

        <span class="c1"># if not compressed or multi-tiled, write the first IFD and then</span>
        <span class="c1"># all data contiguously; else, write all IFDs and data interleaved</span>
        <span class="k">for</span> <span class="n">pageindex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">contiguous</span> <span class="k">else</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="c1"># update pointer at ifd_offset</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># location of IFD must begin on a word boundary</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ifdoffset</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">pos</span><span class="p">))</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

            <span class="c1"># write ifdentries</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">tagnoformat</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)))</span>
            <span class="n">tag_offset</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ifdoffset</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>  <span class="c1"># offset to next IFD</span>

            <span class="c1"># write tag values and patch offsets in ifdentries, if necessary</span>
            <span class="k">for</span> <span class="n">tagindex</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">pos</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="c1"># tag value is expected to begin on word boundary</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">tag_offset</span> <span class="o">+</span> <span class="n">tagindex</span><span class="o">*</span><span class="n">tagsize</span> <span class="o">+</span> <span class="n">offsetsize</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">pos</span><span class="p">))</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tag_offsets</span><span class="p">:</span>
                        <span class="n">stripoffsetsoffset</span> <span class="o">=</span> <span class="n">pos</span>
                    <span class="k">elif</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tagbytecounts</span><span class="p">:</span>
                        <span class="n">strip_bytecounts_offset</span> <span class="o">=</span> <span class="n">pos</span>
                    <span class="k">elif</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">270</span> <span class="ow">and</span> <span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0\0\0\0</span><span class="s1">&#39;</span><span class="p">):</span>
                        <span class="c1"># image description buffer</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptionoffset</span> <span class="o">=</span> <span class="n">pos</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptionlenoffset</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">tag_offset</span> <span class="o">+</span> <span class="n">tagindex</span> <span class="o">*</span> <span class="n">tagsize</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

            <span class="c1"># write image data</span>
            <span class="n">data_offset</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="n">align</span> <span class="o">-</span> <span class="n">data_offset</span> <span class="o">%</span> <span class="n">align</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">skip</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">data_offset</span> <span class="o">+=</span> <span class="n">skip</span>
            <span class="k">if</span> <span class="n">contiguous</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write_empty</span><span class="p">(</span><span class="n">datasize</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tile</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write_empty</span><span class="p">(</span><span class="n">numtiles</span> <span class="o">*</span> <span class="n">stripbytecounts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stripindex</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">pageindex</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">tz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="k">for</span> <span class="n">ty</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tiles</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                                <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tiles</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                                    <span class="n">c0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">tz</span><span class="o">*</span><span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="n">c1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">ty</span><span class="o">*</span><span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                    <span class="n">c2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="n">tx</span><span class="o">*</span><span class="n">tile</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                    <span class="n">chunk</span><span class="p">[</span><span class="n">c0</span><span class="p">:,</span> <span class="n">c1</span><span class="p">:,</span> <span class="n">c2</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="n">chunk</span><span class="p">[:</span><span class="n">c0</span><span class="p">,</span> <span class="p">:</span><span class="n">c1</span><span class="p">,</span> <span class="p">:</span><span class="n">c2</span><span class="p">]</span> <span class="o">=</span> <span class="n">plane</span><span class="p">[</span>
                                        <span class="n">tz</span><span class="o">*</span><span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">tz</span><span class="o">*</span><span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">c0</span><span class="p">,</span>
                                        <span class="n">ty</span><span class="o">*</span><span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">ty</span><span class="o">*</span><span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">c1</span><span class="p">,</span>
                                        <span class="n">tx</span><span class="o">*</span><span class="n">tile</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">tx</span><span class="o">*</span><span class="n">tile</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">c2</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="n">compress</span><span class="p">:</span>
                                        <span class="n">t</span> <span class="o">=</span> <span class="n">compress</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                                        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                                        <span class="n">stripbytecounts</span><span class="p">[</span><span class="n">stripindex</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                                        <span class="n">stripindex</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">fh</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                                        <span class="n">fh</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">compress</span><span class="p">:</span>
                <span class="c1"># write one strip per rowsperstrip</span>
                <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># not handling depth</span>
                <span class="n">numstrips</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">rowsperstrip</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">rowsperstrip</span>
                <span class="n">stripindex</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">pageindex</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numstrips</span><span class="p">):</span>
                        <span class="n">strip</span> <span class="o">=</span> <span class="n">plane</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="n">rowsperstrip</span><span class="p">:</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rowsperstrip</span><span class="p">]</span>
                        <span class="n">strip</span> <span class="o">=</span> <span class="n">compress</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span>
                        <span class="n">stripbytecounts</span><span class="p">[</span><span class="n">stripindex</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span>
                        <span class="n">stripindex</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># update strip/tile offsets and bytecounts if necessary</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">tagindex</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tag_offsets</span><span class="p">:</span>  <span class="c1"># strip/tile offsets</span>
                    <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">stripoffsetsoffset</span><span class="p">)</span>
                        <span class="n">strip_offset</span> <span class="o">=</span> <span class="n">data_offset</span>
                        <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">stripbytecounts</span><span class="p">:</span>
                            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">strip_offset</span><span class="p">))</span>
                            <span class="n">strip_offset</span> <span class="o">+=</span> <span class="n">size</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">tag_offset</span> <span class="o">+</span> <span class="n">tagindex</span><span class="o">*</span><span class="n">tagsize</span> <span class="o">+</span> <span class="n">offsetsize</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
                        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">data_offset</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tagbytecounts</span><span class="p">:</span>  <span class="c1"># strip/tile bytecounts</span>
                    <span class="k">if</span> <span class="n">compress</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">strip_bytecounts_offset</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">stripbytecounts</span><span class="p">:</span>
                                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">tag_offset</span> <span class="o">+</span> <span class="n">tagindex</span><span class="o">*</span><span class="n">tagsize</span> <span class="o">+</span>
                                    <span class="n">offsetsize</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
                            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">stripbytecounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="k">break</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="c1"># remove tags that should be written only once</span>
            <span class="k">if</span> <span class="n">pageindex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">input_shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datadtype</span> <span class="o">=</span> <span class="n">datadtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataoffset</span> <span class="o">=</span> <span class="n">data_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_databytecounts</span> <span class="o">=</span> <span class="n">stripbytecounts</span>

        <span class="k">if</span> <span class="n">contiguous</span><span class="p">:</span>
            <span class="c1"># write remaining IFDs/tags later</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="n">tags</span>
            <span class="c1"># return offset and size of image data</span>
            <span class="k">if</span> <span class="n">returnoffset</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data_offset</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">stripbytecounts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_remaining_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write outstanding IFDs and tags to file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truncate</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span>
        <span class="n">fhpos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fhpos</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fhpos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">byteorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byteorder</span>
        <span class="n">offsetformat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offsetformat</span>
        <span class="n">offsetsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offsetsize</span>
        <span class="n">tagnoformat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tagnoformat</span>
        <span class="n">tagsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tagsize</span>
        <span class="n">dataoffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataoffset</span>
        <span class="n">pagedatasize</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_databytecounts</span><span class="p">)</span>
        <span class="n">pageno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">def</span> <span class="nf">pack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>

        <span class="c1"># construct template IFD in memory</span>
        <span class="c1"># need to patch offsets to next IFD and data before writing to disk</span>
        <span class="n">ifd</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">tagnoformat</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">)))</span>
        <span class="n">tagoffset</span> <span class="o">=</span> <span class="n">ifd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">))</span>
        <span class="n">ifdoffset</span> <span class="o">=</span> <span class="n">ifd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>  <span class="c1"># offset to next IFD</span>
        <span class="c1"># tag values</span>
        <span class="k">for</span> <span class="n">tagindex</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">):</span>
            <span class="n">offset2value</span> <span class="o">=</span> <span class="n">tagoffset</span> <span class="o">+</span> <span class="n">tagindex</span><span class="o">*</span><span class="n">tagsize</span> <span class="o">+</span> <span class="n">offsetsize</span> <span class="o">+</span> <span class="mi">4</span>
            <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">ifd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># tag value is expected to begin on word boundary</span>
                    <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset2value</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">fhpos</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># struct.error</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;truncating ImageJ file&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_truncate</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">return</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data too large for non-BigTIFF file&#39;</span><span class="p">)</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tagoffsets</span><span class="p">:</span>
                    <span class="c1"># save strip/tile offsets for later updates</span>
                    <span class="n">stripoffset2offset</span> <span class="o">=</span> <span class="n">offset2value</span>
                    <span class="n">stripoffset2value</span> <span class="o">=</span> <span class="n">pos</span>
            <span class="k">elif</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tagoffsets</span><span class="p">:</span>
                <span class="c1"># save strip/tile offsets for later updates</span>
                <span class="n">stripoffset2offset</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">stripoffset2value</span> <span class="o">=</span> <span class="n">offset2value</span>
        <span class="c1"># size to word boundary</span>
        <span class="k">if</span> <span class="n">ifd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># check if all IFDs fit in file</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bigtiff</span> <span class="ow">and</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">ifd</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">*</span> <span class="n">pageno</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span> <span class="o">-</span> <span class="mi">256</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;truncating ImageJ file&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_truncate</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data too large for non-BigTIFF file&#39;</span><span class="p">)</span>

        <span class="c1"># TODO: assemble IFD chain in memory</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pageno</span><span class="p">):</span>
            <span class="c1"># update pointer at IFD offset</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ifdoffset</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">pos</span><span class="p">))</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ifdoffset</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">ifdoffset</span>
            <span class="c1"># update strip/tile offsets in IFD</span>
            <span class="n">dataoffset</span> <span class="o">+=</span> <span class="n">pagedatasize</span>  <span class="c1"># offset to image data</span>
            <span class="k">if</span> <span class="n">stripoffset2offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">stripoffset2value</span><span class="p">)</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">dataoffset</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">stripoffset2offset</span><span class="p">)</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">stripoffset2value</span><span class="p">))</span>
                <span class="n">ifd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">stripoffset2value</span><span class="p">)</span>
                <span class="n">stripoffset</span> <span class="o">=</span> <span class="n">dataoffset</span>
                <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_databytecounts</span><span class="p">:</span>
                    <span class="n">ifd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">stripoffset</span><span class="p">))</span>
                    <span class="n">stripoffset</span> <span class="o">+=</span> <span class="n">size</span>
            <span class="c1"># write IFD entry</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ifd</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datadtype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataoffset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_databytecounts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># do not reset _shape or _data_shape</span>

    <span class="k">def</span> <span class="nf">_write_image_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write meta data to ImageDescription tag.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_descriptionoffset</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">colormapped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colormap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagej</span><span class="p">:</span>
            <span class="n">isrgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">imagej_description</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span><span class="p">,</span> <span class="n">isrgb</span><span class="p">,</span> <span class="n">colormapped</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">json_description</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datashape</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">)</span>

        <span class="c1"># rewrite description and its length to file</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">_descriptionlen</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_descriptionoffset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_descriptionlenoffset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_byteorder</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_offsetformat</span><span class="p">,</span>
                                   <span class="nb">len</span><span class="p">(</span><span class="n">description</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptionoffset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptionlenoffset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_descriptionlen</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_now</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return current date and time.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write remaining pages and close file handle.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truncate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_remaining_pages</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_image_description</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">TiffFile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read image and metadata from TIFF file.</span>

<span class="sd">    TiffFile instances must be closed using the &#39;close&#39; method, which is</span>
<span class="sd">    automatically called when using the &#39;with&#39; context manager.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    pages : TiffPages</span>
<span class="sd">        Sequence of TIFF pages in file.</span>
<span class="sd">    series : list of TiffPageSeries</span>
<span class="sd">        Sequences of closely related TIFF pages. These are computed</span>
<span class="sd">        from OME, LSM, ImageJ, etc. metadata or based on similarity</span>
<span class="sd">        of page properties such as shape, dtype, and compression.</span>
<span class="sd">    byteorder : &#39;&gt;&#39;, &#39;&lt;&#39;</span>
<span class="sd">        The endianness of data in the file.</span>
<span class="sd">        &#39;&gt;&#39;: big-endian (Motorola).</span>
<span class="sd">        &#39;&gt;&#39;: little-endian (Intel).</span>
<span class="sd">    is_flag : bool</span>
<span class="sd">        If True, file is of a certain format.</span>
<span class="sd">        Flags are: bigtiff, movie, shaped, ome, imagej, stk, lsm, fluoview,</span>
<span class="sd">        nih, vista, &#39;micromanager, metaseries, mdgel, mediacy, tvips, fei,</span>
<span class="sd">        sem, scn, svs, scanimage, andor, epics, pilatus, qptiff.</span>

<span class="sd">    All attributes are read-only.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; # read image array from TIFF file</span>
<span class="sd">    &gt;&gt;&gt; imsave(&#39;temp.tif&#39;, numpy.random.rand(5, 301, 219))</span>
<span class="sd">    &gt;&gt;&gt; with TiffFile(&#39;temp.tif&#39;) as tif:</span>
<span class="sd">    ...     data = tif.asarray()</span>
<span class="sd">    &gt;&gt;&gt; data.shape</span>
<span class="sd">    (5, 301, 219)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">multifile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">movie</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize instance from file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arg : str or open file</span>
<span class="sd">            Name of file or open file object.</span>
<span class="sd">            The file objects are closed in TiffFile.close().</span>
<span class="sd">        name : str</span>
<span class="sd">            Optional name of file in case &#39;arg&#39; is a file handle.</span>
<span class="sd">        offset : int</span>
<span class="sd">            Optional start position of embedded file. By default, this is</span>
<span class="sd">            the current file position.</span>
<span class="sd">        size : int</span>
<span class="sd">            Optional size of embedded file. By default, this is the number</span>
<span class="sd">            of bytes from the &#39;offset&#39; to the end of the file.</span>
<span class="sd">        multifile : bool</span>
<span class="sd">            If True (default), series may include pages from multiple files.</span>
<span class="sd">            Currently applies to OME-TIFF only.</span>
<span class="sd">        movie : bool</span>
<span class="sd">            If True, assume that later pages differ from first page only by</span>
<span class="sd">            data offsets and byte counts. Significantly increases speed and</span>
<span class="sd">            reduces memory usage when reading movies with thousands of pages.</span>
<span class="sd">            Enabling this for non-movie files will result in data corruption</span>
<span class="sd">            or crashes. Python 3 only.</span>
<span class="sd">        kwargs : bool</span>
<span class="sd">            &#39;is_ome&#39;: If False, disable processing of OME-XML metadata.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;fastij&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fastij&#39;</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">DeprecationWarning</span><span class="p">(</span><span class="s1">&#39;the fastij option will be removed&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;is_&#39;</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">FILE_FLAGS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;unexpected keyword argument: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

        <span class="n">fh</span> <span class="o">=</span> <span class="n">FileHandle</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="n">fh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_multifile</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">multifile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">fh</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="p">}</span>  <span class="c1"># cache of TiffFiles</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">byteorder</span> <span class="o">=</span> <span class="p">{</span><span class="sa">b</span><span class="s1">&#39;II&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;MM&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">}[</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not a TIFF file&#39;</span><span class="p">)</span>
            <span class="n">sys_byteorder</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;big&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">}[</span><span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isnative</span> <span class="o">=</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="n">sys_byteorder</span>

            <span class="n">version</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">43</span><span class="p">:</span>
                <span class="c1"># BigTiff</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_bigtiff</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">offsetsize</span><span class="p">,</span> <span class="n">zero</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;HH&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">zero</span> <span class="ow">or</span> <span class="n">offsetsize</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid BigTIFF file&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">=</span> <span class="n">byteorder</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offsetsize</span> <span class="o">=</span> <span class="mi">8</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offsetformat</span> <span class="o">=</span> <span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;Q&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tagnosize</span> <span class="o">=</span> <span class="mi">8</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tagnoformat</span> <span class="o">=</span> <span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;Q&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tagsize</span> <span class="o">=</span> <span class="mi">20</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tagformat1</span> <span class="o">=</span> <span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;HH&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tagformat2</span> <span class="o">=</span> <span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;Q8s&#39;</span>
            <span class="k">elif</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">42</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_bigtiff</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">=</span> <span class="n">byteorder</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offsetsize</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offsetformat</span> <span class="o">=</span> <span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;I&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tagnosize</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tagnoformat</span> <span class="o">=</span> <span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;H&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tagsize</span> <span class="o">=</span> <span class="mi">12</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tagformat1</span> <span class="o">=</span> <span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;HH&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tagformat2</span> <span class="o">=</span> <span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;I4s&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid TIFF file&#39;</span><span class="p">)</span>

            <span class="c1"># file handle is at offset to offset to first page</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pages</span> <span class="o">=</span> <span class="n">TiffPages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_lsm</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span> <span class="ow">or</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">compression</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">compression</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_lsm_load_pages</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_lsm_fix_strip_offsets</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_lsm_fix_strip_bytecounts</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">movie</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filehandle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return file handle.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return name of file handle.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">fstat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return status of file handle as stat_result object.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># io.UnsupportedOperation</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close open file handle(s).&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">tif</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">maxworkers</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image data from multiple TIFF pages as numpy array.</span>

<span class="sd">        By default, the data from the first series is returned.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : int, slice, or sequence of page indices</span>
<span class="sd">            Defines which pages to return as array.</span>
<span class="sd">        series : int or TiffPageSeries</span>
<span class="sd">            Defines which series of pages to return as array.</span>
<span class="sd">        out : numpy.ndarray, str, or file-like object; optional</span>
<span class="sd">            Buffer where image data will be saved.</span>
<span class="sd">            If None (default), a new array will be created.</span>
<span class="sd">            If numpy.ndarray, a writable array of compatible dtype and shape.</span>
<span class="sd">            If &#39;memmap&#39;, directly memory-map the image data in the TIFF file</span>
<span class="sd">            if possible; else create a memory-mapped array in a temporary file.</span>
<span class="sd">            If str or open file, the file name or file object used to</span>
<span class="sd">            create a memory-map to an array stored in a binary file on disk.</span>
<span class="sd">        validate : bool</span>
<span class="sd">            If True (default), validate various tags.</span>
<span class="sd">            Passed to TiffPage.asarray().</span>
<span class="sd">        maxworkers : int</span>
<span class="sd">            Maximum number of threads to concurrently get data from pages.</span>
<span class="sd">            Default is 1. If None, up to half the CPU cores are used.</span>
<span class="sd">            Reading data from file is limited to a single thread.</span>
<span class="sd">            Using multiple threads can significantly speed up this function</span>
<span class="sd">            if the bottleneck is decoding compressed data, e.g. in case of</span>
<span class="sd">            large LZW compressed LSM files.</span>
<span class="sd">            If the bottleneck is I/O or pure Python code, using multiple</span>
<span class="sd">            threads might be detrimental.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">series</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">series</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="n">series</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">_pages</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">inttypes</span><span class="p">):</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="p">[</span><span class="n">pages</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="p">[</span><span class="n">pages</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;key must be an int, slice, or sequence&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pages</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no pages selected&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_nih</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">stack_pages</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">maxworkers</span><span class="o">=</span><span class="n">maxworkers</span><span class="p">,</span>
                                 <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">series</span> <span class="ow">and</span> <span class="n">series</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span>
            <span class="n">typecode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">+</span> <span class="n">series</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span>
            <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;memmap&#39;</span> <span class="ow">and</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_memmappable</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">memmap_array</span><span class="p">(</span>
                    <span class="n">typecode</span><span class="p">,</span> <span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">series</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">create_output</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">series</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span>
                    <span class="n">typecode</span><span class="p">,</span> <span class="n">product</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">native</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">stack_pages</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">maxworkers</span><span class="o">=</span><span class="n">maxworkers</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;failed to reshape </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                    <span class="c1"># try series of expected shapes</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">series</span><span class="o">.</span><span class="n">shape</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># revert to generic shape</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return related pages as TiffPageSeries.</span>

<span class="sd">        Side effect: after calling this function, TiffFile.pages might contain</span>
<span class="sd">        TiffPage and TiffFrame instances.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">useframes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span>
        <span class="n">keyframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span>
        <span class="n">series</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="s1">&#39;ome imagej lsm fluoview nih mdgel shaped&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;is_&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">series</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">_series&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)()</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="n">useframes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="n">keyframe</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">series</span><span class="p">:</span>
            <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generic_series</span><span class="p">()</span>

        <span class="c1"># remove empty series, e.g. in MD Gel files</span>
        <span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">series</span> <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">series</span>

    <span class="k">def</span> <span class="nf">_generic_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span><span class="p">:</span>
            <span class="c1"># movie mode</span>
            <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">),)</span> <span class="o">+</span> <span class="n">shape</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span> <span class="o">+</span> <span class="n">axes</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">TiffPageSeries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[:],</span> <span class="n">shape</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span>
                                   <span class="n">stype</span><span class="o">=</span><span class="s1">&#39;movie&#39;</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">series</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">compressions</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DECOMPESSORS</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">compression</span> <span class="ow">in</span> <span class="n">compressions</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">series</span><span class="p">:</span>
                <span class="n">series</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">series</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">page</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">),)</span> <span class="o">+</span> <span class="n">shape</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span> <span class="o">+</span> <span class="n">axes</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TiffPageSeries</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span>
                                         <span class="n">stype</span><span class="o">=</span><span class="s1">&#39;Generic&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_shaped_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in &quot;shaped&quot; file.&quot;&quot;&quot;</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">lenpages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">append_series</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">reshape</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                          <span class="n">truncated</span><span class="p">):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">axes</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">),)</span> <span class="o">+</span> <span class="n">shape</span>
                    <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;Q&#39;</span> <span class="o">+</span> <span class="n">axes</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">resize</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">reshape</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span> <span class="ow">and</span> <span class="n">resize</span> <span class="o">&gt;</span> <span class="n">size</span> <span class="ow">and</span> <span class="n">resize</span> <span class="o">%</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">truncated</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">truncated</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;Q&#39;</span> <span class="o">+</span> <span class="n">axes</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">resize</span> <span class="o">//</span> <span class="n">size</span><span class="p">,)</span> <span class="o">+</span> <span class="n">shape</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">reshape_axes</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">reshape</span><span class="p">)</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">reshape</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">TiffPageSeries</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                               <span class="n">stype</span><span class="o">=</span><span class="s1">&#39;Shaped&#39;</span><span class="p">,</span> <span class="n">truncated</span><span class="o">=</span><span class="n">truncated</span><span class="p">))</span>

        <span class="n">keyframe</span> <span class="o">=</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">reshape</span> <span class="o">=</span> <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">series</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">lenpages</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="c1"># new keyframe; start of new series</span>
            <span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="n">index</span>
            <span class="n">keyframe</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">is_shaped</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;invalid shape metadata or corrupted file&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1"># read metadata</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">json_description_metadata</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">is_shaped</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">reshape</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
            <span class="n">truncated</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;truncated&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;axes&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;axes&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">reshape</span><span class="p">):</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="n">reshape</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;axes do not match shape&#39;</span><span class="p">)</span>
            <span class="c1"># skip pages if possible</span>
            <span class="n">spages</span> <span class="o">=</span> <span class="p">[</span><span class="n">keyframe</span><span class="p">]</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">reshape</span><span class="p">)</span>
            <span class="n">npages</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">product</span><span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">mod</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;series shape does not match page shape&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">npages</span> <span class="o">&lt;=</span> <span class="n">lenpages</span> <span class="o">-</span> <span class="n">index</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">*=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">_dtype</span><span class="o">.</span><span class="n">itemsize</span>
                <span class="k">if</span> <span class="n">truncated</span><span class="p">:</span>
                    <span class="n">npages</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">keyframe</span><span class="o">.</span><span class="n">is_final</span> <span class="ow">and</span>
                      <span class="n">keyframe</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span><span class="p">):</span>
                    <span class="n">truncated</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># need to read all pages for series</span>
                    <span class="n">truncated</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">+</span><span class="n">npages</span><span class="p">):</span>
                        <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">page</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="n">keyframe</span>
                        <span class="n">spages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
            <span class="n">append_series</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">spages</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">reshape</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                          <span class="n">truncated</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="n">npages</span>

        <span class="k">return</span> <span class="n">series</span>

    <span class="k">def</span> <span class="nf">_imagej_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in ImageJ file.&quot;&quot;&quot;</span>
        <span class="c1"># ImageJ&#39;s dimension order is always TZCYXS</span>
        <span class="c1"># TODO: fix loading of color, composite, or palette images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">ij</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagej_metadata</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">is_hyperstack</span><span class="p">():</span>
            <span class="c1"># ImageJ hyperstack store all image metadata in the first page and</span>
            <span class="c1"># image data are stored contiguously before the second page, if any</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">page</span><span class="o">.</span><span class="n">is_final</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">ij</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">images</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">offset</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">product</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">page</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">//</span> <span class="mi">8</span>
                    <span class="ow">or</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">count</span><span class="o">*</span><span class="n">images</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
            <span class="c1"># check that next page is stored after data</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">count</span><span class="o">*</span><span class="n">images</span> <span class="o">&gt;</span> <span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">hyperstack</span> <span class="o">=</span> <span class="n">is_hyperstack</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;invalid ImageJ metadata or corrupted file&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">hyperstack</span><span class="p">:</span>
            <span class="c1"># no need to read other pages</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="p">[</span><span class="n">page</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;frames&#39;</span> <span class="ow">in</span> <span class="n">ij</span><span class="p">:</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ij</span><span class="p">[</span><span class="s1">&#39;frames&#39;</span><span class="p">])</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;slices&#39;</span> <span class="ow">in</span> <span class="n">ij</span><span class="p">:</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ij</span><span class="p">[</span><span class="s1">&#39;slices&#39;</span><span class="p">])</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;channels&#39;</span> <span class="ow">in</span> <span class="n">ij</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">photometric</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span>
                                     <span class="n">ij</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hyperstack&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ij</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">])</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="n">remain</span> <span class="o">=</span> <span class="n">ij</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">))</span><span class="o">//</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="k">if</span> <span class="n">shape</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remain</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">remain</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
            <span class="c1"># contiguous multiple images</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">elif</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SI&#39;</span><span class="p">:</span>
            <span class="c1"># color-mapped contiguous multiple images</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">axes</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>

        <span class="n">truncated</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">hyperstack</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span>
            <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">page</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">//</span> <span class="mi">8</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">TiffPageSeries</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">stype</span><span class="o">=</span><span class="s1">&#39;ImageJ&#39;</span><span class="p">,</span>
                               <span class="n">truncated</span><span class="o">=</span><span class="n">truncated</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_fluoview_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in FluoView file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluoview_metadata</span>
        <span class="n">mmhd</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">mm</span><span class="p">[</span><span class="s1">&#39;Dimensions&#39;</span><span class="p">]))</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">MM_DIMENSIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s1">&#39;Q&#39;</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mmhd</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mmhd</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">TiffPageSeries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span>
                               <span class="n">name</span><span class="o">=</span><span class="n">mm</span><span class="p">[</span><span class="s1">&#39;ImageName&#39;</span><span class="p">],</span> <span class="n">stype</span><span class="o">=</span><span class="s1">&#39;FluoView&#39;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_mdgel_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in MD Gel file.&quot;&quot;&quot;</span>
        <span class="c1"># only a single page, scaled according to metadata in second page</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">md</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdgel_metadata</span>
        <span class="k">if</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;FileTag&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">128</span><span class="p">):</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;ScalePixel&#39;</span><span class="p">]</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># rational</span>
            <span class="k">if</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;FileTag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># squary root data format</span>
                <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">scale</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">TiffPageSeries</span><span class="p">([</span><span class="n">page</span><span class="p">],</span> <span class="n">page</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
                               <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">stype</span><span class="o">=</span><span class="s1">&#39;MDGel&#39;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_nih_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in NIH file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">page0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">page0</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">page0</span><span class="o">.</span><span class="n">axes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">),)</span> <span class="o">+</span> <span class="n">page0</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span> <span class="o">+</span> <span class="n">page0</span><span class="o">.</span><span class="n">axes</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">TiffPageSeries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">page0</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">stype</span><span class="o">=</span><span class="s1">&#39;NIH&#39;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_ome_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image series in OME-TIFF file(s).&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">xml.etree</span> <span class="k">import</span> <span class="n">cElementTree</span> <span class="k">as</span> <span class="n">etree</span>  <span class="c1"># delayed import</span>
        <span class="n">omexml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">description</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">omexml</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">etree</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># TODO: test badly encoded OME-XML</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;ome-xml: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># might work on Python 2</span>
                <span class="n">omexml</span> <span class="o">=</span> <span class="n">omexml</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">omexml</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="n">uuid</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;UUID&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">uuid</span><span class="p">:</span> <span class="bp">self</span><span class="p">}</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">dirname</span>
        <span class="n">modulo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">series</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;BinaryOnly&#39;</span><span class="p">):</span>
                <span class="c1"># TODO: load OME-XML from master or companion file</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;ome-xml: not an ome-tiff master file&#39;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;StructuredAnnotations&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">annot</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">annot</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Namespace&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;modulo&#39;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">annot</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">modul</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">along</span> <span class="ow">in</span> <span class="n">modul</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">along</span><span class="o">.</span><span class="n">tag</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Along&#39;</span><span class="p">):</span>
                                    <span class="k">continue</span>
                                <span class="n">axis</span> <span class="o">=</span> <span class="n">along</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">newaxis</span> <span class="o">=</span> <span class="n">along</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Type&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">)</span>
                                <span class="n">newaxis</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">AXES_LABELS</span><span class="p">[</span><span class="n">newaxis</span><span class="p">]</span>
                                <span class="k">if</span> <span class="s1">&#39;Start&#39;</span> <span class="ow">in</span> <span class="n">along</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                                    <span class="n">step</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">along</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Step&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                                    <span class="n">start</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">along</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Start&#39;</span><span class="p">])</span>
                                    <span class="n">stop</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">along</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;End&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">step</span>
                                    <span class="n">labels</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">along</span>
                                              <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Label&#39;</span><span class="p">)]</span>
                                <span class="n">modulo</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Image&#39;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">attr</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">pixels</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pixels</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">pixels</span><span class="o">.</span><span class="n">attrib</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PixelType&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;DimensionOrder&#39;</span><span class="p">]))</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;Size&#39;</span><span class="o">+</span><span class="n">ax</span><span class="p">])</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">ifds</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">spp</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># samples per pixel</span>
                <span class="c1"># FIXME: this implementation assumes the last two</span>
                <span class="c1"># dimensions are stored in tiff pages (shape[:-2]).</span>
                <span class="c1"># Apparently that is not always the case.</span>
                <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Channel&#39;</span><span class="p">):</span>
                        <span class="n">attr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">attrib</span>
                        <span class="k">if</span> <span class="n">ifds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">spp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SamplesPerPixel&#39;</span><span class="p">,</span> <span class="n">spp</span><span class="p">))</span>
                            <span class="n">ifds</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">//</span> <span class="n">spp</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SamplesPerPixel&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="n">spp</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;cannot handle differing SamplesPerPixel&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">ifds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ifds</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">//</span> <span class="n">spp</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;TiffData&#39;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">attrib</span>
                    <span class="n">ifd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;IFD&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NumPlanes&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="k">if</span> <span class="s1">&#39;IFD&#39;</span> <span class="ow">in</span> <span class="n">attr</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PlaneCount&#39;</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;First&#39;</span><span class="o">+</span><span class="n">ax</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c1"># ImageJ produces invalid ome-xml when cropping</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;ome-xml: invalid TiffData index&#39;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">uuid</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;UUID&#39;</span><span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">uuid</span><span class="o">.</span><span class="n">text</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multifile</span><span class="p">:</span>
                                <span class="c1"># abort reading multifile OME series</span>
                                <span class="c1"># and fall back to generic series</span>
                                <span class="k">return</span> <span class="p">[]</span>
                            <span class="n">fname</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;FileName&#39;</span><span class="p">]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">tif</span> <span class="o">=</span> <span class="n">TiffFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
                                <span class="n">tif</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">tif</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">tif</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
                            <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                                    <span class="s2">&quot;ome-xml: failed to read &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
                                <span class="k">break</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">text</span><span class="p">]</span> <span class="o">=</span> <span class="n">tif</span>
                            <span class="n">tif</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">text</span><span class="p">]</span><span class="o">.</span><span class="n">pages</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span> <span class="k">if</span> <span class="n">num</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)):</span>
                                <span class="n">ifds</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">ifd</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;ome-xml: index out of range&#39;</span><span class="p">)</span>
                        <span class="c1"># only process first UUID</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span> <span class="k">if</span> <span class="n">num</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)):</span>
                                <span class="n">ifds</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">ifd</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;ome-xml: index out of range&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ifds</span><span class="p">):</span>
                    <span class="c1"># skip images without data</span>
                    <span class="k">continue</span>

                <span class="c1"># set a keyframe on all IFDs</span>
                <span class="n">keyframe</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ifds</span><span class="p">:</span>
                    <span class="c1"># try find a TiffPage</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="n">i</span><span class="o">.</span><span class="n">keyframe</span><span class="p">:</span>
                        <span class="n">keyframe</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">keyframe</span><span class="p">:</span>
                    <span class="c1"># reload a TiffPage from file</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">keyframe</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ifds</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">keyframe</span><span class="p">:</span>
                            <span class="n">keyframe</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">index</span>
                            <span class="n">keyframe</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">keyframe</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
                            <span class="n">ifds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyframe</span>
                            <span class="k">break</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ifds</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">i</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="n">keyframe</span>

                <span class="n">dtype</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">dtype</span>
                <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">TiffPageSeries</span><span class="p">(</span><span class="n">ifds</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                   <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">stype</span><span class="o">=</span><span class="s1">&#39;OME&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">serie</span> <span class="ow">in</span> <span class="n">series</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">serie</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="p">(</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="ow">in</span> <span class="n">modulo</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">serie</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">size</span><span class="p">:</span>
                    <span class="n">serie</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">serie</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">newaxis</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//=</span> <span class="n">size</span>
                    <span class="n">shape</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                    <span class="n">serie</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">serie</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">axis</span><span class="o">+</span><span class="n">newaxis</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">serie</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="c1"># squeeze dimensions</span>
        <span class="k">for</span> <span class="n">serie</span> <span class="ow">in</span> <span class="n">series</span><span class="p">:</span>
            <span class="n">serie</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">serie</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">squeeze_axes</span><span class="p">(</span><span class="n">serie</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">serie</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">series</span>

    <span class="k">def</span> <span class="nf">_lsm_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return main image series in LSM file. Skip thumbnails.&quot;&quot;&quot;</span>
        <span class="n">lsmi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsm_metadata</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO_SCANTYPE</span><span class="p">[</span><span class="n">lsmi</span><span class="p">[</span><span class="s1">&#39;ScanType&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">photometric</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># RGB; more than one channel</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;XY&#39;</span><span class="p">,</span> <span class="s1">&#39;XYC&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lsmi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DimensionP&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">+=</span> <span class="s1">&#39;P&#39;</span>
        <span class="k">if</span> <span class="n">lsmi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DimensionM&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">+=</span> <span class="s1">&#39;M&#39;</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">lsmi</span><span class="p">[</span><span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO_DIMENSIONS</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">lsmi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
        <span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="n">TiffPageSeries</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                 <span class="n">stype</span><span class="o">=</span><span class="s1">&#39;LSM&#39;</span><span class="p">)]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_reduced</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
            <span class="n">cp</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">cp</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">cp</span> <span class="o">*=</span> <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;CYX&#39;</span>
            <span class="n">series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TiffPageSeries</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                         <span class="n">stype</span><span class="o">=</span><span class="s1">&#39;LSMreduced&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">series</span>

    <span class="k">def</span> <span class="nf">_lsm_load_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load all pages from LSM file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># second series: thumbnails</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">keyframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">page</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="n">keyframe</span>
        <span class="c1"># first series: data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">keyframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[::</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">page</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="n">keyframe</span>

    <span class="k">def</span> <span class="nf">_lsm_fix_strip_offsets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unwrap strip offsets for LSM files greater than 4 GB.</span>

<span class="sd">        Each series and position require separate unwrapping (undocumented).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="n">npages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span>
        <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">axes</span>

        <span class="c1"># find positions</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">series</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;PM&#39;</span><span class="p">:</span>
                <span class="n">positions</span> <span class="o">*=</span> <span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># make time axis first</span>
        <span class="k">if</span> <span class="n">positions</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ntimes</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
                    <span class="n">ntimes</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">ntimes</span><span class="p">:</span>
                <span class="n">div</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">npages</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">positions</span><span class="o">*</span><span class="n">ntimes</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">mod</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">ntimes</span><span class="p">,</span> <span class="n">div</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npages</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># images of reduced page might be stored first</span>
        <span class="k">if</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># unwrap offsets</span>
        <span class="n">wrap</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">previousoffset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">dataoffsets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">currentoffset</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">currentoffset</span> <span class="o">&lt;</span> <span class="n">previousoffset</span><span class="p">:</span>
                    <span class="n">wrap</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span>
                <span class="n">dataoffsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentoffset</span> <span class="o">+</span> <span class="n">wrap</span><span class="p">)</span>
                <span class="n">previousoffset</span> <span class="o">=</span> <span class="n">currentoffset</span>
            <span class="n">page</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dataoffsets</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lsm_fix_strip_bytecounts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set databytecounts to size of compressed data.</span>

<span class="sd">        The StripByteCounts tag in LSM files contains the number of bytes</span>
<span class="sd">        for the uncompressed data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="k">if</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">compression</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># sort pages by first strip offset</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">npages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">index</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">dataoffsets</span>
            <span class="n">bytecounts</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">databytecounts</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">npages</span><span class="p">:</span>
                <span class="n">lastoffset</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># LZW compressed strips might be longer than uncompressed</span>
                <span class="n">lastoffset</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">offsets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">bytecounts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="n">offsets</span> <span class="o">+</span> <span class="p">(</span><span class="n">lastoffset</span><span class="p">,)</span>
            <span class="n">page</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">offsets</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">offsets</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bytecounts</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return &#39;is_flag&#39; attributes from first page.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">FILE_FLAGS</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; object has no attribute &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">79</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string containing information about file.</span>

<span class="sd">        The detail parameter specifies the level of detail returned:</span>

<span class="sd">        0: file only.</span>
<span class="sd">        1: all series, first page of series and its tags.</span>
<span class="sd">        2: large tag values and file metadata.</span>
<span class="sd">        3: all pages.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;TiffFile &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
            <span class="n">format_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
            <span class="p">{</span><span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="s1">&#39;LittleEndian&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;BigEndian&#39;</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">byteorder</span><span class="p">]]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_bigtiff</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;BigTiff&#39;</span><span class="p">)</span>
        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1"> Pages&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1"> Series&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1"> Files&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">)))</span>
        <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;   &#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">info</span> <span class="o">%</span> <span class="n">snipstr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">width</span><span class="o">+</span><span class="mi">2</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">detail</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">info</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span>
        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">detail</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">TiffPage</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
                         <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">TiffPage</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">,</span>
                                          <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span>
                         <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">detail</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_metadata&#39;</span><span class="p">):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_metadata&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_METADATA</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                                                 <span class="n">pformat</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
                                                         <span class="n">height</span><span class="o">=</span><span class="n">detail</span><span class="o">*</span><span class="mi">12</span><span class="p">)))</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return set of file flags.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">FILE_FLAGS</span><span class="p">)</span>
                   <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;is_&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">))</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_mdgel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;File has MD Gel format.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_mdgel</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_mdgel</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_movie</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if file is a movie.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">useframes</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">shaped_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return Tifffile metadata from JSON descriptions as dicts.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shaped</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">json_description_metadata</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_shaped</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">stype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;shaped&#39;</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">ome_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return OME XML as dict.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: remove this or return XML?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ome</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="n">xml2dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">description</span><span class="p">)[</span><span class="s1">&#39;OME&#39;</span><span class="p">]</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">qptiff_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return PerkinElmer-QPI-ImageDescription XML element as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_qptiff</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">root</span> <span class="o">=</span> <span class="s1">&#39;PerkinElmer-QPI-ImageDescription&#39;</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">root</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xml2dict</span><span class="p">(</span><span class="n">xml</span><span class="p">)[</span><span class="n">root</span><span class="p">]</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">lsm_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return LSM metadata from CZ_LSMINFO tag as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_lsm</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;CZ_LSMINFO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">stk_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return STK metadata from UIC tags as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stk</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">tags</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;NumberPlanes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;UIC2tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span>
        <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;PlaneDescriptions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># result[&#39;plane_descriptions&#39;] = stk_description_metadata(</span>
            <span class="c1">#    page.image_description)</span>
        <span class="k">if</span> <span class="s1">&#39;UIC1tag&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;UIC1tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;UIC3tag&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;UIC3tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># wavelengths</span>
        <span class="k">if</span> <span class="s1">&#39;UIC4tag&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;UIC4tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># override uic1 tags</span>
        <span class="n">uic2tag</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;UIC2tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ZDistance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uic2tag</span><span class="p">[</span><span class="s1">&#39;ZDistance&#39;</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;TimeCreated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uic2tag</span><span class="p">[</span><span class="s1">&#39;TimeCreated&#39;</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;TimeModified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uic2tag</span><span class="p">[</span><span class="s1">&#39;TimeModified&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;DatetimeCreated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">julian_datetime</span><span class="p">(</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span>
                 <span class="nb">zip</span><span class="p">(</span><span class="n">uic2tag</span><span class="p">[</span><span class="s1">&#39;DateCreated&#39;</span><span class="p">],</span> <span class="n">uic2tag</span><span class="p">[</span><span class="s1">&#39;TimeCreated&#39;</span><span class="p">])],</span>
                <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;DatetimeModified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">julian_datetime</span><span class="p">(</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span>
                 <span class="nb">zip</span><span class="p">(</span><span class="n">uic2tag</span><span class="p">[</span><span class="s1">&#39;DateModified&#39;</span><span class="p">],</span> <span class="n">uic2tag</span><span class="p">[</span><span class="s1">&#39;TimeModified&#39;</span><span class="p">])],</span>
                <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;stk_metadata: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">imagej_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return consolidated ImageJ metadata as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_imagej</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">imagej_description_metadata</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">is_imagej</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;IJMetadata&#39;</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;IJMetadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">fluoview_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return consolidated FluoView metadata as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fluoview</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;MM_Header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="c1"># TODO: read stamps from all pages</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Stamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;MM_Stamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="c1"># skip parsing image description; not reliable</span>
        <span class="c1"># try:</span>
        <span class="c1">#     t = fluoview_description_metadata(page.image_description)</span>
        <span class="c1">#     if t is not None:</span>
        <span class="c1">#         result[&#39;ImageDescription&#39;] = t</span>
        <span class="c1"># except Exception as e:</span>
        <span class="c1">#     warnings.warn(</span>
        <span class="c1">#         &quot;failed to read FluoView image description: %s&quot; % e)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">nih_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return NIH Image metadata from NIHImageHeader tag as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_nih</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;NIHImageHeader&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">fei_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return FEI metadata from SFEG or HELIOS tags as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fei</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span>
        <span class="k">if</span> <span class="s1">&#39;FEI_SFEG&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;FEI_SFEG&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="s1">&#39;FEI_HELIOS&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;FEI_HELIOS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">sem_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return SEM metadata from CZ_SEM tag as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sem</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;CZ_SEM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">mdgel_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return consolidated metadata from MD GEL tags as dict.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;MDFileTag&#39;</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">tags</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">33445</span><span class="p">,</span> <span class="mi">33453</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAGS</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">andor_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return Andor tags as dict.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">andor_tags</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">epics_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return EPICS areaDetector tags as dict.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">epics_tags</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">tvips_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return TVIPS tag as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_tvips</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;TVIPS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">metaseries_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return MetaSeries metadata from image description as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_metaseries</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="n">metaseries_description_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">pilatus_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return Pilatus metadata from image description as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_pilatus</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="n">pilatus_description_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">micromanager_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return consolidated MicroManager metadata as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_micromanager</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># from file header</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">read_micromanager_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="p">)</span>
        <span class="c1"># from tag</span>
        <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;MicroManagerMetadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">scanimage_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return ScanImage non-varying frame and ROI metadata as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_scanimage</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">framedata</span><span class="p">,</span> <span class="n">roidata</span> <span class="o">=</span> <span class="n">read_scanimage_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;FrameData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">framedata</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">roidata</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># TODO: scanimage_artist_metadata</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scanimage_description_metadata</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;scanimage_description_metadata failed: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">geotiff_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return GeoTIFF metadata from first page as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_geotiff</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">geotiff_tags</span>


<span class="k">class</span> <span class="nc">TiffPages</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sequence of TIFF image file directories.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize instance from file. Read first TiffPage from file.</span>

<span class="sd">        The file position must be at an offset to an offset to a TiffPage.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># cache of TiffPages, TiffFrames, or their offsets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># True if offsets to all pages were read</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tiffpage</span> <span class="o">=</span> <span class="n">TiffPage</span>  <span class="c1"># class for reading tiff pages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># read offset to first page</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nextpageoffset</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">offsetformat</span><span class="p">,</span>
                               <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">offsetsize</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># warnings.warn(&#39;file contains no pages&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">fh</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;invalid page offset (</span><span class="si">%i</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">offset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>

        <span class="c1"># always read and cache first page</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">TiffPage</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span> <span class="o">=</span> <span class="n">page</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if pages/frames are currenly being cached.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>

    <span class="nd">@cache</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enable or disable caching of pages/frames. Clear cache if False.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">useframes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if currently using TiffFrame (True) or TiffPage (False).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tiffpage</span> <span class="o">==</span> <span class="n">TiffFrame</span> <span class="ow">and</span> <span class="n">TiffFrame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TiffPage</span>

    <span class="nd">@useframes</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">useframes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set to use TiffFrame (True) or TiffPage (False).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tiffpage</span> <span class="o">=</span> <span class="n">TiffFrame</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="n">TiffPage</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return index of current keyframe.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span><span class="o">.</span><span class="n">index</span>

    <span class="nd">@keyframe</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set current keyframe. Load TiffPage from file if necessary.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">index</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="ow">or</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">TiffPage</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span> <span class="o">=</span> <span class="n">page</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">TiffFrame</span><span class="p">):</span>
                <span class="c1"># remove existing frame</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">offset</span>
        <span class="c1"># load TiffPage from file</span>
        <span class="n">useframes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">useframes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tiffpage</span> <span class="o">=</span> <span class="n">TiffPage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">useframes</span> <span class="o">=</span> <span class="n">useframes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">next_page_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return offset where offset to a new page can be stored.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nextpageoffset</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read all remaining pages from file.&quot;&quot;&quot;</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
        <span class="n">keyframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">inttypes</span><span class="p">):</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
                <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tiffpage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">keyframe</span><span class="o">=</span><span class="n">keyframe</span><span class="p">)</span>
                <span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fully</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete all but first page from cache. Set keyframe to first page.&quot;&quot;&quot;</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fully</span><span class="p">:</span>
            <span class="c1"># delete all but first TiffPage/TiffFrame</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">inttypes</span><span class="p">):</span>
                    <span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">offset</span>
        <span class="k">elif</span> <span class="n">TiffFrame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TiffPage</span><span class="p">:</span>
            <span class="c1"># delete only TiffFrames</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">TiffFrame</span><span class="p">):</span>
                    <span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">offset</span>

    <span class="k">def</span> <span class="nf">_seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">maxpages</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">22</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Seek file to offset of specified page.&quot;&quot;&quot;</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pages</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
        <span class="k">if</span> <span class="n">fh</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;FileHandle is closed&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="ow">or</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">page</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">inttypes</span><span class="p">)</span> <span class="k">else</span> <span class="n">page</span><span class="o">.</span><span class="n">offset</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">offsetformat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">offsetformat</span>
        <span class="n">offsetsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">offsetsize</span>
        <span class="n">tagnoformat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">tagnoformat</span>
        <span class="n">tagnosize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">tagnosize</span>
        <span class="n">tagsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">tagsize</span>
        <span class="n">unpack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span>

        <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">page</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">inttypes</span><span class="p">)</span> <span class="k">else</span> <span class="n">page</span><span class="o">.</span><span class="n">offset</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">maxpages</span><span class="p">:</span>
            <span class="c1"># read offsets to pages from file until index is reached</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="c1"># skip tags</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tagno</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">tagnoformat</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">tagnosize</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">tagno</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;suspicious number of tags&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;corrupted tag list at offset </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">offset</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">pages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nextpageoffset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">tagnosize</span> <span class="o">+</span> <span class="n">tagno</span> <span class="o">*</span> <span class="n">tagsize</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nextpageoffset</span><span class="p">)</span>

            <span class="c1"># read offset to next page</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">offsetsize</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">fh</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;invalid page offset (</span><span class="si">%i</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">offset</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

            <span class="n">pages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;list index out of range&#39;</span><span class="p">)</span>

        <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">page</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">inttypes</span><span class="p">)</span> <span class="k">else</span> <span class="n">page</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if file contains any pages.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of pages in file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return specified page(s) from cache or file.&quot;&quot;&quot;</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pages</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;list index out of range&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pages</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)))]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;list index out of range&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">inttypes</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">page</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tiffpage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">keyframe</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_keyframe</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="n">pages</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
        <span class="k">return</span> <span class="n">page</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return iterator over all pages.&quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">break</span>


<span class="k">class</span> <span class="nc">TiffPage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;TIFF image file directory (IFD).</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    index : int</span>
<span class="sd">        Index of page in file.</span>
<span class="sd">    dtype : numpy.dtype or None</span>
<span class="sd">        Data type (native byte order) of the image in IFD.</span>
<span class="sd">    shape : tuple</span>
<span class="sd">        Dimensions of the image in IFD.</span>
<span class="sd">    axes : str</span>
<span class="sd">        Axes label codes:</span>
<span class="sd">        &#39;X&#39; width, &#39;Y&#39; height, &#39;S&#39; sample, &#39;I&#39; image series|page|plane,</span>
<span class="sd">        &#39;Z&#39; depth, &#39;C&#39; color|em-wavelength|channel, &#39;E&#39; ex-wavelength|lambda,</span>
<span class="sd">        &#39;T&#39; time, &#39;R&#39; region|tile, &#39;A&#39; angle, &#39;P&#39; phase, &#39;H&#39; lifetime,</span>
<span class="sd">        &#39;L&#39; exposure, &#39;V&#39; event, &#39;Q&#39; unknown, &#39;_&#39; missing</span>
<span class="sd">    tags : dict</span>
<span class="sd">        Dictionary of tags in IFD. {tag.name: TiffTag}</span>
<span class="sd">    colormap : numpy.ndarray</span>
<span class="sd">        Color look up table, if exists.</span>

<span class="sd">    All attributes are read-only.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The internal, normalized &#39;_shape&#39; attribute is 6 dimensional:</span>

<span class="sd">    0 : number planes/images  (stk, ij).</span>
<span class="sd">    1 : planar samplesperpixel.</span>
<span class="sd">    2 : imagedepth Z  (sgi).</span>
<span class="sd">    3 : imagelength Y.</span>
<span class="sd">    4 : imagewidth X.</span>
<span class="sd">    5 : contig samplesperpixel.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># default properties; will be updated from tags</span>
    <span class="n">imagewidth</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">imagelength</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">imagedepth</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">tilewidth</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tilelength</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tiledepth</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">bitspersample</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">sampleformat</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">rowsperstrip</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">compression</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">planarconfig</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">fillorder</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">photometric</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">extrasamples</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">colormap</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">description1</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">keyframe</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize instance from file.</span>

<span class="sd">        The file handle position must be at offset to a valid IFD.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="p">()</span>

        <span class="c1"># read TIFF IFD structure and its tags from file</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>  <span class="c1"># offset to this IFD</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tagno</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">tagnoformat</span><span class="p">,</span>
                                  <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">tagnosize</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tagno</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;suspicious number of tags&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;corrupted tag list at offset </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>

        <span class="n">tagsize</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">tagsize</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">tagsize</span> <span class="o">*</span> <span class="n">tagno</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
        <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="n">tagsize</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tagno</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="n">tagsize</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">TiffTag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">index</span><span class="o">+</span><span class="n">tagsize</span><span class="p">])</span>
            <span class="k">except</span> <span class="n">TiffTag</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="n">tagname</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">tagname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">tagname</span>
                <span class="n">tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># some files contain multiple tags with same code</span>
                <span class="c1"># e.g. MicroManager files contain two ImageDescription tags</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tagname</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                        <span class="n">tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span>
                        <span class="k">break</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_ATTRIBUTES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;sof des&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                    <span class="k">pass</span>  <span class="c1"># wrong string type for software, description</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># found in FIBICS</span>

        <span class="c1"># consolidate private tags; remove them from self.tags</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_andor</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">andor_tags</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_epics</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epics_tags</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_lsm</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">is_lsm</span><span class="p">):</span>
            <span class="c1"># correct non standard LSM bitspersample tags</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;BitsPerSample&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_fix_lsm_bitspersample</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_vista</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">is_vista</span><span class="p">):</span>
            <span class="c1"># ISS Vista writes wrong ImageDepth tag</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imagedepth</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stk</span> <span class="ow">and</span> <span class="s1">&#39;UIC1tag&#39;</span> <span class="ow">in</span> <span class="n">tags</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;UIC1tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="c1"># read UIC1tag now that plane count is known</span>
            <span class="n">uic1tag</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;UIC1tag&#39;</span><span class="p">]</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">uic1tag</span><span class="o">.</span><span class="n">valueoffset</span><span class="p">)</span>
            <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;UIC1tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">read_uic1tag</span><span class="p">(</span>
                <span class="n">fh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span> <span class="n">uic1tag</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                <span class="n">uic1tag</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;UIC2tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;IJMetadata&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="c1"># decode IJMetadata tag</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;IJMetadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">imagej_metadata</span><span class="p">(</span>
                    <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;IJMetadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;IJMetadataByteCounts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">byteorder</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;BitsPerSample&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;BitsPerSample&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># LSM might list more items than samplesperpixel</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">samplesperpixel</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">v</span><span class="o">-</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;SampleFormat&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;SampleFormat&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sampleformat</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">samplesperpixel</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">v</span><span class="o">-</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sampleformat</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sampleformat</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;ImageLength&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;RowsPerStrip&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span> <span class="ow">or</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;RowsPerStrip&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rowsperstrip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagelength</span>
            <span class="c1"># self.stripsperimage = int(math.floor(</span>
            <span class="c1">#    float(self.imagelength + self.rowsperstrip - 1) /</span>
            <span class="c1">#    self.rowsperstrip))</span>

        <span class="c1"># determine dtype</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampleformat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">SAMPLE_DTYPES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">dtype</span>

        <span class="c1"># determine shape of data</span>
        <span class="n">imagelength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagelength</span>
        <span class="n">imagewidth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagewidth</span>
        <span class="n">imagedepth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagedepth</span>
        <span class="n">samplesperpixel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplesperpixel</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stk</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagedepth</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">uictag</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;UIC2tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">planes</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;UIC2tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">planes</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">,</span> <span class="n">samplesperpixel</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">samplesperpixel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">planes</span><span class="p">,</span> <span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;YX&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">planes</span><span class="p">,</span> <span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">,</span> <span class="n">samplesperpixel</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;YXS&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">planes</span><span class="p">,</span> <span class="n">samplesperpixel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">samplesperpixel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">planes</span><span class="p">,</span> <span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;YX&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">planes</span><span class="p">,</span> <span class="n">samplesperpixel</span><span class="p">,</span> <span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;SYX&#39;</span>
            <span class="c1"># detect type of series</span>
            <span class="k">if</span> <span class="n">planes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">uictag</span><span class="p">[</span><span class="s1">&#39;ZDistance&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;Z&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span>
            <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">uictag</span><span class="p">[</span><span class="s1">&#39;TimeCreated&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">photometric</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">samplesperpixel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># PHOTOMETRIC.RGB</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imagedepth</span><span class="p">,</span> <span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">,</span> <span class="n">samplesperpixel</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">imagedepth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">,</span> <span class="n">samplesperpixel</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;YXS&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">imagedepth</span><span class="p">,</span> <span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">,</span> <span class="n">samplesperpixel</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;ZYXS&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">samplesperpixel</span><span class="p">,</span> <span class="n">imagedepth</span><span class="p">,</span>
                               <span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">imagedepth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">samplesperpixel</span><span class="p">,</span> <span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;SYX&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">samplesperpixel</span><span class="p">,</span> <span class="n">imagedepth</span><span class="p">,</span> <span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;SZYX&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imagedepth</span><span class="p">,</span> <span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">imagedepth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;YX&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">imagedepth</span><span class="p">,</span> <span class="n">imagelength</span><span class="p">,</span> <span class="n">imagewidth</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;ZYX&#39;</span>

        <span class="c1"># dataoffsets and databytecounts</span>
        <span class="k">if</span> <span class="s1">&#39;TileOffsets&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;TileOffsets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="s1">&#39;StripOffsets&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;StripOffsets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>

        <span class="k">if</span> <span class="s1">&#39;TileByteCounts&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;TileByteCounts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="s1">&#39;StripByteCounts&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;StripByteCounts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="o">//</span> <span class="mi">8</span><span class="p">),)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;required ByteCounts tag is missing&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reopen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">maxsize</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">44</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read image data from file and return as numpy array.</span>

<span class="sd">        Raise ValueError if format is unsupported.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        out : numpy.ndarray, str, or file-like object; optional</span>
<span class="sd">            Buffer where image data will be saved.</span>
<span class="sd">            If None (default), a new array will be created.</span>
<span class="sd">            If numpy.ndarray, a writable array of compatible dtype and shape.</span>
<span class="sd">            If &#39;memmap&#39;, directly memory-map the image data in the TIFF file</span>
<span class="sd">            if possible; else create a memory-mapped array in a temporary file.</span>
<span class="sd">            If str or open file, the file name or file object used to</span>
<span class="sd">            create a memory-map to an array stored in a binary file on disk.</span>
<span class="sd">        squeeze : bool</span>
<span class="sd">            If True, all length-1 dimensions (except X and Y) are</span>
<span class="sd">            squeezed out from the array.</span>
<span class="sd">            If False, the shape of the returned array might be different from</span>
<span class="sd">            the page.shape.</span>
<span class="sd">        lock : {RLock, NullContext}</span>
<span class="sd">            A reentrant lock used to syncronize reads from file.</span>
<span class="sd">            If None (default), the lock of the parent&#39;s filehandle is used.</span>
<span class="sd">        reopen : bool</span>
<span class="sd">            If True (default) and the parent file handle is closed, the file</span>
<span class="sd">            is temporarily re-opened and closed if no exception occurs.</span>
<span class="sd">        maxsize: int or None</span>
<span class="sd">            Maximum size of data before a ValueError is raised.</span>
<span class="sd">            Can be used to catch DOS. Default: 16 TB.</span>
<span class="sd">        validate : bool</span>
<span class="sd">            If True (default), validate various parameters.</span>
<span class="sd">            If None, only validate parameters and return None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">self_</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span>  <span class="c1"># self or keyframe</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="ow">or</span> <span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

        <span class="k">if</span> <span class="n">validate</span> <span class="ow">or</span> <span class="n">validate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">maxsize</span> <span class="ow">and</span> <span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxsize</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data are too large </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data type not supported: </span><span class="si">%s%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sampleformat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DECOMPESSORS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;cannot decompress </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;SampleFormat&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;SampleFormat&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;sample formats do not match </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_chroma_subsampled</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">!=</span> <span class="mi">7</span> <span class="ow">or</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;chroma subsampling not supported&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">validate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="n">fh</span> <span class="o">=</span> <span class="n">self_</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">lock</span> <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lock</span>
        <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">closed</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">closed</span>
            <span class="k">if</span> <span class="n">closed</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">reopen</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;file handle is closed&#39;</span><span class="p">)</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span>
        <span class="n">imagewidth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagewidth</span>
        <span class="n">imagelength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagelength</span>
        <span class="n">imagedepth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagedepth</span>
        <span class="n">bitspersample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span>
        <span class="n">typecode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">+</span> <span class="n">dtype</span><span class="o">.</span><span class="n">char</span>
        <span class="n">lsb2msb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillorder</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">offsets</span><span class="p">,</span> <span class="n">bytecounts</span> <span class="o">=</span> <span class="n">self_</span><span class="o">.</span><span class="n">offsets_bytecounts</span>
        <span class="n">istiled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_tiled</span>

        <span class="k">if</span> <span class="n">istiled</span><span class="p">:</span>
            <span class="n">tilewidth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span>
            <span class="n">tilelength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilelength</span>
            <span class="n">tiledepth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiledepth</span>
            <span class="n">tw</span> <span class="o">=</span> <span class="p">(</span><span class="n">imagewidth</span> <span class="o">+</span> <span class="n">tilewidth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">tilewidth</span>
            <span class="n">tl</span> <span class="o">=</span> <span class="p">(</span><span class="n">imagelength</span> <span class="o">+</span> <span class="n">tilelength</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">tilelength</span>
            <span class="n">td</span> <span class="o">=</span> <span class="p">(</span><span class="n">imagedepth</span> <span class="o">+</span> <span class="n">tiledepth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">tiledepth</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                     <span class="n">td</span><span class="o">*</span><span class="n">tiledepth</span><span class="p">,</span> <span class="n">tl</span><span class="o">*</span><span class="n">tilelength</span><span class="p">,</span> <span class="n">tw</span><span class="o">*</span><span class="n">tilewidth</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">tileshape</span> <span class="o">=</span> <span class="p">(</span><span class="n">tiledepth</span><span class="p">,</span> <span class="n">tilelength</span><span class="p">,</span> <span class="n">tilewidth</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">runlen</span> <span class="o">=</span> <span class="n">tilewidth</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">runlen</span> <span class="o">=</span> <span class="n">imagewidth</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">runlen</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplesperpixel</span>

        <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;memmap&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_memmappable</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">memmap_array</span><span class="p">(</span><span class="n">typecode</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">create_output</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="n">typecode</span><span class="p">,</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">isnative</span><span class="p">:</span>
                <span class="c1"># swap byte order and dtype without copy</span>
                <span class="n">result</span><span class="o">.</span><span class="n">byteswap</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">lsb2msb</span><span class="p">:</span>
                <span class="n">reverse_bitorder</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">create_output</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>

            <span class="n">decompress</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DECOMPESSORS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>  <span class="c1"># COMPRESSION.JPEG</span>
                <span class="k">if</span> <span class="n">bitspersample</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;unsupported JPEG precision </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">bitspersample</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;JPEGTables&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                    <span class="n">table</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;JPEGTables&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">table</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
                <span class="n">unpack</span> <span class="o">=</span> <span class="n">identityfunc</span>
                <span class="n">colorspace</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">photometric</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

                <span class="k">def</span> <span class="nf">decompress</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">decompress</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span>
                               <span class="n">bitspersample</span><span class="o">=</span><span class="n">bitspersample</span><span class="p">,</span>
                               <span class="n">colorspace</span><span class="o">=</span><span class="n">colorspace</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">bitspersample</span><span class="p">,</span>
                                <span class="n">colorspace</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">bitspersample</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">bitspersample</span> <span class="o">*</span> <span class="n">runlen</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data and sample size mismatch&#39;</span><span class="p">)</span>

                <span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">typecode</span><span class="o">=</span><span class="n">typecode</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># PREDICTOR.FLOATINGPOINT</span>
                        <span class="c1"># the floating point horizontal differencing decoder</span>
                        <span class="c1"># needs the raw byte order</span>
                        <span class="n">typecode</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">char</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># read only numpy array</span>
                        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">typecode</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c1"># strips may be missing EOI</span>
                        <span class="c1"># warnings.warn(&#39;unpack: %s&#39; % e)</span>
                        <span class="n">xlen</span> <span class="o">=</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="n">bitspersample</span> <span class="o">//</span> <span class="mi">8</span><span class="p">))</span> <span class="o">*</span>
                                <span class="p">(</span><span class="n">bitspersample</span> <span class="o">//</span> <span class="mi">8</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="n">xlen</span><span class="p">],</span> <span class="n">typecode</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bitspersample</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">typecode</span><span class="o">=</span><span class="n">typecode</span><span class="p">,</span> <span class="n">bitspersample</span><span class="o">=</span><span class="n">bitspersample</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">unpack_rgb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">typecode</span><span class="p">,</span> <span class="n">bitspersample</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">typecode</span><span class="o">=</span><span class="n">typecode</span><span class="p">,</span> <span class="n">bitspersample</span><span class="o">=</span><span class="n">bitspersample</span><span class="p">,</span>
                           <span class="n">runlen</span><span class="o">=</span><span class="n">runlen</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">unpack_ints</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">typecode</span><span class="p">,</span> <span class="n">bitspersample</span><span class="p">,</span> <span class="n">runlen</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">istiled</span><span class="p">:</span>
                <span class="n">writable</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">tw</span><span class="p">,</span> <span class="n">tl</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">pl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">tile</span> <span class="ow">in</span> <span class="n">buffered_read</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">bytecounts</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">lsb2msb</span><span class="p">:</span>
                        <span class="n">tile</span> <span class="o">=</span> <span class="n">reverse_bitorder</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span>
                    <span class="n">tile</span> <span class="o">=</span> <span class="n">decompress</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span>
                    <span class="n">tile</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tile</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">tileshape</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c1"># incomplete tiles; see gdal issue #1179</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;invalid tile data&#39;</span><span class="p">)</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tileshape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                        <span class="n">t</span><span class="p">[:</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile</span><span class="p">[:</span><span class="n">s</span><span class="p">]</span>
                        <span class="n">tile</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tileshape</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># PREDICTOR.HORIZONTAL</span>
                        <span class="k">if</span> <span class="n">writable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">writable</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;WRITEABLE&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">writable</span><span class="p">:</span>
                            <span class="n">numpy</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">tile</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tile</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># PREDICTOR.FLOATINGPOINT</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
                    <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">td</span><span class="p">:</span><span class="n">td</span><span class="o">+</span><span class="n">tiledepth</span><span class="p">,</span>
                           <span class="n">tl</span><span class="p">:</span><span class="n">tl</span><span class="o">+</span><span class="n">tilelength</span><span class="p">,</span> <span class="n">tw</span><span class="p">:</span><span class="n">tw</span><span class="o">+</span><span class="n">tilewidth</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tile</span>
                    <span class="k">del</span> <span class="n">tile</span>
                    <span class="n">tw</span> <span class="o">+=</span> <span class="n">tilewidth</span>
                    <span class="k">if</span> <span class="n">tw</span> <span class="o">&gt;=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
                        <span class="n">tw</span><span class="p">,</span> <span class="n">tl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tl</span> <span class="o">+</span> <span class="n">tilelength</span>
                        <span class="k">if</span> <span class="n">tl</span> <span class="o">&gt;=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                            <span class="n">tl</span><span class="p">,</span> <span class="n">td</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">td</span> <span class="o">+</span> <span class="n">tiledepth</span>
                            <span class="k">if</span> <span class="n">td</span> <span class="o">&gt;=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                                <span class="n">td</span><span class="p">,</span> <span class="n">pl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pl</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">imagedepth</span><span class="p">,</span> <span class="p">:</span><span class="n">imagelength</span><span class="p">,</span> <span class="p">:</span><span class="n">imagewidth</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">strip_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowsperstrip</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagewidth</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">strip_size</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samplesperpixel</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">strip</span> <span class="ow">in</span> <span class="n">buffered_read</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">bytecounts</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">lsb2msb</span><span class="p">:</span>
                        <span class="n">strip</span> <span class="o">=</span> <span class="n">reverse_bitorder</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span>
                    <span class="n">strip</span> <span class="o">=</span> <span class="n">decompress</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span>
                    <span class="n">strip</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">strip</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">strip_size</span><span class="p">,</span>
                               <span class="n">result</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">index</span><span class="p">)</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">index</span><span class="o">+</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">strip</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">strip</span>
                    <span class="n">index</span> <span class="o">+=</span> <span class="n">size</span>

        <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">istiled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">is_lsm</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># work around bug in LSM510 software</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># PREDICTOR.HORIZONTAL</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># PREDICTOR.FLOATINGPOINT</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">decode_floats</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">squeeze</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;failed to reshape from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">closed</span><span class="p">:</span>
            <span class="c1"># TODO: file should remain open if an exception occurred above</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">asrgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uint8</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">dmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image data as RGB(A).</span>

<span class="sd">        Work in progress.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span>  <span class="c1"># self or keyframe</span>
        <span class="n">photometric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">photometric</span>
        <span class="n">PHOTOMETRIC</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span>

        <span class="k">if</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">PALETTE</span><span class="p">:</span>
            <span class="n">colormap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">colormap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;BH&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot apply colormap&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">uint8</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">colormap</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
                    <span class="n">colormap</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span>
                <span class="n">colormap</span> <span class="o">=</span> <span class="n">colormap</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;S&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">apply_colormap</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">colormap</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">RGB</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;ExtraSamples&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">EXTRASAMPLE</span>
                <span class="n">extrasamples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrasamples</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;ExtraSamples&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">extrasamples</span> <span class="o">=</span> <span class="p">(</span><span class="n">extrasamples</span><span class="p">,)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">exs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">extrasamples</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">exs</span> <span class="ow">in</span> <span class="n">alpha</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">+</span><span class="n">i</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">+</span><span class="n">i</span><span class="p">]]</span>
                        <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="c1"># TODO: convert to uint8?</span>

        <span class="k">elif</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">MINISBLACK</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">MINISWHITE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">photometric</span> <span class="o">==</span> <span class="n">PHOTOMETRIC</span><span class="o">.</span><span class="n">SEPARATED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">aspage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@keyframe</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">offsets_bytecounts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return simplified offsets and bytecounts.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">:</span>
            <span class="n">offset</span><span class="p">,</span> <span class="n">byte_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_contiguous</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">offset</span><span class="p">],</span> <span class="p">[</span><span class="n">byte_count</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">clean_offsets_counts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_contiguous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return offset and size of contiguous data, else None.</span>

<span class="sd">        Excludes prediction and fill_order.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">!=</span> <span class="mi">1</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">)):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="s1">&#39;TileWidth&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imagewidth</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imagelength</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilelength</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tilewidth</span> <span class="o">%</span> <span class="mi">16</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilelength</span> <span class="o">%</span> <span class="mi">16</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;ImageDepth&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span> <span class="s1">&#39;TileDepth&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imagelength</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilelength</span> <span class="ow">or</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">imagedepth</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiledepth</span><span class="p">)):</span>
                <span class="k">return</span>

        <span class="n">offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span>
        <span class="n">bytecounts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bytecounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stk</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">((</span><span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">bytecounts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span>
                               <span class="n">bytecounts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># no data/ignore offset</span>
                              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">sum</span><span class="p">(</span><span class="n">bytecounts</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_final</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if page&#39;s image data are stored in final form.</span>

<span class="sd">        Excludes byte-swapping.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_contiguous</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillorder</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_chroma_subsampled</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_memmappable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if page&#39;s image data in file can be memory-mapped.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">is_file</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_final</span> <span class="ow">and</span>
                <span class="c1"># (self.bitspersample == 8 or self.parent.isnative) and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># aligned?</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">79</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string containing information about page.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TiffFrame</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="p">)</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;memmappable&#39;</span><span class="p">,</span> <span class="s1">&#39;final&#39;</span><span class="p">,</span> <span class="s1">&#39;contiguous&#39;</span><span class="p">):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;is_&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="k">break</span>
        <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s1">&#39;x&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
            <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">SAMPLEFORMAT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sampleformat</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">bitspersample</span><span class="p">),</span>
            <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">photometric</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;TILED&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_tiled</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compression</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compression</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">planarconfig</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fillorder</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillorder</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                     <span class="k">if</span> <span class="n">i</span><span class="p">),</span>
            <span class="n">attr</span><span class="p">,</span>
            <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">))</span>
            <span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;TiffPage </span><span class="si">%i</span><span class="s1"> @</span><span class="si">%i</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">detail</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">info</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
        <span class="n">tlines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vlines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tags</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">code</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">tlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">[:</span><span class="n">width</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">detail</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">width</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">detail</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;COUNTS&#39;</span> <span class="ow">in</span> <span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;OFFSETS&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">pformat</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">detail</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">pformat</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">detail</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span>
                <span class="n">vlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tlines</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">detail</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vlines</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">detail</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;DATA</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pformat</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">asarray</span><span class="p">(),</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">detail</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return set of flags.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">((</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">FILE_FLAGS</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;is_&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of array dimensions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of elements in array.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">andor_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return consolidated metadata from Andor tags as dict.</span>

<span class="sd">        Remove Andor tags from self.tags.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_andor</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Id&#39;</span><span class="p">:</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;AndorId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">code</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="mi">4864</span> <span class="o">&lt;</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="mi">5031</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span>
            <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">del</span> <span class="n">tags</span><span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">epics_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return consolidated metadata from EPICS areaDetector tags as dict.</span>

<span class="sd">        Remove areaDetector tags from self.tags.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_epics</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">code</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="mi">65000</span> <span class="o">&lt;=</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="mi">65500</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">65000</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;timeStamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">65001</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;uniqueID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">65002</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;epicsTSSec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">65003</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;epicsTSNsec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">tags</span><span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">geotiff_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return consolidated metadata from GeoTIFF tags as dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_geotiff</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

        <span class="n">gkd</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;GeoKeyDirectoryTag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">gkd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;invalid GeoKeyDirectoryTag&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;KeyDirectoryVersion&#39;</span><span class="p">:</span> <span class="n">gkd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;KeyRevision&#39;</span><span class="p">:</span> <span class="n">gkd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;KeyRevisionMinor&#39;</span><span class="p">:</span> <span class="n">gkd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="c1"># &#39;NumberOfKeys&#39;: gkd[3],</span>
        <span class="p">}</span>
        <span class="c1"># deltags = [&#39;GeoKeyDirectoryTag&#39;]</span>
        <span class="n">geokeys</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">GEO_KEYS</span>
        <span class="n">geocodes</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">GEO_CODES</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">gkd</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">keyid</span><span class="p">,</span> <span class="n">tagid</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">gkd</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">4</span><span class="p">:</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span>
            <span class="n">keyid</span> <span class="o">=</span> <span class="n">geokeys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keyid</span><span class="p">,</span> <span class="n">keyid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tagid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">offset</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tagname</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAGS</span><span class="p">[</span><span class="n">tagid</span><span class="p">]</span>
                <span class="c1"># deltags.append(tagname)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="n">tagname</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">count</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">tagid</span> <span class="o">==</span> <span class="mi">34737</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;|&#39;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">keyid</span> <span class="ow">in</span> <span class="n">geocodes</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">geocodes</span><span class="p">[</span><span class="n">keyid</span><span class="p">](</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">result</span><span class="p">[</span><span class="n">keyid</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="s1">&#39;IntergraphMatrixTag&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;IntergraphMatrixTag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;IntergraphMatrix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="s1">&#39;ModelPixelScaleTag&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;ModelPixelScaleTag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ModelPixelScale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="s1">&#39;ModelTiepointTag&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;ModelTiepointTag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ModelTiepoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="s1">&#39;ModelTransformationTag&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;ModelTransformationTag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ModelTransformation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># if &#39;ModelPixelScaleTag&#39; in tags and &#39;ModelTiepointTag&#39; in tags:</span>
            <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;ModelPixelScaleTag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">tiepoints</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;ModelTiepointTag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">transforms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tiepoints</span><span class="p">),</span> <span class="mi">6</span><span class="p">):</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">tiepoints</span><span class="p">[</span><span class="n">tp</span><span class="p">:</span><span class="n">tp</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                    <span class="p">[</span><span class="n">sx</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="n">sx</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="n">sy</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">sy</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="n">sz</span><span class="p">,</span> <span class="n">z</span> <span class="o">-</span> <span class="n">k</span> <span class="o">*</span> <span class="n">sz</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tiepoints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ModelTransformation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transforms</span>

        <span class="k">if</span> <span class="s1">&#39;RPCCoefficientTag&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">rpcc</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;RPCCoefficientTag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;RPCCoefficient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;ERR_BIAS&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;ERR_RAND&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;LINE_OFF&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="s1">&#39;SAMP_OFF&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                <span class="s1">&#39;LAT_OFF&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                <span class="s1">&#39;LONG_OFF&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                <span class="s1">&#39;HEIGHT_OFF&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                <span class="s1">&#39;LINE_SCALE&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                <span class="s1">&#39;SAMP_SCALE&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
                <span class="s1">&#39;LAT_SCALE&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
                <span class="s1">&#39;LONG_SCALE&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>
                <span class="s1">&#39;HEIGHT_SCALE&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
                <span class="s1">&#39;LINE_NUM_COEFF&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">33</span><span class="p">],</span>
                <span class="s1">&#39;LINE_DEN_COEFF &#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">33</span><span class="p">:</span><span class="mi">53</span><span class="p">],</span>
                <span class="s1">&#39;SAMP_NUM_COEFF&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">53</span><span class="p">:</span><span class="mi">73</span><span class="p">],</span>
                <span class="s1">&#39;SAMP_DEN_COEFF&#39;</span><span class="p">:</span> <span class="n">rpcc</span><span class="p">[</span><span class="mi">73</span><span class="p">:]}</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_tiled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains tiled image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;TileWidth&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_reduced</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page is reduced image of another image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;NewSubfileType&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;NewSubfileType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_chroma_subsampled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains chroma subsampled image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;YCbCrSubSampling&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;YCbCrSubSampling&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_imagej</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return ImageJ description if exists, else None.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description1</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">description</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ImageJ=&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">description</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">is_shaped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return description containing array shape if exists, else None.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description1</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">description</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;{&#39;</span> <span class="ow">and</span> <span class="s1">&#39;&quot;shape&quot;:&#39;</span> <span class="ow">in</span> <span class="n">description</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">description</span>
            <span class="k">if</span> <span class="n">description</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shape=&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">description</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_mdgel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains MDFileTag tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;MDFileTag&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_mediacy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains Media Cybernetics Id tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;MC_Id&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;MC_Id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;MC TIFF&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_stk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains UIC2Tag tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;UIC2tag&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_lsm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains CZ_LSMINFO tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;CZ_LSMINFO&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_fluoview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains FluoView MM_STAMP tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;MM_Stamp&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_nih</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains NIH image header.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;NIHImageHeader&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_sgi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains SGI image and tile depth tags.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;ImageDepth&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span> <span class="s1">&#39;TileDepth&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_vista</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Software tag is &#39;ISS Vista&#39;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;ISS Vista&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_metaseries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains MDS MetaSeries metadata in ImageDescription tag.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">!=</span> <span class="s1">&#39;MetaSeries&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>
        <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;MetaData&gt;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&lt;/MetaData&gt;&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_ome</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains OME-XML in ImageDescription tag.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>
        <span class="k">return</span> <span class="n">d</span><span class="p">[:</span><span class="mi">14</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&lt;?xml version=&#39;</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;&lt;/OME&gt;&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_scn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains Leica SCN XML in ImageDescription tag.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>
        <span class="k">return</span> <span class="n">d</span><span class="p">[:</span><span class="mi">14</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&lt;?xml version=&#39;</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;&lt;/scn&gt;&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_micromanager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains Micro-Manager metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;MicroManagerMetadata&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_andor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains Andor Technology tags.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;AndorId&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_pilatus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains Pilatus tags.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TVX TIFF&#39;</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;# &#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_epics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains EPICS areaDetector tags.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">==</span> <span class="s1">&#39;EPICS areaDetector&#39;</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;EPICS areaDetector&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_tvips</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains TVIPS metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;TVIPS&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_fei</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains SFEG or HELIOS metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;FEI_SFEG&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">or</span> <span class="s1">&#39;FEI_HELIOS&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_sem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains Zeiss SEM metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;CZ_SEM&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_svs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains Aperio metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Aperio Image Library&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_scanimage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains ScanImage metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">[:</span><span class="mi">12</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;state.config&#39;</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">[:</span><span class="mi">22</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SI.LINE_FORMAT_VERSION&#39;</span> <span class="ow">or</span>
                <span class="s1">&#39;scanimage.SI.&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">[</span><span class="o">-</span><span class="mi">256</span><span class="p">:])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_qptiff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains PerkinElmer tissue images metadata.&quot;&quot;&quot;</span>
        <span class="c1"># The ImageDescription tag contains XML with a top-level</span>
        <span class="c1"># &lt;PerkinElmer-QPI-ImageDescription&gt; element</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">[:</span><span class="mi">15</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PerkinElmer-QPI&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_geotiff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Page contains GeoTIFF metadata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;GeoKeyDirectoryTag&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>


<span class="k">class</span> <span class="nc">TiffFrame</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Lightweight TIFF image file directory (IFD).</span>

<span class="sd">    Only a limited number of tag values are read from file, e.g. StripOffsets,</span>
<span class="sd">    and StripByteCounts. Other tag values are assumed to be identical with a</span>
<span class="sd">    specified TiffPage instance, the keyframe.</span>

<span class="sd">    TiffFrame is intended to reduce resource usage and speed up reading data</span>
<span class="sd">    from file, not for introspection of metadata.</span>

<span class="sd">    Not compatible with Python 2.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;keyframe&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;dataoffsets&#39;</span><span class="p">,</span> <span class="s1">&#39;databytecounts&#39;</span><span class="p">)</span>

    <span class="n">is_mdgel</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read specified tags from file.</span>

<span class="sd">        The file handle position must be at the offset to a valid IFD.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span> <span class="o">=</span> <span class="n">keyframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">unpack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tagno</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">tagnoformat</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">tagnosize</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tagno</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;suspicious number of tags&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;corrupted page list at offset </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>

        <span class="c1"># tags = {}</span>
        <span class="n">tagcodes</span> <span class="o">=</span> <span class="p">{</span><span class="mi">273</span><span class="p">,</span> <span class="mi">279</span><span class="p">,</span> <span class="mi">324</span><span class="p">,</span> <span class="mi">325</span><span class="p">}</span>  <span class="c1"># TIFF.FRAME_TAGS</span>
        <span class="n">tagsize</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">tagsize</span>
        <span class="n">codeformat</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">tagformat1</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">tagsize</span> <span class="o">*</span> <span class="n">tagno</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="n">tagsize</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tagno</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="n">tagsize</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">codeformat</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">index</span><span class="o">+</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tagcodes</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">TiffTag</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">index</span><span class="o">+</span><span class="n">tagsize</span><span class="p">])</span>
            <span class="k">except</span> <span class="n">TiffTag</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">273</span> <span class="ow">or</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">324</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;dataoffsets&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">279</span> <span class="ow">or</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">325</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;databytecounts&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="c1"># elif code == 270:</span>
            <span class="c1">#     tagname = tag.name</span>
            <span class="c1">#     if tagname not in tags:</span>
            <span class="c1">#         tags[tagname] = bytes2str(tag.value)</span>
            <span class="c1">#     elif &#39;ImageDescription1&#39; not in tags:</span>
            <span class="c1">#         tags[&#39;ImageDescription1&#39;] = bytes2str(tag.value)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     tags[tag.name] = tag.value</span>

    <span class="k">def</span> <span class="nf">aspage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return TiffPage from file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TiffPage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">keyframe</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read image data from file and return as numpy array.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: fix TypeError on Python 2</span>
        <span class="c1">#   &quot;TypeError: unbound method asarray() must be called with TiffPage</span>
        <span class="c1">#   instance as first argument (got TiffFrame instance instead)&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">TiffPage</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">asrgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read image data from file and return RGB image as numpy array.&quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">TiffPage</span><span class="o">.</span><span class="n">asrgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">offsets_bytecounts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return simplified offsets and bytecounts.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">clean_offsets_counts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">databytecounts</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_contiguous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return offset and size of contiguous data, else None.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataoffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_memmappable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if page&#39;s image data in file can be memory-mapped.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">is_memmappable</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return attribute from keyframe.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">FRAME_ATTRS</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="c1"># this error could be raised because an AttributeError was</span>
        <span class="c1"># raised inside a @property function</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; object has no attribute &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string containing information about frame.&quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s1">&#39;x&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)))</span>
        <span class="k">return</span> <span class="s1">&#39;TiffFrame </span><span class="si">%i</span><span class="s1"> @</span><span class="si">%i</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TiffTag</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;TIFF tag structure.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : string</span>
<span class="sd">        Name of tag.</span>
<span class="sd">    code : int</span>
<span class="sd">        Decimal code of tag.</span>
<span class="sd">    dtype : str</span>
<span class="sd">        Datatype of tag data. One of TIFF DATA_FORMATS.</span>
<span class="sd">    count : int</span>
<span class="sd">        Number of values.</span>
<span class="sd">    value : various types</span>
<span class="sd">        Tag data as Python object.</span>
<span class="sd">    ImageSourceData : int</span>
<span class="sd">        Location of value in file.</span>

<span class="sd">    All attributes are read-only.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;valueoffset&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">tagheader</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize instance from tag header.&quot;&quot;&quot;</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span>
        <span class="n">byteorder</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">byteorder</span>
        <span class="n">unpack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span>
        <span class="n">offsetsize</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">offsetsize</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">valueoffset</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">+</span> <span class="n">offsetsize</span> <span class="o">+</span> <span class="mi">4</span>
        <span class="n">code</span><span class="p">,</span> <span class="n">type_</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">tagformat1</span><span class="p">,</span> <span class="n">tagheader</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">count</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">tagformat2</span><span class="p">,</span> <span class="n">tagheader</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DATA_FORMATS</span><span class="p">[</span><span class="n">type_</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TiffTag</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s1">&#39;unknown tag data type </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">type_</span><span class="p">)</span>

        <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%i%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">byteorder</span><span class="p">,</span> <span class="n">count</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">dtype</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">offsetsize</span> <span class="ow">or</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_READERS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valueoffset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="ow">or</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="n">fh</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">size</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TiffTag</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s1">&#39;invalid tag value offset&#39;</span><span class="p">)</span>
            <span class="c1"># if offset % 2:</span>
            <span class="c1">#     warnings.warn(&#39;tag value does not begin on word boundary&#39;)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_READERS</span><span class="p">:</span>
                <span class="n">readfunc</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_READERS</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">readfunc</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="mi">7</span> <span class="ow">or</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">read_bytes</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAGS</span> <span class="ow">or</span> <span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">read_numpy</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span> <span class="ow">or</span> <span class="n">type_</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">value</span><span class="p">[:</span><span class="n">size</span><span class="p">])</span>

        <span class="n">process</span> <span class="o">=</span> <span class="p">(</span><span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_READERS</span> <span class="ow">and</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_TUPLE</span>
                   <span class="ow">and</span> <span class="n">type_</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">process</span> <span class="ow">and</span> <span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="c1"># TIFF ASCII fields can contain multiple strings,</span>
            <span class="c1">#   each terminated with a NUL</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripascii</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;tag </span><span class="si">%i</span><span class="s1">: coercing invalid ASCII to bytes&#39;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;1B&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_ENUM</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_ENUM</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">process</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAGS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_fix_lsm_bitspersample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Correct LSM bitspersample tag.</span>

<span class="sd">        Old LSM writers may use a separate region for two 16-bit values,</span>
<span class="sd">        although they fit into the tag value element of the tag.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">258</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># TODO: test this case; need example file</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;correcting LSM bitspersample tag&#39;</span><span class="p">)</span>
            <span class="n">tof</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">offsetformat</span><span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">offsetsize</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valueoffset</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">tof</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valueoffset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;HH&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">79</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string containing information about tag.&quot;&quot;&quot;</span>
        <span class="n">height</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">detail</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">detail</span>
        <span class="n">tcode</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%i%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;TiffTag </span><span class="si">%i</span><span class="s1"> </span><span class="si">%s</span><span class="s1">  </span><span class="si">%s</span><span class="s1"> @</span><span class="si">%i</span><span class="s1">  &#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tcode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valueoffset</span><span class="p">)[:</span><span class="n">width</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_ENUM</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_ENUM</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">pformat</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">detail</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">value</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">width</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">line</span>


<span class="k">class</span> <span class="nc">TiffPageSeries</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Series of TIFF pages with compatible shape and data type.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    pages : list of TiffPage</span>
<span class="sd">        Sequence of TiffPages in series.</span>
<span class="sd">    dtype : numpy.dtype</span>
<span class="sd">        Data type (native byte order) of the image array in series.</span>
<span class="sd">    shape : tuple</span>
<span class="sd">        Dimensions of the image array in series.</span>
<span class="sd">    axes : str</span>
<span class="sd">        Labels of axes in shape. See TiffPage.axes.</span>
<span class="sd">    offset : int or None</span>
<span class="sd">        Position of image data in file if memory-mappable, else None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">truncated</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span> <span class="o">=</span> <span class="n">pages</span>  <span class="c1"># might contain only first of contiguous pages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stype</span> <span class="o">=</span> <span class="n">stype</span> <span class="k">if</span> <span class="n">stype</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="k">elif</span> <span class="n">pages</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">truncated</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">//</span> <span class="n">product</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return image data from series of TIFF pages as numpy array.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@lazyattr</span>
    <span class="k">def</span> <span class="nf">offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return offset to series data in file, if any.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">page</span><span class="o">.</span><span class="n">is_final</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pos</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">!=</span> <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">return</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">is_imagej</span> <span class="ow">or</span> <span class="n">page</span><span class="o">.</span><span class="n">is_shaped</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># truncated files</span>
            <span class="k">return</span> <span class="n">offset</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">offset</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of array dimensions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of elements in array.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return sequence of all pages in series.&quot;&quot;&quot;</span>
        <span class="c1"># a workaround to keep the old interface working</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of TiffPages in series.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return specified TiffPage.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">key</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return iterator over TiffPages in series.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">page</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">pages</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_len</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">pages</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string with information about series.&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">snipstr</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;x&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stype</span><span class="p">,</span>
            <span class="s1">&#39;</span><span class="si">%i</span><span class="s1"> Pages&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Offset=</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;TiffPageSeries </span><span class="si">%i</span><span class="s1">  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TiffSequence</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sequence of TIFF files.</span>

<span class="sd">    The image data in all files must match shape, dtype, etc.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    files : list</span>
<span class="sd">        List of file names.</span>
<span class="sd">    shape : tuple</span>
<span class="sd">        Shape of image sequence. Excludes shape of image array.</span>
<span class="sd">    axes : str</span>
<span class="sd">        Labels of axes in shape.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; # read image stack from sequence of TIFF files</span>
<span class="sd">    &gt;&gt;&gt; imsave(&#39;temp_C001T001.tif&#39;, numpy.random.rand(64, 64))</span>
<span class="sd">    &gt;&gt;&gt; imsave(&#39;temp_C001T002.tif&#39;, numpy.random.rand(64, 64))</span>
<span class="sd">    &gt;&gt;&gt; tifs = TiffSequence(&#39;temp_C001*.tif&#39;)</span>
<span class="sd">    &gt;&gt;&gt; tifs.shape</span>
<span class="sd">    (1, 2)</span>
<span class="sd">    &gt;&gt;&gt; tifs.axes</span>
<span class="sd">    &#39;CT&#39;</span>
<span class="sd">    &gt;&gt;&gt; data = tifs.asarray()</span>
<span class="sd">    &gt;&gt;&gt; data.shape</span>
<span class="sd">    (1, 2, 64, 64)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_patterns</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;axes&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # matches Olympus OIF and Leica TIFF series</span>
<span class="s2">            _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))</span>
<span class="s2">            _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))?</span>
<span class="s2">            _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))?</span>
<span class="s2">            _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))?</span>
<span class="s2">            _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))?</span>
<span class="s2">            _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))?</span>
<span class="s2">            _?(?:(q|l|p|a|c|t|x|y|z|ch|tp)(\d{1,4}))?</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">}</span>

    <span class="k">class</span> <span class="nc">ParseError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">imread</span><span class="o">=</span><span class="n">TiffFile</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span>
                 <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize instance from multiple files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files : str, pathlib.Path, or sequence thereof</span>
<span class="sd">            Glob pattern or sequence of file names.</span>
<span class="sd">            Binary streams are not supported.</span>
<span class="sd">        imread : function or class</span>
<span class="sd">            Image read function or class with asarray function returning numpy</span>
<span class="sd">            array from single file.</span>
<span class="sd">        pattern : str</span>
<span class="sd">            Regular expression pattern that matches axes names and sequence</span>
<span class="sd">            indices in file names.</span>
<span class="sd">            By default, the pattern matches Olympus OIF and Leica TIFF series.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">natural_sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no files found&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not a file name&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">imread</span><span class="p">,</span> <span class="s1">&#39;asarray&#39;</span><span class="p">):</span>
            <span class="c1"># redefine imread</span>
            <span class="n">_imread</span> <span class="o">=</span> <span class="n">imread</span>

            <span class="k">def</span> <span class="nf">imread</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">_imread</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">im</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">im</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">imread</span> <span class="o">=</span> <span class="n">imread</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patterns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">ParseError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_startindex</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">i</span><span class="p">,)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string with information about image sequence.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39; size: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">),</span>
            <span class="s1">&#39; axes: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span>
            <span class="s1">&#39; shape: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read image data from all files and return as numpy array.</span>

<span class="sd">        The args and kwargs parameters are passed to the imread function.</span>

<span class="sd">        Raise IndexError or ValueError if image shapes do not match.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">create_output</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_startindex</span><span class="p">)]</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">im</span>
        <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get axes and shape from file names.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">ParseError</span><span class="p">(</span><span class="s1">&#39;invalid pattern&#39;</span><span class="p">)</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pattern</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">ParseError</span><span class="p">(</span><span class="s1">&#39;pattern does not match file names&#39;</span><span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">ParseError</span><span class="p">(</span><span class="s1">&#39;pattern does not match axis name and index&#39;</span><span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">m</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">axes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">ParseError</span><span class="p">(</span><span class="s1">&#39;pattern does not match file names&#39;</span><span class="p">)</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">axes</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">m</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;axes do not match within the image sequence&#39;</span><span class="p">)</span>
            <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">m</span><span class="p">])</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">startindex</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">startindex</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;files are missing. Missing data are zeroed&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span> <span class="o">=</span> <span class="n">indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_startindex</span> <span class="o">=</span> <span class="n">startindex</span>


<span class="k">class</span> <span class="nc">FileHandle</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Binary file handle.</span>

<span class="sd">    A limited, special purpose file handler that can:</span>

<span class="sd">    * handle embedded files (for CZI within CZI files)</span>
<span class="sd">    * re-open closed files (for multi-file formats, such as OME-TIFF)</span>
<span class="sd">    * read and write numpy arrays and records from file like objects</span>

<span class="sd">    Only &#39;rb&#39; and &#39;wb&#39; modes are supported. Concurrently reading and writing</span>
<span class="sd">    of the same stream is untested.</span>

<span class="sd">    When initialized from another file handle, do not use it unless this</span>
<span class="sd">    FileHandle is closed.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of the file.</span>
<span class="sd">    path : str</span>
<span class="sd">        Absolute path to file.</span>
<span class="sd">    size : int</span>
<span class="sd">        Size of file in bytes.</span>
<span class="sd">    is_file : bool</span>
<span class="sd">        If True, file has a filno and can be memory-mapped.</span>

<span class="sd">    All attributes are read-only.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_fh&#39;</span><span class="p">,</span> <span class="s1">&#39;_file&#39;</span><span class="p">,</span> <span class="s1">&#39;_mode&#39;</span><span class="p">,</span> <span class="s1">&#39;_name&#39;</span><span class="p">,</span> <span class="s1">&#39;_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;_lock&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;_size&#39;</span><span class="p">,</span> <span class="s1">&#39;_close&#39;</span><span class="p">,</span> <span class="s1">&#39;is_file&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize file handle from file name or another file handle.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : str, pathlib.Path, binary stream, or FileHandle</span>
<span class="sd">            File name or seekable binary stream, such as an open file</span>
<span class="sd">            or BytesIO.</span>
<span class="sd">        mode : str</span>
<span class="sd">            File open mode in case &#39;file&#39; is a file name. Must be &#39;rb&#39; or &#39;wb&#39;.</span>
<span class="sd">        name : str</span>
<span class="sd">            Optional name of file in case &#39;file&#39; is a binary stream.</span>
<span class="sd">        offset : int</span>
<span class="sd">            Optional start position of embedded file. By default, this is</span>
<span class="sd">            the current file position.</span>
<span class="sd">        size : int</span>
<span class="sd">            Optional size of embedded file. By default, this is the number</span>
<span class="sd">            of bytes from the &#39;offset&#39; to the end of the file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="n">file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_file</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">NullContext</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open or re-open file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># file is open</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="c1"># file name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="n">FileHandle</span><span class="p">):</span>
            <span class="c1"># FileHandle</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">_fh</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">_offset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">:</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">@</span><span class="si">%i%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">_name</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">_mode</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;FileHandle has wrong mode&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">_mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">_dir</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="s1">&#39;seek&#39;</span><span class="p">):</span>
            <span class="c1"># binary stream: open file, BytesIO</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;binary stream is not seekable&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;Unnamed binary stream&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">mode</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The first parameter must be a file name, &#39;</span>
                             <span class="s1">&#39;seekable binary stream, or FileHandle&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_file</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_file</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read &#39;size&#39; bytes from file, or until EOF is reached.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bytestring</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write bytestring to file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bytestring</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flush write buffers if applicable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">memmap_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return numpy.memmap of data stored in file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_file</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot memory-map file without fileno&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                            <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
                            <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">25</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">native</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return numpy array from file.</span>

<span class="sd">        Work around numpy issue #2230, &quot;numpy.fromfile does not accept</span>
<span class="sd">        StringIO object&quot; https://github.com/numpy/numpy/issues/2230.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">count</span> <span class="o">*</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>

        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">sep</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="c1"># ByteIO</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">native</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">isnative</span><span class="p">:</span>
                <span class="c1"># swap byte order and dtype without copy</span>
                <span class="n">result</span><span class="o">.</span><span class="n">byteswap</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># Read data from file in chunks and copy to output array</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">nbytes</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
            <span class="n">datasize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">datasize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">size</span> <span class="o">-=</span> <span class="n">datasize</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">index</span><span class="o">+</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s1">&#39;flush&#39;</span><span class="p">):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return numpy record from file.&quot;&quot;&quot;</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">rec</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">//</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">sequence</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span> <span class="o">*</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">shape</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">record</span>

    <span class="k">def</span> <span class="nf">write_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append size bytes to file. Position must be at end of file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write numpy array to binary file.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># BytesIO</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return file&#39;s current position.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span>

    <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set file&#39;s current position.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">whence</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">whence</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">whence</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_close</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return attribute from underlying file object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;FileHandle: &#39;</span><span class="si">%s</span><span class="s2">&#39; not implemented for embedded files&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fh</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dirname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fh</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span>

    <span class="nd">@lock</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="n">NullContext</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">NullContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Null context manager.</span>

<span class="sd">    &gt;&gt;&gt; with NullContext():</span>
<span class="sd">    ...     pass</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">OpenFileCache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Keep files open.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="s1">&#39;past&#39;</span><span class="p">,</span> <span class="s1">&#39;lock&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize open file cache.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">past</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># FIFO of opened files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># refcounts of opened files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">NullContext</span><span class="p">()</span> <span class="k">if</span> <span class="n">lock</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filehandle</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Re-open file if necessary.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filehandle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">filehandle</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">filehandle</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                <span class="n">filehandle</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">filehandle</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">past</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filehandle</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filehandle</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close openend file if no longer used.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filehandle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">filehandle</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="c1"># trim the file cache</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">past</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>
                    <span class="n">filehandle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">past</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">filehandle</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">filehandle</span><span class="p">]</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">past</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                        <span class="n">size</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close all opened files if not in use.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">filehandle</span><span class="p">,</span> <span class="n">refcount</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">refcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">filehandle</span><span class="p">]</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">past</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">past</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">filehandle</span><span class="p">)]</span>


<span class="k">class</span> <span class="nc">LazyConst</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class whose attributes are computed on first access from its methods.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span> <span class="o">=</span> <span class="bp">cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;__doc__&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">func</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># Python 2 unbound method</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__func__</span><span class="p">()</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="nd">@LazyConst</span>
<span class="k">class</span> <span class="nc">TIFF</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Namespace for module constants.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">TAGS</span><span class="p">():</span>
        <span class="c1"># TIFF tag codes and names from TIFF6, TIFF/EP, EXIF, and other specs</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;ProcessingSoftware&#39;</span><span class="p">,</span>
            <span class="mi">254</span><span class="p">:</span> <span class="s1">&#39;NewSubfileType&#39;</span><span class="p">,</span>
            <span class="mi">255</span><span class="p">:</span> <span class="s1">&#39;SubfileType&#39;</span><span class="p">,</span>
            <span class="mi">256</span><span class="p">:</span> <span class="s1">&#39;ImageWidth&#39;</span><span class="p">,</span>
            <span class="mi">257</span><span class="p">:</span> <span class="s1">&#39;ImageLength&#39;</span><span class="p">,</span>
            <span class="mi">258</span><span class="p">:</span> <span class="s1">&#39;BitsPerSample&#39;</span><span class="p">,</span>
            <span class="mi">259</span><span class="p">:</span> <span class="s1">&#39;Compression&#39;</span><span class="p">,</span>
            <span class="mi">262</span><span class="p">:</span> <span class="s1">&#39;PhotometricInterpretation&#39;</span><span class="p">,</span>
            <span class="mi">263</span><span class="p">:</span> <span class="s1">&#39;Thresholding&#39;</span><span class="p">,</span>
            <span class="mi">264</span><span class="p">:</span> <span class="s1">&#39;CellWidth&#39;</span><span class="p">,</span>
            <span class="mi">265</span><span class="p">:</span> <span class="s1">&#39;CellLength&#39;</span><span class="p">,</span>
            <span class="mi">266</span><span class="p">:</span> <span class="s1">&#39;FillOrder&#39;</span><span class="p">,</span>
            <span class="mi">269</span><span class="p">:</span> <span class="s1">&#39;DocumentName&#39;</span><span class="p">,</span>
            <span class="mi">270</span><span class="p">:</span> <span class="s1">&#39;ImageDescription&#39;</span><span class="p">,</span>
            <span class="mi">271</span><span class="p">:</span> <span class="s1">&#39;Make&#39;</span><span class="p">,</span>
            <span class="mi">272</span><span class="p">:</span> <span class="s1">&#39;Model&#39;</span><span class="p">,</span>
            <span class="mi">273</span><span class="p">:</span> <span class="s1">&#39;StripOffsets&#39;</span><span class="p">,</span>
            <span class="mi">274</span><span class="p">:</span> <span class="s1">&#39;Orientation&#39;</span><span class="p">,</span>
            <span class="mi">277</span><span class="p">:</span> <span class="s1">&#39;SamplesPerPixel&#39;</span><span class="p">,</span>
            <span class="mi">278</span><span class="p">:</span> <span class="s1">&#39;RowsPerStrip&#39;</span><span class="p">,</span>
            <span class="mi">279</span><span class="p">:</span> <span class="s1">&#39;StripByteCounts&#39;</span><span class="p">,</span>
            <span class="mi">280</span><span class="p">:</span> <span class="s1">&#39;MinSampleValue&#39;</span><span class="p">,</span>
            <span class="mi">281</span><span class="p">:</span> <span class="s1">&#39;MaxSampleValue&#39;</span><span class="p">,</span>
            <span class="mi">282</span><span class="p">:</span> <span class="s1">&#39;XResolution&#39;</span><span class="p">,</span>
            <span class="mi">283</span><span class="p">:</span> <span class="s1">&#39;YResolution&#39;</span><span class="p">,</span>
            <span class="mi">284</span><span class="p">:</span> <span class="s1">&#39;PlanarConfiguration&#39;</span><span class="p">,</span>
            <span class="mi">285</span><span class="p">:</span> <span class="s1">&#39;PageName&#39;</span><span class="p">,</span>
            <span class="mi">286</span><span class="p">:</span> <span class="s1">&#39;XPosition&#39;</span><span class="p">,</span>
            <span class="mi">287</span><span class="p">:</span> <span class="s1">&#39;YPosition&#39;</span><span class="p">,</span>
            <span class="mi">288</span><span class="p">:</span> <span class="s1">&#39;FreeOffsets&#39;</span><span class="p">,</span>
            <span class="mi">289</span><span class="p">:</span> <span class="s1">&#39;FreeByteCounts&#39;</span><span class="p">,</span>
            <span class="mi">290</span><span class="p">:</span> <span class="s1">&#39;GrayResponseUnit&#39;</span><span class="p">,</span>
            <span class="mi">291</span><span class="p">:</span> <span class="s1">&#39;GrayResponseCurve&#39;</span><span class="p">,</span>
            <span class="mi">292</span><span class="p">:</span> <span class="s1">&#39;T4Options&#39;</span><span class="p">,</span>
            <span class="mi">293</span><span class="p">:</span> <span class="s1">&#39;T6Options&#39;</span><span class="p">,</span>
            <span class="mi">296</span><span class="p">:</span> <span class="s1">&#39;ResolutionUnit&#39;</span><span class="p">,</span>
            <span class="mi">297</span><span class="p">:</span> <span class="s1">&#39;PageNumber&#39;</span><span class="p">,</span>
            <span class="mi">300</span><span class="p">:</span> <span class="s1">&#39;ColorResponseUnit&#39;</span><span class="p">,</span>
            <span class="mi">301</span><span class="p">:</span> <span class="s1">&#39;TransferFunction&#39;</span><span class="p">,</span>
            <span class="mi">305</span><span class="p">:</span> <span class="s1">&#39;Software&#39;</span><span class="p">,</span>
            <span class="mi">306</span><span class="p">:</span> <span class="s1">&#39;DateTime&#39;</span><span class="p">,</span>
            <span class="mi">315</span><span class="p">:</span> <span class="s1">&#39;Artist&#39;</span><span class="p">,</span>
            <span class="mi">316</span><span class="p">:</span> <span class="s1">&#39;HostComputer&#39;</span><span class="p">,</span>
            <span class="mi">317</span><span class="p">:</span> <span class="s1">&#39;Predictor&#39;</span><span class="p">,</span>
            <span class="mi">318</span><span class="p">:</span> <span class="s1">&#39;WhitePoint&#39;</span><span class="p">,</span>
            <span class="mi">319</span><span class="p">:</span> <span class="s1">&#39;PrimaryChromaticities&#39;</span><span class="p">,</span>
            <span class="mi">320</span><span class="p">:</span> <span class="s1">&#39;ColorMap&#39;</span><span class="p">,</span>
            <span class="mi">321</span><span class="p">:</span> <span class="s1">&#39;HalftoneHints&#39;</span><span class="p">,</span>
            <span class="mi">322</span><span class="p">:</span> <span class="s1">&#39;TileWidth&#39;</span><span class="p">,</span>
            <span class="mi">323</span><span class="p">:</span> <span class="s1">&#39;TileLength&#39;</span><span class="p">,</span>
            <span class="mi">324</span><span class="p">:</span> <span class="s1">&#39;TileOffsets&#39;</span><span class="p">,</span>
            <span class="mi">325</span><span class="p">:</span> <span class="s1">&#39;TileByteCounts&#39;</span><span class="p">,</span>
            <span class="mi">326</span><span class="p">:</span> <span class="s1">&#39;BadFaxLines&#39;</span><span class="p">,</span>
            <span class="mi">327</span><span class="p">:</span> <span class="s1">&#39;CleanFaxData&#39;</span><span class="p">,</span>
            <span class="mi">328</span><span class="p">:</span> <span class="s1">&#39;ConsecutiveBadFaxLines&#39;</span><span class="p">,</span>
            <span class="mi">330</span><span class="p">:</span> <span class="s1">&#39;SubIFDs&#39;</span><span class="p">,</span>
            <span class="mi">332</span><span class="p">:</span> <span class="s1">&#39;InkSet&#39;</span><span class="p">,</span>
            <span class="mi">333</span><span class="p">:</span> <span class="s1">&#39;InkNames&#39;</span><span class="p">,</span>
            <span class="mi">334</span><span class="p">:</span> <span class="s1">&#39;NumberOfInks&#39;</span><span class="p">,</span>
            <span class="mi">336</span><span class="p">:</span> <span class="s1">&#39;DotRange&#39;</span><span class="p">,</span>
            <span class="mi">337</span><span class="p">:</span> <span class="s1">&#39;TargetPrinter&#39;</span><span class="p">,</span>
            <span class="mi">338</span><span class="p">:</span> <span class="s1">&#39;ExtraSamples&#39;</span><span class="p">,</span>
            <span class="mi">339</span><span class="p">:</span> <span class="s1">&#39;SampleFormat&#39;</span><span class="p">,</span>
            <span class="mi">340</span><span class="p">:</span> <span class="s1">&#39;SMinSampleValue&#39;</span><span class="p">,</span>
            <span class="mi">341</span><span class="p">:</span> <span class="s1">&#39;SMaxSampleValue&#39;</span><span class="p">,</span>
            <span class="mi">342</span><span class="p">:</span> <span class="s1">&#39;TransferRange&#39;</span><span class="p">,</span>
            <span class="mi">343</span><span class="p">:</span> <span class="s1">&#39;ClipPath&#39;</span><span class="p">,</span>
            <span class="mi">344</span><span class="p">:</span> <span class="s1">&#39;XClipPathUnits&#39;</span><span class="p">,</span>
            <span class="mi">345</span><span class="p">:</span> <span class="s1">&#39;YClipPathUnits&#39;</span><span class="p">,</span>
            <span class="mi">346</span><span class="p">:</span> <span class="s1">&#39;Indexed&#39;</span><span class="p">,</span>
            <span class="mi">347</span><span class="p">:</span> <span class="s1">&#39;JPEGTables&#39;</span><span class="p">,</span>
            <span class="mi">351</span><span class="p">:</span> <span class="s1">&#39;OPIProxy&#39;</span><span class="p">,</span>
            <span class="mi">400</span><span class="p">:</span> <span class="s1">&#39;GlobalParametersIFD&#39;</span><span class="p">,</span>
            <span class="mi">401</span><span class="p">:</span> <span class="s1">&#39;ProfileType&#39;</span><span class="p">,</span>
            <span class="mi">402</span><span class="p">:</span> <span class="s1">&#39;FaxProfile&#39;</span><span class="p">,</span>
            <span class="mi">403</span><span class="p">:</span> <span class="s1">&#39;CodingMethods&#39;</span><span class="p">,</span>
            <span class="mi">404</span><span class="p">:</span> <span class="s1">&#39;VersionYear&#39;</span><span class="p">,</span>
            <span class="mi">405</span><span class="p">:</span> <span class="s1">&#39;ModeNumber&#39;</span><span class="p">,</span>
            <span class="mi">433</span><span class="p">:</span> <span class="s1">&#39;Decode&#39;</span><span class="p">,</span>
            <span class="mi">434</span><span class="p">:</span> <span class="s1">&#39;DefaultImageColor&#39;</span><span class="p">,</span>
            <span class="mi">435</span><span class="p">:</span> <span class="s1">&#39;T82Options&#39;</span><span class="p">,</span>
            <span class="mi">437</span><span class="p">:</span> <span class="s1">&#39;JPEGTables_&#39;</span><span class="p">,</span>  <span class="c1"># 347</span>
            <span class="mi">512</span><span class="p">:</span> <span class="s1">&#39;JPEGProc&#39;</span><span class="p">,</span>
            <span class="mi">513</span><span class="p">:</span> <span class="s1">&#39;JPEGInterchangeFormat&#39;</span><span class="p">,</span>
            <span class="mi">514</span><span class="p">:</span> <span class="s1">&#39;JPEGInterchangeFormatLength&#39;</span><span class="p">,</span>
            <span class="mi">515</span><span class="p">:</span> <span class="s1">&#39;JPEGRestartInterval&#39;</span><span class="p">,</span>
            <span class="mi">517</span><span class="p">:</span> <span class="s1">&#39;JPEGLosslessPredictors&#39;</span><span class="p">,</span>
            <span class="mi">518</span><span class="p">:</span> <span class="s1">&#39;JPEGPointTransforms&#39;</span><span class="p">,</span>
            <span class="mi">519</span><span class="p">:</span> <span class="s1">&#39;JPEGQTables&#39;</span><span class="p">,</span>
            <span class="mi">520</span><span class="p">:</span> <span class="s1">&#39;JPEGDCTables&#39;</span><span class="p">,</span>
            <span class="mi">521</span><span class="p">:</span> <span class="s1">&#39;JPEGACTables&#39;</span><span class="p">,</span>
            <span class="mi">529</span><span class="p">:</span> <span class="s1">&#39;YCbCrCoefficients&#39;</span><span class="p">,</span>
            <span class="mi">530</span><span class="p">:</span> <span class="s1">&#39;YCbCrSubSampling&#39;</span><span class="p">,</span>
            <span class="mi">531</span><span class="p">:</span> <span class="s1">&#39;YCbCrPositioning&#39;</span><span class="p">,</span>
            <span class="mi">532</span><span class="p">:</span> <span class="s1">&#39;ReferenceBlackWhite&#39;</span><span class="p">,</span>
            <span class="mi">559</span><span class="p">:</span> <span class="s1">&#39;StripRowCounts&#39;</span><span class="p">,</span>
            <span class="mi">700</span><span class="p">:</span> <span class="s1">&#39;XMP&#39;</span><span class="p">,</span>  <span class="c1"># XMLPacket</span>
            <span class="mi">769</span><span class="p">:</span> <span class="s1">&#39;GDIGamma&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">770</span><span class="p">:</span> <span class="s1">&#39;ICCProfileDescriptor&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">771</span><span class="p">:</span> <span class="s1">&#39;SRGBRenderingIntent&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">800</span><span class="p">:</span> <span class="s1">&#39;ImageTitle&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">999</span><span class="p">:</span> <span class="s1">&#39;USPTO_Miscellaneous&#39;</span><span class="p">,</span>
            <span class="mi">4864</span><span class="p">:</span> <span class="s1">&#39;AndorId&#39;</span><span class="p">,</span>  <span class="c1"># TODO: Andor Technology 4864 - 5030</span>
            <span class="mi">4869</span><span class="p">:</span> <span class="s1">&#39;AndorTemperature&#39;</span><span class="p">,</span>
            <span class="mi">4876</span><span class="p">:</span> <span class="s1">&#39;AndorExposureTime&#39;</span><span class="p">,</span>
            <span class="mi">4878</span><span class="p">:</span> <span class="s1">&#39;AndorKineticCycleTime&#39;</span><span class="p">,</span>
            <span class="mi">4879</span><span class="p">:</span> <span class="s1">&#39;AndorAccumulations&#39;</span><span class="p">,</span>
            <span class="mi">4881</span><span class="p">:</span> <span class="s1">&#39;AndorAcquisitionCycleTime&#39;</span><span class="p">,</span>
            <span class="mi">4882</span><span class="p">:</span> <span class="s1">&#39;AndorReadoutTime&#39;</span><span class="p">,</span>
            <span class="mi">4884</span><span class="p">:</span> <span class="s1">&#39;AndorPhotonCounting&#39;</span><span class="p">,</span>
            <span class="mi">4885</span><span class="p">:</span> <span class="s1">&#39;AndorEmDacLevel&#39;</span><span class="p">,</span>
            <span class="mi">4890</span><span class="p">:</span> <span class="s1">&#39;AndorFrames&#39;</span><span class="p">,</span>
            <span class="mi">4896</span><span class="p">:</span> <span class="s1">&#39;AndorHorizontalFlip&#39;</span><span class="p">,</span>
            <span class="mi">4897</span><span class="p">:</span> <span class="s1">&#39;AndorVerticalFlip&#39;</span><span class="p">,</span>
            <span class="mi">4898</span><span class="p">:</span> <span class="s1">&#39;AndorClockwise&#39;</span><span class="p">,</span>
            <span class="mi">4899</span><span class="p">:</span> <span class="s1">&#39;AndorCounterClockwise&#39;</span><span class="p">,</span>
            <span class="mi">4904</span><span class="p">:</span> <span class="s1">&#39;AndorVerticalClockVoltage&#39;</span><span class="p">,</span>
            <span class="mi">4905</span><span class="p">:</span> <span class="s1">&#39;AndorVerticalShiftSpeed&#39;</span><span class="p">,</span>
            <span class="mi">4907</span><span class="p">:</span> <span class="s1">&#39;AndorPreAmpSetting&#39;</span><span class="p">,</span>
            <span class="mi">4908</span><span class="p">:</span> <span class="s1">&#39;AndorCameraSerial&#39;</span><span class="p">,</span>
            <span class="mi">4911</span><span class="p">:</span> <span class="s1">&#39;AndorActualTemperature&#39;</span><span class="p">,</span>
            <span class="mi">4912</span><span class="p">:</span> <span class="s1">&#39;AndorBaselineClamp&#39;</span><span class="p">,</span>
            <span class="mi">4913</span><span class="p">:</span> <span class="s1">&#39;AndorPrescans&#39;</span><span class="p">,</span>
            <span class="mi">4914</span><span class="p">:</span> <span class="s1">&#39;AndorModel&#39;</span><span class="p">,</span>
            <span class="mi">4915</span><span class="p">:</span> <span class="s1">&#39;AndorChipSizeX&#39;</span><span class="p">,</span>
            <span class="mi">4916</span><span class="p">:</span> <span class="s1">&#39;AndorChipSizeY&#39;</span><span class="p">,</span>
            <span class="mi">4944</span><span class="p">:</span> <span class="s1">&#39;AndorBaselineOffset&#39;</span><span class="p">,</span>
            <span class="mi">4966</span><span class="p">:</span> <span class="s1">&#39;AndorSoftwareVersion&#39;</span><span class="p">,</span>
            <span class="mi">18246</span><span class="p">:</span> <span class="s1">&#39;Rating&#39;</span><span class="p">,</span>
            <span class="mi">18247</span><span class="p">:</span> <span class="s1">&#39;XP_DIP_XML&#39;</span><span class="p">,</span>
            <span class="mi">18248</span><span class="p">:</span> <span class="s1">&#39;StitchInfo&#39;</span><span class="p">,</span>
            <span class="mi">18249</span><span class="p">:</span> <span class="s1">&#39;RatingPercent&#39;</span><span class="p">,</span>
            <span class="mi">20481</span><span class="p">:</span> <span class="s1">&#39;ResolutionXUnit&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20482</span><span class="p">:</span> <span class="s1">&#39;ResolutionYUnit&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20483</span><span class="p">:</span> <span class="s1">&#39;ResolutionXLengthUnit&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20484</span><span class="p">:</span> <span class="s1">&#39;ResolutionYLengthUnit&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20485</span><span class="p">:</span> <span class="s1">&#39;PrintFlags&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20486</span><span class="p">:</span> <span class="s1">&#39;PrintFlagsVersion&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20487</span><span class="p">:</span> <span class="s1">&#39;PrintFlagsCrop&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20488</span><span class="p">:</span> <span class="s1">&#39;PrintFlagsBleedWidth&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20489</span><span class="p">:</span> <span class="s1">&#39;PrintFlagsBleedWidthScale&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20490</span><span class="p">:</span> <span class="s1">&#39;HalftoneLPI&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20491</span><span class="p">:</span> <span class="s1">&#39;HalftoneLPIUnit&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20492</span><span class="p">:</span> <span class="s1">&#39;HalftoneDegree&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20493</span><span class="p">:</span> <span class="s1">&#39;HalftoneShape&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20494</span><span class="p">:</span> <span class="s1">&#39;HalftoneMisc&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20495</span><span class="p">:</span> <span class="s1">&#39;HalftoneScreen&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20496</span><span class="p">:</span> <span class="s1">&#39;JPEGQuality&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20497</span><span class="p">:</span> <span class="s1">&#39;GridSize&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20498</span><span class="p">:</span> <span class="s1">&#39;ThumbnailFormat&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20499</span><span class="p">:</span> <span class="s1">&#39;ThumbnailWidth&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20500</span><span class="p">:</span> <span class="s1">&#39;ThumbnailHeight&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20501</span><span class="p">:</span> <span class="s1">&#39;ThumbnailColorDepth&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20502</span><span class="p">:</span> <span class="s1">&#39;ThumbnailPlanes&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20503</span><span class="p">:</span> <span class="s1">&#39;ThumbnailRawBytes&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20504</span><span class="p">:</span> <span class="s1">&#39;ThumbnailSize&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20505</span><span class="p">:</span> <span class="s1">&#39;ThumbnailCompressedSize&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20506</span><span class="p">:</span> <span class="s1">&#39;ColorTransferFunction&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20507</span><span class="p">:</span> <span class="s1">&#39;ThumbnailData&#39;</span><span class="p">,</span>
            <span class="mi">20512</span><span class="p">:</span> <span class="s1">&#39;ThumbnailImageWidth&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20513</span><span class="p">:</span> <span class="s1">&#39;ThumbnailImageHeight&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20514</span><span class="p">:</span> <span class="s1">&#39;ThumbnailBitsPerSample&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20515</span><span class="p">:</span> <span class="s1">&#39;ThumbnailCompression&#39;</span><span class="p">,</span>
            <span class="mi">20516</span><span class="p">:</span> <span class="s1">&#39;ThumbnailPhotometricInterp&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20517</span><span class="p">:</span> <span class="s1">&#39;ThumbnailImageDescription&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20518</span><span class="p">:</span> <span class="s1">&#39;ThumbnailEquipMake&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20519</span><span class="p">:</span> <span class="s1">&#39;ThumbnailEquipModel&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20520</span><span class="p">:</span> <span class="s1">&#39;ThumbnailStripOffsets&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20521</span><span class="p">:</span> <span class="s1">&#39;ThumbnailOrientation&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20522</span><span class="p">:</span> <span class="s1">&#39;ThumbnailSamplesPerPixel&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20523</span><span class="p">:</span> <span class="s1">&#39;ThumbnailRowsPerStrip&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20524</span><span class="p">:</span> <span class="s1">&#39;ThumbnailStripBytesCount&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20525</span><span class="p">:</span> <span class="s1">&#39;ThumbnailResolutionX&#39;</span><span class="p">,</span>
            <span class="mi">20526</span><span class="p">:</span> <span class="s1">&#39;ThumbnailResolutionY&#39;</span><span class="p">,</span>
            <span class="mi">20527</span><span class="p">:</span> <span class="s1">&#39;ThumbnailPlanarConfig&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20528</span><span class="p">:</span> <span class="s1">&#39;ThumbnailResolutionUnit&#39;</span><span class="p">,</span>
            <span class="mi">20529</span><span class="p">:</span> <span class="s1">&#39;ThumbnailTransferFunction&#39;</span><span class="p">,</span>
            <span class="mi">20530</span><span class="p">:</span> <span class="s1">&#39;ThumbnailSoftwareUsed&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20531</span><span class="p">:</span> <span class="s1">&#39;ThumbnailDateTime&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20532</span><span class="p">:</span> <span class="s1">&#39;ThumbnailArtist&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20533</span><span class="p">:</span> <span class="s1">&#39;ThumbnailWhitePoint&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20534</span><span class="p">:</span> <span class="s1">&#39;ThumbnailPrimaryChromaticities&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20535</span><span class="p">:</span> <span class="s1">&#39;ThumbnailYCbCrCoefficients&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20536</span><span class="p">:</span> <span class="s1">&#39;ThumbnailYCbCrSubsampling&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20537</span><span class="p">:</span> <span class="s1">&#39;ThumbnailYCbCrPositioning&#39;</span><span class="p">,</span>
            <span class="mi">20538</span><span class="p">:</span> <span class="s1">&#39;ThumbnailRefBlackWhite&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20539</span><span class="p">:</span> <span class="s1">&#39;ThumbnailCopyRight&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20545</span><span class="p">:</span> <span class="s1">&#39;InteroperabilityIndex&#39;</span><span class="p">,</span>
            <span class="mi">20546</span><span class="p">:</span> <span class="s1">&#39;InteroperabilityVersion&#39;</span><span class="p">,</span>
            <span class="mi">20624</span><span class="p">:</span> <span class="s1">&#39;LuminanceTable&#39;</span><span class="p">,</span>
            <span class="mi">20625</span><span class="p">:</span> <span class="s1">&#39;ChrominanceTable&#39;</span><span class="p">,</span>
            <span class="mi">20736</span><span class="p">:</span> <span class="s1">&#39;FrameDelay&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20737</span><span class="p">:</span> <span class="s1">&#39;LoopCount&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20738</span><span class="p">:</span> <span class="s1">&#39;GlobalPalette&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20739</span><span class="p">:</span> <span class="s1">&#39;IndexBackground&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20740</span><span class="p">:</span> <span class="s1">&#39;IndexTransparent&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20752</span><span class="p">:</span> <span class="s1">&#39;PixelUnit&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20753</span><span class="p">:</span> <span class="s1">&#39;PixelPerUnitX&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20754</span><span class="p">:</span> <span class="s1">&#39;PixelPerUnitY&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">20755</span><span class="p">:</span> <span class="s1">&#39;PaletteHistogram&#39;</span><span class="p">,</span>  <span class="c1"># GDI+</span>
            <span class="mi">28672</span><span class="p">:</span> <span class="s1">&#39;SonyRawFileType&#39;</span><span class="p">,</span>  <span class="c1"># Sony ARW</span>
            <span class="mi">28722</span><span class="p">:</span> <span class="s1">&#39;VignettingCorrParams&#39;</span><span class="p">,</span>  <span class="c1"># Sony ARW</span>
            <span class="mi">28725</span><span class="p">:</span> <span class="s1">&#39;ChromaticAberrationCorrParams&#39;</span><span class="p">,</span>  <span class="c1"># Sony ARW</span>
            <span class="mi">28727</span><span class="p">:</span> <span class="s1">&#39;DistortionCorrParams&#39;</span><span class="p">,</span>  <span class="c1"># Sony ARW</span>
            <span class="c1"># Private tags &gt;= 32768</span>
            <span class="mi">32781</span><span class="p">:</span> <span class="s1">&#39;ImageID&#39;</span><span class="p">,</span>
            <span class="mi">32931</span><span class="p">:</span> <span class="s1">&#39;WangTag1&#39;</span><span class="p">,</span>
            <span class="mi">32932</span><span class="p">:</span> <span class="s1">&#39;WangAnnotation&#39;</span><span class="p">,</span>
            <span class="mi">32933</span><span class="p">:</span> <span class="s1">&#39;WangTag3&#39;</span><span class="p">,</span>
            <span class="mi">32934</span><span class="p">:</span> <span class="s1">&#39;WangTag4&#39;</span><span class="p">,</span>
            <span class="mi">32953</span><span class="p">:</span> <span class="s1">&#39;ImageReferencePoints&#39;</span><span class="p">,</span>
            <span class="mi">32954</span><span class="p">:</span> <span class="s1">&#39;RegionXformTackPoint&#39;</span><span class="p">,</span>
            <span class="mi">32955</span><span class="p">:</span> <span class="s1">&#39;WarpQuadrilateral&#39;</span><span class="p">,</span>
            <span class="mi">32956</span><span class="p">:</span> <span class="s1">&#39;AffineTransformMat&#39;</span><span class="p">,</span>
            <span class="mi">32995</span><span class="p">:</span> <span class="s1">&#39;Matteing&#39;</span><span class="p">,</span>
            <span class="mi">32996</span><span class="p">:</span> <span class="s1">&#39;DataType&#39;</span><span class="p">,</span>
            <span class="mi">32997</span><span class="p">:</span> <span class="s1">&#39;ImageDepth&#39;</span><span class="p">,</span>
            <span class="mi">32998</span><span class="p">:</span> <span class="s1">&#39;TileDepth&#39;</span><span class="p">,</span>
            <span class="mi">33300</span><span class="p">:</span> <span class="s1">&#39;ImageFullWidth&#39;</span><span class="p">,</span>
            <span class="mi">33301</span><span class="p">:</span> <span class="s1">&#39;ImageFullLength&#39;</span><span class="p">,</span>
            <span class="mi">33302</span><span class="p">:</span> <span class="s1">&#39;TextureFormat&#39;</span><span class="p">,</span>
            <span class="mi">33303</span><span class="p">:</span> <span class="s1">&#39;TextureWrapModes&#39;</span><span class="p">,</span>
            <span class="mi">33304</span><span class="p">:</span> <span class="s1">&#39;FieldOfViewCotangent&#39;</span><span class="p">,</span>
            <span class="mi">33305</span><span class="p">:</span> <span class="s1">&#39;MatrixWorldToScreen&#39;</span><span class="p">,</span>
            <span class="mi">33306</span><span class="p">:</span> <span class="s1">&#39;MatrixWorldToCamera&#39;</span><span class="p">,</span>
            <span class="mi">33405</span><span class="p">:</span> <span class="s1">&#39;Model2&#39;</span><span class="p">,</span>
            <span class="mi">33421</span><span class="p">:</span> <span class="s1">&#39;CFARepeatPatternDim&#39;</span><span class="p">,</span>
            <span class="mi">33422</span><span class="p">:</span> <span class="s1">&#39;CFAPattern&#39;</span><span class="p">,</span>
            <span class="mi">33423</span><span class="p">:</span> <span class="s1">&#39;BatteryLevel&#39;</span><span class="p">,</span>
            <span class="mi">33424</span><span class="p">:</span> <span class="s1">&#39;KodakIFD&#39;</span><span class="p">,</span>
            <span class="mi">33434</span><span class="p">:</span> <span class="s1">&#39;ExposureTime&#39;</span><span class="p">,</span>
            <span class="mi">33437</span><span class="p">:</span> <span class="s1">&#39;FNumber&#39;</span><span class="p">,</span>
            <span class="mi">33432</span><span class="p">:</span> <span class="s1">&#39;Copyright&#39;</span><span class="p">,</span>
            <span class="mi">33445</span><span class="p">:</span> <span class="s1">&#39;MDFileTag&#39;</span><span class="p">,</span>
            <span class="mi">33446</span><span class="p">:</span> <span class="s1">&#39;MDScalePixel&#39;</span><span class="p">,</span>
            <span class="mi">33447</span><span class="p">:</span> <span class="s1">&#39;MDColorTable&#39;</span><span class="p">,</span>
            <span class="mi">33448</span><span class="p">:</span> <span class="s1">&#39;MDLabName&#39;</span><span class="p">,</span>
            <span class="mi">33449</span><span class="p">:</span> <span class="s1">&#39;MDSampleInfo&#39;</span><span class="p">,</span>
            <span class="mi">33450</span><span class="p">:</span> <span class="s1">&#39;MDPrepDate&#39;</span><span class="p">,</span>
            <span class="mi">33451</span><span class="p">:</span> <span class="s1">&#39;MDPrepTime&#39;</span><span class="p">,</span>
            <span class="mi">33452</span><span class="p">:</span> <span class="s1">&#39;MDFileUnits&#39;</span><span class="p">,</span>
            <span class="mi">33550</span><span class="p">:</span> <span class="s1">&#39;ModelPixelScaleTag&#39;</span><span class="p">,</span>
            <span class="mi">33589</span><span class="p">:</span> <span class="s1">&#39;AdventScale&#39;</span><span class="p">,</span>
            <span class="mi">33590</span><span class="p">:</span> <span class="s1">&#39;AdventRevision&#39;</span><span class="p">,</span>
            <span class="mi">33628</span><span class="p">:</span> <span class="s1">&#39;UIC1tag&#39;</span><span class="p">,</span>  <span class="c1"># Metamorph  Universal Imaging Corp STK</span>
            <span class="mi">33629</span><span class="p">:</span> <span class="s1">&#39;UIC2tag&#39;</span><span class="p">,</span>
            <span class="mi">33630</span><span class="p">:</span> <span class="s1">&#39;UIC3tag&#39;</span><span class="p">,</span>
            <span class="mi">33631</span><span class="p">:</span> <span class="s1">&#39;UIC4tag&#39;</span><span class="p">,</span>
            <span class="mi">33723</span><span class="p">:</span> <span class="s1">&#39;IPTCNAA&#39;</span><span class="p">,</span>
            <span class="mi">33858</span><span class="p">:</span> <span class="s1">&#39;ExtendedTagsOffset&#39;</span><span class="p">,</span>  <span class="c1"># DEFF points IFD with private tags</span>
            <span class="mi">33918</span><span class="p">:</span> <span class="s1">&#39;IntergraphPacketData&#39;</span><span class="p">,</span>  <span class="c1"># INGRPacketDataTag</span>
            <span class="mi">33919</span><span class="p">:</span> <span class="s1">&#39;IntergraphFlagRegisters&#39;</span><span class="p">,</span>  <span class="c1"># INGRFlagRegisters</span>
            <span class="mi">33920</span><span class="p">:</span> <span class="s1">&#39;IntergraphMatrixTag&#39;</span><span class="p">,</span>  <span class="c1"># IrasBTransformationMatrix</span>
            <span class="mi">33921</span><span class="p">:</span> <span class="s1">&#39;INGRReserved&#39;</span><span class="p">,</span>
            <span class="mi">33922</span><span class="p">:</span> <span class="s1">&#39;ModelTiepointTag&#39;</span><span class="p">,</span>
            <span class="mi">33923</span><span class="p">:</span> <span class="s1">&#39;LeicaMagic&#39;</span><span class="p">,</span>
            <span class="mi">34016</span><span class="p">:</span> <span class="s1">&#39;Site&#39;</span><span class="p">,</span>
            <span class="mi">34017</span><span class="p">:</span> <span class="s1">&#39;ColorSequence&#39;</span><span class="p">,</span>
            <span class="mi">34018</span><span class="p">:</span> <span class="s1">&#39;IT8Header&#39;</span><span class="p">,</span>
            <span class="mi">34019</span><span class="p">:</span> <span class="s1">&#39;RasterPadding&#39;</span><span class="p">,</span>
            <span class="mi">34020</span><span class="p">:</span> <span class="s1">&#39;BitsPerRunLength&#39;</span><span class="p">,</span>
            <span class="mi">34021</span><span class="p">:</span> <span class="s1">&#39;BitsPerExtendedRunLength&#39;</span><span class="p">,</span>
            <span class="mi">34022</span><span class="p">:</span> <span class="s1">&#39;ColorTable&#39;</span><span class="p">,</span>
            <span class="mi">34023</span><span class="p">:</span> <span class="s1">&#39;ImageColorIndicator&#39;</span><span class="p">,</span>
            <span class="mi">34024</span><span class="p">:</span> <span class="s1">&#39;BackgroundColorIndicator&#39;</span><span class="p">,</span>
            <span class="mi">34025</span><span class="p">:</span> <span class="s1">&#39;ImageColorValue&#39;</span><span class="p">,</span>
            <span class="mi">34026</span><span class="p">:</span> <span class="s1">&#39;BackgroundColorValue&#39;</span><span class="p">,</span>
            <span class="mi">34027</span><span class="p">:</span> <span class="s1">&#39;PixelIntensityRange&#39;</span><span class="p">,</span>
            <span class="mi">34028</span><span class="p">:</span> <span class="s1">&#39;TransparencyIndicator&#39;</span><span class="p">,</span>
            <span class="mi">34029</span><span class="p">:</span> <span class="s1">&#39;ColorCharacterization&#39;</span><span class="p">,</span>
            <span class="mi">34030</span><span class="p">:</span> <span class="s1">&#39;HCUsage&#39;</span><span class="p">,</span>
            <span class="mi">34031</span><span class="p">:</span> <span class="s1">&#39;TrapIndicator&#39;</span><span class="p">,</span>
            <span class="mi">34032</span><span class="p">:</span> <span class="s1">&#39;CMYKEquivalent&#39;</span><span class="p">,</span>
            <span class="mi">34118</span><span class="p">:</span> <span class="s1">&#39;CZ_SEM&#39;</span><span class="p">,</span>  <span class="c1"># Zeiss SEM</span>
            <span class="mi">34152</span><span class="p">:</span> <span class="s1">&#39;AFCP_IPTC&#39;</span><span class="p">,</span>
            <span class="mi">34232</span><span class="p">:</span> <span class="s1">&#39;PixelMagicJBIGOptions&#39;</span><span class="p">,</span>
            <span class="mi">34263</span><span class="p">:</span> <span class="s1">&#39;JPLCartoIFD&#39;</span><span class="p">,</span>
            <span class="mi">34122</span><span class="p">:</span> <span class="s1">&#39;IPLAB&#39;</span><span class="p">,</span>  <span class="c1"># number of images</span>
            <span class="mi">34264</span><span class="p">:</span> <span class="s1">&#39;ModelTransformationTag&#39;</span><span class="p">,</span>
            <span class="mi">34306</span><span class="p">:</span> <span class="s1">&#39;WB_GRGBLevels&#39;</span><span class="p">,</span>  <span class="c1"># Leaf MOS</span>
            <span class="mi">34310</span><span class="p">:</span> <span class="s1">&#39;LeafData&#39;</span><span class="p">,</span>
            <span class="mi">34361</span><span class="p">:</span> <span class="s1">&#39;MM_Header&#39;</span><span class="p">,</span>
            <span class="mi">34362</span><span class="p">:</span> <span class="s1">&#39;MM_Stamp&#39;</span><span class="p">,</span>
            <span class="mi">34363</span><span class="p">:</span> <span class="s1">&#39;MM_Unknown&#39;</span><span class="p">,</span>
            <span class="mi">34377</span><span class="p">:</span> <span class="s1">&#39;ImageResources&#39;</span><span class="p">,</span>  <span class="c1"># Photoshop</span>
            <span class="mi">34386</span><span class="p">:</span> <span class="s1">&#39;MM_UserBlock&#39;</span><span class="p">,</span>
            <span class="mi">34412</span><span class="p">:</span> <span class="s1">&#39;CZ_LSMINFO&#39;</span><span class="p">,</span>
            <span class="mi">34665</span><span class="p">:</span> <span class="s1">&#39;ExifTag&#39;</span><span class="p">,</span>
            <span class="mi">34675</span><span class="p">:</span> <span class="s1">&#39;InterColorProfile&#39;</span><span class="p">,</span>  <span class="c1"># ICCProfile</span>
            <span class="mi">34680</span><span class="p">:</span> <span class="s1">&#39;FEI_SFEG&#39;</span><span class="p">,</span>  <span class="c1">#</span>
            <span class="mi">34682</span><span class="p">:</span> <span class="s1">&#39;FEI_HELIOS&#39;</span><span class="p">,</span>  <span class="c1">#</span>
            <span class="mi">34683</span><span class="p">:</span> <span class="s1">&#39;FEI_TITAN&#39;</span><span class="p">,</span>  <span class="c1">#</span>
            <span class="mi">34687</span><span class="p">:</span> <span class="s1">&#39;FXExtensions&#39;</span><span class="p">,</span>
            <span class="mi">34688</span><span class="p">:</span> <span class="s1">&#39;MultiProfiles&#39;</span><span class="p">,</span>
            <span class="mi">34689</span><span class="p">:</span> <span class="s1">&#39;SharedData&#39;</span><span class="p">,</span>
            <span class="mi">34690</span><span class="p">:</span> <span class="s1">&#39;T88Options&#39;</span><span class="p">,</span>
            <span class="mi">34710</span><span class="p">:</span> <span class="s1">&#39;MarCCD&#39;</span><span class="p">,</span>  <span class="c1"># offset to MarCCD header</span>
            <span class="mi">34732</span><span class="p">:</span> <span class="s1">&#39;ImageLayer&#39;</span><span class="p">,</span>
            <span class="mi">34735</span><span class="p">:</span> <span class="s1">&#39;GeoKeyDirectoryTag&#39;</span><span class="p">,</span>
            <span class="mi">34736</span><span class="p">:</span> <span class="s1">&#39;GeoDoubleParamsTag&#39;</span><span class="p">,</span>
            <span class="mi">34737</span><span class="p">:</span> <span class="s1">&#39;GeoAsciiParamsTag&#39;</span><span class="p">,</span>
            <span class="mi">34750</span><span class="p">:</span> <span class="s1">&#39;JBIGOptions&#39;</span><span class="p">,</span>
            <span class="mi">34821</span><span class="p">:</span> <span class="s1">&#39;PIXTIFF&#39;</span><span class="p">,</span>  <span class="c1"># ? Pixel Translations Inc</span>
            <span class="mi">34850</span><span class="p">:</span> <span class="s1">&#39;ExposureProgram&#39;</span><span class="p">,</span>
            <span class="mi">34852</span><span class="p">:</span> <span class="s1">&#39;SpectralSensitivity&#39;</span><span class="p">,</span>
            <span class="mi">34853</span><span class="p">:</span> <span class="s1">&#39;GPSTag&#39;</span><span class="p">,</span>  <span class="c1"># GPSIFD</span>
            <span class="mi">34855</span><span class="p">:</span> <span class="s1">&#39;ISOSpeedRatings&#39;</span><span class="p">,</span>
            <span class="mi">34856</span><span class="p">:</span> <span class="s1">&#39;OECF&#39;</span><span class="p">,</span>
            <span class="mi">34857</span><span class="p">:</span> <span class="s1">&#39;Interlace&#39;</span><span class="p">,</span>
            <span class="mi">34858</span><span class="p">:</span> <span class="s1">&#39;TimeZoneOffset&#39;</span><span class="p">,</span>
            <span class="mi">34859</span><span class="p">:</span> <span class="s1">&#39;SelfTimerMode&#39;</span><span class="p">,</span>
            <span class="mi">34864</span><span class="p">:</span> <span class="s1">&#39;SensitivityType&#39;</span><span class="p">,</span>
            <span class="mi">34865</span><span class="p">:</span> <span class="s1">&#39;StandardOutputSensitivity&#39;</span><span class="p">,</span>
            <span class="mi">34866</span><span class="p">:</span> <span class="s1">&#39;RecommendedExposureIndex&#39;</span><span class="p">,</span>
            <span class="mi">34867</span><span class="p">:</span> <span class="s1">&#39;ISOSpeed&#39;</span><span class="p">,</span>
            <span class="mi">34868</span><span class="p">:</span> <span class="s1">&#39;ISOSpeedLatitudeyyy&#39;</span><span class="p">,</span>
            <span class="mi">34869</span><span class="p">:</span> <span class="s1">&#39;ISOSpeedLatitudezzz&#39;</span><span class="p">,</span>
            <span class="mi">34908</span><span class="p">:</span> <span class="s1">&#39;HylaFAXFaxRecvParams&#39;</span><span class="p">,</span>
            <span class="mi">34909</span><span class="p">:</span> <span class="s1">&#39;HylaFAXFaxSubAddress&#39;</span><span class="p">,</span>
            <span class="mi">34910</span><span class="p">:</span> <span class="s1">&#39;HylaFAXFaxRecvTime&#39;</span><span class="p">,</span>
            <span class="mi">34911</span><span class="p">:</span> <span class="s1">&#39;FaxDcs&#39;</span><span class="p">,</span>
            <span class="mi">34929</span><span class="p">:</span> <span class="s1">&#39;FedexEDR&#39;</span><span class="p">,</span>
            <span class="mi">34954</span><span class="p">:</span> <span class="s1">&#39;LeafSubIFD&#39;</span><span class="p">,</span>
            <span class="mi">34959</span><span class="p">:</span> <span class="s1">&#39;Aphelion1&#39;</span><span class="p">,</span>
            <span class="mi">34960</span><span class="p">:</span> <span class="s1">&#39;Aphelion2&#39;</span><span class="p">,</span>
            <span class="mi">34961</span><span class="p">:</span> <span class="s1">&#39;AphelionInternal&#39;</span><span class="p">,</span>  <span class="c1"># ADCIS</span>
            <span class="mi">36864</span><span class="p">:</span> <span class="s1">&#39;ExifVersion&#39;</span><span class="p">,</span>
            <span class="mi">36867</span><span class="p">:</span> <span class="s1">&#39;DateTimeOriginal&#39;</span><span class="p">,</span>
            <span class="mi">36868</span><span class="p">:</span> <span class="s1">&#39;DateTimeDigitized&#39;</span><span class="p">,</span>
            <span class="mi">36873</span><span class="p">:</span> <span class="s1">&#39;GooglePlusUploadCode&#39;</span><span class="p">,</span>
            <span class="mi">36880</span><span class="p">:</span> <span class="s1">&#39;OffsetTime&#39;</span><span class="p">,</span>
            <span class="mi">36881</span><span class="p">:</span> <span class="s1">&#39;OffsetTimeOriginal&#39;</span><span class="p">,</span>
            <span class="mi">36882</span><span class="p">:</span> <span class="s1">&#39;OffsetTimeDigitized&#39;</span><span class="p">,</span>
            <span class="c1"># TODO: Pilatus/CHESS/TV6 36864..37120 conflicting with Exif tags</span>
            <span class="c1"># 36864: &#39;TVX ?&#39;,</span>
            <span class="c1"># 36865: &#39;TVX_NumExposure&#39;,</span>
            <span class="c1"># 36866: &#39;TVX_NumBackground&#39;,</span>
            <span class="c1"># 36867: &#39;TVX_ExposureTime&#39;,</span>
            <span class="c1"># 36868: &#39;TVX_BackgroundTime&#39;,</span>
            <span class="c1"># 36870: &#39;TVX ?&#39;,</span>
            <span class="c1"># 36873: &#39;TVX_SubBpp&#39;,</span>
            <span class="c1"># 36874: &#39;TVX_SubWide&#39;,</span>
            <span class="c1"># 36875: &#39;TVX_SubHigh&#39;,</span>
            <span class="c1"># 36876: &#39;TVX_BlackLevel&#39;,</span>
            <span class="c1"># 36877: &#39;TVX_DarkCurrent&#39;,</span>
            <span class="c1"># 36878: &#39;TVX_ReadNoise&#39;,</span>
            <span class="c1"># 36879: &#39;TVX_DarkCurrentNoise&#39;,</span>
            <span class="c1"># 36880: &#39;TVX_BeamMonitor&#39;,</span>
            <span class="c1"># 37120: &#39;TVX_UserVariables&#39;,  # A/D values</span>
            <span class="mi">37121</span><span class="p">:</span> <span class="s1">&#39;ComponentsConfiguration&#39;</span><span class="p">,</span>
            <span class="mi">37122</span><span class="p">:</span> <span class="s1">&#39;CompressedBitsPerPixel&#39;</span><span class="p">,</span>
            <span class="mi">37377</span><span class="p">:</span> <span class="s1">&#39;ShutterSpeedValue&#39;</span><span class="p">,</span>
            <span class="mi">37378</span><span class="p">:</span> <span class="s1">&#39;ApertureValue&#39;</span><span class="p">,</span>
            <span class="mi">37379</span><span class="p">:</span> <span class="s1">&#39;BrightnessValue&#39;</span><span class="p">,</span>
            <span class="mi">37380</span><span class="p">:</span> <span class="s1">&#39;ExposureBiasValue&#39;</span><span class="p">,</span>
            <span class="mi">37381</span><span class="p">:</span> <span class="s1">&#39;MaxApertureValue&#39;</span><span class="p">,</span>
            <span class="mi">37382</span><span class="p">:</span> <span class="s1">&#39;SubjectDistance&#39;</span><span class="p">,</span>
            <span class="mi">37383</span><span class="p">:</span> <span class="s1">&#39;MeteringMode&#39;</span><span class="p">,</span>
            <span class="mi">37384</span><span class="p">:</span> <span class="s1">&#39;LightSource&#39;</span><span class="p">,</span>
            <span class="mi">37385</span><span class="p">:</span> <span class="s1">&#39;Flash&#39;</span><span class="p">,</span>
            <span class="mi">37386</span><span class="p">:</span> <span class="s1">&#39;FocalLength&#39;</span><span class="p">,</span>
            <span class="mi">37387</span><span class="p">:</span> <span class="s1">&#39;FlashEnergy_&#39;</span><span class="p">,</span>  <span class="c1"># 37387</span>
            <span class="mi">37388</span><span class="p">:</span> <span class="s1">&#39;SpatialFrequencyResponse_&#39;</span><span class="p">,</span>  <span class="c1"># 37388</span>
            <span class="mi">37389</span><span class="p">:</span> <span class="s1">&#39;Noise&#39;</span><span class="p">,</span>
            <span class="mi">37390</span><span class="p">:</span> <span class="s1">&#39;FocalPlaneXResolution&#39;</span><span class="p">,</span>
            <span class="mi">37391</span><span class="p">:</span> <span class="s1">&#39;FocalPlaneYResolution&#39;</span><span class="p">,</span>
            <span class="mi">37392</span><span class="p">:</span> <span class="s1">&#39;FocalPlaneResolutionUnit&#39;</span><span class="p">,</span>
            <span class="mi">37393</span><span class="p">:</span> <span class="s1">&#39;ImageNumber&#39;</span><span class="p">,</span>
            <span class="mi">37394</span><span class="p">:</span> <span class="s1">&#39;SecurityClassification&#39;</span><span class="p">,</span>
            <span class="mi">37395</span><span class="p">:</span> <span class="s1">&#39;ImageHistory&#39;</span><span class="p">,</span>
            <span class="mi">37396</span><span class="p">:</span> <span class="s1">&#39;SubjectLocation&#39;</span><span class="p">,</span>
            <span class="mi">37397</span><span class="p">:</span> <span class="s1">&#39;ExposureIndex&#39;</span><span class="p">,</span>
            <span class="mi">37398</span><span class="p">:</span> <span class="s1">&#39;TIFFEPStandardID&#39;</span><span class="p">,</span>
            <span class="mi">37399</span><span class="p">:</span> <span class="s1">&#39;SensingMethod&#39;</span><span class="p">,</span>
            <span class="mi">37434</span><span class="p">:</span> <span class="s1">&#39;CIP3DataFile&#39;</span><span class="p">,</span>
            <span class="mi">37435</span><span class="p">:</span> <span class="s1">&#39;CIP3Sheet&#39;</span><span class="p">,</span>
            <span class="mi">37436</span><span class="p">:</span> <span class="s1">&#39;CIP3Side&#39;</span><span class="p">,</span>
            <span class="mi">37439</span><span class="p">:</span> <span class="s1">&#39;StoNits&#39;</span><span class="p">,</span>
            <span class="mi">37500</span><span class="p">:</span> <span class="s1">&#39;MakerNote&#39;</span><span class="p">,</span>
            <span class="mi">37510</span><span class="p">:</span> <span class="s1">&#39;UserComment&#39;</span><span class="p">,</span>
            <span class="mi">37520</span><span class="p">:</span> <span class="s1">&#39;SubsecTime&#39;</span><span class="p">,</span>
            <span class="mi">37521</span><span class="p">:</span> <span class="s1">&#39;SubsecTimeOriginal&#39;</span><span class="p">,</span>
            <span class="mi">37522</span><span class="p">:</span> <span class="s1">&#39;SubsecTimeDigitized&#39;</span><span class="p">,</span>
            <span class="mi">37679</span><span class="p">:</span> <span class="s1">&#39;MODIText&#39;</span><span class="p">,</span>  <span class="c1"># Microsoft Office Document Imaging</span>
            <span class="mi">37680</span><span class="p">:</span> <span class="s1">&#39;MODIOLEPropertySetStorage&#39;</span><span class="p">,</span>
            <span class="mi">37681</span><span class="p">:</span> <span class="s1">&#39;MODIPositioning&#39;</span><span class="p">,</span>
            <span class="mi">37706</span><span class="p">:</span> <span class="s1">&#39;TVIPS&#39;</span><span class="p">,</span>  <span class="c1"># offset to TemData structure</span>
            <span class="mi">37707</span><span class="p">:</span> <span class="s1">&#39;TVIPS1&#39;</span><span class="p">,</span>
            <span class="mi">37708</span><span class="p">:</span> <span class="s1">&#39;TVIPS2&#39;</span><span class="p">,</span>  <span class="c1"># same TemData structure as undefined</span>
            <span class="mi">37724</span><span class="p">:</span> <span class="s1">&#39;ImageSourceData&#39;</span><span class="p">,</span>  <span class="c1"># Photoshop</span>
            <span class="mi">37888</span><span class="p">:</span> <span class="s1">&#39;Temperature&#39;</span><span class="p">,</span>
            <span class="mi">37889</span><span class="p">:</span> <span class="s1">&#39;Humidity&#39;</span><span class="p">,</span>
            <span class="mi">37890</span><span class="p">:</span> <span class="s1">&#39;Pressure&#39;</span><span class="p">,</span>
            <span class="mi">37891</span><span class="p">:</span> <span class="s1">&#39;WaterDepth&#39;</span><span class="p">,</span>
            <span class="mi">37892</span><span class="p">:</span> <span class="s1">&#39;Acceleration&#39;</span><span class="p">,</span>
            <span class="mi">37893</span><span class="p">:</span> <span class="s1">&#39;CameraElevationAngle&#39;</span><span class="p">,</span>
            <span class="mi">40001</span><span class="p">:</span> <span class="s1">&#39;MC_IpWinScal&#39;</span><span class="p">,</span>  <span class="c1"># Media Cybernetics</span>
            <span class="mi">40100</span><span class="p">:</span> <span class="s1">&#39;MC_IdOld&#39;</span><span class="p">,</span>
            <span class="mi">40965</span><span class="p">:</span> <span class="s1">&#39;InteroperabilityTag&#39;</span><span class="p">,</span>  <span class="c1"># InteropOffset</span>
            <span class="mi">40091</span><span class="p">:</span> <span class="s1">&#39;XPTitle&#39;</span><span class="p">,</span>
            <span class="mi">40092</span><span class="p">:</span> <span class="s1">&#39;XPComment&#39;</span><span class="p">,</span>
            <span class="mi">40093</span><span class="p">:</span> <span class="s1">&#39;XPAuthor&#39;</span><span class="p">,</span>
            <span class="mi">40094</span><span class="p">:</span> <span class="s1">&#39;XPKeywords&#39;</span><span class="p">,</span>
            <span class="mi">40095</span><span class="p">:</span> <span class="s1">&#39;XPSubject&#39;</span><span class="p">,</span>
            <span class="mi">40960</span><span class="p">:</span> <span class="s1">&#39;FlashpixVersion&#39;</span><span class="p">,</span>
            <span class="mi">40961</span><span class="p">:</span> <span class="s1">&#39;ColorSpace&#39;</span><span class="p">,</span>
            <span class="mi">40962</span><span class="p">:</span> <span class="s1">&#39;PixelXDimension&#39;</span><span class="p">,</span>
            <span class="mi">40963</span><span class="p">:</span> <span class="s1">&#39;PixelYDimension&#39;</span><span class="p">,</span>
            <span class="mi">40964</span><span class="p">:</span> <span class="s1">&#39;RelatedSoundFile&#39;</span><span class="p">,</span>
            <span class="mi">40976</span><span class="p">:</span> <span class="s1">&#39;SamsungRawPointersOffset&#39;</span><span class="p">,</span>
            <span class="mi">40977</span><span class="p">:</span> <span class="s1">&#39;SamsungRawPointersLength&#39;</span><span class="p">,</span>
            <span class="mi">41217</span><span class="p">:</span> <span class="s1">&#39;SamsungRawByteOrder&#39;</span><span class="p">,</span>
            <span class="mi">41218</span><span class="p">:</span> <span class="s1">&#39;SamsungRawUnknown&#39;</span><span class="p">,</span>
            <span class="mi">41483</span><span class="p">:</span> <span class="s1">&#39;FlashEnergy&#39;</span><span class="p">,</span>
            <span class="mi">41484</span><span class="p">:</span> <span class="s1">&#39;SpatialFrequencyResponse&#39;</span><span class="p">,</span>
            <span class="mi">41485</span><span class="p">:</span> <span class="s1">&#39;Noise_&#39;</span><span class="p">,</span>  <span class="c1"># 37389</span>
            <span class="mi">41486</span><span class="p">:</span> <span class="s1">&#39;FocalPlaneXResolution_&#39;</span><span class="p">,</span>  <span class="c1"># 37390</span>
            <span class="mi">41487</span><span class="p">:</span> <span class="s1">&#39;FocalPlaneYResolution_&#39;</span><span class="p">,</span>  <span class="c1"># 37391</span>
            <span class="mi">41488</span><span class="p">:</span> <span class="s1">&#39;FocalPlaneResolutionUnit_&#39;</span><span class="p">,</span>  <span class="c1"># 37392</span>
            <span class="mi">41489</span><span class="p">:</span> <span class="s1">&#39;ImageNumber_&#39;</span><span class="p">,</span>  <span class="c1"># 37393</span>
            <span class="mi">41490</span><span class="p">:</span> <span class="s1">&#39;SecurityClassification_&#39;</span><span class="p">,</span>  <span class="c1"># 37394</span>
            <span class="mi">41491</span><span class="p">:</span> <span class="s1">&#39;ImageHistory_&#39;</span><span class="p">,</span>  <span class="c1"># 37395</span>
            <span class="mi">41492</span><span class="p">:</span> <span class="s1">&#39;SubjectLocation_&#39;</span><span class="p">,</span>  <span class="c1"># 37395</span>
            <span class="mi">41493</span><span class="p">:</span> <span class="s1">&#39;ExposureIndex_ &#39;</span><span class="p">,</span>  <span class="c1"># 37397</span>
            <span class="mi">41494</span><span class="p">:</span> <span class="s1">&#39;TIFF-EPStandardID&#39;</span><span class="p">,</span>
            <span class="mi">41495</span><span class="p">:</span> <span class="s1">&#39;SensingMethod_&#39;</span><span class="p">,</span>  <span class="c1"># 37399</span>
            <span class="mi">41728</span><span class="p">:</span> <span class="s1">&#39;FileSource&#39;</span><span class="p">,</span>
            <span class="mi">41729</span><span class="p">:</span> <span class="s1">&#39;SceneType&#39;</span><span class="p">,</span>
            <span class="mi">41730</span><span class="p">:</span> <span class="s1">&#39;CFAPattern_&#39;</span><span class="p">,</span>  <span class="c1"># 33422</span>
            <span class="mi">41985</span><span class="p">:</span> <span class="s1">&#39;CustomRendered&#39;</span><span class="p">,</span>
            <span class="mi">41986</span><span class="p">:</span> <span class="s1">&#39;ExposureMode&#39;</span><span class="p">,</span>
            <span class="mi">41987</span><span class="p">:</span> <span class="s1">&#39;WhiteBalance&#39;</span><span class="p">,</span>
            <span class="mi">41988</span><span class="p">:</span> <span class="s1">&#39;DigitalZoomRatio&#39;</span><span class="p">,</span>
            <span class="mi">41989</span><span class="p">:</span> <span class="s1">&#39;FocalLengthIn35mmFilm&#39;</span><span class="p">,</span>
            <span class="mi">41990</span><span class="p">:</span> <span class="s1">&#39;SceneCaptureType&#39;</span><span class="p">,</span>
            <span class="mi">41991</span><span class="p">:</span> <span class="s1">&#39;GainControl&#39;</span><span class="p">,</span>
            <span class="mi">41992</span><span class="p">:</span> <span class="s1">&#39;Contrast&#39;</span><span class="p">,</span>
            <span class="mi">41993</span><span class="p">:</span> <span class="s1">&#39;Saturation&#39;</span><span class="p">,</span>
            <span class="mi">41994</span><span class="p">:</span> <span class="s1">&#39;Sharpness&#39;</span><span class="p">,</span>
            <span class="mi">41995</span><span class="p">:</span> <span class="s1">&#39;DeviceSettingDescription&#39;</span><span class="p">,</span>
            <span class="mi">41996</span><span class="p">:</span> <span class="s1">&#39;SubjectDistanceRange&#39;</span><span class="p">,</span>
            <span class="mi">42016</span><span class="p">:</span> <span class="s1">&#39;ImageUniqueID&#39;</span><span class="p">,</span>
            <span class="mi">42032</span><span class="p">:</span> <span class="s1">&#39;CameraOwnerName&#39;</span><span class="p">,</span>
            <span class="mi">42033</span><span class="p">:</span> <span class="s1">&#39;BodySerialNumber&#39;</span><span class="p">,</span>
            <span class="mi">42034</span><span class="p">:</span> <span class="s1">&#39;LensSpecification&#39;</span><span class="p">,</span>
            <span class="mi">42035</span><span class="p">:</span> <span class="s1">&#39;LensMake&#39;</span><span class="p">,</span>
            <span class="mi">42036</span><span class="p">:</span> <span class="s1">&#39;LensModel&#39;</span><span class="p">,</span>
            <span class="mi">42037</span><span class="p">:</span> <span class="s1">&#39;LensSerialNumber&#39;</span><span class="p">,</span>
            <span class="mi">42112</span><span class="p">:</span> <span class="s1">&#39;GDAL_METADATA&#39;</span><span class="p">,</span>
            <span class="mi">42113</span><span class="p">:</span> <span class="s1">&#39;GDAL_NODATA&#39;</span><span class="p">,</span>
            <span class="mi">42240</span><span class="p">:</span> <span class="s1">&#39;Gamma&#39;</span><span class="p">,</span>
            <span class="mi">43314</span><span class="p">:</span> <span class="s1">&#39;NIHImageHeader&#39;</span><span class="p">,</span>
            <span class="mi">44992</span><span class="p">:</span> <span class="s1">&#39;ExpandSoftware&#39;</span><span class="p">,</span>
            <span class="mi">44993</span><span class="p">:</span> <span class="s1">&#39;ExpandLens&#39;</span><span class="p">,</span>
            <span class="mi">44994</span><span class="p">:</span> <span class="s1">&#39;ExpandFilm&#39;</span><span class="p">,</span>
            <span class="mi">44995</span><span class="p">:</span> <span class="s1">&#39;ExpandFilterLens&#39;</span><span class="p">,</span>
            <span class="mi">44996</span><span class="p">:</span> <span class="s1">&#39;ExpandScanner&#39;</span><span class="p">,</span>
            <span class="mi">44997</span><span class="p">:</span> <span class="s1">&#39;ExpandFlashLamp&#39;</span><span class="p">,</span>
            <span class="mi">48129</span><span class="p">:</span> <span class="s1">&#39;PixelFormat&#39;</span><span class="p">,</span>  <span class="c1"># HDP and WDP</span>
            <span class="mi">48130</span><span class="p">:</span> <span class="s1">&#39;Transformation&#39;</span><span class="p">,</span>
            <span class="mi">48131</span><span class="p">:</span> <span class="s1">&#39;Uncompressed&#39;</span><span class="p">,</span>
            <span class="mi">48132</span><span class="p">:</span> <span class="s1">&#39;ImageType&#39;</span><span class="p">,</span>
            <span class="mi">48256</span><span class="p">:</span> <span class="s1">&#39;ImageWidth_&#39;</span><span class="p">,</span>  <span class="c1"># 256</span>
            <span class="mi">48257</span><span class="p">:</span> <span class="s1">&#39;ImageHeight_&#39;</span><span class="p">,</span>
            <span class="mi">48258</span><span class="p">:</span> <span class="s1">&#39;WidthResolution&#39;</span><span class="p">,</span>
            <span class="mi">48259</span><span class="p">:</span> <span class="s1">&#39;HeightResolution&#39;</span><span class="p">,</span>
            <span class="mi">48320</span><span class="p">:</span> <span class="s1">&#39;ImageOffset&#39;</span><span class="p">,</span>
            <span class="mi">48321</span><span class="p">:</span> <span class="s1">&#39;ImageByteCount&#39;</span><span class="p">,</span>
            <span class="mi">48322</span><span class="p">:</span> <span class="s1">&#39;AlphaOffset&#39;</span><span class="p">,</span>
            <span class="mi">48323</span><span class="p">:</span> <span class="s1">&#39;AlphaByteCount&#39;</span><span class="p">,</span>
            <span class="mi">48324</span><span class="p">:</span> <span class="s1">&#39;ImageDataDiscard&#39;</span><span class="p">,</span>
            <span class="mi">48325</span><span class="p">:</span> <span class="s1">&#39;AlphaDataDiscard&#39;</span><span class="p">,</span>
            <span class="mi">50215</span><span class="p">:</span> <span class="s1">&#39;OceScanjobDescription&#39;</span><span class="p">,</span>
            <span class="mi">50216</span><span class="p">:</span> <span class="s1">&#39;OceApplicationSelector&#39;</span><span class="p">,</span>
            <span class="mi">50217</span><span class="p">:</span> <span class="s1">&#39;OceIdentificationNumber&#39;</span><span class="p">,</span>
            <span class="mi">50218</span><span class="p">:</span> <span class="s1">&#39;OceImageLogicCharacteristics&#39;</span><span class="p">,</span>
            <span class="mi">50255</span><span class="p">:</span> <span class="s1">&#39;Annotations&#39;</span><span class="p">,</span>
            <span class="mi">50288</span><span class="p">:</span> <span class="s1">&#39;MC_Id&#39;</span><span class="p">,</span>  <span class="c1"># Media Cybernetics</span>
            <span class="mi">50289</span><span class="p">:</span> <span class="s1">&#39;MC_XYPosition&#39;</span><span class="p">,</span>
            <span class="mi">50290</span><span class="p">:</span> <span class="s1">&#39;MC_ZPosition&#39;</span><span class="p">,</span>
            <span class="mi">50291</span><span class="p">:</span> <span class="s1">&#39;MC_XYCalibration&#39;</span><span class="p">,</span>
            <span class="mi">50292</span><span class="p">:</span> <span class="s1">&#39;MC_LensCharacteristics&#39;</span><span class="p">,</span>
            <span class="mi">50293</span><span class="p">:</span> <span class="s1">&#39;MC_ChannelName&#39;</span><span class="p">,</span>
            <span class="mi">50294</span><span class="p">:</span> <span class="s1">&#39;MC_ExcitationWavelength&#39;</span><span class="p">,</span>
            <span class="mi">50295</span><span class="p">:</span> <span class="s1">&#39;MC_TimeStamp&#39;</span><span class="p">,</span>
            <span class="mi">50296</span><span class="p">:</span> <span class="s1">&#39;MC_FrameProperties&#39;</span><span class="p">,</span>
            <span class="mi">50341</span><span class="p">:</span> <span class="s1">&#39;PrintImageMatching&#39;</span><span class="p">,</span>
            <span class="mi">50495</span><span class="p">:</span> <span class="s1">&#39;PCO_RAW&#39;</span><span class="p">,</span>  <span class="c1"># TODO: PCO CamWare</span>
            <span class="mi">50547</span><span class="p">:</span> <span class="s1">&#39;OriginalFileName&#39;</span><span class="p">,</span>
            <span class="mi">50560</span><span class="p">:</span> <span class="s1">&#39;USPTO_OriginalContentType&#39;</span><span class="p">,</span>  <span class="c1"># US Patent Office</span>
            <span class="mi">50561</span><span class="p">:</span> <span class="s1">&#39;USPTO_RotationCode&#39;</span><span class="p">,</span>
            <span class="mi">50656</span><span class="p">:</span> <span class="s1">&#39;CR2CFAPattern&#39;</span><span class="p">,</span>
            <span class="mi">50706</span><span class="p">:</span> <span class="s1">&#39;DNGVersion&#39;</span><span class="p">,</span>  <span class="c1"># DNG 50706 .. 51112</span>
            <span class="mi">50707</span><span class="p">:</span> <span class="s1">&#39;DNGBackwardVersion&#39;</span><span class="p">,</span>
            <span class="mi">50708</span><span class="p">:</span> <span class="s1">&#39;UniqueCameraModel&#39;</span><span class="p">,</span>
            <span class="mi">50709</span><span class="p">:</span> <span class="s1">&#39;LocalizedCameraModel&#39;</span><span class="p">,</span>
            <span class="mi">50710</span><span class="p">:</span> <span class="s1">&#39;CFAPlaneColor&#39;</span><span class="p">,</span>
            <span class="mi">50711</span><span class="p">:</span> <span class="s1">&#39;CFALayout&#39;</span><span class="p">,</span>
            <span class="mi">50712</span><span class="p">:</span> <span class="s1">&#39;LinearizationTable&#39;</span><span class="p">,</span>
            <span class="mi">50713</span><span class="p">:</span> <span class="s1">&#39;BlackLevelRepeatDim&#39;</span><span class="p">,</span>
            <span class="mi">50714</span><span class="p">:</span> <span class="s1">&#39;BlackLevel&#39;</span><span class="p">,</span>
            <span class="mi">50715</span><span class="p">:</span> <span class="s1">&#39;BlackLevelDeltaH&#39;</span><span class="p">,</span>
            <span class="mi">50716</span><span class="p">:</span> <span class="s1">&#39;BlackLevelDeltaV&#39;</span><span class="p">,</span>
            <span class="mi">50717</span><span class="p">:</span> <span class="s1">&#39;WhiteLevel&#39;</span><span class="p">,</span>
            <span class="mi">50718</span><span class="p">:</span> <span class="s1">&#39;DefaultScale&#39;</span><span class="p">,</span>
            <span class="mi">50719</span><span class="p">:</span> <span class="s1">&#39;DefaultCropOrigin&#39;</span><span class="p">,</span>
            <span class="mi">50720</span><span class="p">:</span> <span class="s1">&#39;DefaultCropSize&#39;</span><span class="p">,</span>
            <span class="mi">50721</span><span class="p">:</span> <span class="s1">&#39;ColorMatrix1&#39;</span><span class="p">,</span>
            <span class="mi">50722</span><span class="p">:</span> <span class="s1">&#39;ColorMatrix2&#39;</span><span class="p">,</span>
            <span class="mi">50723</span><span class="p">:</span> <span class="s1">&#39;CameraCalibration1&#39;</span><span class="p">,</span>
            <span class="mi">50724</span><span class="p">:</span> <span class="s1">&#39;CameraCalibration2&#39;</span><span class="p">,</span>
            <span class="mi">50725</span><span class="p">:</span> <span class="s1">&#39;ReductionMatrix1&#39;</span><span class="p">,</span>
            <span class="mi">50726</span><span class="p">:</span> <span class="s1">&#39;ReductionMatrix2&#39;</span><span class="p">,</span>
            <span class="mi">50727</span><span class="p">:</span> <span class="s1">&#39;AnalogBalance&#39;</span><span class="p">,</span>
            <span class="mi">50728</span><span class="p">:</span> <span class="s1">&#39;AsShotNeutral&#39;</span><span class="p">,</span>
            <span class="mi">50729</span><span class="p">:</span> <span class="s1">&#39;AsShotWhiteXY&#39;</span><span class="p">,</span>
            <span class="mi">50730</span><span class="p">:</span> <span class="s1">&#39;BaselineExposure&#39;</span><span class="p">,</span>
            <span class="mi">50731</span><span class="p">:</span> <span class="s1">&#39;BaselineNoise&#39;</span><span class="p">,</span>
            <span class="mi">50732</span><span class="p">:</span> <span class="s1">&#39;BaselineSharpness&#39;</span><span class="p">,</span>
            <span class="mi">50733</span><span class="p">:</span> <span class="s1">&#39;BayerGreenSplit&#39;</span><span class="p">,</span>
            <span class="mi">50734</span><span class="p">:</span> <span class="s1">&#39;LinearResponseLimit&#39;</span><span class="p">,</span>
            <span class="mi">50735</span><span class="p">:</span> <span class="s1">&#39;CameraSerialNumber&#39;</span><span class="p">,</span>
            <span class="mi">50736</span><span class="p">:</span> <span class="s1">&#39;LensInfo&#39;</span><span class="p">,</span>
            <span class="mi">50737</span><span class="p">:</span> <span class="s1">&#39;ChromaBlurRadius&#39;</span><span class="p">,</span>
            <span class="mi">50738</span><span class="p">:</span> <span class="s1">&#39;AntiAliasStrength&#39;</span><span class="p">,</span>
            <span class="mi">50739</span><span class="p">:</span> <span class="s1">&#39;ShadowScale&#39;</span><span class="p">,</span>
            <span class="mi">50740</span><span class="p">:</span> <span class="s1">&#39;DNGPrivateData&#39;</span><span class="p">,</span>
            <span class="mi">50741</span><span class="p">:</span> <span class="s1">&#39;MakerNoteSafety&#39;</span><span class="p">,</span>
            <span class="mi">50752</span><span class="p">:</span> <span class="s1">&#39;RawImageSegmentation&#39;</span><span class="p">,</span>
            <span class="mi">50778</span><span class="p">:</span> <span class="s1">&#39;CalibrationIlluminant1&#39;</span><span class="p">,</span>
            <span class="mi">50779</span><span class="p">:</span> <span class="s1">&#39;CalibrationIlluminant2&#39;</span><span class="p">,</span>
            <span class="mi">50780</span><span class="p">:</span> <span class="s1">&#39;BestQualityScale&#39;</span><span class="p">,</span>
            <span class="mi">50781</span><span class="p">:</span> <span class="s1">&#39;RawDataUniqueID&#39;</span><span class="p">,</span>
            <span class="mi">50784</span><span class="p">:</span> <span class="s1">&#39;AliasLayerMetadata&#39;</span><span class="p">,</span>
            <span class="mi">50827</span><span class="p">:</span> <span class="s1">&#39;OriginalRawFileName&#39;</span><span class="p">,</span>
            <span class="mi">50828</span><span class="p">:</span> <span class="s1">&#39;OriginalRawFileData&#39;</span><span class="p">,</span>
            <span class="mi">50829</span><span class="p">:</span> <span class="s1">&#39;ActiveArea&#39;</span><span class="p">,</span>
            <span class="mi">50830</span><span class="p">:</span> <span class="s1">&#39;MaskedAreas&#39;</span><span class="p">,</span>
            <span class="mi">50831</span><span class="p">:</span> <span class="s1">&#39;AsShotICCProfile&#39;</span><span class="p">,</span>
            <span class="mi">50832</span><span class="p">:</span> <span class="s1">&#39;AsShotPreProfileMatrix&#39;</span><span class="p">,</span>
            <span class="mi">50833</span><span class="p">:</span> <span class="s1">&#39;CurrentICCProfile&#39;</span><span class="p">,</span>
            <span class="mi">50834</span><span class="p">:</span> <span class="s1">&#39;CurrentPreProfileMatrix&#39;</span><span class="p">,</span>
            <span class="mi">50838</span><span class="p">:</span> <span class="s1">&#39;IJMetadataByteCounts&#39;</span><span class="p">,</span>
            <span class="mi">50839</span><span class="p">:</span> <span class="s1">&#39;IJMetadata&#39;</span><span class="p">,</span>
            <span class="mi">50844</span><span class="p">:</span> <span class="s1">&#39;RPCCoefficientTag&#39;</span><span class="p">,</span>
            <span class="mi">50879</span><span class="p">:</span> <span class="s1">&#39;ColorimetricReference&#39;</span><span class="p">,</span>
            <span class="mi">50885</span><span class="p">:</span> <span class="s1">&#39;SRawType&#39;</span><span class="p">,</span>
            <span class="mi">50898</span><span class="p">:</span> <span class="s1">&#39;PanasonicTitle&#39;</span><span class="p">,</span>
            <span class="mi">50899</span><span class="p">:</span> <span class="s1">&#39;PanasonicTitle2&#39;</span><span class="p">,</span>
            <span class="mi">50931</span><span class="p">:</span> <span class="s1">&#39;CameraCalibrationSignature&#39;</span><span class="p">,</span>
            <span class="mi">50932</span><span class="p">:</span> <span class="s1">&#39;ProfileCalibrationSignature&#39;</span><span class="p">,</span>
            <span class="mi">50933</span><span class="p">:</span> <span class="s1">&#39;ProfileIFD&#39;</span><span class="p">,</span>
            <span class="mi">50934</span><span class="p">:</span> <span class="s1">&#39;AsShotProfileName&#39;</span><span class="p">,</span>
            <span class="mi">50935</span><span class="p">:</span> <span class="s1">&#39;NoiseReductionApplied&#39;</span><span class="p">,</span>
            <span class="mi">50936</span><span class="p">:</span> <span class="s1">&#39;ProfileName&#39;</span><span class="p">,</span>
            <span class="mi">50937</span><span class="p">:</span> <span class="s1">&#39;ProfileHueSatMapDims&#39;</span><span class="p">,</span>
            <span class="mi">50938</span><span class="p">:</span> <span class="s1">&#39;ProfileHueSatMapData1&#39;</span><span class="p">,</span>
            <span class="mi">50939</span><span class="p">:</span> <span class="s1">&#39;ProfileHueSatMapData2&#39;</span><span class="p">,</span>
            <span class="mi">50940</span><span class="p">:</span> <span class="s1">&#39;ProfileToneCurve&#39;</span><span class="p">,</span>
            <span class="mi">50941</span><span class="p">:</span> <span class="s1">&#39;ProfileEmbedPolicy&#39;</span><span class="p">,</span>
            <span class="mi">50942</span><span class="p">:</span> <span class="s1">&#39;ProfileCopyright&#39;</span><span class="p">,</span>
            <span class="mi">50964</span><span class="p">:</span> <span class="s1">&#39;ForwardMatrix1&#39;</span><span class="p">,</span>
            <span class="mi">50965</span><span class="p">:</span> <span class="s1">&#39;ForwardMatrix2&#39;</span><span class="p">,</span>
            <span class="mi">50966</span><span class="p">:</span> <span class="s1">&#39;PreviewApplicationName&#39;</span><span class="p">,</span>
            <span class="mi">50967</span><span class="p">:</span> <span class="s1">&#39;PreviewApplicationVersion&#39;</span><span class="p">,</span>
            <span class="mi">50968</span><span class="p">:</span> <span class="s1">&#39;PreviewSettingsName&#39;</span><span class="p">,</span>
            <span class="mi">50969</span><span class="p">:</span> <span class="s1">&#39;PreviewSettingsDigest&#39;</span><span class="p">,</span>
            <span class="mi">50970</span><span class="p">:</span> <span class="s1">&#39;PreviewColorSpace&#39;</span><span class="p">,</span>
            <span class="mi">50971</span><span class="p">:</span> <span class="s1">&#39;PreviewDateTime&#39;</span><span class="p">,</span>
            <span class="mi">50972</span><span class="p">:</span> <span class="s1">&#39;RawImageDigest&#39;</span><span class="p">,</span>
            <span class="mi">50973</span><span class="p">:</span> <span class="s1">&#39;OriginalRawFileDigest&#39;</span><span class="p">,</span>
            <span class="mi">50974</span><span class="p">:</span> <span class="s1">&#39;SubTileBlockSize&#39;</span><span class="p">,</span>
            <span class="mi">50975</span><span class="p">:</span> <span class="s1">&#39;RowInterleaveFactor&#39;</span><span class="p">,</span>
            <span class="mi">50981</span><span class="p">:</span> <span class="s1">&#39;ProfileLookTableDims&#39;</span><span class="p">,</span>
            <span class="mi">50982</span><span class="p">:</span> <span class="s1">&#39;ProfileLookTableData&#39;</span><span class="p">,</span>
            <span class="mi">51008</span><span class="p">:</span> <span class="s1">&#39;OpcodeList1&#39;</span><span class="p">,</span>
            <span class="mi">51009</span><span class="p">:</span> <span class="s1">&#39;OpcodeList2&#39;</span><span class="p">,</span>
            <span class="mi">51022</span><span class="p">:</span> <span class="s1">&#39;OpcodeList3&#39;</span><span class="p">,</span>
            <span class="mi">51023</span><span class="p">:</span> <span class="s1">&#39;FibicsXML&#39;</span><span class="p">,</span>  <span class="c1">#</span>
            <span class="mi">51041</span><span class="p">:</span> <span class="s1">&#39;NoiseProfile&#39;</span><span class="p">,</span>
            <span class="mi">51043</span><span class="p">:</span> <span class="s1">&#39;TimeCodes&#39;</span><span class="p">,</span>
            <span class="mi">51044</span><span class="p">:</span> <span class="s1">&#39;FrameRate&#39;</span><span class="p">,</span>
            <span class="mi">51058</span><span class="p">:</span> <span class="s1">&#39;TStop&#39;</span><span class="p">,</span>
            <span class="mi">51081</span><span class="p">:</span> <span class="s1">&#39;ReelName&#39;</span><span class="p">,</span>
            <span class="mi">51089</span><span class="p">:</span> <span class="s1">&#39;OriginalDefaultFinalSize&#39;</span><span class="p">,</span>
            <span class="mi">51090</span><span class="p">:</span> <span class="s1">&#39;OriginalBestQualitySize&#39;</span><span class="p">,</span>
            <span class="mi">51091</span><span class="p">:</span> <span class="s1">&#39;OriginalDefaultCropSize&#39;</span><span class="p">,</span>
            <span class="mi">51105</span><span class="p">:</span> <span class="s1">&#39;CameraLabel&#39;</span><span class="p">,</span>
            <span class="mi">51107</span><span class="p">:</span> <span class="s1">&#39;ProfileHueSatMapEncoding&#39;</span><span class="p">,</span>
            <span class="mi">51108</span><span class="p">:</span> <span class="s1">&#39;ProfileLookTableEncoding&#39;</span><span class="p">,</span>
            <span class="mi">51109</span><span class="p">:</span> <span class="s1">&#39;BaselineExposureOffset&#39;</span><span class="p">,</span>
            <span class="mi">51110</span><span class="p">:</span> <span class="s1">&#39;DefaultBlackRender&#39;</span><span class="p">,</span>
            <span class="mi">51111</span><span class="p">:</span> <span class="s1">&#39;NewRawImageDigest&#39;</span><span class="p">,</span>
            <span class="mi">51112</span><span class="p">:</span> <span class="s1">&#39;RawToPreviewGain&#39;</span><span class="p">,</span>
            <span class="mi">51125</span><span class="p">:</span> <span class="s1">&#39;DefaultUserCrop&#39;</span><span class="p">,</span>
            <span class="mi">51123</span><span class="p">:</span> <span class="s1">&#39;MicroManagerMetadata&#39;</span><span class="p">,</span>
            <span class="mi">59932</span><span class="p">:</span> <span class="s1">&#39;Padding&#39;</span><span class="p">,</span>
            <span class="mi">59933</span><span class="p">:</span> <span class="s1">&#39;OffsetSchema&#39;</span><span class="p">,</span>
            <span class="c1"># Reusable Tags 65000-65535</span>
            <span class="c1"># 65000:  Dimap_Document XML</span>
            <span class="c1"># 65000-65112:  Photoshop Camera RAW EXIF tags</span>
            <span class="c1"># 65000: &#39;OwnerName&#39;,</span>
            <span class="c1"># 65001: &#39;SerialNumber&#39;,</span>
            <span class="c1"># 65002: &#39;Lens&#39;,</span>
            <span class="c1"># 65024: &#39;KDC_IFD&#39;,</span>
            <span class="c1"># 65100: &#39;RawFile&#39;,</span>
            <span class="c1"># 65101: &#39;Converter&#39;,</span>
            <span class="c1"># 65102: &#39;WhiteBalance&#39;,</span>
            <span class="c1"># 65105: &#39;Exposure&#39;,</span>
            <span class="c1"># 65106: &#39;Shadows&#39;,</span>
            <span class="c1"># 65107: &#39;Brightness&#39;,</span>
            <span class="c1"># 65108: &#39;Contrast&#39;,</span>
            <span class="c1"># 65109: &#39;Saturation&#39;,</span>
            <span class="c1"># 65110: &#39;Sharpness&#39;,</span>
            <span class="c1"># 65111: &#39;Smoothness&#39;,</span>
            <span class="c1"># 65112: &#39;MoireFilter&#39;,</span>
            <span class="mi">65200</span><span class="p">:</span> <span class="s1">&#39;FlexXML&#39;</span><span class="p">,</span>  <span class="c1">#</span>
            <span class="mi">65563</span><span class="p">:</span> <span class="s1">&#39;PerSample&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">TAG_NAMES</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAGS</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">TAG_READERS</span><span class="p">():</span>
        <span class="c1"># Map TIFF tag codes to import functions</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="mi">320</span><span class="p">:</span> <span class="n">read_colormap</span><span class="p">,</span>
            <span class="c1"># 700: read_bytes,  # read_utf8,</span>
            <span class="c1"># 34377: read_bytes,</span>
            <span class="mi">33723</span><span class="p">:</span> <span class="n">read_bytes</span><span class="p">,</span>
            <span class="c1"># 34675: read_bytes,</span>
            <span class="mi">33628</span><span class="p">:</span> <span class="n">read_uic1tag</span><span class="p">,</span>  <span class="c1"># Universal Imaging Corp STK</span>
            <span class="mi">33629</span><span class="p">:</span> <span class="n">read_uic2tag</span><span class="p">,</span>
            <span class="mi">33630</span><span class="p">:</span> <span class="n">read_uic3tag</span><span class="p">,</span>
            <span class="mi">33631</span><span class="p">:</span> <span class="n">read_uic4tag</span><span class="p">,</span>
            <span class="mi">34118</span><span class="p">:</span> <span class="n">read_cz_sem</span><span class="p">,</span>  <span class="c1"># Carl Zeiss SEM</span>
            <span class="mi">34361</span><span class="p">:</span> <span class="n">read_mm_header</span><span class="p">,</span>  <span class="c1"># Olympus FluoView</span>
            <span class="mi">34362</span><span class="p">:</span> <span class="n">read_mm_stamp</span><span class="p">,</span>
            <span class="mi">34363</span><span class="p">:</span> <span class="n">read_numpy</span><span class="p">,</span>  <span class="c1"># MM_Unknown</span>
            <span class="mi">34386</span><span class="p">:</span> <span class="n">read_numpy</span><span class="p">,</span>  <span class="c1"># MM_UserBlock</span>
            <span class="mi">34412</span><span class="p">:</span> <span class="n">read_cz_lsminfo</span><span class="p">,</span>  <span class="c1"># Carl Zeiss LSM</span>
            <span class="mi">34680</span><span class="p">:</span> <span class="n">read_fei_metadata</span><span class="p">,</span>  <span class="c1"># S-FEG</span>
            <span class="mi">34682</span><span class="p">:</span> <span class="n">read_fei_metadata</span><span class="p">,</span>  <span class="c1"># Helios NanoLab</span>
            <span class="mi">37706</span><span class="p">:</span> <span class="n">read_tvips_header</span><span class="p">,</span>  <span class="c1"># TVIPS EMMENU</span>
            <span class="mi">37724</span><span class="p">:</span> <span class="n">read_bytes</span><span class="p">,</span>  <span class="c1"># ImageSourceData</span>
            <span class="mi">33923</span><span class="p">:</span> <span class="n">read_bytes</span><span class="p">,</span>  <span class="c1"># read_leica_magic</span>
            <span class="mi">43314</span><span class="p">:</span> <span class="n">read_nih_image_header</span><span class="p">,</span>
            <span class="c1"># 40001: read_bytes,</span>
            <span class="mi">40100</span><span class="p">:</span> <span class="n">read_bytes</span><span class="p">,</span>
            <span class="mi">50288</span><span class="p">:</span> <span class="n">read_bytes</span><span class="p">,</span>
            <span class="mi">50296</span><span class="p">:</span> <span class="n">read_bytes</span><span class="p">,</span>
            <span class="mi">50839</span><span class="p">:</span> <span class="n">read_bytes</span><span class="p">,</span>
            <span class="mi">51123</span><span class="p">:</span> <span class="n">read_json</span><span class="p">,</span>
            <span class="mi">34665</span><span class="p">:</span> <span class="n">read_exif_ifd</span><span class="p">,</span>
            <span class="mi">34853</span><span class="p">:</span> <span class="n">read_gps_ifd</span><span class="p">,</span>
            <span class="mi">40965</span><span class="p">:</span> <span class="n">read_interoperability_ifd</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">TAG_TUPLE</span><span class="p">():</span>
        <span class="c1"># Tags whose values must be stored as tuples</span>
        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">((</span><span class="mi">273</span><span class="p">,</span> <span class="mi">279</span><span class="p">,</span> <span class="mi">324</span><span class="p">,</span> <span class="mi">325</span><span class="p">,</span> <span class="mi">530</span><span class="p">,</span> <span class="mi">531</span><span class="p">,</span> <span class="mi">34736</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">TAG_ATTRIBUTES</span><span class="p">():</span>
        <span class="c1">#  Map tag codes to TiffPage attribute names</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;ImageWidth&#39;</span><span class="p">:</span> <span class="s1">&#39;imagewidth&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ImageLength&#39;</span><span class="p">:</span> <span class="s1">&#39;imagelength&#39;</span><span class="p">,</span>
            <span class="s1">&#39;BitsPerSample&#39;</span><span class="p">:</span> <span class="s1">&#39;bitspersample&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Compression&#39;</span><span class="p">:</span> <span class="s1">&#39;compression&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PlanarConfiguration&#39;</span><span class="p">:</span> <span class="s1">&#39;planarconfig&#39;</span><span class="p">,</span>
            <span class="s1">&#39;FillOrder&#39;</span><span class="p">:</span> <span class="s1">&#39;fillorder&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PhotometricInterpretation&#39;</span><span class="p">:</span> <span class="s1">&#39;photometric&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ColorMap&#39;</span><span class="p">:</span> <span class="s1">&#39;colormap&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ImageDescription&#39;</span><span class="p">:</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ImageDescription1&#39;</span><span class="p">:</span> <span class="s1">&#39;description1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SamplesPerPixel&#39;</span><span class="p">:</span> <span class="s1">&#39;samplesperpixel&#39;</span><span class="p">,</span>
            <span class="s1">&#39;RowsPerStrip&#39;</span><span class="p">:</span> <span class="s1">&#39;rowsperstrip&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Software&#39;</span><span class="p">:</span> <span class="s1">&#39;software&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Predictor&#39;</span><span class="p">:</span> <span class="s1">&#39;predictor&#39;</span><span class="p">,</span>
            <span class="s1">&#39;TileWidth&#39;</span><span class="p">:</span> <span class="s1">&#39;tilewidth&#39;</span><span class="p">,</span>
            <span class="s1">&#39;TileLength&#39;</span><span class="p">:</span> <span class="s1">&#39;tilelength&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ExtraSamples&#39;</span><span class="p">:</span> <span class="s1">&#39;extrasamples&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SampleFormat&#39;</span><span class="p">:</span> <span class="s1">&#39;sampleformat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ImageDepth&#39;</span><span class="p">:</span> <span class="s1">&#39;imagedepth&#39;</span><span class="p">,</span>
            <span class="s1">&#39;TileDepth&#39;</span><span class="p">:</span> <span class="s1">&#39;tiledepth&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">TAG_ENUM</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="c1"># 254: TIFF.FILETYPE,</span>
            <span class="mi">255</span><span class="p">:</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">OFILETYPE</span><span class="p">,</span>
            <span class="mi">259</span><span class="p">:</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">COMPRESSION</span><span class="p">,</span>
            <span class="mi">262</span><span class="p">:</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="p">,</span>
            <span class="mi">263</span><span class="p">:</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">THRESHHOLD</span><span class="p">,</span>
            <span class="mi">266</span><span class="p">:</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">FILLORDER</span><span class="p">,</span>
            <span class="mi">274</span><span class="p">:</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">ORIENTATION</span><span class="p">,</span>
            <span class="mi">284</span><span class="p">:</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PLANARCONFIG</span><span class="p">,</span>
            <span class="mi">290</span><span class="p">:</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">GRAYRESPONSEUNIT</span><span class="p">,</span>
            <span class="c1"># 292: TIFF.GROUP3OPT,</span>
            <span class="c1"># 293: TIFF.GROUP4OPT,</span>
            <span class="mi">296</span><span class="p">:</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">RESUNIT</span><span class="p">,</span>
            <span class="mi">300</span><span class="p">:</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">COLORRESPONSEUNIT</span><span class="p">,</span>
            <span class="mi">317</span><span class="p">:</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PREDICTOR</span><span class="p">,</span>
            <span class="mi">338</span><span class="p">:</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">EXTRASAMPLE</span><span class="p">,</span>
            <span class="mi">339</span><span class="p">:</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">SAMPLEFORMAT</span><span class="p">,</span>
            <span class="c1"># 512: TIFF.JPEGPROC,</span>
            <span class="c1"># 531: TIFF.YCBCRPOSITION,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">FILETYPE</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">FILETYPE</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntFlag</span><span class="p">):</span>
            <span class="c1"># Python 3.6 only</span>
            <span class="n">UNDEFINED</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">REDUCEDIMAGE</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">PAGE</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">MASK</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">return</span> <span class="n">FILETYPE</span>

    <span class="k">def</span> <span class="nf">OFILETYPE</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">OFILETYPE</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">UNDEFINED</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">IMAGE</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">REDUCEDIMAGE</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">PAGE</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">return</span> <span class="n">OFILETYPE</span>

    <span class="k">def</span> <span class="nf">COMPRESSION</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">COMPRESSION</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">NONE</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Uncompressed</span>
            <span class="n">CCITTRLE</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># CCITT 1D</span>
            <span class="n">CCITT_T4</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># &#39;T4/Group 3 Fax&#39;,</span>
            <span class="n">CCITT_T6</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># &#39;T6/Group 4 Fax&#39;,</span>
            <span class="n">LZW</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">OJPEG</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># old-style JPEG</span>
            <span class="n">JPEG</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">ADOBE_DEFLATE</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="n">JBIG_BW</span> <span class="o">=</span> <span class="mi">9</span>
            <span class="n">JBIG_COLOR</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">JPEG_99</span> <span class="o">=</span> <span class="mi">99</span>
            <span class="n">KODAK_262</span> <span class="o">=</span> <span class="mi">262</span>
            <span class="n">NEXT</span> <span class="o">=</span> <span class="mi">32766</span>
            <span class="n">SONY_ARW</span> <span class="o">=</span> <span class="mi">32767</span>
            <span class="n">PACKED_RAW</span> <span class="o">=</span> <span class="mi">32769</span>
            <span class="n">SAMSUNG_SRW</span> <span class="o">=</span> <span class="mi">32770</span>
            <span class="n">CCIRLEW</span> <span class="o">=</span> <span class="mi">32771</span>
            <span class="n">SAMSUNG_SRW2</span> <span class="o">=</span> <span class="mi">32772</span>
            <span class="n">PACKBITS</span> <span class="o">=</span> <span class="mi">32773</span>
            <span class="n">THUNDERSCAN</span> <span class="o">=</span> <span class="mi">32809</span>
            <span class="n">IT8CTPAD</span> <span class="o">=</span> <span class="mi">32895</span>
            <span class="n">IT8LW</span> <span class="o">=</span> <span class="mi">32896</span>
            <span class="n">IT8MP</span> <span class="o">=</span> <span class="mi">32897</span>
            <span class="n">IT8BL</span> <span class="o">=</span> <span class="mi">32898</span>
            <span class="n">PIXARFILM</span> <span class="o">=</span> <span class="mi">32908</span>
            <span class="n">PIXARLOG</span> <span class="o">=</span> <span class="mi">32909</span>
            <span class="n">DEFLATE</span> <span class="o">=</span> <span class="mi">32946</span>
            <span class="n">DCS</span> <span class="o">=</span> <span class="mi">32947</span>
            <span class="n">APERIO_JP2000_YCBC</span> <span class="o">=</span> <span class="mi">33003</span>  <span class="c1"># Leica Aperio</span>
            <span class="n">APERIO_JP2000_RGB</span> <span class="o">=</span> <span class="mi">33005</span>  <span class="c1"># Leica Aperio</span>
            <span class="n">JBIG</span> <span class="o">=</span> <span class="mi">34661</span>
            <span class="n">SGILOG</span> <span class="o">=</span> <span class="mi">34676</span>
            <span class="n">SGILOG24</span> <span class="o">=</span> <span class="mi">34677</span>
            <span class="n">JPEG2000</span> <span class="o">=</span> <span class="mi">34712</span>
            <span class="n">NIKON_NEF</span> <span class="o">=</span> <span class="mi">34713</span>
            <span class="n">JBIG2</span> <span class="o">=</span> <span class="mi">34715</span>
            <span class="n">MDI_BINARY</span> <span class="o">=</span> <span class="mi">34718</span>  <span class="c1"># &#39;Microsoft Document Imaging</span>
            <span class="n">MDI_PROGRESSIVE</span> <span class="o">=</span> <span class="mi">34719</span>  <span class="c1"># &#39;Microsoft Document Imaging</span>
            <span class="n">MDI_VECTOR</span> <span class="o">=</span> <span class="mi">34720</span>  <span class="c1"># &#39;Microsoft Document Imaging</span>
            <span class="n">JPEG_LOSSY</span> <span class="o">=</span> <span class="mi">34892</span>
            <span class="n">LZMA</span> <span class="o">=</span> <span class="mi">34925</span>
            <span class="n">ZSTD</span> <span class="o">=</span> <span class="mi">34926</span>
            <span class="n">OPS_PNG</span> <span class="o">=</span> <span class="mi">34933</span>  <span class="c1"># Objective Pathology Services</span>
            <span class="n">OPS_JPEGXR</span> <span class="o">=</span> <span class="mi">34934</span>  <span class="c1"># Objective Pathology Services</span>
            <span class="n">PIXTIFF</span> <span class="o">=</span> <span class="mi">50013</span>
            <span class="n">KODAK_DCR</span> <span class="o">=</span> <span class="mi">65000</span>
            <span class="n">PENTAX_PEF</span> <span class="o">=</span> <span class="mi">65535</span>
            <span class="c1"># def __bool__(self): return self != 1  # Python 3.6 only</span>
        <span class="k">return</span> <span class="n">COMPRESSION</span>

    <span class="k">def</span> <span class="nf">PHOTOMETRIC</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">PHOTOMETRIC</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">MINISWHITE</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">MINISBLACK</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">RGB</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">PALETTE</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">MASK</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">SEPARATED</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># CMYK</span>
            <span class="n">YCBCR</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="n">CIELAB</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="n">ICCLAB</span> <span class="o">=</span> <span class="mi">9</span>
            <span class="n">ITULAB</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">CFA</span> <span class="o">=</span> <span class="mi">32803</span>  <span class="c1"># Color Filter Array</span>
            <span class="n">LOGL</span> <span class="o">=</span> <span class="mi">32844</span>
            <span class="n">LOGLUV</span> <span class="o">=</span> <span class="mi">32845</span>
            <span class="n">LINEAR_RAW</span> <span class="o">=</span> <span class="mi">34892</span>
        <span class="k">return</span> <span class="n">PHOTOMETRIC</span>

    <span class="k">def</span> <span class="nf">THRESHHOLD</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">THRESHHOLD</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">BILEVEL</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">HALFTONE</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">ERRORDIFFUSE</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">return</span> <span class="n">THRESHHOLD</span>

    <span class="k">def</span> <span class="nf">FILLORDER</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">FILLORDER</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">MSB2LSB</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">LSB2MSB</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">FILLORDER</span>

    <span class="k">def</span> <span class="nf">ORIENTATION</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">ORIENTATION</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">TOPLEFT</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">TOPRIGHT</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">BOTRIGHT</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">BOTLEFT</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">LEFTTOP</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">RIGHTTOP</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="n">RIGHTBOT</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">LEFTBOT</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="k">return</span> <span class="n">ORIENTATION</span>

    <span class="k">def</span> <span class="nf">PLANARCONFIG</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">PLANARCONFIG</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">CONTIG</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">SEPARATE</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">PLANARCONFIG</span>

    <span class="k">def</span> <span class="nf">GRAYRESPONSEUNIT</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">GRAYRESPONSEUNIT</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">_10S</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">_100S</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">_1000S</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">_10000S</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">_100000S</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">return</span> <span class="n">GRAYRESPONSEUNIT</span>

    <span class="k">def</span> <span class="nf">GROUP4OPT</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">GROUP4OPT</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">UNCOMPRESSED</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">GROUP4OPT</span>

    <span class="k">def</span> <span class="nf">RESUNIT</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">RESUNIT</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">NONE</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">INCH</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">CENTIMETER</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="c1"># def __bool__(self): return self != 1  # Python 3.6 only</span>
        <span class="k">return</span> <span class="n">RESUNIT</span>

    <span class="k">def</span> <span class="nf">COLORRESPONSEUNIT</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">COLORRESPONSEUNIT</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">_10S</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">_100S</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">_1000S</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">_10000S</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">_100000S</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">return</span> <span class="n">COLORRESPONSEUNIT</span>

    <span class="k">def</span> <span class="nf">PREDICTOR</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">PREDICTOR</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">NONE</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">HORIZONTAL</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">FLOATINGPOINT</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="c1"># def __bool__(self): return self != 1  # Python 3.6 only</span>
        <span class="k">return</span> <span class="n">PREDICTOR</span>

    <span class="k">def</span> <span class="nf">EXTRASAMPLE</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">EXTRASAMPLE</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">UNSPECIFIED</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ASSOCALPHA</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">UNASSALPHA</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">EXTRASAMPLE</span>

    <span class="k">def</span> <span class="nf">SAMPLEFORMAT</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">SAMPLEFORMAT</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">UINT</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">INT</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">IEEEFP</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">VOID</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">COMPLEXINT</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">COMPLEXIEEEFP</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="k">return</span> <span class="n">SAMPLEFORMAT</span>

    <span class="k">def</span> <span class="nf">DATATYPES</span><span class="p">():</span>
        <span class="k">class</span> <span class="nc">DATATYPES</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
            <span class="n">NOTYPE</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">BYTE</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">ASCII</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">SHORT</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">LONG</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">RATIONAL</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">SBYTE</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="n">UNDEFINED</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">SSHORT</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="n">SLONG</span> <span class="o">=</span> <span class="mi">9</span>
            <span class="n">SRATIONAL</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">FLOAT</span> <span class="o">=</span> <span class="mi">11</span>
            <span class="n">DOUBLE</span> <span class="o">=</span> <span class="mi">12</span>
            <span class="n">IFD</span> <span class="o">=</span> <span class="mi">13</span>
            <span class="n">UNICODE</span> <span class="o">=</span> <span class="mi">14</span>
            <span class="n">COMPLEX</span> <span class="o">=</span> <span class="mi">15</span>
            <span class="n">LONG8</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="n">SLONG8</span> <span class="o">=</span> <span class="mi">17</span>
            <span class="n">IFD8</span> <span class="o">=</span> <span class="mi">18</span>
        <span class="k">return</span> <span class="n">DATATYPES</span>

    <span class="k">def</span> <span class="nf">DATA_FORMATS</span><span class="p">():</span>
        <span class="c1"># Map TIFF DATATYPES to Python struct formats</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;1B&#39;</span><span class="p">,</span>   <span class="c1"># BYTE 8-bit unsigned integer.</span>
            <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;1s&#39;</span><span class="p">,</span>   <span class="c1"># ASCII 8-bit byte that contains a 7-bit ASCII code;</span>
                       <span class="c1">#   the last byte must be NULL (binary zero).</span>
            <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;1H&#39;</span><span class="p">,</span>   <span class="c1"># SHORT 16-bit (2-byte) unsigned integer</span>
            <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;1I&#39;</span><span class="p">,</span>   <span class="c1"># LONG 32-bit (4-byte) unsigned integer.</span>
            <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;2I&#39;</span><span class="p">,</span>   <span class="c1"># RATIONAL Two LONGs: the first represents the numerator</span>
                       <span class="c1">#   of a fraction; the second, the denominator.</span>
            <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;1b&#39;</span><span class="p">,</span>   <span class="c1"># SBYTE An 8-bit signed (twos-complement) integer.</span>
            <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;1B&#39;</span><span class="p">,</span>   <span class="c1"># UNDEFINED An 8-bit byte that may contain anything,</span>
                       <span class="c1">#   depending on the definition of the field.</span>
            <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span>   <span class="c1"># SSHORT A 16-bit (2-byte) signed (twos-complement)</span>
                       <span class="c1">#   integer.</span>
            <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;1i&#39;</span><span class="p">,</span>   <span class="c1"># SLONG A 32-bit (4-byte) signed (twos-complement)</span>
                       <span class="c1">#   integer.</span>
            <span class="mi">10</span><span class="p">:</span> <span class="s1">&#39;2i&#39;</span><span class="p">,</span>  <span class="c1"># SRATIONAL Two SLONGs: the first represents the</span>
                       <span class="c1">#   numerator of a fraction, the second the denominator.</span>
            <span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;1f&#39;</span><span class="p">,</span>  <span class="c1"># FLOAT Single precision (4-byte) IEEE format.</span>
            <span class="mi">12</span><span class="p">:</span> <span class="s1">&#39;1d&#39;</span><span class="p">,</span>  <span class="c1"># DOUBLE Double precision (8-byte) IEEE format.</span>
            <span class="mi">13</span><span class="p">:</span> <span class="s1">&#39;1I&#39;</span><span class="p">,</span>  <span class="c1"># IFD unsigned 4 byte IFD offset.</span>
            <span class="c1"># 14: &#39;&#39;,  # UNICODE</span>
            <span class="c1"># 15: &#39;&#39;,  # COMPLEX</span>
            <span class="mi">16</span><span class="p">:</span> <span class="s1">&#39;1Q&#39;</span><span class="p">,</span>  <span class="c1"># LONG8 unsigned 8 byte integer (BigTiff)</span>
            <span class="mi">17</span><span class="p">:</span> <span class="s1">&#39;1q&#39;</span><span class="p">,</span>  <span class="c1"># SLONG8 signed 8 byte integer (BigTiff)</span>
            <span class="mi">18</span><span class="p">:</span> <span class="s1">&#39;1Q&#39;</span><span class="p">,</span>  <span class="c1"># IFD8 unsigned 8 byte IFD offset (BigTiff)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">DATA_DTYPES</span><span class="p">():</span>
        <span class="c1"># Map numpy dtypes to TIFF DATATYPES</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;2I&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;2i&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">:</span> <span class="mi">17</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">SAMPLE_DTYPES</span><span class="p">():</span>
        <span class="c1"># Map TIFF SampleFormats and BitsPerSample to numpy dtype</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span>  <span class="c1"># bitmap</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">14</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">18</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">22</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">23</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">24</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">26</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">27</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">29</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">):</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">32</span><span class="p">):</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">):</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">128</span><span class="p">):</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)):</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">COMPESSORS</span><span class="p">():</span>
        <span class="c1"># Map COMPRESSION to compress functions and default compression levels</span>

        <span class="k">class</span> <span class="nc">Compressors</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Delay import compressor functions.&quot;&quot;&quot;</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compressors</span> <span class="o">=</span> <span class="p">{</span><span class="mi">8</span><span class="p">:</span> <span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
                                     <span class="mi">32946</span><span class="p">:</span> <span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">,</span> <span class="mi">6</span><span class="p">)}</span>

            <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressors</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressors</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34925</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">lzma</span>  <span class="c1"># delayed import</span>
                    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="kn">import</span> <span class="nn">backports.lzma</span> <span class="k">as</span> <span class="nn">lzma</span>  <span class="c1"># delayed import</span>
                        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">KeyError</span>

                    <span class="k">def</span> <span class="nf">lzma_compress</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">lzma</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_compressors</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">lzma_compress</span><span class="p">,</span> <span class="mi">0</span>
                    <span class="k">return</span> <span class="n">lzma_compress</span><span class="p">,</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34926</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">zstd</span>  <span class="c1"># delayed import</span>
                    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_compressors</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">zstd</span><span class="o">.</span><span class="n">compress</span><span class="p">,</span> <span class="mi">9</span>
                    <span class="k">return</span> <span class="n">zstd</span><span class="o">.</span><span class="n">compress</span><span class="p">,</span> <span class="mi">9</span>

                <span class="k">raise</span> <span class="ne">KeyError</span>

            <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">Compressors</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">DECOMPESSORS</span><span class="p">():</span>
        <span class="c1"># Map COMPRESSION to decompress functions</span>

        <span class="k">class</span> <span class="nc">Decompressors</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Delay import decompressor functions.&quot;&quot;&quot;</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_decompressors</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="n">identityfunc</span><span class="p">,</span>
                                       <span class="mi">1</span><span class="p">:</span> <span class="n">identityfunc</span><span class="p">,</span>
                                       <span class="mi">5</span><span class="p">:</span> <span class="n">decode_lzw</span><span class="p">,</span>
                                       <span class="mi">8</span><span class="p">:</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">,</span>
                                       <span class="mi">32773</span><span class="p">:</span> <span class="n">decode_packbits</span><span class="p">,</span>
                                       <span class="mi">32946</span><span class="p">:</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">}</span>

            <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decompressors</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decompressors</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">from</span> <span class="nn">imagecodecs</span> <span class="k">import</span> <span class="n">jpeg</span><span class="p">,</span> <span class="n">jpeg_12</span>
                    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span>

                    <span class="k">def</span> <span class="nf">decode_jpeg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">bps</span><span class="p">,</span> <span class="n">colorspace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">bps</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">jpeg</span><span class="o">.</span><span class="n">decode_jpeg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">colorspace</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">bps</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">jpeg_12</span><span class="o">.</span><span class="n">decode_jpeg_12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">colorspace</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;bitspersample not supported&#39;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_decompressors</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">decode_jpeg</span>
                    <span class="k">return</span> <span class="n">decode_jpeg</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34925</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">lzma</span>  <span class="c1"># delayed import</span>
                    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="kn">import</span> <span class="nn">backports.lzma</span> <span class="k">as</span> <span class="nn">lzma</span>  <span class="c1"># delayed import</span>
                        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">KeyError</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_decompressors</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">lzma</span><span class="o">.</span><span class="n">decompress</span>
                    <span class="k">return</span> <span class="n">lzma</span><span class="o">.</span><span class="n">decompress</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">34926</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">zstd</span>  <span class="c1"># delayed import</span>
                    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_decompressors</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">zstd</span><span class="o">.</span><span class="n">decompress</span>
                    <span class="k">return</span> <span class="n">zstd</span><span class="o">.</span><span class="n">decompress</span>
                <span class="k">raise</span> <span class="ne">KeyError</span>

            <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">Decompressors</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">FRAME_ATTRS</span><span class="p">():</span>
        <span class="c1"># Attributes that a TiffFrame shares with its keyframe</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="s1">&#39;shape ndim size dtype axes is_final&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">FILE_FLAGS</span><span class="p">():</span>
        <span class="c1"># TiffFile and TiffPage &#39;is_\*&#39; attributes</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="s1">&#39;reduced final memmappable contiguous tiled &#39;</span>
                      <span class="s1">&#39;chroma_subsampled&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">TiffPage</span><span class="p">)</span>
                   <span class="k">if</span> <span class="n">a</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;is_&#39;</span> <span class="ow">and</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">FILE_EXTENSIONS</span><span class="p">():</span>
        <span class="c1"># TIFF file extensions</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;tif tiff ome.tif lsm stk qptiff pcoraw &#39;</span>
                     <span class="s1">&#39;gel seq svs bif tf8 tf2 btf&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">FILEOPEN_FILTER</span><span class="p">():</span>
        <span class="c1"># String for use in Windows File Open box</span>
        <span class="k">return</span> <span class="p">[(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> files&#39;</span> <span class="o">%</span> <span class="n">ext</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s1">&#39;*.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ext</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">FILE_EXTENSIONS</span><span class="p">]</span> <span class="o">+</span> <span class="p">[(</span><span class="s1">&#39;allfiles&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">AXES_LABELS</span><span class="p">():</span>
        <span class="c1"># TODO: is there a standard for character axes labels?</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="s1">&#39;depth&#39;</span><span class="p">,</span>
            <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="s1">&#39;sample&#39;</span><span class="p">,</span>  <span class="c1"># rgb(a)</span>
            <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="s1">&#39;series&#39;</span><span class="p">,</span>  <span class="c1"># general sequence, plane, page, IFD</span>
            <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="s1">&#39;channel&#39;</span><span class="p">,</span>  <span class="c1"># color, emission wavelength</span>
            <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="s1">&#39;angle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="s1">&#39;phase&#39;</span><span class="p">,</span>  <span class="c1"># formerly F    # P is Position in LSM!</span>
            <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="s1">&#39;tile&#39;</span><span class="p">,</span>  <span class="c1"># region, point, mosaic</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="s1">&#39;lifetime&#39;</span><span class="p">,</span>  <span class="c1"># histogram</span>
            <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="s1">&#39;lambda&#39;</span><span class="p">,</span>  <span class="c1"># excitation wavelength</span>
            <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="s1">&#39;exposure&#39;</span><span class="p">,</span>  <span class="c1"># lux</span>
            <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="s1">&#39;event&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="s1">&#39;other&#39;</span><span class="p">,</span>
            <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="s1">&#39;mosaic&#39;</span><span class="p">,</span>  <span class="c1"># LSM 6</span>
        <span class="p">}</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">axes</span>

    <span class="k">def</span> <span class="nf">ANDOR_TAGS</span><span class="p">():</span>
        <span class="c1"># Andor Technology tags #4864 - 5030</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">4864</span><span class="p">,</span> <span class="mi">5030</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">EXIF_TAGS</span><span class="p">():</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># 65000 - 65112  Photoshop Camera RAW EXIF tags</span>
            <span class="mi">65000</span><span class="p">:</span> <span class="s1">&#39;OwnerName&#39;</span><span class="p">,</span>
            <span class="mi">65001</span><span class="p">:</span> <span class="s1">&#39;SerialNumber&#39;</span><span class="p">,</span>
            <span class="mi">65002</span><span class="p">:</span> <span class="s1">&#39;Lens&#39;</span><span class="p">,</span>
            <span class="mi">65100</span><span class="p">:</span> <span class="s1">&#39;RawFile&#39;</span><span class="p">,</span>
            <span class="mi">65101</span><span class="p">:</span> <span class="s1">&#39;Converter&#39;</span><span class="p">,</span>
            <span class="mi">65102</span><span class="p">:</span> <span class="s1">&#39;WhiteBalance&#39;</span><span class="p">,</span>
            <span class="mi">65105</span><span class="p">:</span> <span class="s1">&#39;Exposure&#39;</span><span class="p">,</span>
            <span class="mi">65106</span><span class="p">:</span> <span class="s1">&#39;Shadows&#39;</span><span class="p">,</span>
            <span class="mi">65107</span><span class="p">:</span> <span class="s1">&#39;Brightness&#39;</span><span class="p">,</span>
            <span class="mi">65108</span><span class="p">:</span> <span class="s1">&#39;Contrast&#39;</span><span class="p">,</span>
            <span class="mi">65109</span><span class="p">:</span> <span class="s1">&#39;Saturation&#39;</span><span class="p">,</span>
            <span class="mi">65110</span><span class="p">:</span> <span class="s1">&#39;Sharpness&#39;</span><span class="p">,</span>
            <span class="mi">65111</span><span class="p">:</span> <span class="s1">&#39;Smoothness&#39;</span><span class="p">,</span>
            <span class="mi">65112</span><span class="p">:</span> <span class="s1">&#39;MoireFilter&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">tags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">TAGS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tags</span>

    <span class="k">def</span> <span class="nf">GPS_TAGS</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;GPSVersionID&#39;</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;GPSLatitudeRef&#39;</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;GPSLatitude&#39;</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;GPSLongitudeRef&#39;</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;GPSLongitude&#39;</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;GPSAltitudeRef&#39;</span><span class="p">,</span>
            <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;GPSAltitude&#39;</span><span class="p">,</span>
            <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;GPSTimeStamp&#39;</span><span class="p">,</span>
            <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;GPSSatellites&#39;</span><span class="p">,</span>
            <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;GPSStatus&#39;</span><span class="p">,</span>
            <span class="mi">10</span><span class="p">:</span> <span class="s1">&#39;GPSMeasureMode&#39;</span><span class="p">,</span>
            <span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;GPSDOP&#39;</span><span class="p">,</span>
            <span class="mi">12</span><span class="p">:</span> <span class="s1">&#39;GPSSpeedRef&#39;</span><span class="p">,</span>
            <span class="mi">13</span><span class="p">:</span> <span class="s1">&#39;GPSSpeed&#39;</span><span class="p">,</span>
            <span class="mi">14</span><span class="p">:</span> <span class="s1">&#39;GPSTrackRef&#39;</span><span class="p">,</span>
            <span class="mi">15</span><span class="p">:</span> <span class="s1">&#39;GPSTrack&#39;</span><span class="p">,</span>
            <span class="mi">16</span><span class="p">:</span> <span class="s1">&#39;GPSImgDirectionRef&#39;</span><span class="p">,</span>
            <span class="mi">17</span><span class="p">:</span> <span class="s1">&#39;GPSImgDirection&#39;</span><span class="p">,</span>
            <span class="mi">18</span><span class="p">:</span> <span class="s1">&#39;GPSMapDatum&#39;</span><span class="p">,</span>
            <span class="mi">19</span><span class="p">:</span> <span class="s1">&#39;GPSDestLatitudeRef&#39;</span><span class="p">,</span>
            <span class="mi">20</span><span class="p">:</span> <span class="s1">&#39;GPSDestLatitude&#39;</span><span class="p">,</span>
            <span class="mi">21</span><span class="p">:</span> <span class="s1">&#39;GPSDestLongitudeRef&#39;</span><span class="p">,</span>
            <span class="mi">22</span><span class="p">:</span> <span class="s1">&#39;GPSDestLongitude&#39;</span><span class="p">,</span>
            <span class="mi">23</span><span class="p">:</span> <span class="s1">&#39;GPSDestBearingRef&#39;</span><span class="p">,</span>
            <span class="mi">24</span><span class="p">:</span> <span class="s1">&#39;GPSDestBearing&#39;</span><span class="p">,</span>
            <span class="mi">25</span><span class="p">:</span> <span class="s1">&#39;GPSDestDistanceRef&#39;</span><span class="p">,</span>
            <span class="mi">26</span><span class="p">:</span> <span class="s1">&#39;GPSDestDistance&#39;</span><span class="p">,</span>
            <span class="mi">27</span><span class="p">:</span> <span class="s1">&#39;GPSProcessingMethod&#39;</span><span class="p">,</span>
            <span class="mi">28</span><span class="p">:</span> <span class="s1">&#39;GPSAreaInformation&#39;</span><span class="p">,</span>
            <span class="mi">29</span><span class="p">:</span> <span class="s1">&#39;GPSDateStamp&#39;</span><span class="p">,</span>
            <span class="mi">30</span><span class="p">:</span> <span class="s1">&#39;GPSDifferential&#39;</span><span class="p">,</span>
            <span class="mi">31</span><span class="p">:</span> <span class="s1">&#39;GPSHPositioningError&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">IOP_TAGS</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;InteroperabilityIndex&#39;</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;InteroperabilityVersion&#39;</span><span class="p">,</span>
            <span class="mi">4096</span><span class="p">:</span> <span class="s1">&#39;RelatedImageFileFormat&#39;</span><span class="p">,</span>
            <span class="mi">4097</span><span class="p">:</span> <span class="s1">&#39;RelatedImageWidth&#39;</span><span class="p">,</span>
            <span class="mi">4098</span><span class="p">:</span> <span class="s1">&#39;RelatedImageLength&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">GEO_KEYS</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="mi">1024</span><span class="p">:</span> <span class="s1">&#39;GTModelTypeGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">1025</span><span class="p">:</span> <span class="s1">&#39;GTRasterTypeGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">1026</span><span class="p">:</span> <span class="s1">&#39;GTCitationGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">2048</span><span class="p">:</span> <span class="s1">&#39;GeographicTypeGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">2049</span><span class="p">:</span> <span class="s1">&#39;GeogCitationGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">2050</span><span class="p">:</span> <span class="s1">&#39;GeogGeodeticDatumGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">2051</span><span class="p">:</span> <span class="s1">&#39;GeogPrimeMeridianGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">2052</span><span class="p">:</span> <span class="s1">&#39;GeogLinearUnitsGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">2053</span><span class="p">:</span> <span class="s1">&#39;GeogLinearUnitSizeGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">2054</span><span class="p">:</span> <span class="s1">&#39;GeogAngularUnitsGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">2055</span><span class="p">:</span> <span class="s1">&#39;GeogAngularUnitsSizeGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">2056</span><span class="p">:</span> <span class="s1">&#39;GeogEllipsoidGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">2057</span><span class="p">:</span> <span class="s1">&#39;GeogSemiMajorAxisGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">2058</span><span class="p">:</span> <span class="s1">&#39;GeogSemiMinorAxisGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">2059</span><span class="p">:</span> <span class="s1">&#39;GeogInvFlatteningGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">2060</span><span class="p">:</span> <span class="s1">&#39;GeogAzimuthUnitsGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">2061</span><span class="p">:</span> <span class="s1">&#39;GeogPrimeMeridianLongGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">2062</span><span class="p">:</span> <span class="s1">&#39;GeogTOWGS84GeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3059</span><span class="p">:</span> <span class="s1">&#39;ProjLinearUnitsInterpCorrectGeoKey&#39;</span><span class="p">,</span>  <span class="c1"># GDAL</span>
            <span class="mi">3072</span><span class="p">:</span> <span class="s1">&#39;ProjectedCSTypeGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3073</span><span class="p">:</span> <span class="s1">&#39;PCSCitationGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3074</span><span class="p">:</span> <span class="s1">&#39;ProjectionGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3075</span><span class="p">:</span> <span class="s1">&#39;ProjCoordTransGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3076</span><span class="p">:</span> <span class="s1">&#39;ProjLinearUnitsGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3077</span><span class="p">:</span> <span class="s1">&#39;ProjLinearUnitSizeGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3078</span><span class="p">:</span> <span class="s1">&#39;ProjStdParallel1GeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3079</span><span class="p">:</span> <span class="s1">&#39;ProjStdParallel2GeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3080</span><span class="p">:</span> <span class="s1">&#39;ProjNatOriginLongGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3081</span><span class="p">:</span> <span class="s1">&#39;ProjNatOriginLatGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3082</span><span class="p">:</span> <span class="s1">&#39;ProjFalseEastingGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3083</span><span class="p">:</span> <span class="s1">&#39;ProjFalseNorthingGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3084</span><span class="p">:</span> <span class="s1">&#39;ProjFalseOriginLongGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3085</span><span class="p">:</span> <span class="s1">&#39;ProjFalseOriginLatGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3086</span><span class="p">:</span> <span class="s1">&#39;ProjFalseOriginEastingGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3087</span><span class="p">:</span> <span class="s1">&#39;ProjFalseOriginNorthingGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3088</span><span class="p">:</span> <span class="s1">&#39;ProjCenterLongGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3089</span><span class="p">:</span> <span class="s1">&#39;ProjCenterLatGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3090</span><span class="p">:</span> <span class="s1">&#39;ProjCenterEastingGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3091</span><span class="p">:</span> <span class="s1">&#39;ProjFalseOriginNorthingGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3092</span><span class="p">:</span> <span class="s1">&#39;ProjScaleAtNatOriginGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3093</span><span class="p">:</span> <span class="s1">&#39;ProjScaleAtCenterGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3094</span><span class="p">:</span> <span class="s1">&#39;ProjAzimuthAngleGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3095</span><span class="p">:</span> <span class="s1">&#39;ProjStraightVertPoleLongGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">3096</span><span class="p">:</span> <span class="s1">&#39;ProjRectifiedGridAngleGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">4096</span><span class="p">:</span> <span class="s1">&#39;VerticalCSTypeGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">4097</span><span class="p">:</span> <span class="s1">&#39;VerticalCitationGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">4098</span><span class="p">:</span> <span class="s1">&#39;VerticalDatumGeoKey&#39;</span><span class="p">,</span>
            <span class="mi">4099</span><span class="p">:</span> <span class="s1">&#39;VerticalUnitsGeoKey&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">GEO_CODES</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.tifffile_geodb</span> <span class="k">import</span> <span class="n">GEO_CODES</span>  <span class="c1"># delayed import</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">tifffile_geodb</span> <span class="k">import</span> <span class="n">GEO_CODES</span>  <span class="c1"># delayed import</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">GEO_CODES</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">GEO_CODES</span>

    <span class="k">def</span> <span class="nf">CZ_LSMINFO</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;MagicNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;StructureSize&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DimensionX&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DimensionY&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DimensionZ&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DimensionChannels&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DimensionTime&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DataType&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>  <span class="c1"># DATATYPES</span>
            <span class="p">(</span><span class="s1">&#39;ThumbnailX&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ThumbnailY&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;VoxelSizeX&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;VoxelSizeY&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;VoxelSizeZ&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OriginX&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OriginY&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OriginZ&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ScanType&#39;</span><span class="p">,</span> <span class="s1">&#39;u2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SpectralScan&#39;</span><span class="p">,</span> <span class="s1">&#39;u2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TypeOfData&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>  <span class="c1"># TYPEOFDATA</span>
            <span class="p">(</span><span class="s1">&#39;OffsetVectorOverlay&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetInputLut&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetOutputLut&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetChannelColors&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TimeIntervall&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetChannelDataTypes&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetScanInformation&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>  <span class="c1"># SCANINFO</span>
            <span class="p">(</span><span class="s1">&#39;OffsetKsData&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetTimeStamps&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetEventList&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetRoi&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetBleachRoi&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetNextRecording&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="c1"># LSM 2.0 ends here</span>
            <span class="p">(</span><span class="s1">&#39;DisplayAspectX&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DisplayAspectY&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DisplayAspectZ&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DisplayAspectTime&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetMeanOfRoisOverlay&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetTopoIsolineOverlay&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetTopoProfileOverlay&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetLinescanOverlay&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ToolbarFlags&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetChannelWavelength&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetChannelFactors&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ObjectiveSphereCorrection&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetUnmixParameters&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="c1"># LSM 3.2, 4.0 end here</span>
            <span class="p">(</span><span class="s1">&#39;OffsetAcquisitionParameters&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetCharacteristics&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetPalette&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TimeDifferenceX&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TimeDifferenceY&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TimeDifferenceZ&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;InternalUse1&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DimensionP&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DimensionM&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DimensionsReserved&#39;</span><span class="p">,</span> <span class="s1">&#39;16i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetTilePositions&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;9u4&#39;</span><span class="p">),</span>  <span class="c1"># Reserved</span>
            <span class="p">(</span><span class="s1">&#39;OffsetPositions&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="c1"># (&#39;&#39;, &#39;21u4&#39;),  # must be 0</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">CZ_LSMINFO_READERS</span><span class="p">():</span>
        <span class="c1"># Import functions for CZ_LSMINFO sub-records</span>
        <span class="c1"># TODO: read more CZ_LSMINFO sub-records</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;ScanInformation&#39;</span><span class="p">:</span> <span class="n">read_lsm_scaninfo</span><span class="p">,</span>
            <span class="s1">&#39;TimeStamps&#39;</span><span class="p">:</span> <span class="n">read_lsm_timestamps</span><span class="p">,</span>
            <span class="s1">&#39;EventList&#39;</span><span class="p">:</span> <span class="n">read_lsm_eventlist</span><span class="p">,</span>
            <span class="s1">&#39;ChannelColors&#39;</span><span class="p">:</span> <span class="n">read_lsm_channelcolors</span><span class="p">,</span>
            <span class="s1">&#39;Positions&#39;</span><span class="p">:</span> <span class="n">read_lsm_floatpairs</span><span class="p">,</span>
            <span class="s1">&#39;TilePositions&#39;</span><span class="p">:</span> <span class="n">read_lsm_floatpairs</span><span class="p">,</span>
            <span class="s1">&#39;VectorOverlay&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;InputLut&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;OutputLut&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;TimeIntervall&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;ChannelDataTypes&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;KsData&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;Roi&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;BleachRoi&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;NextRecording&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;MeanOfRoisOverlay&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;TopoIsolineOverlay&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;TopoProfileOverlay&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;ChannelWavelength&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;SphereCorrection&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;ChannelFactors&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;UnmixParameters&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;AcquisitionParameters&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;Characteristics&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">CZ_LSMINFO_SCANTYPE</span><span class="p">():</span>
        <span class="c1"># Map CZ_LSMINFO.ScanType to dimension order</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;XYZCT&#39;</span><span class="p">,</span>  <span class="c1"># &#39;Stack&#39; normal x-y-z-scan</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;XYZCT&#39;</span><span class="p">,</span>  <span class="c1"># &#39;Z-Scan&#39; x-z-plane Y=1</span>
            <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;XYZCT&#39;</span><span class="p">,</span>  <span class="c1"># &#39;Line&#39;</span>
            <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;XYTCZ&#39;</span><span class="p">,</span>  <span class="c1"># &#39;Time Series Plane&#39; time series x-y  XYCTZ ? Z=1</span>
            <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;XYZTC&#39;</span><span class="p">,</span>  <span class="c1"># &#39;Time Series z-Scan&#39; time series x-z</span>
            <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;XYTCZ&#39;</span><span class="p">,</span>  <span class="c1"># &#39;Time Series Mean-of-ROIs&#39;</span>
            <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;XYZTC&#39;</span><span class="p">,</span>  <span class="c1"># &#39;Time Series Stack&#39; time series x-y-z</span>
            <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;XYCTZ&#39;</span><span class="p">,</span>  <span class="c1"># Spline Scan</span>
            <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;XYCZT&#39;</span><span class="p">,</span>  <span class="c1"># Spline Plane x-z</span>
            <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;XYTCZ&#39;</span><span class="p">,</span>  <span class="c1"># Time Series Spline Plane x-z</span>
            <span class="mi">10</span><span class="p">:</span> <span class="s1">&#39;XYZCT&#39;</span><span class="p">,</span>  <span class="c1"># &#39;Time Series Point&#39; point mode</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">CZ_LSMINFO_DIMENSIONS</span><span class="p">():</span>
        <span class="c1"># Map dimension codes to CZ_LSMINFO attribute</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="s1">&#39;DimensionX&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="s1">&#39;DimensionY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="s1">&#39;DimensionZ&#39;</span><span class="p">,</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="s1">&#39;DimensionChannels&#39;</span><span class="p">,</span>
            <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;DimensionTime&#39;</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="s1">&#39;DimensionP&#39;</span><span class="p">,</span>
            <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="s1">&#39;DimensionM&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">CZ_LSMINFO_DATATYPES</span><span class="p">():</span>
        <span class="c1"># Description of CZ_LSMINFO.DataType</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;varying data types&#39;</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;8 bit unsigned integer&#39;</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;12 bit unsigned integer&#39;</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;32 bit float&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">CZ_LSMINFO_TYPEOFDATA</span><span class="p">():</span>
        <span class="c1"># Description of CZ_LSMINFO.TypeOfData</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;Original scan data&#39;</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;Calculated data&#39;</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;3D reconstruction&#39;</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;Topography height map&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">CZ_LSMINFO_SCANINFO_ARRAYS</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="mh">0x20000000</span><span class="p">:</span> <span class="s1">&#39;Tracks&#39;</span><span class="p">,</span>
            <span class="mh">0x30000000</span><span class="p">:</span> <span class="s1">&#39;Lasers&#39;</span><span class="p">,</span>
            <span class="mh">0x60000000</span><span class="p">:</span> <span class="s1">&#39;DetectionChannels&#39;</span><span class="p">,</span>
            <span class="mh">0x80000000</span><span class="p">:</span> <span class="s1">&#39;IlluminationChannels&#39;</span><span class="p">,</span>
            <span class="mh">0xa0000000</span><span class="p">:</span> <span class="s1">&#39;BeamSplitters&#39;</span><span class="p">,</span>
            <span class="mh">0xc0000000</span><span class="p">:</span> <span class="s1">&#39;DataChannels&#39;</span><span class="p">,</span>
            <span class="mh">0x11000000</span><span class="p">:</span> <span class="s1">&#39;Timers&#39;</span><span class="p">,</span>
            <span class="mh">0x13000000</span><span class="p">:</span> <span class="s1">&#39;Markers&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">CZ_LSMINFO_SCANINFO_STRUCTS</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="c1"># 0x10000000: &#39;Recording&#39;,</span>
            <span class="mh">0x40000000</span><span class="p">:</span> <span class="s1">&#39;Track&#39;</span><span class="p">,</span>
            <span class="mh">0x50000000</span><span class="p">:</span> <span class="s1">&#39;Laser&#39;</span><span class="p">,</span>
            <span class="mh">0x70000000</span><span class="p">:</span> <span class="s1">&#39;DetectionChannel&#39;</span><span class="p">,</span>
            <span class="mh">0x90000000</span><span class="p">:</span> <span class="s1">&#39;IlluminationChannel&#39;</span><span class="p">,</span>
            <span class="mh">0xb0000000</span><span class="p">:</span> <span class="s1">&#39;BeamSplitter&#39;</span><span class="p">,</span>
            <span class="mh">0xd0000000</span><span class="p">:</span> <span class="s1">&#39;DataChannel&#39;</span><span class="p">,</span>
            <span class="mh">0x12000000</span><span class="p">:</span> <span class="s1">&#39;Timer&#39;</span><span class="p">,</span>
            <span class="mh">0x14000000</span><span class="p">:</span> <span class="s1">&#39;Marker&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">CZ_LSMINFO_SCANINFO_ATTRIBUTES</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="c1"># Recording</span>
            <span class="mh">0x10000001</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
            <span class="mh">0x10000002</span><span class="p">:</span> <span class="s1">&#39;Description&#39;</span><span class="p">,</span>
            <span class="mh">0x10000003</span><span class="p">:</span> <span class="s1">&#39;Notes&#39;</span><span class="p">,</span>
            <span class="mh">0x10000004</span><span class="p">:</span> <span class="s1">&#39;Objective&#39;</span><span class="p">,</span>
            <span class="mh">0x10000005</span><span class="p">:</span> <span class="s1">&#39;ProcessingSummary&#39;</span><span class="p">,</span>
            <span class="mh">0x10000006</span><span class="p">:</span> <span class="s1">&#39;SpecialScanMode&#39;</span><span class="p">,</span>
            <span class="mh">0x10000007</span><span class="p">:</span> <span class="s1">&#39;ScanType&#39;</span><span class="p">,</span>
            <span class="mh">0x10000008</span><span class="p">:</span> <span class="s1">&#39;ScanMode&#39;</span><span class="p">,</span>
            <span class="mh">0x10000009</span><span class="p">:</span> <span class="s1">&#39;NumberOfStacks&#39;</span><span class="p">,</span>
            <span class="mh">0x1000000a</span><span class="p">:</span> <span class="s1">&#39;LinesPerPlane&#39;</span><span class="p">,</span>
            <span class="mh">0x1000000b</span><span class="p">:</span> <span class="s1">&#39;SamplesPerLine&#39;</span><span class="p">,</span>
            <span class="mh">0x1000000c</span><span class="p">:</span> <span class="s1">&#39;PlanesPerVolume&#39;</span><span class="p">,</span>
            <span class="mh">0x1000000d</span><span class="p">:</span> <span class="s1">&#39;ImagesWidth&#39;</span><span class="p">,</span>
            <span class="mh">0x1000000e</span><span class="p">:</span> <span class="s1">&#39;ImagesHeight&#39;</span><span class="p">,</span>
            <span class="mh">0x1000000f</span><span class="p">:</span> <span class="s1">&#39;ImagesNumberPlanes&#39;</span><span class="p">,</span>
            <span class="mh">0x10000010</span><span class="p">:</span> <span class="s1">&#39;ImagesNumberStacks&#39;</span><span class="p">,</span>
            <span class="mh">0x10000011</span><span class="p">:</span> <span class="s1">&#39;ImagesNumberChannels&#39;</span><span class="p">,</span>
            <span class="mh">0x10000012</span><span class="p">:</span> <span class="s1">&#39;LinscanXySize&#39;</span><span class="p">,</span>
            <span class="mh">0x10000013</span><span class="p">:</span> <span class="s1">&#39;ScanDirection&#39;</span><span class="p">,</span>
            <span class="mh">0x10000014</span><span class="p">:</span> <span class="s1">&#39;TimeSeries&#39;</span><span class="p">,</span>
            <span class="mh">0x10000015</span><span class="p">:</span> <span class="s1">&#39;OriginalScanData&#39;</span><span class="p">,</span>
            <span class="mh">0x10000016</span><span class="p">:</span> <span class="s1">&#39;ZoomX&#39;</span><span class="p">,</span>
            <span class="mh">0x10000017</span><span class="p">:</span> <span class="s1">&#39;ZoomY&#39;</span><span class="p">,</span>
            <span class="mh">0x10000018</span><span class="p">:</span> <span class="s1">&#39;ZoomZ&#39;</span><span class="p">,</span>
            <span class="mh">0x10000019</span><span class="p">:</span> <span class="s1">&#39;Sample0X&#39;</span><span class="p">,</span>
            <span class="mh">0x1000001a</span><span class="p">:</span> <span class="s1">&#39;Sample0Y&#39;</span><span class="p">,</span>
            <span class="mh">0x1000001b</span><span class="p">:</span> <span class="s1">&#39;Sample0Z&#39;</span><span class="p">,</span>
            <span class="mh">0x1000001c</span><span class="p">:</span> <span class="s1">&#39;SampleSpacing&#39;</span><span class="p">,</span>
            <span class="mh">0x1000001d</span><span class="p">:</span> <span class="s1">&#39;LineSpacing&#39;</span><span class="p">,</span>
            <span class="mh">0x1000001e</span><span class="p">:</span> <span class="s1">&#39;PlaneSpacing&#39;</span><span class="p">,</span>
            <span class="mh">0x1000001f</span><span class="p">:</span> <span class="s1">&#39;PlaneWidth&#39;</span><span class="p">,</span>
            <span class="mh">0x10000020</span><span class="p">:</span> <span class="s1">&#39;PlaneHeight&#39;</span><span class="p">,</span>
            <span class="mh">0x10000021</span><span class="p">:</span> <span class="s1">&#39;VolumeDepth&#39;</span><span class="p">,</span>
            <span class="mh">0x10000023</span><span class="p">:</span> <span class="s1">&#39;Nutation&#39;</span><span class="p">,</span>
            <span class="mh">0x10000034</span><span class="p">:</span> <span class="s1">&#39;Rotation&#39;</span><span class="p">,</span>
            <span class="mh">0x10000035</span><span class="p">:</span> <span class="s1">&#39;Precession&#39;</span><span class="p">,</span>
            <span class="mh">0x10000036</span><span class="p">:</span> <span class="s1">&#39;Sample0time&#39;</span><span class="p">,</span>
            <span class="mh">0x10000037</span><span class="p">:</span> <span class="s1">&#39;StartScanTriggerIn&#39;</span><span class="p">,</span>
            <span class="mh">0x10000038</span><span class="p">:</span> <span class="s1">&#39;StartScanTriggerOut&#39;</span><span class="p">,</span>
            <span class="mh">0x10000039</span><span class="p">:</span> <span class="s1">&#39;StartScanEvent&#39;</span><span class="p">,</span>
            <span class="mh">0x10000040</span><span class="p">:</span> <span class="s1">&#39;StartScanTime&#39;</span><span class="p">,</span>
            <span class="mh">0x10000041</span><span class="p">:</span> <span class="s1">&#39;StopScanTriggerIn&#39;</span><span class="p">,</span>
            <span class="mh">0x10000042</span><span class="p">:</span> <span class="s1">&#39;StopScanTriggerOut&#39;</span><span class="p">,</span>
            <span class="mh">0x10000043</span><span class="p">:</span> <span class="s1">&#39;StopScanEvent&#39;</span><span class="p">,</span>
            <span class="mh">0x10000044</span><span class="p">:</span> <span class="s1">&#39;StopScanTime&#39;</span><span class="p">,</span>
            <span class="mh">0x10000045</span><span class="p">:</span> <span class="s1">&#39;UseRois&#39;</span><span class="p">,</span>
            <span class="mh">0x10000046</span><span class="p">:</span> <span class="s1">&#39;UseReducedMemoryRois&#39;</span><span class="p">,</span>
            <span class="mh">0x10000047</span><span class="p">:</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span>
            <span class="mh">0x10000048</span><span class="p">:</span> <span class="s1">&#39;UseBcCorrection&#39;</span><span class="p">,</span>
            <span class="mh">0x10000049</span><span class="p">:</span> <span class="s1">&#39;PositionBcCorrection1&#39;</span><span class="p">,</span>
            <span class="mh">0x10000050</span><span class="p">:</span> <span class="s1">&#39;PositionBcCorrection2&#39;</span><span class="p">,</span>
            <span class="mh">0x10000051</span><span class="p">:</span> <span class="s1">&#39;InterpolationY&#39;</span><span class="p">,</span>
            <span class="mh">0x10000052</span><span class="p">:</span> <span class="s1">&#39;CameraBinning&#39;</span><span class="p">,</span>
            <span class="mh">0x10000053</span><span class="p">:</span> <span class="s1">&#39;CameraSupersampling&#39;</span><span class="p">,</span>
            <span class="mh">0x10000054</span><span class="p">:</span> <span class="s1">&#39;CameraFrameWidth&#39;</span><span class="p">,</span>
            <span class="mh">0x10000055</span><span class="p">:</span> <span class="s1">&#39;CameraFrameHeight&#39;</span><span class="p">,</span>
            <span class="mh">0x10000056</span><span class="p">:</span> <span class="s1">&#39;CameraOffsetX&#39;</span><span class="p">,</span>
            <span class="mh">0x10000057</span><span class="p">:</span> <span class="s1">&#39;CameraOffsetY&#39;</span><span class="p">,</span>
            <span class="mh">0x10000059</span><span class="p">:</span> <span class="s1">&#39;RtBinning&#39;</span><span class="p">,</span>
            <span class="mh">0x1000005a</span><span class="p">:</span> <span class="s1">&#39;RtFrameWidth&#39;</span><span class="p">,</span>
            <span class="mh">0x1000005b</span><span class="p">:</span> <span class="s1">&#39;RtFrameHeight&#39;</span><span class="p">,</span>
            <span class="mh">0x1000005c</span><span class="p">:</span> <span class="s1">&#39;RtRegionWidth&#39;</span><span class="p">,</span>
            <span class="mh">0x1000005d</span><span class="p">:</span> <span class="s1">&#39;RtRegionHeight&#39;</span><span class="p">,</span>
            <span class="mh">0x1000005e</span><span class="p">:</span> <span class="s1">&#39;RtOffsetX&#39;</span><span class="p">,</span>
            <span class="mh">0x1000005f</span><span class="p">:</span> <span class="s1">&#39;RtOffsetY&#39;</span><span class="p">,</span>
            <span class="mh">0x10000060</span><span class="p">:</span> <span class="s1">&#39;RtZoom&#39;</span><span class="p">,</span>
            <span class="mh">0x10000061</span><span class="p">:</span> <span class="s1">&#39;RtLinePeriod&#39;</span><span class="p">,</span>
            <span class="mh">0x10000062</span><span class="p">:</span> <span class="s1">&#39;Prescan&#39;</span><span class="p">,</span>
            <span class="mh">0x10000063</span><span class="p">:</span> <span class="s1">&#39;ScanDirectionZ&#39;</span><span class="p">,</span>
            <span class="c1"># Track</span>
            <span class="mh">0x40000001</span><span class="p">:</span> <span class="s1">&#39;MultiplexType&#39;</span><span class="p">,</span>  <span class="c1"># 0 After Line; 1 After Frame</span>
            <span class="mh">0x40000002</span><span class="p">:</span> <span class="s1">&#39;MultiplexOrder&#39;</span><span class="p">,</span>
            <span class="mh">0x40000003</span><span class="p">:</span> <span class="s1">&#39;SamplingMode&#39;</span><span class="p">,</span>  <span class="c1"># 0 Sample; 1 Line Avg; 2 Frame Avg</span>
            <span class="mh">0x40000004</span><span class="p">:</span> <span class="s1">&#39;SamplingMethod&#39;</span><span class="p">,</span>  <span class="c1"># 1 Mean; 2 Sum</span>
            <span class="mh">0x40000005</span><span class="p">:</span> <span class="s1">&#39;SamplingNumber&#39;</span><span class="p">,</span>
            <span class="mh">0x40000006</span><span class="p">:</span> <span class="s1">&#39;Acquire&#39;</span><span class="p">,</span>
            <span class="mh">0x40000007</span><span class="p">:</span> <span class="s1">&#39;SampleObservationTime&#39;</span><span class="p">,</span>
            <span class="mh">0x4000000b</span><span class="p">:</span> <span class="s1">&#39;TimeBetweenStacks&#39;</span><span class="p">,</span>
            <span class="mh">0x4000000c</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
            <span class="mh">0x4000000d</span><span class="p">:</span> <span class="s1">&#39;Collimator1Name&#39;</span><span class="p">,</span>
            <span class="mh">0x4000000e</span><span class="p">:</span> <span class="s1">&#39;Collimator1Position&#39;</span><span class="p">,</span>
            <span class="mh">0x4000000f</span><span class="p">:</span> <span class="s1">&#39;Collimator2Name&#39;</span><span class="p">,</span>
            <span class="mh">0x40000010</span><span class="p">:</span> <span class="s1">&#39;Collimator2Position&#39;</span><span class="p">,</span>
            <span class="mh">0x40000011</span><span class="p">:</span> <span class="s1">&#39;IsBleachTrack&#39;</span><span class="p">,</span>
            <span class="mh">0x40000012</span><span class="p">:</span> <span class="s1">&#39;IsBleachAfterScanNumber&#39;</span><span class="p">,</span>
            <span class="mh">0x40000013</span><span class="p">:</span> <span class="s1">&#39;BleachScanNumber&#39;</span><span class="p">,</span>
            <span class="mh">0x40000014</span><span class="p">:</span> <span class="s1">&#39;TriggerIn&#39;</span><span class="p">,</span>
            <span class="mh">0x40000015</span><span class="p">:</span> <span class="s1">&#39;TriggerOut&#39;</span><span class="p">,</span>
            <span class="mh">0x40000016</span><span class="p">:</span> <span class="s1">&#39;IsRatioTrack&#39;</span><span class="p">,</span>
            <span class="mh">0x40000017</span><span class="p">:</span> <span class="s1">&#39;BleachCount&#39;</span><span class="p">,</span>
            <span class="mh">0x40000018</span><span class="p">:</span> <span class="s1">&#39;SpiCenterWavelength&#39;</span><span class="p">,</span>
            <span class="mh">0x40000019</span><span class="p">:</span> <span class="s1">&#39;PixelTime&#39;</span><span class="p">,</span>
            <span class="mh">0x40000021</span><span class="p">:</span> <span class="s1">&#39;CondensorFrontlens&#39;</span><span class="p">,</span>
            <span class="mh">0x40000023</span><span class="p">:</span> <span class="s1">&#39;FieldStopValue&#39;</span><span class="p">,</span>
            <span class="mh">0x40000024</span><span class="p">:</span> <span class="s1">&#39;IdCondensorAperture&#39;</span><span class="p">,</span>
            <span class="mh">0x40000025</span><span class="p">:</span> <span class="s1">&#39;CondensorAperture&#39;</span><span class="p">,</span>
            <span class="mh">0x40000026</span><span class="p">:</span> <span class="s1">&#39;IdCondensorRevolver&#39;</span><span class="p">,</span>
            <span class="mh">0x40000027</span><span class="p">:</span> <span class="s1">&#39;CondensorFilter&#39;</span><span class="p">,</span>
            <span class="mh">0x40000028</span><span class="p">:</span> <span class="s1">&#39;IdTransmissionFilter1&#39;</span><span class="p">,</span>
            <span class="mh">0x40000029</span><span class="p">:</span> <span class="s1">&#39;IdTransmission1&#39;</span><span class="p">,</span>
            <span class="mh">0x40000030</span><span class="p">:</span> <span class="s1">&#39;IdTransmissionFilter2&#39;</span><span class="p">,</span>
            <span class="mh">0x40000031</span><span class="p">:</span> <span class="s1">&#39;IdTransmission2&#39;</span><span class="p">,</span>
            <span class="mh">0x40000032</span><span class="p">:</span> <span class="s1">&#39;RepeatBleach&#39;</span><span class="p">,</span>
            <span class="mh">0x40000033</span><span class="p">:</span> <span class="s1">&#39;EnableSpotBleachPos&#39;</span><span class="p">,</span>
            <span class="mh">0x40000034</span><span class="p">:</span> <span class="s1">&#39;SpotBleachPosx&#39;</span><span class="p">,</span>
            <span class="mh">0x40000035</span><span class="p">:</span> <span class="s1">&#39;SpotBleachPosy&#39;</span><span class="p">,</span>
            <span class="mh">0x40000036</span><span class="p">:</span> <span class="s1">&#39;SpotBleachPosz&#39;</span><span class="p">,</span>
            <span class="mh">0x40000037</span><span class="p">:</span> <span class="s1">&#39;IdTubelens&#39;</span><span class="p">,</span>
            <span class="mh">0x40000038</span><span class="p">:</span> <span class="s1">&#39;IdTubelensPosition&#39;</span><span class="p">,</span>
            <span class="mh">0x40000039</span><span class="p">:</span> <span class="s1">&#39;TransmittedLight&#39;</span><span class="p">,</span>
            <span class="mh">0x4000003a</span><span class="p">:</span> <span class="s1">&#39;ReflectedLight&#39;</span><span class="p">,</span>
            <span class="mh">0x4000003b</span><span class="p">:</span> <span class="s1">&#39;SimultanGrabAndBleach&#39;</span><span class="p">,</span>
            <span class="mh">0x4000003c</span><span class="p">:</span> <span class="s1">&#39;BleachPixelTime&#39;</span><span class="p">,</span>
            <span class="c1"># Laser</span>
            <span class="mh">0x50000001</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
            <span class="mh">0x50000002</span><span class="p">:</span> <span class="s1">&#39;Acquire&#39;</span><span class="p">,</span>
            <span class="mh">0x50000003</span><span class="p">:</span> <span class="s1">&#39;Power&#39;</span><span class="p">,</span>
            <span class="c1"># DetectionChannel</span>
            <span class="mh">0x70000001</span><span class="p">:</span> <span class="s1">&#39;IntegrationMode&#39;</span><span class="p">,</span>
            <span class="mh">0x70000002</span><span class="p">:</span> <span class="s1">&#39;SpecialMode&#39;</span><span class="p">,</span>
            <span class="mh">0x70000003</span><span class="p">:</span> <span class="s1">&#39;DetectorGainFirst&#39;</span><span class="p">,</span>
            <span class="mh">0x70000004</span><span class="p">:</span> <span class="s1">&#39;DetectorGainLast&#39;</span><span class="p">,</span>
            <span class="mh">0x70000005</span><span class="p">:</span> <span class="s1">&#39;AmplifierGainFirst&#39;</span><span class="p">,</span>
            <span class="mh">0x70000006</span><span class="p">:</span> <span class="s1">&#39;AmplifierGainLast&#39;</span><span class="p">,</span>
            <span class="mh">0x70000007</span><span class="p">:</span> <span class="s1">&#39;AmplifierOffsFirst&#39;</span><span class="p">,</span>
            <span class="mh">0x70000008</span><span class="p">:</span> <span class="s1">&#39;AmplifierOffsLast&#39;</span><span class="p">,</span>
            <span class="mh">0x70000009</span><span class="p">:</span> <span class="s1">&#39;PinholeDiameter&#39;</span><span class="p">,</span>
            <span class="mh">0x7000000a</span><span class="p">:</span> <span class="s1">&#39;CountingTrigger&#39;</span><span class="p">,</span>
            <span class="mh">0x7000000b</span><span class="p">:</span> <span class="s1">&#39;Acquire&#39;</span><span class="p">,</span>
            <span class="mh">0x7000000c</span><span class="p">:</span> <span class="s1">&#39;PointDetectorName&#39;</span><span class="p">,</span>
            <span class="mh">0x7000000d</span><span class="p">:</span> <span class="s1">&#39;AmplifierName&#39;</span><span class="p">,</span>
            <span class="mh">0x7000000e</span><span class="p">:</span> <span class="s1">&#39;PinholeName&#39;</span><span class="p">,</span>
            <span class="mh">0x7000000f</span><span class="p">:</span> <span class="s1">&#39;FilterSetName&#39;</span><span class="p">,</span>
            <span class="mh">0x70000010</span><span class="p">:</span> <span class="s1">&#39;FilterName&#39;</span><span class="p">,</span>
            <span class="mh">0x70000013</span><span class="p">:</span> <span class="s1">&#39;IntegratorName&#39;</span><span class="p">,</span>
            <span class="mh">0x70000014</span><span class="p">:</span> <span class="s1">&#39;ChannelName&#39;</span><span class="p">,</span>
            <span class="mh">0x70000015</span><span class="p">:</span> <span class="s1">&#39;DetectorGainBc1&#39;</span><span class="p">,</span>
            <span class="mh">0x70000016</span><span class="p">:</span> <span class="s1">&#39;DetectorGainBc2&#39;</span><span class="p">,</span>
            <span class="mh">0x70000017</span><span class="p">:</span> <span class="s1">&#39;AmplifierGainBc1&#39;</span><span class="p">,</span>
            <span class="mh">0x70000018</span><span class="p">:</span> <span class="s1">&#39;AmplifierGainBc2&#39;</span><span class="p">,</span>
            <span class="mh">0x70000019</span><span class="p">:</span> <span class="s1">&#39;AmplifierOffsetBc1&#39;</span><span class="p">,</span>
            <span class="mh">0x70000020</span><span class="p">:</span> <span class="s1">&#39;AmplifierOffsetBc2&#39;</span><span class="p">,</span>
            <span class="mh">0x70000021</span><span class="p">:</span> <span class="s1">&#39;SpectralScanChannels&#39;</span><span class="p">,</span>
            <span class="mh">0x70000022</span><span class="p">:</span> <span class="s1">&#39;SpiWavelengthStart&#39;</span><span class="p">,</span>
            <span class="mh">0x70000023</span><span class="p">:</span> <span class="s1">&#39;SpiWavelengthStop&#39;</span><span class="p">,</span>
            <span class="mh">0x70000026</span><span class="p">:</span> <span class="s1">&#39;DyeName&#39;</span><span class="p">,</span>
            <span class="mh">0x70000027</span><span class="p">:</span> <span class="s1">&#39;DyeFolder&#39;</span><span class="p">,</span>
            <span class="c1"># IlluminationChannel</span>
            <span class="mh">0x90000001</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
            <span class="mh">0x90000002</span><span class="p">:</span> <span class="s1">&#39;Power&#39;</span><span class="p">,</span>
            <span class="mh">0x90000003</span><span class="p">:</span> <span class="s1">&#39;Wavelength&#39;</span><span class="p">,</span>
            <span class="mh">0x90000004</span><span class="p">:</span> <span class="s1">&#39;Aquire&#39;</span><span class="p">,</span>
            <span class="mh">0x90000005</span><span class="p">:</span> <span class="s1">&#39;DetchannelName&#39;</span><span class="p">,</span>
            <span class="mh">0x90000006</span><span class="p">:</span> <span class="s1">&#39;PowerBc1&#39;</span><span class="p">,</span>
            <span class="mh">0x90000007</span><span class="p">:</span> <span class="s1">&#39;PowerBc2&#39;</span><span class="p">,</span>
            <span class="c1"># BeamSplitter</span>
            <span class="mh">0xb0000001</span><span class="p">:</span> <span class="s1">&#39;FilterSet&#39;</span><span class="p">,</span>
            <span class="mh">0xb0000002</span><span class="p">:</span> <span class="s1">&#39;Filter&#39;</span><span class="p">,</span>
            <span class="mh">0xb0000003</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
            <span class="c1"># DataChannel</span>
            <span class="mh">0xd0000001</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
            <span class="mh">0xd0000003</span><span class="p">:</span> <span class="s1">&#39;Acquire&#39;</span><span class="p">,</span>
            <span class="mh">0xd0000004</span><span class="p">:</span> <span class="s1">&#39;Color&#39;</span><span class="p">,</span>
            <span class="mh">0xd0000005</span><span class="p">:</span> <span class="s1">&#39;SampleType&#39;</span><span class="p">,</span>
            <span class="mh">0xd0000006</span><span class="p">:</span> <span class="s1">&#39;BitsPerSample&#39;</span><span class="p">,</span>
            <span class="mh">0xd0000007</span><span class="p">:</span> <span class="s1">&#39;RatioType&#39;</span><span class="p">,</span>
            <span class="mh">0xd0000008</span><span class="p">:</span> <span class="s1">&#39;RatioTrack1&#39;</span><span class="p">,</span>
            <span class="mh">0xd0000009</span><span class="p">:</span> <span class="s1">&#39;RatioTrack2&#39;</span><span class="p">,</span>
            <span class="mh">0xd000000a</span><span class="p">:</span> <span class="s1">&#39;RatioChannel1&#39;</span><span class="p">,</span>
            <span class="mh">0xd000000b</span><span class="p">:</span> <span class="s1">&#39;RatioChannel2&#39;</span><span class="p">,</span>
            <span class="mh">0xd000000c</span><span class="p">:</span> <span class="s1">&#39;RatioConst1&#39;</span><span class="p">,</span>
            <span class="mh">0xd000000d</span><span class="p">:</span> <span class="s1">&#39;RatioConst2&#39;</span><span class="p">,</span>
            <span class="mh">0xd000000e</span><span class="p">:</span> <span class="s1">&#39;RatioConst3&#39;</span><span class="p">,</span>
            <span class="mh">0xd000000f</span><span class="p">:</span> <span class="s1">&#39;RatioConst4&#39;</span><span class="p">,</span>
            <span class="mh">0xd0000010</span><span class="p">:</span> <span class="s1">&#39;RatioConst5&#39;</span><span class="p">,</span>
            <span class="mh">0xd0000011</span><span class="p">:</span> <span class="s1">&#39;RatioConst6&#39;</span><span class="p">,</span>
            <span class="mh">0xd0000012</span><span class="p">:</span> <span class="s1">&#39;RatioFirstImages1&#39;</span><span class="p">,</span>
            <span class="mh">0xd0000013</span><span class="p">:</span> <span class="s1">&#39;RatioFirstImages2&#39;</span><span class="p">,</span>
            <span class="mh">0xd0000014</span><span class="p">:</span> <span class="s1">&#39;DyeName&#39;</span><span class="p">,</span>
            <span class="mh">0xd0000015</span><span class="p">:</span> <span class="s1">&#39;DyeFolder&#39;</span><span class="p">,</span>
            <span class="mh">0xd0000016</span><span class="p">:</span> <span class="s1">&#39;Spectrum&#39;</span><span class="p">,</span>
            <span class="mh">0xd0000017</span><span class="p">:</span> <span class="s1">&#39;Acquire&#39;</span><span class="p">,</span>
            <span class="c1"># Timer</span>
            <span class="mh">0x12000001</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
            <span class="mh">0x12000002</span><span class="p">:</span> <span class="s1">&#39;Description&#39;</span><span class="p">,</span>
            <span class="mh">0x12000003</span><span class="p">:</span> <span class="s1">&#39;Interval&#39;</span><span class="p">,</span>
            <span class="mh">0x12000004</span><span class="p">:</span> <span class="s1">&#39;TriggerIn&#39;</span><span class="p">,</span>
            <span class="mh">0x12000005</span><span class="p">:</span> <span class="s1">&#39;TriggerOut&#39;</span><span class="p">,</span>
            <span class="mh">0x12000006</span><span class="p">:</span> <span class="s1">&#39;ActivationTime&#39;</span><span class="p">,</span>
            <span class="mh">0x12000007</span><span class="p">:</span> <span class="s1">&#39;ActivationNumber&#39;</span><span class="p">,</span>
            <span class="c1"># Marker</span>
            <span class="mh">0x14000001</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
            <span class="mh">0x14000002</span><span class="p">:</span> <span class="s1">&#39;Description&#39;</span><span class="p">,</span>
            <span class="mh">0x14000003</span><span class="p">:</span> <span class="s1">&#39;TriggerIn&#39;</span><span class="p">,</span>
            <span class="mh">0x14000004</span><span class="p">:</span> <span class="s1">&#39;TriggerOut&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">NIH_IMAGE_HEADER</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;FileID&#39;</span><span class="p">,</span> <span class="s1">&#39;a8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;nLines&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PixelsPerLine&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Version&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OldLutMode&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OldnColors&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Colors&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;OldColorStart&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ColorWidth&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ExtraColors&#39;</span><span class="p">,</span> <span class="s1">&#39;u2&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;nExtraColors&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ForegroundIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BackgroundIndex&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;XScale&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Unused2&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Unused3&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;UnitsID&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>  <span class="c1"># NIH_UNITS_TYPE</span>
            <span class="p">(</span><span class="s1">&#39;p1&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="s1">&#39;p2&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="s1">&#39;CurveFitType&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>  <span class="c1"># NIH_CURVEFIT_TYPE</span>
            <span class="p">(</span><span class="s1">&#39;nCoefficients&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Coeff&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;UMsize&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;UM&#39;</span><span class="p">,</span> <span class="s1">&#39;a15&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;UnusedBoolean&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BinaryPic&#39;</span><span class="p">,</span> <span class="s1">&#39;b1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SliceStart&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SliceEnd&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ScaleMagnification&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;nSlices&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SliceSpacing&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CurrentSlice&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FrameInterval&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PixelAspectRatio&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ColorStart&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ColorEnd&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;nColors&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Fill1&#39;</span><span class="p">,</span> <span class="s1">&#39;3u2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Fill2&#39;</span><span class="p">,</span> <span class="s1">&#39;3u2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Table&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">),</span>  <span class="c1"># NIH_COLORTABLE_TYPE</span>
            <span class="p">(</span><span class="s1">&#39;LutMode&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">),</span>  <span class="c1"># NIH_LUTMODE_TYPE</span>
            <span class="p">(</span><span class="s1">&#39;InvertedTable&#39;</span><span class="p">,</span> <span class="s1">&#39;b1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ZeroClip&#39;</span><span class="p">,</span> <span class="s1">&#39;b1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;XUnitSize&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;XUnit&#39;</span><span class="p">,</span> <span class="s1">&#39;a11&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;StackType&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>  <span class="c1"># NIH_STACKTYPE_TYPE</span>
            <span class="c1"># (&#39;UnusedBytes&#39;, &#39;u1&#39;, 200)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">NIH_COLORTABLE_TYPE</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;CustomTable&#39;</span><span class="p">,</span> <span class="s1">&#39;AppleDefault&#39;</span><span class="p">,</span> <span class="s1">&#39;Pseudo20&#39;</span><span class="p">,</span> <span class="s1">&#39;Pseudo32&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Rainbow&#39;</span><span class="p">,</span> <span class="s1">&#39;Fire1&#39;</span><span class="p">,</span> <span class="s1">&#39;Fire2&#39;</span><span class="p">,</span> <span class="s1">&#39;Ice&#39;</span><span class="p">,</span> <span class="s1">&#39;Grays&#39;</span><span class="p">,</span> <span class="s1">&#39;Spectrum&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">NIH_LUTMODE_TYPE</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;PseudoColor&#39;</span><span class="p">,</span> <span class="s1">&#39;OldAppleDefault&#39;</span><span class="p">,</span> <span class="s1">&#39;OldSpectrum&#39;</span><span class="p">,</span> <span class="s1">&#39;GrayScale&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ColorLut&#39;</span><span class="p">,</span> <span class="s1">&#39;CustomGrayscale&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">NIH_CURVEFIT_TYPE</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;StraightLine&#39;</span><span class="p">,</span> <span class="s1">&#39;Poly2&#39;</span><span class="p">,</span> <span class="s1">&#39;Poly3&#39;</span><span class="p">,</span> <span class="s1">&#39;Poly4&#39;</span><span class="p">,</span> <span class="s1">&#39;Poly5&#39;</span><span class="p">,</span> <span class="s1">&#39;ExpoFit&#39;</span><span class="p">,</span>
                <span class="s1">&#39;PowerFit&#39;</span><span class="p">,</span> <span class="s1">&#39;LogFit&#39;</span><span class="p">,</span> <span class="s1">&#39;RodbardFit&#39;</span><span class="p">,</span> <span class="s1">&#39;SpareFit1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Uncalibrated&#39;</span><span class="p">,</span> <span class="s1">&#39;UncalibratedOD&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">NIH_UNITS_TYPE</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;Nanometers&#39;</span><span class="p">,</span> <span class="s1">&#39;Micrometers&#39;</span><span class="p">,</span> <span class="s1">&#39;Millimeters&#39;</span><span class="p">,</span> <span class="s1">&#39;Centimeters&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Meters&#39;</span><span class="p">,</span> <span class="s1">&#39;Kilometers&#39;</span><span class="p">,</span> <span class="s1">&#39;Inches&#39;</span><span class="p">,</span> <span class="s1">&#39;Feet&#39;</span><span class="p">,</span> <span class="s1">&#39;Miles&#39;</span><span class="p">,</span> <span class="s1">&#39;Pixels&#39;</span><span class="p">,</span>
                <span class="s1">&#39;OtherUnits&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">NIH_STACKTYPE_TYPE</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;VolumeStack&#39;</span><span class="p">,</span> <span class="s1">&#39;RGBStack&#39;</span><span class="p">,</span> <span class="s1">&#39;MovieStack&#39;</span><span class="p">,</span> <span class="s1">&#39;HSVStack&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">TVIPS_HEADER_V1</span><span class="p">():</span>
        <span class="c1"># TVIPS TemData structure from EMMENU Help file</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;Version&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CommentV1&#39;</span><span class="p">,</span> <span class="s1">&#39;a80&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;HighTension&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SphericalAberration&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;IlluminationAperture&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Magnification&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PostMagnification&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FocalLength&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Defocus&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Astigmatism&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;AstigmatismDirection&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BiprismVoltage&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SpecimenTiltAngle&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SpecimenTiltDirection&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;IlluminationTiltDirection&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;IlluminationTiltAngle&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageMode&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;EnergySpread&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ChromaticAberration&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ShutterType&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DefocusSpread&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CcdNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CcdSize&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetXV1&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetYV1&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PhysicalPixelSize&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Binning&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ReadoutSpeed&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GainV1&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SensitivityV1&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ExposureTimeV1&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FlatCorrected&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DeadPxCorrected&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageMean&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageStd&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DisplacementX&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DisplacementY&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;DateV1&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TimeV1&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageMin&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageMax&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageStatisticsQuality&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">TVIPS_HEADER_V2</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;ImageName&#39;</span><span class="p">,</span> <span class="s1">&#39;V160&#39;</span><span class="p">),</span>  <span class="c1"># utf16</span>
            <span class="p">(</span><span class="s1">&#39;ImageFolder&#39;</span><span class="p">,</span> <span class="s1">&#39;V160&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageSizeX&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageSizeY&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageSizeZ&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageSizeE&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageDataType&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Comment&#39;</span><span class="p">,</span> <span class="s1">&#39;V1024&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageHistory&#39;</span><span class="p">,</span> <span class="s1">&#39;V1024&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Scaling&#39;</span><span class="p">,</span> <span class="s1">&#39;16f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageStatistics&#39;</span><span class="p">,</span> <span class="s1">&#39;16c16&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageType&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageDisplaType&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PixelSizeX&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>  <span class="c1"># distance between two px in x, [nm]</span>
            <span class="p">(</span><span class="s1">&#39;PixelSizeY&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>  <span class="c1"># distance between two px in y, [nm]</span>
            <span class="p">(</span><span class="s1">&#39;ImageDistanceZ&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageDistanceE&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageMisc&#39;</span><span class="p">,</span> <span class="s1">&#39;32f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemType&#39;</span><span class="p">,</span> <span class="s1">&#39;V160&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemHighTension&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemAberrations&#39;</span><span class="p">,</span> <span class="s1">&#39;32f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemEnergy&#39;</span><span class="p">,</span> <span class="s1">&#39;32f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemMode&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemMagnification&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemMagnificationCorrection&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PostMagnification&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemStageType&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemStagePosition&#39;</span><span class="p">,</span> <span class="s1">&#39;5f4&#39;</span><span class="p">),</span>  <span class="c1"># x, y, z, a, b</span>
            <span class="p">(</span><span class="s1">&#39;TemImageShift&#39;</span><span class="p">,</span> <span class="s1">&#39;2f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemBeamShift&#39;</span><span class="p">,</span> <span class="s1">&#39;2f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemBeamTilt&#39;</span><span class="p">,</span> <span class="s1">&#39;2f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TilingParameters&#39;</span><span class="p">,</span> <span class="s1">&#39;7f4&#39;</span><span class="p">),</span>  <span class="c1"># 0: tiling? 1:x 2:y 3: max x</span>
                                          <span class="c1"># 4: max y 5: overlap x 6: overlap y</span>
            <span class="p">(</span><span class="s1">&#39;TemIllumination&#39;</span><span class="p">,</span> <span class="s1">&#39;3f4&#39;</span><span class="p">),</span>  <span class="c1"># 0: spotsize 1: intensity</span>
            <span class="p">(</span><span class="s1">&#39;TemShutter&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TemMisc&#39;</span><span class="p">,</span> <span class="s1">&#39;32f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CameraType&#39;</span><span class="p">,</span> <span class="s1">&#39;V160&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PhysicalPixelSizeX&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PhysicalPixelSizeY&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetX&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetY&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BinningX&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BinningY&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ExposureTime&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Gain&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ReadoutRate&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FlatfieldDescription&#39;</span><span class="p">,</span> <span class="s1">&#39;V160&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Sensitivity&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Dose&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CamMisc&#39;</span><span class="p">,</span> <span class="s1">&#39;32f4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FeiMicroscopeInformation&#39;</span><span class="p">,</span> <span class="s1">&#39;V1024&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FeiSpecimenInformation&#39;</span><span class="p">,</span> <span class="s1">&#39;V1024&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Magic&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">MM_HEADER</span><span class="p">():</span>
        <span class="c1"># Olympus FluoView MM_Header</span>
        <span class="n">MM_DIMENSION</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;a16&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Size&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Origin&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Resolution&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Unit&#39;</span><span class="p">,</span> <span class="s1">&#39;a64&#39;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;HeaderFlag&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageType&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageName&#39;</span><span class="p">,</span> <span class="s1">&#39;a257&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetData&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PaletteSize&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetPalette0&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetPalette1&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CommentSize&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetComment&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Dimensions&#39;</span><span class="p">,</span> <span class="n">MM_DIMENSION</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetPosition&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MapType&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MapMin&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MapMax&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MinValue&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MaxValue&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetMap&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Offset&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GrayChannel&#39;</span><span class="p">,</span> <span class="n">MM_DIMENSION</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetThumbnail&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;VoiceField&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OffsetVoiceField&#39;</span><span class="p">,</span> <span class="s1">&#39;u4&#39;</span><span class="p">),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">MM_DIMENSIONS</span><span class="p">():</span>
        <span class="c1"># Map FluoView MM_Header.Dimensions to axes characters</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="s1">&#39;Z&#39;</span><span class="p">,</span>
            <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span>
            <span class="s1">&#39;CH&#39;</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span>
            <span class="s1">&#39;WAVELENGTH&#39;</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span>
            <span class="s1">&#39;TIME&#39;</span><span class="p">:</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span>
            <span class="s1">&#39;XY&#39;</span><span class="p">:</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span>
            <span class="s1">&#39;EVENT&#39;</span><span class="p">:</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span>
            <span class="s1">&#39;EXPOSURE&#39;</span><span class="p">:</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">UIC_TAGS</span><span class="p">():</span>
        <span class="c1"># Map Universal Imaging Corporation MetaMorph internal tag ids to</span>
        <span class="c1"># name and type</span>
        <span class="kn">from</span> <span class="nn">fractions</span> <span class="k">import</span> <span class="n">Fraction</span>  <span class="c1"># delayed import</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;AutoScale&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MinScale&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MaxScale&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SpatialCalibration&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;XCalibration&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;YCalibration&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CalibrationUnits&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ThreshState&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ThreshStateRed&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;tagid_10&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>  <span class="c1"># undefined</span>
            <span class="p">(</span><span class="s1">&#39;ThreshStateGreen&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ThreshStateBlue&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ThreshStateLo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ThreshStateHi&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Zoom&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CreateTime&#39;</span><span class="p">,</span> <span class="n">julian_datetime</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;LastSavedTime&#39;</span><span class="p">,</span> <span class="n">julian_datetime</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;currentBuffer&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;grayFit&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;grayPointCount&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;grayX&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;grayY&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;grayMin&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;grayMax&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;grayUnitName&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;StandardLUT&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;wavelength&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;StagePosition&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%i</span><span class="s1">,2,2)u4&#39;</span><span class="p">),</span>  <span class="c1"># N xy positions as fract</span>
            <span class="p">(</span><span class="s1">&#39;CameraChipOffset&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%i</span><span class="s1">,2,2)u4&#39;</span><span class="p">),</span>  <span class="c1"># N xy offsets as fract</span>
            <span class="p">(</span><span class="s1">&#39;OverlayMask&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;OverlayCompress&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Overlay&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SpecialOverlayMask&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SpecialOverlayCompress&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SpecialOverlay&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImageProperty&#39;</span><span class="p">,</span> <span class="n">read_uic_image_property</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;StageLabel&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">p&#39;</span><span class="p">),</span>  <span class="c1"># N str</span>
            <span class="p">(</span><span class="s1">&#39;AutoScaleLoInfo&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;AutoScaleHiInfo&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;AbsoluteZ&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%i</span><span class="s1">,2)u4&#39;</span><span class="p">),</span>  <span class="c1"># N fractions</span>
            <span class="p">(</span><span class="s1">&#39;AbsoluteZValid&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%i</span><span class="s1">,)u4&#39;</span><span class="p">),</span>  <span class="c1"># N long</span>
            <span class="p">(</span><span class="s1">&#39;Gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">),</span>  <span class="c1"># &#39;I&#39; uses offset</span>
            <span class="p">(</span><span class="s1">&#39;GammaRed&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GammaGreen&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GammaBlue&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CameraBin&#39;</span><span class="p">,</span> <span class="s1">&#39;2I&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;NewLUT&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ImagePropertyEx&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;PlaneProperty&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;UserLutTable&#39;</span><span class="p">,</span> <span class="s1">&#39;(256,3)u1&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;RedAutoScaleInfo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;RedAutoScaleLoInfo&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;RedAutoScaleHiInfo&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;RedMinScaleInfo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;RedMaxScaleInfo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GreenAutoScaleInfo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GreenAutoScaleLoInfo&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GreenAutoScaleHiInfo&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GreenMinScaleInfo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GreenMaxScaleInfo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BlueAutoScaleInfo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BlueAutoScaleLoInfo&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BlueAutoScaleHiInfo&#39;</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BlueMinScaleInfo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BlueMaxScaleInfo&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="c1"># (&#39;OverlayPlaneColor&#39;, read_uic_overlay_plane_color),</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">PILATUS_HEADER</span><span class="p">():</span>
        <span class="c1"># PILATUS CBF Header Specification, Version 1.4</span>
        <span class="c1"># Map key to [value_indices], type</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;Detector&#39;</span><span class="p">:</span> <span class="p">([</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)],</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s1">&#39;Pixel_size&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Silicon&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">3</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Exposure_time&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Exposure_period&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Tau&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Count_cutoff&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;Threshold_setting&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Gain_setting&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s1">&#39;N_excluded_pixels&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;Excluded_pixels&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s1">&#39;Flat_field&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s1">&#39;Trim_file&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s1">&#39;Image_path&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">),</span>
            <span class="c1"># optional</span>
            <span class="s1">&#39;Wavelength&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Energy_range&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Detector_distance&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Detector_Voffset&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Beam_xy&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Flux&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s1">&#39;Filter_transmission&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Start_angle&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Angle_increment&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Detector_2theta&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Polarization&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Alpha&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Kappa&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Phi&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Phi_increment&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Chi&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Chi_increment&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Oscillation_axis&#39;</span><span class="p">:</span> <span class="p">([</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)],</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s1">&#39;N_oscillations&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;Start_position&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Position_increment&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Shutter_time&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Omega&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">),</span>
            <span class="s1">&#39;Omega_increment&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">REVERSE_BITORDER_BYTES</span><span class="p">():</span>
        <span class="c1"># Bytes with reversed bitorder</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x80</span><span class="s1">@</span><span class="se">\xc0</span><span class="s1"> </span><span class="se">\xa0</span><span class="s1">`</span><span class="se">\xe0\x10\x90</span><span class="s1">P</span><span class="se">\xd0</span><span class="s1">0</span><span class="se">\xb0</span><span class="s1">p</span><span class="se">\xf0\x08\x88</span><span class="s1">H</span><span class="se">\xc8</span><span class="s1">(&#39;</span>
            <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xa8</span><span class="s1">h</span><span class="se">\xe8\x18\x98</span><span class="s1">X</span><span class="se">\xd8</span><span class="s1">8</span><span class="se">\xb8</span><span class="s1">x</span><span class="se">\xf8\x04\x84</span><span class="s1">D</span><span class="se">\xc4</span><span class="s1">$</span><span class="se">\xa4</span><span class="s1">d</span><span class="se">\xe4\x14</span><span class="s1">&#39;</span>
            <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x94</span><span class="s1">T</span><span class="se">\xd4</span><span class="s1">4</span><span class="se">\xb4</span><span class="s1">t</span><span class="se">\xf4\x0c\x8c</span><span class="s1">L</span><span class="se">\xcc</span><span class="s1">,</span><span class="se">\xac</span><span class="s1">l</span><span class="se">\xec\x1c\x9c\\\xdc</span><span class="s1">&lt;</span><span class="se">\xbc</span><span class="s1">|&#39;</span>
            <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xfc\x02\x82</span><span class="s1">B</span><span class="se">\xc2</span><span class="s1">&quot;</span><span class="se">\xa2</span><span class="s1">b</span><span class="se">\xe2\x12\x92</span><span class="s1">R</span><span class="se">\xd2</span><span class="s1">2</span><span class="se">\xb2</span><span class="s1">r</span><span class="se">\xf2\n\x8a</span><span class="s1">J</span><span class="se">\xca</span><span class="s1">*&#39;</span>
            <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xaa</span><span class="s1">j</span><span class="se">\xea\x1a\x9a</span><span class="s1">Z</span><span class="se">\xda</span><span class="s1">:</span><span class="se">\xba</span><span class="s1">z</span><span class="se">\xfa\x06\x86</span><span class="s1">F</span><span class="se">\xc6</span><span class="s1">&amp;</span><span class="se">\xa6</span><span class="s1">f</span><span class="se">\xe6\x16</span><span class="s1">&#39;</span>
            <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x96</span><span class="s1">V</span><span class="se">\xd6</span><span class="s1">6</span><span class="se">\xb6</span><span class="s1">v</span><span class="se">\xf6\x0e\x8e</span><span class="s1">N</span><span class="se">\xce</span><span class="s1">.</span><span class="se">\xae</span><span class="s1">n</span><span class="se">\xee\x1e\x9e</span><span class="s1">^</span><span class="se">\xde</span><span class="s1">&gt;</span><span class="se">\xbe</span><span class="s1">~&#39;</span>
            <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xfe\x01\x81</span><span class="s1">A</span><span class="se">\xc1</span><span class="s1">!</span><span class="se">\xa1</span><span class="s1">a</span><span class="se">\xe1\x11\x91</span><span class="s1">Q</span><span class="se">\xd1</span><span class="s1">1</span><span class="se">\xb1</span><span class="s1">q</span><span class="se">\xf1\t\x89</span><span class="s1">I</span><span class="se">\xc9</span><span class="s1">)&#39;</span>
            <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xa9</span><span class="s1">i</span><span class="se">\xe9\x19\x99</span><span class="s1">Y</span><span class="se">\xd9</span><span class="s1">9</span><span class="se">\xb9</span><span class="s1">y</span><span class="se">\xf9\x05\x85</span><span class="s1">E</span><span class="se">\xc5</span><span class="s1">%</span><span class="se">\xa5</span><span class="s1">e</span><span class="se">\xe5\x15</span><span class="s1">&#39;</span>
            <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x95</span><span class="s1">U</span><span class="se">\xd5</span><span class="s1">5</span><span class="se">\xb5</span><span class="s1">u</span><span class="se">\xf5\r\x8d</span><span class="s1">M</span><span class="se">\xcd</span><span class="s1">-</span><span class="se">\xad</span><span class="s1">m</span><span class="se">\xed\x1d\x9d</span><span class="s1">]</span><span class="se">\xdd</span><span class="s1">=</span><span class="se">\xbd</span><span class="s1">}&#39;</span>
            <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xfd\x03\x83</span><span class="s1">C</span><span class="se">\xc3</span><span class="s1">#</span><span class="se">\xa3</span><span class="s1">c</span><span class="se">\xe3\x13\x93</span><span class="s1">S</span><span class="se">\xd3</span><span class="s1">3</span><span class="se">\xb3</span><span class="s1">s</span><span class="se">\xf3\x0b\x8b</span><span class="s1">K&#39;</span>
            <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xcb</span><span class="s1">+</span><span class="se">\xab</span><span class="s1">k</span><span class="se">\xeb\x1b\x9b</span><span class="s1">[</span><span class="se">\xdb</span><span class="s1">;</span><span class="se">\xbb</span><span class="s1">{</span><span class="se">\xfb\x07\x87</span><span class="s1">G</span><span class="se">\xc7\&#39;\xa7</span><span class="s1">g</span><span class="se">\xe7</span><span class="s1">&#39;</span>
            <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x17\x97</span><span class="s1">W</span><span class="se">\xd7</span><span class="s1">7</span><span class="se">\xb7</span><span class="s1">w</span><span class="se">\xf7\x0f\x8f</span><span class="s1">O</span><span class="se">\xcf</span><span class="s1">/</span><span class="se">\xaf</span><span class="s1">o</span><span class="se">\xef\x1f\x9f</span><span class="s1">_&#39;</span>
            <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xdf</span><span class="s1">?</span><span class="se">\xbf\x7f\xff</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">REVERSE_BITORDER_ARRAY</span><span class="p">():</span>
        <span class="c1"># Numpy array of bytes with reversed bitorder</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">REVERSE_BITORDER_BYTES</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ALLOCATIONGRANULARITY</span><span class="p">():</span>
        <span class="c1"># alignment for writing contiguous data to TIFF</span>
        <span class="kn">import</span> <span class="nn">mmap</span>  <span class="c1"># delayed import</span>
        <span class="k">return</span> <span class="n">mmap</span><span class="o">.</span><span class="n">ALLOCATIONGRANULARITY</span>


<span class="k">def</span> <span class="nf">read_tags</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">,</span> <span class="n">tagnames</span><span class="p">,</span>
              <span class="n">customtags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxifds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read tags from chain of IFDs and return as list of dicts.</span>

<span class="sd">    The file handle position must be at a valid IFD header.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">offsetsize</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">offsetformat</span> <span class="o">=</span> <span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;I&#39;</span>
        <span class="n">tagnosize</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">tagnoformat</span> <span class="o">=</span> <span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;H&#39;</span>
        <span class="n">tagsize</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">tagformat1</span> <span class="o">=</span> <span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;HH&#39;</span>
        <span class="n">tagformat2</span> <span class="o">=</span> <span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;I4s&#39;</span>
    <span class="k">elif</span> <span class="n">offsetsize</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">offsetformat</span> <span class="o">=</span> <span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;Q&#39;</span>
        <span class="n">tagnosize</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">tagnoformat</span> <span class="o">=</span> <span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;Q&#39;</span>
        <span class="n">tagsize</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">tagformat1</span> <span class="o">=</span> <span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;HH&#39;</span>
        <span class="n">tagformat2</span> <span class="o">=</span> <span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;Q8s&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid offset size&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">customtags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">customtags</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">maxifds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">maxifds</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unpack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">maxifds</span><span class="p">:</span>
        <span class="c1"># loop over IFDs</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tagno</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">tagnoformat</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">tagnosize</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tagno</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;suspicious number of tags&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;corrupted tag list at offset </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">offset</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="n">tags</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">tagsize</span> <span class="o">*</span> <span class="n">tagno</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tagno</span><span class="p">):</span>
            <span class="n">code</span><span class="p">,</span> <span class="n">type_</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">tagformat1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">index</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">count</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">tagformat2</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="mi">4</span><span class="p">:</span><span class="n">index</span><span class="o">+</span><span class="n">tagsize</span><span class="p">])</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="n">tagsize</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">tagnames</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">DATA_FORMATS</span><span class="p">[</span><span class="n">type_</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TiffTag</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s1">&#39;unknown tag data type </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">type_</span><span class="p">)</span>

            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%i%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">byteorder</span><span class="p">,</span> <span class="n">count</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">dtype</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">offsetsize</span> <span class="ow">or</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">customtags</span><span class="p">:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="ow">or</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="n">fh</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">size</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TiffTag</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s1">&#39;invalid tag value offset </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">offset</span><span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">customtags</span><span class="p">:</span>
                    <span class="n">readfunc</span> <span class="o">=</span> <span class="n">customtags</span><span class="p">[</span><span class="n">code</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">readfunc</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="mi">7</span> <span class="ow">or</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">read_bytes</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">tagnames</span> <span class="ow">or</span> <span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">read_numpy</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span> <span class="ow">or</span> <span class="n">type_</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">value</span><span class="p">[:</span><span class="n">size</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">customtags</span> <span class="ow">and</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TAG_TUPLE</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">type_</span> <span class="o">!=</span> <span class="mi">7</span> <span class="ow">and</span> <span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="c1"># TIFF ASCII fields can contain multiple strings,</span>
                <span class="c1">#   each terminated with a NUL</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripascii</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s1">&#39;tag </span><span class="si">%i</span><span class="s1">: coercing invalid ASCII to bytes&#39;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>

            <span class="n">tags</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
        <span class="c1"># read offset to next page</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">offsetformat</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">offsetsize</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">fh</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;invalid page offset </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">offset</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">maxifds</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">read_exif_ifd</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read EXIF tags from file and return as dict.&quot;&quot;&quot;</span>
    <span class="n">exif</span> <span class="o">=</span> <span class="n">read_tags</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">,</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">EXIF_TAGS</span><span class="p">,</span> <span class="n">maxifds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ExifVersion&#39;</span><span class="p">,</span> <span class="s1">&#39;FlashpixVersion&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exif</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">exif</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="s1">&#39;UserComment&#39;</span> <span class="ow">in</span> <span class="n">exif</span><span class="p">:</span>
        <span class="n">idcode</span> <span class="o">=</span> <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;UserComment&#39;</span><span class="p">][:</span><span class="mi">8</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">idcode</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;ASCII</span><span class="se">\x00\x00\x00</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;UserComment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">exif</span><span class="p">[</span><span class="s1">&#39;UserComment&#39;</span><span class="p">][</span><span class="mi">8</span><span class="p">:])</span>
            <span class="k">elif</span> <span class="n">idcode</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;UNICODE</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;UserComment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exif</span><span class="p">[</span><span class="s1">&#39;UserComment&#39;</span><span class="p">][</span><span class="mi">8</span><span class="p">:]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-16&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">exif</span>


<span class="k">def</span> <span class="nf">read_gps_ifd</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read GPS tags from file and return as dict.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">read_tags</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">,</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">GPS_TAGS</span><span class="p">,</span> <span class="n">maxifds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_interoperability_ifd</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read Interoperability tags from file and return as dict.&quot;&quot;&quot;</span>
    <span class="n">tag_names</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;InteroperabilityIndex&#39;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">read_tags</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">,</span> <span class="n">tag_names</span><span class="p">,</span> <span class="n">maxifds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_bytes</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read tag data from file and return as byte string.&quot;&quot;&quot;</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;B&#39;</span> <span class="k">if</span> <span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span> <span class="k">else</span> <span class="n">byteorder</span><span class="o">+</span><span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">count</span> <span class="o">*=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">count</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;failed to read all bytes: </span><span class="si">%i</span><span class="s1">, </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">count</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">read_utf8</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read tag data from file and return as unicode string.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_numpy</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read tag data from file and return as numpy array.&quot;&quot;&quot;</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span> <span class="k">if</span> <span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span> <span class="k">else</span> <span class="n">byteorder</span><span class="o">+</span><span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_colormap</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read ColorMap data from file and return as numpy array.&quot;&quot;&quot;</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="n">dtype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">count</span><span class="p">)</span>
    <span class="n">cmap</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cmap</span>


<span class="k">def</span> <span class="nf">read_json</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read JSON tag data from file and return as object.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;invalid JSON &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_mm_header</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read FluoView mm_header tag from file and return as dict.&quot;&quot;&quot;</span>
    <span class="n">mmh</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_record</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">MM_HEADER</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)</span>
    <span class="n">mmh</span> <span class="o">=</span> <span class="n">recarray2dict</span><span class="p">(</span><span class="n">mmh</span><span class="p">)</span>
    <span class="n">mmh</span><span class="p">[</span><span class="s1">&#39;Dimensions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">bytes2str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">mmh</span><span class="p">[</span><span class="s1">&#39;Dimensions&#39;</span><span class="p">]]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">mmh</span><span class="p">[</span><span class="s1">&#39;GrayChannel&#39;</span><span class="p">]</span>
    <span class="n">mmh</span><span class="p">[</span><span class="s1">&#39;GrayChannel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">bytes2str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">mmh</span>


<span class="k">def</span> <span class="nf">read_mm_stamp</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read FluoView mm_stamp tag from file and return as numpy.ndarray.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_uic1tag</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">,</span> <span class="n">planecount</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MetaMorph STK UIC1Tag from file and return as dict.</span>

<span class="sd">    Return empty dictionary if planecount is unknown.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;2I&#39;</span><span class="p">,</span> <span class="s1">&#39;1I&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;2I&#39;</span><span class="p">:</span>
        <span class="c1"># pre MetaMorph 2.5 (not tested)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;u4&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ZDistance&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]}</span>
    <span class="k">elif</span> <span class="n">planecount</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
            <span class="n">tagid</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tagid</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">):</span>
                <span class="c1"># silently skip unexpected tags</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">read_uic_tag</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">tagid</span><span class="p">,</span> <span class="n">planecount</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">read_uic2tag</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">planecount</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MetaMorph STK UIC2Tag from file and return as dict.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;2I&#39;</span> <span class="ow">and</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;u4&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="n">planecount</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">planecount</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;ZDistance&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="s1">&#39;DateCreated&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>  <span class="c1"># julian days</span>
        <span class="s1">&#39;TimeCreated&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span>  <span class="c1"># milliseconds</span>
        <span class="s1">&#39;DateModified&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span>  <span class="c1"># julian days</span>
        <span class="s1">&#39;TimeModified&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]}</span>  <span class="c1"># milliseconds</span>


<span class="k">def</span> <span class="nf">read_uic3tag</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">planecount</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MetaMorph STK UIC3Tag from file and return as dict.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;2I&#39;</span> <span class="ow">and</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;u4&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">planecount</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">planecount</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Wavelengths&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]}</span>


<span class="k">def</span> <span class="nf">read_uic4tag</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">planecount</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MetaMorph STK UIC4Tag from file and return as dict.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;1I&#39;</span> <span class="ow">and</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">tagid</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;H&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tagid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">read_uic_tag</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">tagid</span><span class="p">,</span> <span class="n">planecount</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">read_uic_tag</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">tagid</span><span class="p">,</span> <span class="n">planecount</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read a single UIC tag value from file and return tag name and value.</span>

<span class="sd">    UIC1Tags use an offset.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">read_int</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;</span><span class="si">%i</span><span class="s1">I&#39;</span> <span class="o">%</span> <span class="n">count</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">count</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">value</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">UIC_TAGS</span><span class="p">[</span><span class="n">tagid</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="c1"># unknown tag</span>
        <span class="k">return</span> <span class="s1">&#39;_TagId</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tagid</span><span class="p">,</span> <span class="n">read_int</span><span class="p">()</span>

    <span class="n">Fraction</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">UIC_TAGS</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">offset</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">off</span> <span class="o">=</span> <span class="n">read_int</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">off</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;invalid offset for uic tag &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">off</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">off</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># skip</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">read_int</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># int</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">read_int</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="n">Fraction</span><span class="p">:</span>
        <span class="c1"># fraction</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">read_int</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="n">julian_datetime</span><span class="p">:</span>
        <span class="c1"># datetime</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">julian_datetime</span><span class="p">(</span><span class="o">*</span><span class="n">read_int</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="n">read_uic_image_property</span><span class="p">:</span>
        <span class="c1"># ImagePropertyEx</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">read_uic_image_property</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># pascal string</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">read_int</span><span class="p">()</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">10</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="n">size</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">))[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">offset</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;corrupt string in uic tag &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid string size: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">size</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">p&#39;</span><span class="p">:</span>
        <span class="c1"># sequence of pascal strings</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">planecount</span><span class="p">):</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">read_int</span><span class="p">()</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">10</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="n">size</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">))[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">string</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>
                <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">offset</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;corrupt string in uic tag &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid string size: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">size</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># struct or numpy type</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="n">dtype</span>
        <span class="k">if</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">dtype</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span> <span class="o">%</span> <span class="n">planecount</span>
        <span class="k">if</span> <span class="s1">&#39;(&#39;</span> <span class="ow">in</span> <span class="n">dtype</span><span class="p">:</span>
            <span class="c1"># numpy type</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># assume fractions</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">value</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># struct format</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">dtype</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">offset</span><span class="p">:</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">read_uic_image_property</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read UIC ImagePropertyEx tag from file and return as dict.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: test this</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="n">size</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">))[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">flags</span><span class="p">,</span> <span class="n">prop</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;IB&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="n">size</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_cz_lsminfo</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read CZ_LSMINFO tag from file and return as dict.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span>
    <span class="n">magic_number</span><span class="p">,</span> <span class="n">structure_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;II&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">magic_number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">50350412</span><span class="p">,</span> <span class="mi">67127628</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid CZ_LSMINFO structure&#39;</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">structure_size</span> <span class="o">&lt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span><span class="p">:</span>
        <span class="c1"># adjust structure according to structure_size</span>
        <span class="n">lsminfo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">structure_size</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">lsminfo</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lsminfo</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO</span>

    <span class="n">lsminfo</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_record</span><span class="p">(</span><span class="n">lsminfo</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)</span>
    <span class="n">lsminfo</span> <span class="o">=</span> <span class="n">recarray2dict</span><span class="p">(</span><span class="n">lsminfo</span><span class="p">)</span>

    <span class="c1"># read LSM info subrecords at offsets</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">reader</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO_READERS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">reader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">lsminfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Offset&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lsminfo</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">reader</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">lsminfo</span>


<span class="k">def</span> <span class="nf">read_lsm_floatpairs</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read LSM sequence of float pairs from file and return as list.&quot;&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;2f8&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_lsm_positions</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read LSM positions from file and return as list.&quot;&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;2f8&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_lsm_timestamps</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read LSM time stamps from file and return as list.&quot;&quot;&quot;</span>
    <span class="n">size</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;ii&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">count</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;invalid LSM TimeStamps block&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="c1"># return struct.unpack(&#39;&lt;%dd&#39; % count, fh.read(8*count))</span>
    <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;&lt;f8&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_lsm_eventlist</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read LSM events from file and return as list of (time, type, text).&quot;&quot;&quot;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;II&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">esize</span><span class="p">,</span> <span class="n">etime</span><span class="p">,</span> <span class="n">etype</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;IdI&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
        <span class="n">etext</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">esize</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)))</span>
        <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">etime</span><span class="p">,</span> <span class="n">etype</span><span class="p">,</span> <span class="n">etext</span><span class="p">))</span>
        <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">events</span>


<span class="k">def</span> <span class="nf">read_lsm_channelcolors</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read LSM ChannelColors structure from file and return as dict.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Mono&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Colors&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;ColorNames&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">ncolors</span><span class="p">,</span> <span class="n">nnames</span><span class="p">,</span>
     <span class="n">coffset</span><span class="p">,</span> <span class="n">noffset</span><span class="p">,</span> <span class="n">mono</span><span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;IIIIII&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ncolors</span> <span class="o">!=</span> <span class="n">nnames</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;invalid LSM ChannelColors structure&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Mono&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">mono</span><span class="p">)</span>
    <span class="c1"># Colors</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">coffset</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_array</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ncolors</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">ncolors</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Colors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="c1"># ColorNames</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">noffset</span><span class="p">)</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">noffset</span><span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bytes2str</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">3</span><span class="o">+</span><span class="n">size</span><span class="p">]))</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="o">+</span><span class="n">size</span><span class="p">:]</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ColorNames&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">names</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">read_lsm_scaninfo</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read LSM ScanInfo structure from file and return as dict.&quot;&quot;&quot;</span>
    <span class="n">block</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">block</span><span class="p">]</span>
    <span class="n">unpack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span>
    <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x10000000</span><span class="p">:</span>
        <span class="c1"># not a Recording sub block</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;invalid LSM ScanInfo structure&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">block</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">entry</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;III&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># ascii</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># long</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="c1"># rational</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;d&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO_SCANINFO_ARRAYS</span><span class="p">:</span>
            <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO_SCANINFO_ARRAYS</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span>
            <span class="n">newobj</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">block</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">newobj</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">newobj</span>
        <span class="k">elif</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO_SCANINFO_STRUCTS</span><span class="p">:</span>
            <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="n">newobj</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">block</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newobj</span><span class="p">)</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">newobj</span>
        <span class="k">elif</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO_SCANINFO_ATTRIBUTES</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">CZ_LSMINFO_SCANINFO_ATTRIBUTES</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span>
            <span class="n">block</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">entry</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">:</span>
            <span class="c1"># end sub block</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># unknown entry</span>
            <span class="n">block</span><span class="p">[</span><span class="s1">&#39;Entry0x</span><span class="si">%x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blocks</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">block</span>


<span class="k">def</span> <span class="nf">read_tvips_header</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read TVIPS EM-MENU headers and return as dict.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_record</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">TVIPS_HEADER_V1</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">typestr</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TVIPS_HEADER_V1</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_record</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">TVIPS_HEADER_V2</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Magic&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="mh">0xaaaaaaaa</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;invalid TVIPS v2 magic number&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="c1"># decode utf16 strings</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">typestr</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">TVIPS_HEADER_V2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">typestr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf16&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">stripnull</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="c1"># convert nm to m</span>
        <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="s1">&#39;XY&#39;</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;PhysicalPixelSize&#39;</span> <span class="o">+</span> <span class="n">axis</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">1e9</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;PixelSize&#39;</span> <span class="o">+</span> <span class="n">axis</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">1e9</span>
    <span class="k">elif</span> <span class="n">header</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;unknown TVIPS header version&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">read_fei_metadata</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read FEI SFEG/HELIOS headers and return as dict.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">section</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">count</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">):</span>
            <span class="n">section</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">result</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">section</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">section</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">read_cz_sem</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read Zeiss SEM tag and return as dict.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="p">()}</span>
    <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">count</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">v</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">number</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">number</span> <span class="o">!=</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">number</span>
                    <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">number</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">number</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">number</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;No&#39;</span><span class="p">,</span> <span class="s1">&#39;Off&#39;</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Yes&#39;</span><span class="p">,</span> <span class="s1">&#39;On&#39;</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unit</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">unit</span><span class="p">,)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">astype</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)),)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">read_nih_image_header</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offsetsize</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read NIH_IMAGE_HEADER tag from file and return as dict.&quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read_record</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">NIH_IMAGE_HEADER</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="n">byteorder</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(</span><span class="n">byteorder</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">recarray2dict</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">a</span><span class="p">[</span><span class="s1">&#39;XUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;XUnit&#39;</span><span class="p">][:</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;XUnitSize&#39;</span><span class="p">]]</span>
    <span class="n">a</span><span class="p">[</span><span class="s1">&#39;UM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;UM&#39;</span><span class="p">][:</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;UMsize&#39;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">read_scanimage_metadata</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read ScanImage BigTIFF v3 static and ROI metadata from open file.</span>

<span class="sd">    Return non-varying frame data as dict and ROI group data as JSON.</span>

<span class="sd">    The settings can be used to read image data and metadata without parsing</span>
<span class="sd">    the TIFF file.</span>

<span class="sd">    Raise ValueError if file does not contain valid ScanImage v3 metadata.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">byteorder</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;2sH&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">byteorder</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;II&#39;</span> <span class="ow">or</span> <span class="n">version</span> <span class="o">!=</span> <span class="mi">43</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">magic</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">size0</span><span class="p">,</span> <span class="n">size1</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;IIII&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">magic</span> <span class="o">!=</span> <span class="mi">117637889</span> <span class="ow">or</span> <span class="n">version</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not a ScanImage BigTIFF v3 file&#39;</span><span class="p">)</span>

    <span class="n">frame_data</span> <span class="o">=</span> <span class="n">matlabstr2py</span><span class="p">(</span><span class="n">bytes2str</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">roi_data</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">size1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">size1</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">frame_data</span><span class="p">,</span> <span class="n">roi_data</span>


<span class="k">def</span> <span class="nf">read_micromanager_metadata</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MicroManager non-TIFF settings from open file and return as dict.</span>

<span class="sd">    The settings can be used to read image data without parsing the TIFF file.</span>

<span class="sd">    Raise ValueError if the file does not contain valid MicroManager metadata.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">byteorder</span> <span class="o">=</span> <span class="p">{</span><span class="sa">b</span><span class="s1">&#39;II&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;MM&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">}[</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not a MicroManager TIFF file&#39;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="p">(</span><span class="n">index_header</span><span class="p">,</span> <span class="n">index_offset</span><span class="p">,</span> <span class="n">display_header</span><span class="p">,</span> <span class="n">display_offset</span><span class="p">,</span>
     <span class="n">comments_header</span><span class="p">,</span> <span class="n">comments_offset</span><span class="p">,</span> <span class="n">summary_header</span><span class="p">,</span> <span class="n">summary_length</span>
     <span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;IIIIIIII&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">summary_header</span> <span class="o">!=</span> <span class="mi">2355492</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid MicroManager summary header&#39;</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">summary_length</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">index_header</span> <span class="o">!=</span> <span class="mi">54773648</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid MicroManager index header&#39;</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">index_offset</span><span class="p">)</span>
    <span class="n">header</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">header</span> <span class="o">!=</span> <span class="mi">3453623</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid MicroManager index header&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;IIIII&#39;</span><span class="o">*</span><span class="n">count</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">20</span><span class="o">*</span><span class="n">count</span><span class="p">))</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;IndexMap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Channel&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[::</span><span class="mi">5</span><span class="p">],</span>
                          <span class="s1">&#39;Slice&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">5</span><span class="p">],</span>
                          <span class="s1">&#39;Frame&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">5</span><span class="p">],</span>
                          <span class="s1">&#39;Position&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">::</span><span class="mi">5</span><span class="p">],</span>
                          <span class="s1">&#39;Offset&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">::</span><span class="mi">5</span><span class="p">]}</span>

    <span class="k">if</span> <span class="n">display_header</span> <span class="o">!=</span> <span class="mi">483765892</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid MicroManager display header&#39;</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">display_offset</span><span class="p">)</span>
    <span class="n">header</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">header</span> <span class="o">!=</span> <span class="mi">347834724</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid MicroManager display header&#39;</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;DisplaySettings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">comments_header</span> <span class="o">!=</span> <span class="mi">99384722</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid MicroManager comments header&#39;</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">comments_offset</span><span class="p">)</span>
    <span class="n">header</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span> <span class="o">+</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">header</span> <span class="o">!=</span> <span class="mi">84720485</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid MicroManager comments header&#39;</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Comments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">read_metaseries_catalog</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read MetaSeries non-TIFF hint catalog from file.</span>

<span class="sd">    Raise ValueError if the file does not contain a valid hint catalog.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: implement read_metaseries_catalog</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">imagej_metadata_tags</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return IJMetadata and IJMetadataByteCounts tags from metadata dict.</span>

<span class="sd">    The tags can be passed to the TiffWriter.save function as extratags.</span>

<span class="sd">    The metadata dict may contain the following keys and values:</span>

<span class="sd">        Info : str</span>
<span class="sd">            Human-readable information as string.</span>
<span class="sd">        Labels : sequence of str</span>
<span class="sd">            Human-readable labels for each channel.</span>
<span class="sd">        Ranges : sequence of doubles</span>
<span class="sd">            Lower and upper values for each channel.</span>
<span class="sd">        LUTs : sequence of (3, 256) uint8 ndarrays</span>
<span class="sd">            Color palettes for each channel.</span>
<span class="sd">        Plot : bytes</span>
<span class="sd">            Undocumented ImageJ internal format.</span>
<span class="sd">        ROI: bytes</span>
<span class="sd">            Undocumented ImageJ internal region of interest format.</span>
<span class="sd">        Overlays : bytes</span>
<span class="sd">            Undocumented ImageJ internal format.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">header</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;IJIJ&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;JIJI&#39;</span><span class="p">}[</span><span class="n">byteorder</span><span class="p">]]</span>
    <span class="n">bytecounts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_string</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-16&#39;</span> <span class="o">+</span> <span class="p">{</span><span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;be&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="s1">&#39;le&#39;</span><span class="p">}[</span><span class="n">byteorder</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_doubles</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;d&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ndarray</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="n">metadata_types</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;Info&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_string</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Labels&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;labl&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_string</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Ranges&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;rang&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_doubles</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;LUTs&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;luts&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_ndarray</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Plot&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;plot&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_bytes</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;roi &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_bytes</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Overlays&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;over&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_bytes</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">metadata_types</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
            <span class="n">mtype</span> <span class="o">=</span> <span class="n">mtype</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mtype</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">)</span>
            <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">bytecounts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">body</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">()</span>
    <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">body</span>
    <span class="n">bytecounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="n">bytecounts</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;I&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">bytecounts</span><span class="p">)),</span> <span class="o">*</span><span class="n">bytecounts</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">((</span><span class="mi">50839</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">50838</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bytecounts</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="p">,</span> <span class="n">bytecounts</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">imagej_metadata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bytecounts</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return IJMetadata tag value as dict.</span>

<span class="sd">    The &#39;Info&#39; string can have multiple formats, e.g. OIF or ScanImage,</span>
<span class="sd">    that might be parsed into dicts using the matlabstr2py or</span>
<span class="sd">    oiffile.SettingsFile functions.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_string</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-16&#39;</span> <span class="o">+</span> <span class="p">{</span><span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;be&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="s1">&#39;le&#39;</span><span class="p">}[</span><span class="n">byteorder</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_doubles</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;d&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span><span class="p">)),</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lut</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;uint8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="n">metadata_types</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># big-endian</span>
        <span class="sa">b</span><span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Info&#39;</span><span class="p">,</span> <span class="n">_string</span><span class="p">),</span>
        <span class="sa">b</span><span class="s1">&#39;labl&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Labels&#39;</span><span class="p">,</span> <span class="n">_string</span><span class="p">),</span>
        <span class="sa">b</span><span class="s1">&#39;rang&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Ranges&#39;</span><span class="p">,</span> <span class="n">_doubles</span><span class="p">),</span>
        <span class="sa">b</span><span class="s1">&#39;luts&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;LUTs&#39;</span><span class="p">,</span> <span class="n">_lut</span><span class="p">),</span>
        <span class="sa">b</span><span class="s1">&#39;plot&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Plots&#39;</span><span class="p">,</span> <span class="n">_bytes</span><span class="p">),</span>
        <span class="sa">b</span><span class="s1">&#39;roi &#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="n">_bytes</span><span class="p">),</span>
        <span class="sa">b</span><span class="s1">&#39;over&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Overlays&#39;</span><span class="p">,</span> <span class="n">_bytes</span><span class="p">)}</span>
    <span class="n">metadata_types</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>  <span class="c1"># little-endian</span>
        <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadata_types</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">bytecounts</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no ImageJ metadata&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;IJIJ&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;JIJI&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid ImageJ metadata&#39;</span><span class="p">)</span>

    <span class="n">header_size</span> <span class="o">=</span> <span class="n">bytecounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">header_size</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="ow">or</span> <span class="n">header_size</span> <span class="o">&gt;</span> <span class="mi">804</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid ImageJ metadata header size&#39;</span><span class="p">)</span>

    <span class="n">ntypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">header_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">byteorder</span><span class="o">+</span><span class="s1">&#39;4sI&#39;</span><span class="o">*</span><span class="n">ntypes</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">4</span><span class="o">+</span><span class="n">ntypes</span><span class="o">*</span><span class="mi">8</span><span class="p">])</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">ntypes</span> <span class="o">*</span> <span class="mi">8</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">header</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">metadata_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mtype</span><span class="p">,</span> <span class="p">(</span><span class="n">bytes2str</span><span class="p">(</span><span class="n">mtype</span><span class="p">),</span> <span class="n">read_bytes</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">pos1</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">bytecounts</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos1</span><span class="p">],</span> <span class="n">byteorder</span><span class="p">))</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">pos1</span>
        <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">values</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">imagej_description_metadata</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return metatata from ImageJ image description as dict.</span>

<span class="sd">    Raise ValueError if not a valid ImageJ description.</span>

<span class="sd">    &gt;&gt;&gt; description = &#39;ImageJ=1.11a\\nimages=510\\nhyperstack=true\\n&#39;</span>
<span class="sd">    &gt;&gt;&gt; imagej_description_metadata(description)  # doctest: +SKIP</span>
<span class="sd">    {&#39;ImageJ&#39;: &#39;1.11a&#39;, &#39;images&#39;: 510, &#39;hyperstack&#39;: True}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_bool</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;true&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}[</span><span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">description</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">_bool</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">if</span> <span class="s1">&#39;ImageJ&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not a ImageJ image description&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">imagej_description</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">rgb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colormaped</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1.11a&#39;</span><span class="p">,</span>
                       <span class="n">hyperstack</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return ImageJ image description from data shape.</span>

<span class="sd">    ImageJ can handle up to 6 dimensions in order TZCYXS.</span>

<span class="sd">    &gt;&gt;&gt; imagej_description((51, 5, 2, 196, 171))  # doctest: +SKIP</span>
<span class="sd">    ImageJ=1.11a</span>
<span class="sd">    images=510</span>
<span class="sd">    channels=2</span>
<span class="sd">    slices=5</span>
<span class="sd">    frames=51</span>
<span class="sd">    hyperstack=true</span>
<span class="sd">    mode=grayscale</span>
<span class="sd">    loop=false</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">colormaped</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;ImageJ colormapping not supported&#39;</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">imagej_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">rgb</span><span class="o">=</span><span class="n">rgb</span><span class="p">)</span>
    <span class="n">rgb</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ImageJ=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">version</span><span class="p">]</span>
    <span class="n">append</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;images=</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">hyperstack</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hyperstack</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">append</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;hyperstack=true&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">append</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;hyperstack=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">bool</span><span class="p">(</span><span class="n">hyperstack</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;channels=</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rgb</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;grayscale&#39;</span>
    <span class="k">if</span> <span class="n">hyperstack</span> <span class="ow">and</span> <span class="n">mode</span><span class="p">:</span>
        <span class="n">append</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;mode=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;slices=</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;frames=</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">append</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;loop=false&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">append</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;loop=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">bool</span><span class="p">(</span><span class="n">loop</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">append</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">value</span><span class="p">))</span>

    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span> <span class="o">+</span> <span class="n">append</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">imagej_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">rgb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return shape normalized to 6D ImageJ hyperstack TZCYXS.</span>

<span class="sd">    Raise ValueError if not a valid ImageJ hyperstack shape.</span>

<span class="sd">    &gt;&gt;&gt; imagej_shape((2, 3, 4, 5, 3), False)</span>
<span class="sd">    (2, 3, 4, 5, 3, 1)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">)</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid ImageJ hyperstack: not 2 to 6 dimensional&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rgb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">rgb</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid ImageJ hyperstack: not a RGB image&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rgb</span> <span class="ow">and</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid ImageJ hyperstack: not a non-RGB image&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rgb</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">6</span> <span class="o">-</span> <span class="n">ndim</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">-</span> <span class="n">ndim</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>


<span class="k">def</span> <span class="nf">json_description</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return JSON image description from data shape and other meta data.</span>

<span class="sd">    Return UTF-8 encoded JSON.</span>

<span class="sd">    &gt;&gt;&gt; json_description((256, 256, 3), axes=&#39;YXS&#39;)  # doctest: +SKIP</span>
<span class="sd">    b&#39;{&quot;shape&quot;: [256, 256, 3], &quot;axes&quot;: &quot;YXS&quot;}&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>  <span class="c1"># .encode(&#39;utf-8&#39;)</span>


<span class="k">def</span> <span class="nf">json_description_metadata</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return metatata from JSON formated image description as dict.</span>

<span class="sd">    Raise ValuError if description is of unknown format.</span>

<span class="sd">    &gt;&gt;&gt; description = &#39;{&quot;shape&quot;: [256, 256, 3], &quot;axes&quot;: &quot;YXS&quot;}&#39;</span>
<span class="sd">    &gt;&gt;&gt; json_description_metadata(description)  # doctest: +SKIP</span>
<span class="sd">    {&#39;shape&#39;: [256, 256, 3], &#39;axes&#39;: &#39;YXS&#39;}</span>
<span class="sd">    &gt;&gt;&gt; json_description_metadata(&#39;shape=(256, 256, 3)&#39;)</span>
<span class="sd">    {&#39;shape&#39;: (256, 256, 3)}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">description</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shape=&#39;</span><span class="p">:</span>
        <span class="c1"># old style &#39;shaped&#39; description; not JSON</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">description</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">description</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;{&#39;</span> <span class="ow">and</span> <span class="n">description</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;}&#39;</span><span class="p">:</span>
        <span class="c1"># JSON description</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid JSON image description&#39;</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">fluoview_description_metadata</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">ignoresections</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return metatata from FluoView image description as dict.</span>

<span class="sd">    The FluoView image description format is unspecified. Expect failures.</span>

<span class="sd">    &gt;&gt;&gt; descr = (&#39;[Intensity Mapping]\\nMap Ch0: Range=00000 to 02047\\n&#39;</span>
<span class="sd">    ...          &#39;[Intensity Mapping End]&#39;)</span>
<span class="sd">    &gt;&gt;&gt; fluoview_description_metadata(descr)</span>
<span class="sd">    {&#39;Intensity Mapping&#39;: {&#39;Map Ch0: Range&#39;: &#39;00000 to 02047&#39;}}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid FluoView image description&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ignoresections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ignoresections</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Region Info (Fields)&#39;</span><span class="p">,</span> <span class="s1">&#39;Protocol Description&#39;</span><span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">sections</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">]</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">description</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;[&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39; End]&#39;</span><span class="p">:</span>
                <span class="c1"># close section</span>
                <span class="k">del</span> <span class="n">sections</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">section</span> <span class="o">=</span> <span class="n">sections</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
                    <span class="n">section</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">section</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LUT &#39;</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">section</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span>
                    <span class="n">section</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
                <span class="k">continue</span>
            <span class="c1"># new section</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LUT &#39;</span><span class="p">:</span>
                <span class="n">section</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ignoresections</span><span class="p">:</span>
                <span class="n">section</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">comment</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">section</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">section</span>
            <span class="k">continue</span>
        <span class="c1"># add entry</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">section</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">section</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">continue</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span>
        <span class="k">if</span> <span class="n">key</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RGB &#39;</span><span class="p">:</span>
            <span class="n">section</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span> <span class="k">for</span> <span class="n">rgb</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">section</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">pilatus_description_metadata</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return metatata from Pilatus image description as dict.</span>

<span class="sd">    Return metadata from Pilatus pixel array detectors by Dectris, created</span>
<span class="sd">    by camserver or TVX software.</span>

<span class="sd">    &gt;&gt;&gt; pilatus_description_metadata(&#39;# Pixel_size 172e-6 m x 172e-6 m&#39;)</span>
<span class="sd">    {&#39;Pixel_size&#39;: (0.000172, 0.000172)}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;# &#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="s1">&#39;#:=,()&#39;</span><span class="p">:</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">description</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;  &#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PILATUS_HEADER</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;DateTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                    <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H %M %S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">continue</span>
        <span class="n">indices</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PILATUS_HEADER</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="c1"># assumes one slice</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">and</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;not&#39;</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NaN&#39;</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">svs_description_metadata</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return metatata from Aperio image description as dict.</span>

<span class="sd">    The Aperio image description format is unspecified. Expect failures.</span>

<span class="sd">    &gt;&gt;&gt; svs_description_metadata(&#39;Aperio Image Library v1.0&#39;)</span>
<span class="sd">    {&#39;Aperio Image Library&#39;: &#39;v1.0&#39;}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Aperio Image Library &#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid Aperio image description&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># &#39;Aperio Image Library&#39;</span>
    <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># TODO: parse this?</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; = &#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">stk_description_metadata</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return metadata from MetaMorph image description as list of dict.</span>

<span class="sd">    The MetaMorph image description format is unspecified. Expect failures.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;failed to parse MetaMorph image description&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">description</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">plane</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span>
                <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">metaseries_description_metadata</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return metatata from MetaSeries image description as dict.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;MetaData&gt;&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid MetaSeries image description&#39;</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">xml.etree</span> <span class="k">import</span> <span class="n">cElementTree</span> <span class="k">as</span> <span class="n">etree</span>  <span class="c1"># delayed import</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
    <span class="n">types</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;float&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
             <span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">asbool</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="c1"># recursive</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
            <span class="n">attrib</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">attrib</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attrib</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">attrib</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="n">t</span><span class="p">](</span><span class="n">v</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="n">adict</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="s1">&#39;Description&#39;</span> <span class="ow">in</span> <span class="n">adict</span><span class="p">:</span>
        <span class="n">adict</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adict</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&amp;#13;&amp;#10;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">adict</span>


<span class="k">def</span> <span class="nf">scanimage_description_metadata</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return metatata from ScanImage image description as dict.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">matlabstr2py</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">scanimage_artist_metadata</span><span class="p">(</span><span class="n">artist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return metatata from ScanImage artist tag as dict.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">artist</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;invalid JSON &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">artist</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_replace_by</span><span class="p">(</span><span class="n">module_function</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="n">__package__</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Try replace decorated function by module.function.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_warn</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">warn</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">warn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Functionality might be degraded or be slow.</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">warn</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">warn</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">warn</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">warn</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">importlib</span> <span class="k">import</span> <span class="n">import_module</span>
    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">_warn</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">warn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">identityfunc</span>

    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">module_function</span><span class="o">=</span><span class="n">module_function</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="n">warn</span><span class="p">):</span>
        <span class="n">module</span><span class="p">,</span> <span class="n">function</span> <span class="o">=</span> <span class="n">module_function</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">package</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">module</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="n">package</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">_warn</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">warn</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">func</span><span class="p">,</span> <span class="n">oldfunc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">function</span><span class="p">),</span> <span class="n">func</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">_warn</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">warn</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span>
        <span class="nb">globals</span><span class="p">()[</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">oldfunc</span>
        <span class="k">return</span> <span class="n">func</span>

    <span class="k">return</span> <span class="n">decorate</span>


<span class="k">def</span> <span class="nf">decode_floats</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decode floating point horizontal differencing.</span>

<span class="sd">    The TIFF predictor type 3 reorders the bytes of the image values and</span>
<span class="sd">    applies horizontal byte differencing to improve compression of floating</span>
<span class="sd">    point images. The ordering of interleaved color channels is preserved.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : numpy.ndarray</span>
<span class="sd">        The image to be decoded. The dtype must be a floating point.</span>
<span class="sd">        The shape must include the number of contiguous samples per pixel</span>
<span class="sd">        even if 1.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid data shape&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;dfe&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not a floating point image&#39;</span><span class="p">)</span>
    <span class="n">littleendian</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;little&#39;</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">)</span>
    <span class="c1"># undo horizontal byte differencing</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">numpy</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># reorder bytes</span>
    <span class="k">if</span> <span class="n">littleendian</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># back to float</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="nd">@_replace_by</span><span class="p">(</span><span class="s1">&#39;_tifffile.decode_packbits&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">decode_packbits</span><span class="p">(</span><span class="n">encoded</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decompress PackBits encoded byte string.</span>

<span class="sd">    PackBits is a simple byte-oriented run-length compression scheme.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">func</span> <span class="o">=</span> <span class="nb">ord</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span> <span class="k">else</span> <span class="n">identityfunc</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">result_extend</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">extend</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">129</span><span class="p">:</span>
                <span class="n">result_extend</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">n</span><span class="p">])</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="n">n</span>
            <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">129</span><span class="p">:</span>
                <span class="n">result_extend</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">258</span><span class="o">-</span><span class="n">n</span><span class="p">))</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span> <span class="k">else</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>


<span class="nd">@_replace_by</span><span class="p">(</span><span class="s1">&#39;_tifffile.decode_lzw&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">decode_lzw</span><span class="p">(</span><span class="n">encoded</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decompress LZW (Lempel-Ziv-Welch) encoded TIFF strip (byte string).</span>

<span class="sd">    The strip must begin with a CLEAR code and end with an EOI code.</span>

<span class="sd">    This implementation of the LZW decoding algorithm is described in (1) and</span>
<span class="sd">    is not compatible with old style LZW compressed files like quad-lzw.tif.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">len_encoded</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
    <span class="n">bitcount_max</span> <span class="o">=</span> <span class="n">len_encoded</span> <span class="o">*</span> <span class="mi">8</span>
    <span class="n">unpack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
        <span class="n">newtable</span> <span class="o">=</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newtable</span> <span class="o">=</span> <span class="p">[</span><span class="nb">bytes</span><span class="p">([</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">)]</span>
    <span class="n">newtable</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">next_code</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Return integer of &#39;bitw&#39; bits at &#39;bitcount&#39; position in encoded.&quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">bitcount</span> <span class="o">//</span> <span class="mi">8</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">encoded</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">code</span> <span class="o">&lt;&lt;=</span> <span class="n">bitcount</span> <span class="o">%</span> <span class="mi">8</span>
        <span class="n">code</span> <span class="o">&amp;=</span> <span class="n">mask</span>
        <span class="k">return</span> <span class="n">code</span> <span class="o">&gt;&gt;</span> <span class="n">shr</span>

    <span class="n">switchbitch</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># code: bit-width, shr-bits, bit-mask</span>
        <span class="mi">255</span><span class="p">:</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">9</span><span class="o">*</span><span class="s1">&#39;1&#39;</span><span class="o">+</span><span class="s1">&#39;0&#39;</span><span class="o">*</span><span class="mi">23</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
        <span class="mi">511</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="s1">&#39;1&#39;</span><span class="o">+</span><span class="s1">&#39;0&#39;</span><span class="o">*</span><span class="mi">22</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
        <span class="mi">1023</span><span class="p">:</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="o">*</span><span class="s1">&#39;1&#39;</span><span class="o">+</span><span class="s1">&#39;0&#39;</span><span class="o">*</span><span class="mi">21</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
        <span class="mi">2047</span><span class="p">:</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">12</span><span class="o">*</span><span class="s1">&#39;1&#39;</span><span class="o">+</span><span class="s1">&#39;0&#39;</span><span class="o">*</span><span class="mi">20</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="p">}</span>
    <span class="n">bitw</span><span class="p">,</span> <span class="n">shr</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">switchbitch</span><span class="p">[</span><span class="mi">255</span><span class="p">]</span>
    <span class="n">bitcount</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">len_encoded</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;strip must be at least 4 characters long&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">next_code</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">256</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;strip must begin with CLEAR code&#39;</span><span class="p">)</span>

    <span class="n">code</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">oldcode</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">result_append</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">next_code</span><span class="p">()</span>  <span class="c1"># ~5% faster when inlining this function</span>
        <span class="n">bitcount</span> <span class="o">+=</span> <span class="n">bitw</span>
        <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">257</span> <span class="ow">or</span> <span class="n">bitcount</span> <span class="o">&gt;=</span> <span class="n">bitcount_max</span><span class="p">:</span>  <span class="c1"># EOI</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">256</span><span class="p">:</span>  <span class="c1"># CLEAR</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">newtable</span><span class="p">[:]</span>
            <span class="n">table_append</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">append</span>
            <span class="n">lentable</span> <span class="o">=</span> <span class="mi">258</span>
            <span class="n">bitw</span><span class="p">,</span> <span class="n">shr</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">switchbitch</span><span class="p">[</span><span class="mi">255</span><span class="p">]</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">next_code</span><span class="p">()</span>
            <span class="n">bitcount</span> <span class="o">+=</span> <span class="n">bitw</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">257</span><span class="p">:</span>  <span class="c1"># EOI</span>
                <span class="k">break</span>
            <span class="n">result_append</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">code</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="n">lentable</span><span class="p">:</span>
                <span class="n">decoded</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
                <span class="n">newcode</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">oldcode</span><span class="p">]</span> <span class="o">+</span> <span class="n">decoded</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newcode</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">oldcode</span><span class="p">]</span>
                <span class="n">newcode</span> <span class="o">+=</span> <span class="n">newcode</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">decoded</span> <span class="o">=</span> <span class="n">newcode</span>
            <span class="n">result_append</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>
            <span class="n">table_append</span><span class="p">(</span><span class="n">newcode</span><span class="p">)</span>
            <span class="n">lentable</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">oldcode</span> <span class="o">=</span> <span class="n">code</span>
        <span class="k">if</span> <span class="n">lentable</span> <span class="ow">in</span> <span class="n">switchbitch</span><span class="p">:</span>
            <span class="n">bitw</span><span class="p">,</span> <span class="n">shr</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">switchbitch</span><span class="p">[</span><span class="n">lentable</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">code</span> <span class="o">!=</span> <span class="mi">257</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;unexpected end of LZW stream (code </span><span class="si">%i</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>

    <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>


<span class="nd">@_replace_by</span><span class="p">(</span><span class="s1">&#39;_tifffile.unpack_ints&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">unpack_ints</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">itemsize</span><span class="p">,</span> <span class="n">runlen</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decompress byte string to array of integers of any bit size &lt;= 32.</span>

<span class="sd">    This Python implementation is slow and only handles itemsizes 1, 2, 4, 8,</span>
<span class="sd">    16, 32, and 64.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : byte str</span>
<span class="sd">        Data to decompress.</span>
<span class="sd">    dtype : numpy.dtype or str</span>
<span class="sd">        A numpy boolean or integer type.</span>
<span class="sd">    itemsize : int</span>
<span class="sd">        Number of bits per integer.</span>
<span class="sd">    runlen : int</span>
<span class="sd">        Number of consecutive integers, after which to start at next byte.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; unpack_ints(b&#39;a&#39;, &#39;B&#39;, 1)</span>
<span class="sd">    array([0, 1, 1, 0, 0, 0, 0, 1], dtype=uint8)</span>
<span class="sd">    &gt;&gt;&gt; unpack_ints(b&#39;ab&#39;, &#39;B&#39;, 2)</span>
<span class="sd">    array([1, 2, 0, 1, 1, 2, 0, 2], dtype=uint8)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">itemsize</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># bitarray</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;|B&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unpackbits</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">runlen</span> <span class="o">%</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">runlen</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">runlen</span> <span class="o">%</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:</span><span class="n">runlen</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">itemsize</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">itemsize</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;itemsize not supported: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">itemsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;biu&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid dtype&#39;</span><span class="p">)</span>

    <span class="n">itembytes</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="k">if</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">itemsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">itembytes</span> <span class="o">!=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;dtype.itemsize too small&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">runlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">runlen</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">//</span> <span class="n">itemsize</span>
    <span class="n">skipbits</span> <span class="o">=</span> <span class="n">runlen</span> <span class="o">*</span> <span class="n">itemsize</span> <span class="o">%</span> <span class="mi">8</span>
    <span class="k">if</span> <span class="n">skipbits</span><span class="p">:</span>
        <span class="n">skipbits</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">skipbits</span>
    <span class="n">shrbits</span> <span class="o">=</span> <span class="n">itembytes</span><span class="o">*</span><span class="mi">8</span> <span class="o">-</span> <span class="n">itemsize</span>
    <span class="n">bitmask</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">itemsize</span><span class="o">*</span><span class="s1">&#39;1&#39;</span><span class="o">+</span><span class="s1">&#39;0&#39;</span><span class="o">*</span><span class="n">shrbits</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">dtypestr</span> <span class="o">=</span> <span class="s1">&#39;&gt;&#39;</span> <span class="o">+</span> <span class="n">dtype</span><span class="o">.</span><span class="n">char</span>  <span class="c1"># dtype always big-endian?</span>

    <span class="n">unpack</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">runlen</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span> <span class="o">//</span> <span class="p">(</span><span class="n">runlen</span><span class="o">*</span><span class="n">itemsize</span> <span class="o">+</span> <span class="n">skipbits</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">size</span><span class="p">,),</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">bitcount</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">bitcount</span> <span class="o">//</span> <span class="mi">8</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">itembytes</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">dtypestr</span><span class="p">,</span> <span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">dtypestr</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="p">(</span><span class="n">itembytes</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">code</span> <span class="o">&lt;&lt;=</span> <span class="n">bitcount</span> <span class="o">%</span> <span class="mi">8</span>
        <span class="n">code</span> <span class="o">&amp;=</span> <span class="n">bitmask</span>
        <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span> <span class="o">&gt;&gt;</span> <span class="n">shrbits</span>
        <span class="n">bitcount</span> <span class="o">+=</span> <span class="n">itemsize</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">runlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bitcount</span> <span class="o">+=</span> <span class="n">skipbits</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">unpack_rgb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;&lt;B&#39;</span><span class="p">,</span> <span class="n">bitspersample</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return array from byte string containing packed samples.</span>

<span class="sd">    Use to unpack RGB565 or RGB555 to RGB888 format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : byte str</span>
<span class="sd">        The data to be decoded. Samples in each pixel are stored consecutively.</span>
<span class="sd">        Pixels are aligned to 8, 16, or 32 bit boundaries.</span>
<span class="sd">    dtype : numpy.dtype</span>
<span class="sd">        The sample data type. The byteorder applies also to the data stream.</span>
<span class="sd">    bitspersample : tuple</span>
<span class="sd">        Number of bits for each sample in a pixel.</span>
<span class="sd">    rescale : bool</span>
<span class="sd">        Upscale samples to the number of bits in dtype.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : ndarray</span>
<span class="sd">        Flattened array of unpacked samples of native dtype.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; data = struct.pack(&#39;BBBB&#39;, 0x21, 0x08, 0xff, 0xff)</span>
<span class="sd">    &gt;&gt;&gt; print(unpack_rgb(data, &#39;&lt;B&#39;, (5, 6, 5), False))</span>
<span class="sd">    [ 1  1  1 31 63 31]</span>
<span class="sd">    &gt;&gt;&gt; print(unpack_rgb(data, &#39;&lt;B&#39;, (5, 6, 5)))</span>
<span class="sd">    [  8   4   8 255 255 255]</span>
<span class="sd">    &gt;&gt;&gt; print(unpack_rgb(data, &#39;&lt;B&#39;, (5, 5, 5)))</span>
<span class="sd">    [ 16   8   8 255 255 255]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">bits</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bitspersample</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&lt;=</span> <span class="mi">32</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="o">*</span><span class="mi">8</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bitspersample</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;sample size not supported: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">bitspersample</span><span class="p">))</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="s1">&#39;BHI&#39;</span> <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span><span class="o">*</span><span class="mi">8</span> <span class="o">&gt;=</span> <span class="n">bits</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">.</span><span class="n">byteorder</span><span class="o">+</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bitspersample</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bps</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bitspersample</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bitspersample</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="n">t</span> <span class="o">&amp;=</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;0b&#39;</span><span class="o">+</span><span class="s1">&#39;1&#39;</span><span class="o">*</span><span class="n">bps</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rescale</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="p">((</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">//</span> <span class="n">bps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">bps</span>
            <span class="k">if</span> <span class="n">o</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">o</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">bps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">//=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">o</span> <span class="o">-</span> <span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">result</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="nd">@_replace_by</span><span class="p">(</span><span class="s1">&#39;_tifffile.reverse_bitorder&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">reverse_bitorder</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reverse bits in each byte of byte string or numpy array.</span>

<span class="sd">    Decode data where pixels with lower column values are stored in the</span>
<span class="sd">    lower-order bits of the bytes (FillOrder is LSB2MSB).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : byte string or ndarray</span>
<span class="sd">        The data to be bit reversed. If byte string, a new bit-reversed byte</span>
<span class="sd">        string is returned. Numpy arrays are bit-reversed in-place.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; reverse_bitorder(b&#39;\\x01\\x64&#39;)</span>
<span class="sd">    b&#39;\\x80&amp;&#39;</span>
<span class="sd">    &gt;&gt;&gt; data = numpy.array([1, 666], dtype=&#39;uint16&#39;)</span>
<span class="sd">    &gt;&gt;&gt; reverse_bitorder(data)</span>
<span class="sd">    &gt;&gt;&gt; data</span>
<span class="sd">    array([  128, 16473], dtype=uint16)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">REVERSE_BITORDER_ARRAY</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">view</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">TIFF</span><span class="o">.</span><span class="n">REVERSE_BITORDER_BYTES</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;slices of arrays not supported&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">apply_colormap</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">colormap</span><span class="p">,</span> <span class="n">contig</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return palette-colored image.</span>

<span class="sd">    The image values are used to index the colormap on axis 1. The returned</span>
<span class="sd">    image is of shape image.shape+colormap.shape[0] and dtype colormap.dtype.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : numpy.ndarray</span>
<span class="sd">        Indexes into the colormap.</span>
<span class="sd">    colormap : numpy.ndarray</span>
<span class="sd">        RGB lookup table aka palette of shape (3, 2**bits_per_sample).</span>
<span class="sd">    contig : bool</span>
<span class="sd">        If True, return a contiguous array.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; image = numpy.arange(256, dtype=&#39;uint8&#39;)</span>
<span class="sd">    &gt;&gt;&gt; colormap = numpy.vstack([image, image, image]).astype(&#39;uint16&#39;) * 256</span>
<span class="sd">    &gt;&gt;&gt; apply_colormap(image, colormap)[-1]</span>
<span class="sd">    array([65280, 65280, 65280], dtype=uint16)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">rollaxis</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">contig</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span>


<span class="k">def</span> <span class="nf">reorient</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">orientation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return reoriented view of image array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : numpy.ndarray</span>
<span class="sd">        Non-squeezed output of asarray() functions.</span>
<span class="sd">        Axes -3 and -2 must be image length and width respectively.</span>
<span class="sd">    orientation : int or str</span>
<span class="sd">        One of TIFF.ORIENTATION names or values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ORIENTATION</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">ORIENTATION</span>
    <span class="n">orientation</span> <span class="o">=</span> <span class="n">enumarg</span><span class="p">(</span><span class="n">ORIENTATION</span><span class="p">,</span> <span class="n">orientation</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">ORIENTATION</span><span class="o">.</span><span class="n">TOPLEFT</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">image</span>
    <span class="k">elif</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">ORIENTATION</span><span class="o">.</span><span class="n">TOPRIGHT</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">elif</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">ORIENTATION</span><span class="o">.</span><span class="n">BOTLEFT</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">elif</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">ORIENTATION</span><span class="o">.</span><span class="n">BOTRIGHT</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">elif</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">ORIENTATION</span><span class="o">.</span><span class="n">LEFTTOP</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">ORIENTATION</span><span class="o">.</span><span class="n">RIGHTTOP</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">elif</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">ORIENTATION</span><span class="o">.</span><span class="n">RIGHTBOT</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">elif</span> <span class="n">orientation</span> <span class="o">==</span> <span class="n">ORIENTATION</span><span class="o">.</span><span class="n">LEFTBOT</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>


<span class="k">def</span> <span class="nf">repeat_nd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">repeats</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return read-only view into input array with elements repeated.</span>

<span class="sd">    Zoom nD image by integer factors using nearest neighbor interpolation</span>
<span class="sd">    (box filter).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a : array_like</span>
<span class="sd">        Input array.</span>
<span class="sd">    repeats : sequence of int</span>
<span class="sd">        The number of repetitions to apply along each dimension of input array.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; repeat_nd([[1, 2], [3, 4]], (2, 2))</span>
<span class="sd">    array([[1, 1, 2, 2],</span>
<span class="sd">           [1, 1, 2, 2],</span>
<span class="sd">           [3, 3, 4, 4],</span>
<span class="sd">           [3, 3, 4, 4]])</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">reshape</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">strides</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">strides</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">repeats</span><span class="p">):</span>
        <span class="n">shape</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
        <span class="n">strides</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">reshape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">strides</span><span class="p">,</span> <span class="n">writeable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">reshape</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">reshape_nd</span><span class="p">(</span><span class="n">data_or_shape</span><span class="p">,</span> <span class="n">ndim</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return image array or shape with at least ndim dimensions.</span>

<span class="sd">    Prepend 1s to image shape as necessary.</span>

<span class="sd">    &gt;&gt;&gt; reshape_nd(numpy.empty(0), 1).shape</span>
<span class="sd">    (0,)</span>
<span class="sd">    &gt;&gt;&gt; reshape_nd(numpy.empty(1), 2).shape</span>
<span class="sd">    (1, 1)</span>
<span class="sd">    &gt;&gt;&gt; reshape_nd(numpy.empty((2, 3)), 3).shape</span>
<span class="sd">    (1, 2, 3)</span>
<span class="sd">    &gt;&gt;&gt; reshape_nd(numpy.empty((3, 4, 5)), 3).shape</span>
<span class="sd">    (3, 4, 5)</span>
<span class="sd">    &gt;&gt;&gt; reshape_nd((2, 3), 3)</span>
<span class="sd">    (1, 2, 3)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_shape</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_or_shape</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">data_or_shape</span> <span class="k">if</span> <span class="n">is_shape</span> <span class="k">else</span> <span class="n">data_or_shape</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ndim</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data_or_shape</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span> <span class="o">+</span> <span class="n">shape</span>
    <span class="k">return</span> <span class="n">shape</span> <span class="k">if</span> <span class="n">is_shape</span> <span class="k">else</span> <span class="n">data_or_shape</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">squeeze_axes</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="s1">&#39;XY&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return shape and axes with single-dimensional entries removed.</span>

<span class="sd">    Remove unused dimensions unless their axes are listed in &#39;skip&#39;.</span>

<span class="sd">    &gt;&gt;&gt; squeeze_axes((5, 1, 2, 1, 1), &#39;TZYXC&#39;)</span>
<span class="sd">    ((5, 2, 1), &#39;TYX&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;dimensions of axes and shape do not match&#39;</span><span class="p">)</span>
    <span class="n">shape</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">skip</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">transpose_axes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">asaxes</span><span class="o">=</span><span class="s1">&#39;CTZYX&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return image with its axes permuted to match specified axes.</span>

<span class="sd">    A view is returned if possible.</span>

<span class="sd">    &gt;&gt;&gt; transpose_axes(numpy.zeros((2, 3, 4, 5)), &#39;TYXC&#39;, asaxes=&#39;CTZYX&#39;).shape</span>
<span class="sd">    (5, 2, 1, 3, 4)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">asaxes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unknown axis </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ax</span><span class="p">)</span>
    <span class="c1"># add missing axes to image</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">asaxes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">+</span> <span class="n">axes</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">shape</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># transpose axes</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="n">axes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">asaxes</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">image</span>


<span class="k">def</span> <span class="nf">reshape_axes</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">newshape</span><span class="p">,</span> <span class="n">unknown</span><span class="o">=</span><span class="s1">&#39;Q&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return axes matching new shape.</span>

<span class="sd">    Unknown dimensions are labelled &#39;Q&#39;.</span>

<span class="sd">    &gt;&gt;&gt; reshape_axes(&#39;YXS&#39;, (219, 301, 1), (219, 301))</span>
<span class="sd">    &#39;YX&#39;</span>
<span class="sd">    &gt;&gt;&gt; reshape_axes(&#39;IYX&#39;, (12, 219, 301), (3, 4, 219, 1, 301, 1))</span>
<span class="sd">    &#39;QQYQXQ&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">newshape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">newshape</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;axes do not match shape&#39;</span><span class="p">)</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">newsize</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">newshape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="n">newsize</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot reshape </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">newshape</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">axes</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">newshape</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="n">lendiff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">newshape</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">lendiff</span><span class="p">:</span>
        <span class="n">newshape</span> <span class="o">=</span> <span class="n">newshape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="n">lendiff</span>

    <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">prodns</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">prods</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ns</span> <span class="ow">in</span> <span class="n">newshape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">prodns</span> <span class="o">*=</span> <span class="n">ns</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ns</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">ns</span> <span class="o">==</span> <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">prodns</span> <span class="o">==</span> <span class="n">prods</span><span class="o">*</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">prods</span> <span class="o">*=</span> <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unknown</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">lendiff</span><span class="p">:]))</span>


<span class="k">def</span> <span class="nf">stack_pages</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxworkers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read data from sequence of TiffPage and stack them vertically.</span>

<span class="sd">    Additional parameters are passsed to the TiffPage.asarray function.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">npages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">npages</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no pages&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">npages</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">page0</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pages</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">page0</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">validate</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># ThreadPoolExecutor swallows exceptions</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">npages</span><span class="p">,)</span> <span class="o">+</span> <span class="n">page0</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">page0</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">dtype</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">create_output</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">maxworkers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">maxworkers</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">page0</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">maxworkers</span> <span class="o">&gt;</span> <span class="mi">1</span>

    <span class="n">filecache</span> <span class="o">=</span> <span class="n">OpenFileCache</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">maxworkers</span><span class="p">),</span>
                              <span class="n">lock</span><span class="o">=</span><span class="n">page0</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">lock</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">filecache</span><span class="o">=</span><span class="n">filecache</span><span class="p">,</span>
             <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read, decode, and copy page data.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filecache</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lock</span><span class="o">=</span><span class="n">filecache</span><span class="o">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">reopen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">filecache</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">maxworkers</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pages</span><span class="p">):</span>
            <span class="n">func</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">maxworkers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">npages</span><span class="p">))</span>

    <span class="n">filecache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">page0</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">filehandle</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">clean_offsets_counts</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">counts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return cleaned offsets and byte counts.</span>

<span class="sd">    Remove zero offsets and counts. Use to sanitize _offsets and _bytecounts</span>
<span class="sd">    tag values for strips or tiles.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">offsets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">counts</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">o</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">j</span><span class="p">:</span>
                <span class="n">offsets</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span>
                <span class="n">counts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">o</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid offset&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;empty byte count&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">offsets</span><span class="p">[:</span><span class="n">j</span><span class="p">],</span> <span class="n">counts</span><span class="p">[:</span><span class="n">j</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">buffered_read</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">bytecounts</span><span class="p">,</span> <span class="n">buffersize</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">26</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return iterator over blocks read from file.&quot;&quot;&quot;</span>
    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">buffersize</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">bytecount</span> <span class="o">=</span> <span class="n">bytecounts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">bytecount</span><span class="p">))</span>
                <span class="n">size</span> <span class="o">+=</span> <span class="n">bytecount</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">block</span>


<span class="k">def</span> <span class="nf">create_output</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.memmap&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return numpy array where image data of shape and dtype can be copied.</span>

<span class="sd">    The &#39;out&#39; parameter may have the following values or types:</span>

<span class="sd">    None</span>
<span class="sd">        An empty array of shape and dtype is created and returned.</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        An existing writable array of compatible dtype and shape. A view of</span>
<span class="sd">        the same array is returned after verification.</span>
<span class="sd">    &#39;memmap&#39; or &#39;memmap:tempdir&#39;</span>
<span class="sd">        A memory-map to an array stored in a temporary binary file on disk</span>
<span class="sd">        is created and returned.</span>
<span class="sd">    str or open file</span>
<span class="sd">        The file name or file object used to create a memory-map to an array</span>
<span class="sd">        stored in a binary file on disk. The created memory-mapped array is</span>
<span class="sd">        returned.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">out</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;memmap&#39;</span><span class="p">:</span>
        <span class="n">tempdir</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">tempdir</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="n">product</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;incompatible output shape&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">can_cast</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;incompatible output dtype&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">matlabstr2py</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return Python object from Matlab string representation.</span>

<span class="sd">    Return str, bool, int, float, list (Matlab arrays or cells), or</span>
<span class="sd">    dict (Matlab structures) types.</span>

<span class="sd">    Use to access ScanImage metadata.</span>

<span class="sd">    &gt;&gt;&gt; matlabstr2py(&#39;1&#39;)</span>
<span class="sd">    1</span>
<span class="sd">    &gt;&gt;&gt; matlabstr2py(&quot;[&#39;x y z&#39; true false; 1 2.0 -3e4; NaN Inf @class]&quot;)</span>
<span class="sd">    [[&#39;x y z&#39;, True, False], [1, 2.0, -30000.0], [nan, inf, &#39;@class&#39;]]</span>
<span class="sd">    &gt;&gt;&gt; d = matlabstr2py(&quot;SI.hChannels.channelType = {&#39;stripe&#39; &#39;stripe&#39;}\\n&quot;</span>
<span class="sd">    ...                  &quot;SI.hChannels.channelsActive = 2&quot;)</span>
<span class="sd">    &gt;&gt;&gt; d[&#39;SI.hChannels.channelType&#39;]</span>
<span class="sd">    [&#39;stripe&#39;, &#39;stripe&#39;]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: handle invalid input</span>
    <span class="c1"># TODO: review unboxing of multidimensional arrays</span>

    <span class="k">def</span> <span class="nf">lex</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="c1"># return sequence of tokens from matlab string representation</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;[&#39;</span><span class="p">]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">next_token</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;;&#39;</span><span class="p">:</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;[&#39;</span><span class="p">:</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;]&#39;</span><span class="p">:</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tokens</span>

    <span class="k">def</span> <span class="nf">next_token</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="c1"># return next token in matlab string</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39; &#39;</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">length</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">i</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;{[;]}&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39; {[;]}&#39;</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="n">j</span>

    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fail</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># return Python value of token</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fail</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">s</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fail</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">or</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fail</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&gt;&#39;</span> <span class="ow">or</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="k">if</span> <span class="n">fail</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">s</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="s2">&quot; &#39;;[]</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;@&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;zeros(&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ones(&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">s</span> <span class="ow">or</span> <span class="s1">&#39;e&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># nan, inf</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fail</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="c1"># return Python value from string representation of Matlab value</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fail</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">add2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">add2</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">lex</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="s1">&#39;[{&#39;</span><span class="p">:</span>
                <span class="n">add2</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="ow">in</span> <span class="s1">&#39;]}&#39;</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">levels</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">add2</span> <span class="o">=</span> <span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">add2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">add2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">string</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">string</span><span class="p">:</span>
        <span class="c1"># structure</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;%&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">k</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="s2">&quot; &#39;;[]</span><span class="si">{}</span><span class="s2">&lt;&gt;&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>
    <span class="k">return</span> <span class="n">parse</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">stripnull</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return string truncated at first null character.</span>

<span class="sd">    Clean NULL terminated C strings. For unicode strings use null=&#39;\\0&#39;.</span>

<span class="sd">    &gt;&gt;&gt; stripnull(b&#39;string\\x00&#39;)</span>
<span class="sd">    b&#39;string&#39;</span>
<span class="sd">    &gt;&gt;&gt; stripnull(&#39;string\\x00&#39;, null=&#39;\\0&#39;)</span>
<span class="sd">    &#39;string&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">null</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">string</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">string</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">stripascii</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return string truncated at last byte that is 7-bit ASCII.</span>

<span class="sd">    Clean NULL separated and terminated TIFF strings.</span>

<span class="sd">    &gt;&gt;&gt; stripascii(b&#39;string\\x00string\\n\\x01\\x00&#39;)</span>
<span class="sd">    b&#39;string\\x00string\\n&#39;</span>
<span class="sd">    &gt;&gt;&gt; stripascii(b&#39;\\x00&#39;)</span>
<span class="sd">    b&#39;&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: pythonize this</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="mi">8</span> <span class="o">&lt;</span> <span class="n">byte2int</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">127</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">string</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">asbool</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">true</span><span class="o">=</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;true&#39;</span><span class="p">),</span> <span class="n">false</span><span class="o">=</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;false&#39;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Return string as bool if possible, else raise TypeError.</span>

<span class="sd">    &gt;&gt;&gt; asbool(b&#39; False &#39;)</span>
<span class="sd">    False</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">true</span><span class="p">:</span>  <span class="c1"># might raise UnicodeWarning/BytesWarning</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">false</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">astype</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return argument as one of types if possible.</span>

<span class="sd">    &gt;&gt;&gt; astype(&#39;42&#39;)</span>
<span class="sd">    42</span>
<span class="sd">    &gt;&gt;&gt; astype(&#39;3.14&#39;)</span>
<span class="sd">    3.14</span>
<span class="sd">    &gt;&gt;&gt; astype(&#39;True&#39;)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; astype(b&#39;Neee-Wom&#39;)</span>
<span class="sd">    &#39;Neee-Wom&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">types</span> <span class="o">=</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">asbool</span><span class="p">,</span> <span class="n">bytes2str</span>
    <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">typ</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">UnicodeEncodeError</span><span class="p">):</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">format_size</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1536</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return file size as string from byte size.</span>

<span class="sd">    &gt;&gt;&gt; format_size(1234)</span>
<span class="sd">    &#39;1234 B&#39;</span>
<span class="sd">    &gt;&gt;&gt; format_size(12345678901)</span>
<span class="sd">    &#39;11.50 GiB&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> B&quot;</span> <span class="o">%</span> <span class="n">size</span>
    <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;KiB&#39;</span><span class="p">,</span> <span class="s1">&#39;MiB&#39;</span><span class="p">,</span> <span class="s1">&#39;GiB&#39;</span><span class="p">,</span> <span class="s1">&#39;TiB&#39;</span><span class="p">,</span> <span class="s1">&#39;PiB&#39;</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">/=</span> <span class="mf">1024.0</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">identityfunc</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Single argument identity function.</span>

<span class="sd">    &gt;&gt;&gt; identityfunc(&#39;arg&#39;)</span>
<span class="sd">    &#39;arg&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">arg</span>


<span class="k">def</span> <span class="nf">nullfunc</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Null function.</span>

<span class="sd">    &gt;&gt;&gt; nullfunc(&#39;arg&#39;, kwarg=&#39;kwarg&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">sequence</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return tuple containing value if value is not a sequence.</span>

<span class="sd">    &gt;&gt;&gt; sequence(1)</span>
<span class="sd">    (1,)</span>
<span class="sd">    &gt;&gt;&gt; sequence([1])</span>
<span class="sd">    [1]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">value</span><span class="p">,)</span>


<span class="k">def</span> <span class="nf">product</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return product of sequence of numbers.</span>

<span class="sd">    Equivalent of functools.reduce(operator.mul, iterable, 1).</span>
<span class="sd">    Multiplying numpy integers might overflow.</span>

<span class="sd">    &gt;&gt;&gt; product([2**8, 2**30])</span>
<span class="sd">    274877906944</span>
<span class="sd">    &gt;&gt;&gt; product([])</span>
<span class="sd">    1</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prod</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
        <span class="n">prod</span> <span class="o">*=</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">prod</span>


<span class="k">def</span> <span class="nf">natural_sorted</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return human sorted list of strings.</span>

<span class="sd">    E.g. for sorting file names.</span>

<span class="sd">    &gt;&gt;&gt; natural_sorted([&#39;f1&#39;, &#39;f2&#39;, &#39;f10&#39;])</span>
<span class="sd">    [&#39;f1&#39;, &#39;f2&#39;, &#39;f10&#39;]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">sortkey</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">else</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="n">x</span><span class="p">)]</span>

    <span class="n">numbers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+)&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">sortkey</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">excel_datetime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="mi">693594</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Return datetime object from timestamp in Excel serial format.</span>

<span class="sd">    Convert LSM time stamps.</span>

<span class="sd">    &gt;&gt;&gt; excel_datetime(40237.029999999795)</span>
<span class="sd">    datetime.datetime(2010, 2, 28, 0, 43, 11, 999982)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">epoch</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">julian_datetime</span><span class="p">(</span><span class="n">julianday</span><span class="p">,</span> <span class="n">milisecond</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return datetime from days since 1/1/4713 BC and ms since midnight.</span>

<span class="sd">    Convert Julian dates according to MetaMorph.</span>

<span class="sd">    &gt;&gt;&gt; julian_datetime(2451576, 54362783)</span>
<span class="sd">    datetime.datetime(2000, 2, 2, 15, 6, 2, 783)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">julianday</span> <span class="o">&lt;=</span> <span class="mi">1721423</span><span class="p">:</span>
        <span class="c1"># no datetime before year 1</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">julianday</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">2299160</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">trunc</span><span class="p">((</span><span class="n">a</span> <span class="o">-</span> <span class="mf">1867216.25</span><span class="p">)</span> <span class="o">/</span> <span class="mf">36524.25</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">//</span> <span class="mi">4</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1524</span> <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">1721423</span> <span class="k">else</span> <span class="mi">1158</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">trunc</span><span class="p">((</span><span class="n">b</span> <span class="o">-</span> <span class="mf">122.1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">365.25</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">trunc</span><span class="p">(</span><span class="mf">365.25</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">trunc</span><span class="p">((</span><span class="n">b</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="mf">30.6001</span><span class="p">)</span>

    <span class="n">day</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">d</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">trunc</span><span class="p">(</span><span class="mf">30.6001</span> <span class="o">*</span> <span class="n">e</span><span class="p">)</span>
    <span class="n">month</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="mf">13.5</span> <span class="k">else</span> <span class="mi">13</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="p">(</span><span class="mi">4716</span> <span class="k">if</span> <span class="n">month</span> <span class="o">&gt;</span> <span class="mf">2.5</span> <span class="k">else</span> <span class="mi">4715</span><span class="p">)</span>

    <span class="n">hour</span><span class="p">,</span> <span class="n">milisecond</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">milisecond</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">minute</span><span class="p">,</span> <span class="n">milisecond</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">milisecond</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">second</span><span class="p">,</span> <span class="n">milisecond</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">milisecond</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span>
                             <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">milisecond</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">byteorder_isnative</span><span class="p">(</span><span class="n">byteorder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return if byteorder matches the system&#39;s byteorder.</span>

<span class="sd">    &gt;&gt;&gt; byteorder_isnative(&#39;=&#39;)</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span> <span class="ow">or</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;big&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">byteorder</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">)</span> <span class="o">==</span> <span class="n">keys</span><span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">recarray2dict</span><span class="p">(</span><span class="n">recarray</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return numpy.recarray as dict.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: subarrays</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">descr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">recarray</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">descr</span><span class="p">,</span> <span class="n">recarray</span><span class="p">):</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">descr</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dtype</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">stripnull</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">xml2dict</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return XML as dict.</span>

<span class="sd">    &gt;&gt;&gt; xml2dict(&#39;&lt;?xml version=&quot;1.0&quot; ?&gt;&lt;root attr=&quot;name&quot;&gt;&lt;key&gt;1&lt;/key&gt;&lt;/root&gt;&#39;)</span>
<span class="sd">    {&#39;root&#39;: {&#39;key&#39;: 1, &#39;attr&#39;: &#39;name&#39;}}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">xml.etree</span> <span class="k">import</span> <span class="n">cElementTree</span> <span class="k">as</span> <span class="n">etree</span>  <span class="c1"># delayed import</span>

    <span class="n">at</span> <span class="o">=</span> <span class="n">tx</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
        <span class="n">at</span><span class="p">,</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">prefix</span>

    <span class="k">def</span> <span class="nf">astype</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="c1"># return value as int, float, bool, or str</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">asbool</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">t</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">etree2dict</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="c1"># adapted from https://stackoverflow.com/a/10077069/453463</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">tag</span>
        <span class="k">if</span> <span class="n">sanitize</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">attrib</span> <span class="k">else</span> <span class="kc">None</span><span class="p">}</span>
        <span class="n">children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dc</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">etree2dict</span><span class="p">,</span> <span class="n">children</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">astype</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">astype</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">astype</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">()}}</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">at</span> <span class="o">+</span> <span class="n">k</span><span class="p">,</span> <span class="n">astype</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">children</span> <span class="ow">or</span> <span class="n">t</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">tx</span> <span class="o">+</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">return</span> <span class="n">etree2dict</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">xml</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">hexdump</span><span class="p">(</span><span class="n">bytestr</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">snipat</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">modulo</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ellipsis</span><span class="o">=</span><span class="s1">&#39;...&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return hexdump representation of byte string.</span>

<span class="sd">    &gt;&gt;&gt; hexdump(binascii.unhexlify(&#39;49492a00080000000e00fe0004000100&#39;))</span>
<span class="sd">    &#39;49 49 2a 00 08 00 00 00 0e 00 fe 00 04 00 01 00 II*.............&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bytestr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">height</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="n">bytesperline</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">modulo</span> <span class="o">*</span> <span class="p">(((</span><span class="n">width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span> <span class="o">//</span> <span class="n">modulo</span><span class="p">),</span>
                           <span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bytesperline</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="n">nlines</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">0</span><span class="si">%i</span><span class="s1">x: &#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="si">%x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">size</span><span class="p">)</span>
        <span class="n">bytesperline</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">modulo</span> <span class="o">*</span> <span class="p">(((</span><span class="n">width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">addr</span> <span class="o">%</span> <span class="mi">1</span><span class="p">))</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span> <span class="o">//</span> <span class="n">modulo</span><span class="p">),</span>
                           <span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bytesperline</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">bytesperline</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">addr</span> <span class="o">%</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">nlines</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">bytesperline</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">snipat</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">snipat</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">snipat</span> <span class="o">=</span> <span class="n">height</span>
    <span class="k">elif</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">snipat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">snipat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">snipat</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">snipat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">snipat</span> <span class="o">+=</span> <span class="n">height</span>

    <span class="k">if</span> <span class="n">height</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">nlines</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bytestr</span><span class="p">[:</span><span class="n">bytesperline</span><span class="p">])]</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="n">height</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">bytesperline</span>
    <span class="k">elif</span> <span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">nlines</span> <span class="o">&lt;=</span> <span class="n">height</span><span class="p">:</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bytestr</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">snipat</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">bytesperline</span> <span class="o">*</span> <span class="p">(</span><span class="n">nlines</span> <span class="o">-</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[(</span><span class="n">start</span><span class="p">,</span> <span class="n">bytestr</span><span class="p">[</span><span class="n">start</span><span class="p">:])]</span>  <span class="c1"># (start, None)</span>
    <span class="k">elif</span> <span class="n">snipat</span> <span class="o">&gt;=</span> <span class="n">height</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">bytesperline</span> <span class="o">*</span> <span class="n">height</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bytestr</span><span class="p">[:</span><span class="n">end</span><span class="p">])]</span>  <span class="c1"># (end, None)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end1</span> <span class="o">=</span> <span class="n">bytesperline</span> <span class="o">*</span> <span class="n">snipat</span>
        <span class="n">end2</span> <span class="o">=</span> <span class="n">bytesperline</span> <span class="o">*</span> <span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="n">snipat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bytestr</span><span class="p">[:</span><span class="n">end1</span><span class="p">]),</span>
                  <span class="p">(</span><span class="n">size</span><span class="o">-</span><span class="n">end1</span><span class="o">-</span><span class="n">end2</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                  <span class="p">(</span><span class="n">size</span><span class="o">-</span><span class="n">end2</span><span class="p">,</span> <span class="n">bytestr</span><span class="p">[</span><span class="n">size</span><span class="o">-</span><span class="n">end2</span><span class="p">:])]</span>

    <span class="n">ellipsis</span> <span class="o">=</span> <span class="n">str2bytes</span><span class="p">(</span><span class="n">ellipsis</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">bytestr</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bytestr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ellipsis</span><span class="p">)</span>  <span class="c1"># &#39;skip %i bytes&#39; % start)</span>
            <span class="k">continue</span>
        <span class="n">hexstr</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">bytestr</span><span class="p">)</span>
        <span class="n">strstr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">br</span><span class="s1">&#39;[^\x20-\x7f]&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">bytestr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bytestr</span><span class="p">),</span> <span class="n">bytesperline</span><span class="p">):</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">hexstr</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">bytesperline</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">start</span><span class="p">))</span> <span class="k">if</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">addr</span>
            <span class="n">r</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">bytesperline</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">r</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
            <span class="n">r</span> <span class="o">+=</span> <span class="n">strstr</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">bytesperline</span><span class="p">]</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">isprintable</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return if all characters in string are printable.</span>

<span class="sd">    &gt;&gt;&gt; isprintable(&#39;abc&#39;)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; isprintable(b&#39;\01&#39;)</span>
<span class="sd">    False</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">isprintable</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isprintable</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">isalnum</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">printable</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRST&#39;</span>
                     <span class="s1">&#39;UVWXYZ!&quot;#$%&amp;</span><span class="se">\&#39;</span><span class="s1">()*+,-./:;&lt;=&gt;?@[</span><span class="se">\\</span><span class="s1">]^_`{|}~ </span><span class="se">\t\n\r\x0b\x0c</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">printable</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">clean_whitespace</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return string with compressed whitespace.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">((</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">),</span>
                 <span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)):</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">compact</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">((</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;[ &#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">),</span>
                     <span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)):</span>
            <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">pformat_xml</span><span class="p">(</span><span class="n">xml</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return pretty formatted XML.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">lxml.etree</span> <span class="k">as</span> <span class="nn">etree</span>  <span class="c1"># delayed import</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">xml</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">xml</span><span class="p">))</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">encoding</span><span class="o">=</span><span class="n">xml</span><span class="o">.</span><span class="n">docinfo</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">xml</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&gt;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;</span><span class="se">\n</span><span class="s1">&lt;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xml</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pformat</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">79</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return pretty formatted representation of object as string.</span>

<span class="sd">    Whitespace might be altered.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">height</span> <span class="o">=</span> <span class="mi">1024</span>
    <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mi">256</span>

    <span class="n">npopt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">get_printoptions</span><span class="p">()</span>
    <span class="n">numpy</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">arg</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&lt;?xml&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&lt;?xml&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">height</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[:</span><span class="mi">4</span><span class="o">*</span><span class="n">width</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="n">pformat_xml</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">isprintable</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="n">bytes2str</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="n">clean_whitespace</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="o">**</span><span class="n">npopt</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">hexdump</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="n">modulo</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">record</span><span class="p">):</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">pprint</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pprint</span>  <span class="c1"># delayed import</span>
        <span class="n">compact</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">(</span><span class="n">compact</span><span class="o">=</span><span class="n">compact</span><span class="p">)</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="o">**</span><span class="n">compact</span><span class="p">)</span>

    <span class="n">numpy</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="o">**</span><span class="n">npopt</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">height</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">clean_whitespace</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arg</span><span class="p">[:</span><span class="n">width</span><span class="p">]</span>

    <span class="n">argl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">height</span><span class="p">:</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">argl</span><span class="p">[:</span><span class="n">height</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;...&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">argl</span><span class="p">[</span><span class="o">-</span><span class="n">height</span><span class="o">//</span><span class="mi">2</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">arg</span>


<span class="k">def</span> <span class="nf">snipstr</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">79</span><span class="p">,</span> <span class="n">snipat</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ellipsis</span><span class="o">=</span><span class="s1">&#39;...&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return string cut to specified length.</span>

<span class="sd">    &gt;&gt;&gt; snipstr(&#39;abcdefghijklmnop&#39;, 8)</span>
<span class="sd">    &#39;abc...op&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ellipsis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">ellipsis</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;...&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ellipsis</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u2026</span><span class="s1">&#39;</span>  <span class="c1"># does not print on win-py3.5</span>
    <span class="n">esize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ellipsis</span><span class="p">)</span>

    <span class="n">splitlines</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="c1"># TODO: finish and test multiline snip</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">splitlines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ellipsis</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">linelen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">linelen</span> <span class="o">&lt;=</span> <span class="n">width</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">split</span> <span class="o">=</span> <span class="n">snipat</span>
        <span class="k">if</span> <span class="n">split</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">split</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">split</span> <span class="o">=</span> <span class="n">linelen</span>
        <span class="k">elif</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">split</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">linelen</span> <span class="o">*</span> <span class="n">split</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">split</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">split</span> <span class="o">+=</span> <span class="n">linelen</span>
            <span class="k">if</span> <span class="n">split</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">split</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">esize</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="n">esize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">split</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="o">-</span><span class="n">width</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">[:</span><span class="n">width</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">split</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ellipsis</span> <span class="o">+</span> <span class="n">string</span><span class="p">[</span><span class="n">esize</span><span class="o">-</span><span class="n">width</span><span class="p">:])</span>
        <span class="k">elif</span> <span class="n">split</span> <span class="o">&gt;=</span> <span class="n">linelen</span> <span class="ow">or</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="n">esize</span> <span class="o">+</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">[:</span><span class="n">width</span><span class="o">-</span><span class="n">esize</span><span class="p">]</span> <span class="o">+</span> <span class="n">ellipsis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">splitlen</span> <span class="o">=</span> <span class="n">linelen</span> <span class="o">-</span> <span class="n">width</span> <span class="o">+</span> <span class="n">esize</span>
            <span class="n">end1</span> <span class="o">=</span> <span class="n">split</span> <span class="o">-</span> <span class="n">splitlen</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">end2</span> <span class="o">=</span> <span class="n">end1</span> <span class="o">+</span> <span class="n">splitlen</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">[:</span><span class="n">end1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ellipsis</span> <span class="o">+</span> <span class="n">string</span><span class="p">[</span><span class="n">end2</span><span class="p">:])</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">enumarg</span><span class="p">(</span><span class="n">enum</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return enum member from its name or value.</span>

<span class="sd">    &gt;&gt;&gt; enumarg(TIFF.PHOTOMETRIC, 2)</span>
<span class="sd">    &lt;PHOTOMETRIC.RGB: 2&gt;</span>
<span class="sd">    &gt;&gt;&gt; enumarg(TIFF.PHOTOMETRIC, &#39;RGB&#39;)</span>
<span class="sd">    &lt;PHOTOMETRIC.RGB: 2&gt;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">enum</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">enum</span><span class="p">[</span><span class="n">arg</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid argument </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">parse_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">keyvalues</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return dict with keys from keys|keyvals and values from kwargs|keyvals.</span>

<span class="sd">    Existing keys are deleted from kwargs.</span>

<span class="sd">    &gt;&gt;&gt; kwargs = {&#39;one&#39;: 1, &#39;two&#39;: 2, &#39;four&#39;: 4}</span>
<span class="sd">    &gt;&gt;&gt; kwargs2 = parse_kwargs(kwargs, &#39;two&#39;, &#39;three&#39;, four=None, five=5)</span>
<span class="sd">    &gt;&gt;&gt; kwargs == {&#39;one&#39;: 1}</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; kwargs2 == {&#39;two&#39;: 2, &#39;four&#39;: 4, &#39;five&#39;: 5}</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">keyvalues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">update_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">keyvalues</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update dict with keys and values if keys do not already exist.</span>

<span class="sd">    &gt;&gt;&gt; kwargs = {&#39;one&#39;: 1, }</span>
<span class="sd">    &gt;&gt;&gt; update_kwargs(kwargs, one=None, two=2)</span>
<span class="sd">    &gt;&gt;&gt; kwargs == {&#39;one&#39;: 1, &#39;two&#39;: 2}</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">keyvalues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">validate_jhove</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">jhove</span><span class="o">=</span><span class="s1">&#39;jhove&#39;</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;More than 50 IFDs&#39;</span><span class="p">,)):</span>
    <span class="sd">&quot;&quot;&quot;Validate TIFF file using jhove -m TIFF-hul.</span>

<span class="sd">    Raise ValueError if jhove outputs an error message unless the message</span>
<span class="sd">    contains one of the strings in &#39;ignore&#39;.</span>

<span class="sd">    JHOVE does not support bigtiff or more than 50 IFDs.</span>

<span class="sd">    See `JHOVE TIFF-hul Module &lt;http://jhove.sourceforge.net/tiff-hul.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>  <span class="c1"># noqa: delayed import</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="n">jhove</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;TIFF-hul&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;ErrorMessage: &#39;</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;ErrorMessage: &#39;</span><span class="p">):</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">14</span><span class="p">:]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">error</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="k">break</span>


<span class="k">def</span> <span class="nf">lsm2bin</span><span class="p">(</span><span class="n">lsmfile</span><span class="p">,</span> <span class="n">binfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tile</span><span class="o">=</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert [MP]TZCYX LSM file to series of BIN files.</span>

<span class="sd">    One BIN file containing &#39;ZCYX&#39; data are created for each position, time,</span>
<span class="sd">    and tile. The position, time, and tile indices are encoded at the end</span>
<span class="sd">    of the filenames.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">print_</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">nullfunc</span>

    <span class="k">if</span> <span class="n">binfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">binfile</span> <span class="o">=</span> <span class="n">lsmfile</span>
    <span class="k">elif</span> <span class="n">binfile</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="n">binfile</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">binfile</span><span class="p">:</span>
        <span class="n">binfile</span> <span class="o">+=</span> <span class="s1">&#39;_(z</span><span class="si">%i</span><span class="s1">c</span><span class="si">%i</span><span class="s1">y</span><span class="si">%i</span><span class="s1">x</span><span class="si">%i</span><span class="s1">)_m</span><span class="si">%%</span><span class="s1">ip</span><span class="si">%%</span><span class="s1">it</span><span class="si">%%</span><span class="s1">03iy</span><span class="si">%%</span><span class="s1">ix</span><span class="si">%%</span><span class="s1">i.bin&#39;</span>

    <span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Opening LSM file... &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">TiffFile</span><span class="p">(</span><span class="n">lsmfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">lsm</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lsm</span><span class="o">.</span><span class="n">is_lsm</span><span class="p">:</span>
            <span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">lsm</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not a LSM file&#39;</span><span class="p">)</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">lsm</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># first series contains the image data</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">axes</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">dtype</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>

        <span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1"> s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
        <span class="c1"># verbose(lsm, flush=True)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Image</span><span class="se">\n</span><span class="s1">  axes:  </span><span class="si">%s</span><span class="se">\n</span><span class="s1">  shape: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">  dtype: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">  size:  </span><span class="si">%s</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">format_size</span><span class="p">(</span><span class="n">size</span><span class="p">)),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">series</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;TZCYX&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not a *TZCYX LSM file&#39;</span><span class="p">)</span>

        <span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;Copying image from LSM to BIN files&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">tiles</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="n">tile</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">tile</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">binfile</span><span class="p">:</span>
            <span class="n">binfile</span> <span class="o">=</span> <span class="n">binfile</span> <span class="o">%</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">7</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span> <span class="o">+</span> <span class="n">shape</span>
        <span class="c1"># cache for ZCYX stacks and output files</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                          <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="c1"># iterate over Tiff pages containing data</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># mosaic axis</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># position axis</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>  <span class="c1"># time axis</span>
                    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>  <span class="c1"># z slices</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># tile y</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tiles</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># tile x</span>
                            <span class="n">out</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span>
                                          <span class="n">y</span><span class="o">*</span><span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">tile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                          <span class="n">x</span><span class="o">*</span><span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">]:(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                            <span class="k">if</span> <span class="n">binfile</span><span class="p">:</span>
                                <span class="n">out</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">binfile</span> <span class="o">%</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
                            <span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%.3f</span><span class="s1"> s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bitspersample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">photometric</span><span class="o">=</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">96</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">subplot</span><span class="o">=</span><span class="mi">111</span><span class="p">,</span> <span class="n">maxdim</span><span class="o">=</span><span class="mi">32768</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot n-dimensional images using matplotlib.pyplot.</span>

<span class="sd">    Return figure, subplot and plot axis.</span>
<span class="sd">    Requires pyplot already imported C{from matplotlib import pyplot}.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bitspersample : int or None</span>
<span class="sd">        Number of bits per channel in integer RGB images.</span>
<span class="sd">    photometric : {&#39;MINISWHITE&#39;, &#39;MINISBLACK&#39;, &#39;RGB&#39;, or &#39;PALETTE&#39;}</span>
<span class="sd">        The color space of the image data.</span>
<span class="sd">    title : str</span>
<span class="sd">        Window and subplot title.</span>
<span class="sd">    figure : matplotlib.figure.Figure (optional).</span>
<span class="sd">        Matplotlib to use for plotting.</span>
<span class="sd">    subplot : int</span>
<span class="sd">        A matplotlib.pyplot.subplot axis.</span>
<span class="sd">    maxdim : int</span>
<span class="sd">        maximum image width and length.</span>
<span class="sd">    kwargs : optional</span>
<span class="sd">        Arguments for matplotlib.pyplot.imshow.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">isrgb</span> <span class="o">=</span> <span class="n">photometric</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,)</span>  <span class="c1"># &#39;PALETTE&#39;, &#39;YCBCR&#39;</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
        <span class="n">isrgb</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">isrgb</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))):</span>
        <span class="n">isrgb</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">photometric</span> <span class="o">=</span> <span class="s1">&#39;MINISBLACK&#39;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">photometric</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;MINISWHITE&#39;</span><span class="p">,</span> <span class="s1">&#39;MINISBLACK&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">reshape_nd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">reshape_nd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">dims</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span>
    <span class="k">if</span> <span class="n">dims</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not an image&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dims</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">isrgb</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">isrgb</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">isrgb</span> <span class="ow">and</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">8</span> <span class="ow">and</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">//</span> <span class="mi">8</span> <span class="ow">and</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">isrgb</span> <span class="o">=</span> <span class="n">isrgb</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">dims</span> <span class="o">-=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">isrgb</span> <span class="k">else</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">isrgb</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">maxdim</span><span class="p">,</span> <span class="p">:</span><span class="n">maxdim</span><span class="p">,</span> <span class="p">:</span><span class="n">maxdim</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">maxdim</span><span class="p">,</span> <span class="p">:</span><span class="n">maxdim</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">photometric</span> <span class="o">==</span> <span class="s1">&#39;PALETTE&#39;</span> <span class="ow">and</span> <span class="n">isrgb</span><span class="p">:</span>
        <span class="n">datamax</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">datamax</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span>  <span class="c1"># possible precision loss</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s1">&#39;ui&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">isrgb</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">bitspersample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bitspersample</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">bitspersample</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bitspersample</span><span class="p">,</span> <span class="n">inttypes</span><span class="p">):</span>
            <span class="c1"># bitspersample can be tuple, e.g. (5, 6, 5)</span>
            <span class="n">bitspersample</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">*</span> <span class="mi">8</span>
        <span class="n">datamax</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">bitspersample</span>
        <span class="k">if</span> <span class="n">isrgb</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bitspersample</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">bitspersample</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">bitspersample</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">bitspersample</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span>  <span class="c1"># precision loss</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
        <span class="n">datamax</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">isrgb</span> <span class="ow">and</span> <span class="n">datamax</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">/=</span> <span class="n">datamax</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="n">datamax</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
        <span class="n">datamax</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">datamax</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">isrgb</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">datamax</span>
        <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span>
                <span class="n">dtmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">min</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">vmin</span> <span class="o">==</span> <span class="n">dtmin</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">dtmin</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
                <span class="n">dtmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">min</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">vmin</span> <span class="o">==</span> <span class="n">dtmin</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">dtmin</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">pyplot</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;matplotlib.pyplot&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">figure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;sans-serif&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">figure</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">10.3</span><span class="p">,</span> <span class="mf">6.3</span><span class="p">),</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">title</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span> <span class="k">if</span> <span class="n">title</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.03</span><span class="o">*</span><span class="p">(</span><span class="n">dims</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.98</span><span class="o">-</span><span class="n">size</span><span class="o">*</span><span class="mf">0.03</span><span class="p">,</span>
                               <span class="n">left</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">subplot</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">subplot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="s1">&#39;Windows-1252&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s1">&#39;buf&#39;</span> <span class="ow">or</span> <span class="n">vmin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;coolwarm&#39;</span>
        <span class="k">if</span> <span class="n">photometric</span> <span class="o">==</span> <span class="s1">&#39;MINISWHITE&#39;</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">+=</span> <span class="s1">&#39;_r&#39;</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="n">dims</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()),</span>
                          <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                          <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">isrgb</span><span class="p">:</span>
        <span class="n">pyplot</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>  <span class="c1"># panchor=(0.55, 0.5), fraction=0.05</span>

    <span class="k">def</span> <span class="nf">format_coord</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c1"># callback function to format coordinate display in toolbar</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dims</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> @ </span><span class="si">%s</span><span class="s1"> [</span><span class="si">%4i</span><span class="s1">, </span><span class="si">%4i</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">curaxdat</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span> <span class="n">current</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> @ [</span><span class="si">%4i</span><span class="s1">, </span><span class="si">%4i</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">none</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="n">subplot</span><span class="o">.</span><span class="n">format_coord</span> <span class="o">=</span> <span class="n">format_coord</span>
    <span class="n">image</span><span class="o">.</span><span class="n">get_cursor_data</span> <span class="o">=</span> <span class="n">none</span>
    <span class="n">image</span><span class="o">.</span><span class="n">format_cursor_data</span> <span class="o">=</span> <span class="n">none</span>

    <span class="k">if</span> <span class="n">dims</span><span class="p">:</span>
        <span class="n">current</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="n">dims</span><span class="p">)</span>
        <span class="n">curaxdat</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">current</span><span class="p">)]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()]</span>
        <span class="n">sliders</span> <span class="o">=</span> <span class="p">[</span><span class="n">pyplot</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.03</span><span class="o">*</span><span class="p">(</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.725</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">]),</span>
            <span class="s1">&#39;Dimension </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">axis</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">,</span>
            <span class="n">valfmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">.0f [</span><span class="si">%i</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dims</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">slider</span> <span class="ow">in</span> <span class="n">sliders</span><span class="p">:</span>
            <span class="n">slider</span><span class="o">.</span><span class="n">drawon</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">def</span> <span class="nf">set_image</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">sliders</span><span class="o">=</span><span class="n">sliders</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">):</span>
            <span class="c1"># change image and redraw canvas</span>
            <span class="n">curaxdat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">current</span><span class="p">)]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">image</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">curaxdat</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sliders</span><span class="p">,</span> <span class="n">current</span><span class="p">):</span>
                <span class="n">ctrl</span><span class="o">.</span><span class="n">eventson</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">ctrl</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="n">ctrl</span><span class="o">.</span><span class="n">eventson</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">on_changed</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">current</span><span class="o">=</span><span class="n">current</span><span class="p">):</span>
            <span class="c1"># callback function for slider change event</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
            <span class="n">curaxdat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">current</span><span class="p">[</span><span class="n">axis</span><span class="p">]:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">current</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
            <span class="n">set_image</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">on_keypressed</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">current</span><span class="o">=</span><span class="n">current</span><span class="p">):</span>
            <span class="c1"># callback function for key press event</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">curaxdat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">in</span> <span class="s1">&#39;0123456789&#39;</span><span class="p">:</span>
                <span class="n">on_changed</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
                <span class="n">on_changed</span><span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
                <span class="n">on_changed</span><span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
                <span class="n">curaxdat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">axis</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span><span class="p">:</span>
                <span class="n">curaxdat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">axis</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span>
                <span class="n">on_changed</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;home&#39;</span><span class="p">:</span>
                <span class="n">on_changed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>

        <span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">on_keypressed</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sliders</span><span class="p">):</span>
            <span class="n">ctrl</span><span class="o">.</span><span class="n">on_changed</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">axis</span><span class="p">:</span> <span class="n">on_changed</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">figure</span><span class="p">,</span> <span class="n">subplot</span><span class="p">,</span> <span class="n">image</span>


<span class="k">def</span> <span class="nf">_app_show</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Block the GUI. For use as skimage plugin.&quot;&quot;&quot;</span>
    <span class="n">pyplot</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;matplotlib.pyplot&#39;</span><span class="p">]</span>
    <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">askopenfilename</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return file name(s) from Tkinter&#39;s file open dialog.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">Tkinter</span> <span class="k">import</span> <span class="n">Tk</span>
        <span class="kn">import</span> <span class="nn">tkFileDialog</span> <span class="k">as</span> <span class="nn">filedialog</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">tkinter</span> <span class="k">import</span> <span class="n">Tk</span><span class="p">,</span> <span class="n">filedialog</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">Tk</span><span class="p">()</span>
    <span class="n">root</span><span class="o">.</span><span class="n">withdraw</span><span class="p">()</span>
    <span class="n">root</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">filedialog</span><span class="o">.</span><span class="n">askopenfilename</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">root</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">filenames</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Command line usage main function.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">2.7</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This script requires Python version 2.7 or better.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This is Python version </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">argv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>

    <span class="kn">import</span> <span class="nn">optparse</span>  <span class="c1"># TODO: use argparse</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span>
        <span class="n">usage</span><span class="o">=</span><span class="s1">&#39;usage: %prog [options] path&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Display image data in TIFF files.&#39;</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">prog </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">__version__</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span>
    <span class="n">opt</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--page&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;display single page&#39;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--series&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;series&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;display series of pages of same shape&#39;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s1">&#39;--nomultifile&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;nomultifile&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;do not read OME series from multiple files&#39;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s1">&#39;--noplots&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;noplots&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;maximum number of plots&#39;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s1">&#39;--interpol&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;interpol&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;INTERPOL&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;image interpolation method&#39;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s1">&#39;--dpi&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;dpi&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">96</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;plot resolution&#39;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s1">&#39;--vmin&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;vmin&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;minimum value for colormapping&#39;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s1">&#39;--vmax&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;maximum value for colormapping&#39;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s1">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;raise exception on failures&#39;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s1">&#39;--doctest&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;doctest&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;runs the docstring examples&#39;</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--detail&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;detail&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">opt</span><span class="p">(</span><span class="s1">&#39;-q&#39;</span><span class="p">,</span> <span class="s1">&#39;--quiet&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;quiet&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>

    <span class="n">settings</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">doctest</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">doctest</span>
        <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">(</span><span class="n">optionflags</span><span class="o">=</span><span class="n">doctest</span><span class="o">.</span><span class="n">ELLIPSIS</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">askopenfilename</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Select a TIFF file&#39;</span><span class="p">,</span>
                               <span class="n">filetypes</span><span class="o">=</span><span class="n">TIFF</span><span class="o">.</span><span class="n">FILEOPEN_FILTER</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No file specified&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">path</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="s1">&#39;?*&#39;</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no files match the pattern&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># TODO: handle image sequences</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Reading file structure...&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tif</span> <span class="o">=</span> <span class="n">TiffFile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">multifile</span><span class="o">=</span><span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">nomultifile</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1"> ms&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">tif</span><span class="o">.</span><span class="n">is_ome</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">norgb</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">noplots</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading image data... &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">notnone</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">page</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">images</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">page</span><span class="p">),</span>
                           <span class="n">tif</span><span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">page</span><span class="p">],</span> <span class="kc">None</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="o">.</span><span class="n">series</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">images</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">series</span><span class="p">),</span>
                           <span class="n">notnone</span><span class="p">(</span><span class="n">tif</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">_pages</span><span class="p">),</span>
                           <span class="n">tif</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">series</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tif</span><span class="o">.</span><span class="n">series</span><span class="p">[:</span><span class="n">settings</span><span class="o">.</span><span class="n">noplots</span><span class="p">]):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">i</span><span class="p">),</span>
                                       <span class="n">notnone</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">_pages</span><span class="p">),</span>
                                       <span class="n">tif</span><span class="o">.</span><span class="n">series</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="n">notnone</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pages</span><span class="p">),</span> <span class="kc">None</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                            <span class="k">raise</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Series </span><span class="si">%i</span><span class="s1"> failed: </span><span class="si">%s</span><span class="s1">... &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span>
                                  <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1"> ms&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">TiffFile</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">tif</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">detail</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">()</span>
    <span class="n">tif</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">images</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">noplots</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib</span>
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;TkAgg&#39;</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;failed to import matplotlib.</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">vmin</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">vmax</span>
                <span class="k">if</span> <span class="s1">&#39;GDAL_NODATA&#39;</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">vmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span>
                            <span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;GDAL_NODATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)])</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">if</span> <span class="n">tif</span><span class="o">.</span><span class="n">is_stk</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">vmin</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">stk_metadata</span><span class="p">[</span><span class="s1">&#39;MinScale&#39;</span><span class="p">]</span>
                        <span class="n">vmax</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">stk_metadata</span><span class="p">[</span><span class="s1">&#39;MaxScale&#39;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">vmax</span> <span class="o">&lt;=</span> <span class="n">vmin</span><span class="p">:</span>
                            <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">vmin</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">vmax</span>
                <span class="k">if</span> <span class="n">series</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tif</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">page</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">series</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tif</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
                <span class="n">photometric</span> <span class="o">=</span> <span class="s1">&#39;MINISBLACK&#39;</span>
                <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">photometric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
                    <span class="n">photometric</span> <span class="o">=</span> <span class="n">TIFF</span><span class="o">.</span><span class="n">PHOTOMETRIC</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">photometric</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
                <span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                       <span class="n">bitspersample</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">bitspersample</span><span class="p">,</span>
                       <span class="n">photometric</span><span class="o">=</span><span class="n">photometric</span><span class="p">,</span>
                       <span class="n">interpolation</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">interpol</span><span class="p">,</span>
                       <span class="n">dpi</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">inttypes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">,</span> <span class="n">long</span>  <span class="c1"># noqa</span>

    <span class="k">def</span> <span class="nf">print_</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print function with flush support.&quot;&quot;&quot;</span>
        <span class="n">flush</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;flush&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flush</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">bytes2str</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string from bytes.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">b</span>

    <span class="k">def</span> <span class="nf">str2bytes</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return bytes from string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">byte2int</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return value of byte as int.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">ord</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="ne">IOError</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="n">TiffFrame</span> <span class="o">=</span> <span class="n">TiffPage</span>  <span class="c1"># noqa</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">inttypes</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="n">basestring</span> <span class="o">=</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span>
    <span class="n">unicode</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="n">print_</span> <span class="o">=</span> <span class="nb">print</span>

    <span class="k">def</span> <span class="nf">bytes2str</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;strict&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return unicode string from encoded bytes.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;cp1252&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">str2bytes</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;cp1252&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return bytes from unicode string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">byte2int</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return value of byte as int.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">b</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Allen Institute for Cell Science

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>